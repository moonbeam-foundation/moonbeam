name: Scout Audit

on:
  pull_request:
  push:
    branches:
      - master

jobs:
  scout-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Install required dependencies
        run: |
          sudo apt-get install -y libprotobuf-dev protobuf-compiler
          rustup component add rust-src rustc-dev llvm-tools-preview --toolchain nightly-2025-08-07
          cargo +nightly-2025-08-07 install cargo-scout-audit
          cargo +nightly-2025-08-07 install dylint-link

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run scout audit
        id: run-scout
        shell: bash
        run: |
          # Running scout analysis
          
          log() {
            echo "[INFO] $1"
          }
          
          section() {
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸš€ $1"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          }
          
          # Configuration
          WORKSPACE="${{ github.workspace }}"
          REPORT_DIR="$WORKSPACE/scout-report"
          REPORT_PATH="$REPORT_DIR/report.md"
          
          section "Building Scout Environment"
          
          section "Preparing Analysis"
          log "Creating report directory..."
          mkdir -p "$REPORT_DIR"

          section "Running Security Analysis"
          cargo +nightly-2025-08-07 scout-audit --filter known-vulnerabilities,overflow-check --manifest-path runtime/moonbeam/Cargo.toml --output-path "$REPORT_PATH" --output-format md-gh --cicd "$REPORT_DIR"
          
          if [ ! -f "$REPORT_PATH" ]; then
            echo "[ERROR] Scout analysis failed!"
            exit 1
          fi
          
          echo "report=$REPORT_PATH" >> $GITHUB_OUTPUT
          echo "report_dir=$REPORT_DIR" >> $GITHUB_OUTPUT

      - name: Upload report
        uses: actions/upload-artifact@v6
        with:
          name: scout_audit_report.md
          path: ${{ steps.run-scout.outputs.report }}

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          token: ${{ secrets.GITHUB_TOKEN }}
          body-path: ${{ steps.run-scout.outputs.report }}

      - name: Check for failures
        shell: bash
        run: |
          if [ -f "${{ steps.run-scout.outputs.report_dir }}/FAIL" ]; then
            echo "[ERROR] Scout analysis failed! Please check the report for details."
            exit 1
          fi
          echo "âœ… Scout analysis completed successfully!"
