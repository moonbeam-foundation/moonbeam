# PR #6137: ParachainBlockData Support for Multiple Blocks

## PR Information
- **Title**: cumulus: `ParachainBlockData` support multiple blocks
- **GitHub**: https://github.com/paritytech/polkadot-sdk/pull/6137
- **Labels**: T9-cumulus
- **Audience**: Node Dev
- **Status**: Merged

## Summary
This PR adds support for `ParachainBlockData` to package multiple parachain blocks into a single Proof of Validity (PoV). This is a foundational change that enables parachains to operate with faster block times than the relay chain while maintaining the same PoV resource constraints. The implementation is backwards and forwards compatible, eliminating any dependency between collator and runtime upgrades.

## Changes Overview

### Affected Crates (All Major Bumps)
- `cumulus-client-collator` - Collator service client
- `cumulus-client-consensus-aura` - Aura consensus
- `cumulus-client-pov-recovery` - PoV recovery mechanisms
- `cumulus-pallet-parachain-system` - Core parachain system pallet
- `cumulus-primitives-core` - Core primitives
- `polkadot-primitives` - Polkadot primitives
- `cumulus-pov-validator` - PoV validation

### Key Technical Changes
1. **Encoding Changes**: ParachainBlockData encoding now supports versioning to allow multiple blocks per PoV
2. **Sequential Execution**: Multiple blocks in a PoV execute sequentially but share resource constraints
3. **Resource Sharing**: All blocks together use the same amount of resources as a single PoV (approximately 10MB)
4. **UMP Signaling**: Updated handling for multi-block scenarios
5. **Storage Root**: Computation now occurs only at the final block
6. **Message Limits**: ~16k message limits now apply across all blocks collectively, not per-block

### Compatibility
- **Backwards Compatible**: Old nodes can process new multi-block PoVs
- **Forwards Compatible**: New nodes can process old single-block PoVs
- **No Migration Required**: The encoding/decoding handles both formats transparently

## Impact on Moonbeam

### Impact Category: **MEDIUM** ‚ö†Ô∏è

While this PR doesn't require immediate changes, it introduces infrastructure that Moonbeam already uses and will enable future performance enhancements.

### Evidence-Based Analysis

#### 1. Direct Usage of Affected Crates

**Runtime Dependencies** (All 3 runtimes affected):
```toml
# From runtime/moonbase/Cargo.toml, runtime/moonbeam/Cargo.toml, runtime/moonriver/Cargo.toml
cumulus-pallet-parachain-system = { workspace = true }
cumulus-primitives-core = { workspace = true }
cumulus-primitives-utility = { workspace = true }
```

**Runtime Configuration** (`runtime/moonbase/src/lib.rs:750-763`):
```rust
impl cumulus_pallet_parachain_system::Config for Runtime {
	type RuntimeEvent = RuntimeEvent;
	type OnSystemEvent = ();
	type SelfParaId = ParachainInfo;
	type ReservedDmpWeight = ReservedDmpWeight;
	type OutboundXcmpMessageSource = XcmpQueue;
	type XcmpMessageHandler = XcmpQueue;
	type ReservedXcmpWeight = ReservedXcmpWeight;
	type CheckAssociatedRelayNumber = EmergencyParaXcm;
	type ConsensusHook = ConsensusHook;  // ‚ö†Ô∏è Uses FixedVelocityConsensusHook
	type DmpQueue = frame_support::traits::EnqueueWithOrigin<MessageQueue, RelayOrigin>;
	type WeightInfo = moonbase_weights::cumulus_pallet_parachain_system::WeightInfo<Runtime>;
	type SelectCore = cumulus_pallet_parachain_system::DefaultCoreSelector<Runtime>;
}
```

**Async Backing Configuration** (`runtime/moonbase/src/lib.rs:736-748`):
```rust
/// Maximum number of blocks simultaneously accepted by the Runtime, not yet included
/// into the relay chain.
const UNINCLUDED_SEGMENT_CAPACITY: u32 = 3;
/// How many parachain blocks are processed by the relay chain per parent. Limits the
/// number of blocks authored per slot.
const BLOCK_PROCESSING_VELOCITY: u32 = 1;  // ‚ö†Ô∏è Currently 1, could be increased

type ConsensusHook = pallet_async_backing::consensus_hook::FixedVelocityConsensusHook<
	Runtime,
	RELAY_CHAIN_SLOT_DURATION_MILLIS,
	BLOCK_PROCESSING_VELOCITY,
	UNINCLUDED_SEGMENT_CAPACITY,
>;
```

**Block Time Configuration** (`runtime/moonbase/src/lib.rs:181`):
```rust
pub const MILLISECS_PER_BLOCK: u64 = 6_000;  // Same as relay chain
const RELAY_CHAIN_SLOT_DURATION_MILLIS: u32 = 6000;
```

**PoV Size Limits** (`runtime/moonbase/src/lib.rs:171-179`):
```rust
/// Maximum PoV size we support right now.
pub const MAX_POV_SIZE: u32 = 10 * 1024 * 1024;  // 10MB

/// Maximum weight per block
pub const MAXIMUM_BLOCK_WEIGHT: Weight = Weight::from_parts(
	WEIGHT_REF_TIME_PER_SECOND.saturating_mul(2),
	MAX_POV_SIZE as u64,
);
```

#### 2. Client/Node Service Usage

**Collator Service** (`node/service/src/lib.rs:1020-1025`):
```rust
let collator_service = CollatorService::new(
	client.clone(),
	Arc::new(task_manager.spawn_handle()),
	announce_block,
	client.clone(),
);
```

**Consensus Implementation** (`node/service/src/lib.rs:1059-1089`):
```rust
nimbus_consensus::collators::lookahead::run::<Block, _, _, _, FullBackend, _, _, _, _, _, _>(
	nimbus_consensus::collators::lookahead::Params {
		additional_digests_provider: maybe_provide_vrf_digest,
		// ... configuration ...
		relay_chain_slot_duration,
		// ...
	},
)
```

#### 3. Block Validation Entry Point

**All Runtimes** (`runtime/moonbase/src/lib.rs:1675`, similar in moonbeam and moonriver):
```rust
cumulus_pallet_parachain_system::register_validate_block!(
	Runtime = Runtime,
	BlockExecutor = pallet_author_inherent::BlockExecutor<Runtime, Executive>,
);
```

This macro registration will now use the updated validation logic that supports multi-block PoVs.

#### 4. EVM Integration Considerations

Moonbeam's unique EVM integration adds complexity:

**Gas/PoV Ratio** (`runtime/moonbase/src/lib.rs:441-447`):
```rust
/// The amount of gas per pov. A ratio of 8 if we convert ref_time to gas and we compare
/// it with the pov_size for a block.
pub const GasLimitPovSizeRatio: u64 = 8;
```

This ratio remains valid because multiple blocks in one PoV still share the same 10MB PoV limit collectively.

### Specific Impacts

#### ‚úÖ **Positive Impacts**

1. **Future Performance Path**: This PR creates the foundation for Moonbeam to run 3-second (or faster) block times while relay chain remains at 6 seconds
   - Current: `BLOCK_PROCESSING_VELOCITY = 1`
   - Future possibility: `BLOCK_PROCESSING_VELOCITY = 2+` for faster blocks

2. **No Breaking Changes**: The backwards/forwards compatibility means Moonbeam can upgrade without coordination
   - Runtime upgrade can happen independently
   - Collator upgrade can happen independently
   - No forced synchronization required

3. **Improved User Experience Potential**: Faster block times would reduce transaction confirmation latency for EVM users

4. **Resource Efficiency**: Multiple blocks can share the same PoV overhead, potentially allowing more total throughput

#### ‚ö†Ô∏è **Considerations & Risks**

1. **Weight Model Implications**:
   - Current weight model assumes one block per PoV
   - If BLOCK_PROCESSING_VELOCITY increases, weight budgeting logic may need review
   - EVM gas limit calculations tied to PoV size might need adjustment

2. **Message Queue Changes**:
   - Message limits (~16k) now apply across all blocks in a PoV collectively
   - XCM-heavy workloads might behave differently with multi-block PoVs
   - Current code paths: `XcmpQueue`, `MessageQueue`, `DmpQueue`

3. **Storage Root Computation**:
   - Now only computed at final block in a multi-block PoV
   - May affect storage proof verification in precompiles like `pallet-evm-precompile-relay-verifier`

4. **Validation Data Access**:
   - Multiple places read `ValidationData::<Runtime>::get()` (found in 20+ files)
   - With multi-block PoVs, validation data semantics may change slightly
   - Most common usage: `runtime/moonriver/src/lib.rs:1294` for relay storage root

5. **Test Infrastructure**:
   - Mock relay chain in tests uses single-block assumptions
   - Integration tests may need updates if multi-block PoVs are enabled
   - File: `runtime/moonbase/tests/common/mod.rs:425` - `increase_last_relay_slot_number`

#### üîç **No Impact Areas**

1. **EVM Execution**: The EVM execution layer is unaffected; blocks still execute sequentially
2. **Staking**: ParachainStaking pallet logic unchanged
3. **XCM Configuration**: XCM executor and config unchanged
4. **Precompiles**: EVM precompiles continue to work identically

### Current Status in Moonbeam Codebase

**Version Check**:
```
cumulus-pallet-parachain-system = 0.20.0 (branch: moonbeam-polkadot-stable2503)
cumulus-primitives-core = 0.18.1 (branch: moonbeam-polkadot-stable2503)
```

Moonbeam is currently on `stable2503` branch. This PR is part of `stable2506`, so the changes are **not yet integrated**.

### Action Items

#### Required Actions: **NONE** ‚úÖ

This PR is fully compatible and requires no immediate changes.

#### Recommended Actions:

1. **Testing Priority: Medium**
   - When upgrading to stable2506, run full integration test suite
   - Pay special attention to:
     - Block production and validation tests
     - XCM message queue tests
     - EVM transaction tests across block boundaries
     - Relay storage root verification in precompiles

2. **Monitoring After Upgrade**:
   - Monitor PoV size distribution
   - Watch for any validation errors in logs
   - Track block production latency
   - Observe message queue behavior

3. **Documentation Updates**:
   - Update internal docs about PoV structure when convenient
   - Note the capability for future block time reduction

4. **Future Optimization Path** (Not urgent):
   - Consider testing increased `BLOCK_PROCESSING_VELOCITY` on testnet
   - Evaluate if 3-second block times improve UX for EVM users
   - Assess impact on collator hardware requirements

### Migration Steps

**No migration required** - The encoding changes are transparent.

When Moonbeam upgrades from stable2503 to stable2506:
1. ‚úÖ Runtime upgrade will automatically support new encoding
2. ‚úÖ Node upgrade will automatically support new encoding
3. ‚úÖ No state migration needed
4. ‚úÖ No configuration changes needed

### Testing Recommendations

1. **Pre-Upgrade Testing**:
   ```bash
   # Run full runtime test suite
   cargo test -p moonbase-runtime
   cargo test -p moonbeam-runtime
   cargo test -p moonriver-runtime

   # Run integration tests
   cd test
   pnpm moonwall test smoke_moonbase
   pnpm moonwall test dev_moonbase
   ```

2. **Post-Upgrade Testing**:
   - Verify block production continues normally
   - Check PoV sizes remain within limits
   - Test XCM message delivery
   - Verify EVM transaction execution
   - Confirm relay storage root verification works

3. **Testnet Validation**:
   - Deploy to Moonbase Alpha first
   - Monitor for 24-48 hours before production networks
   - Check for any unusual validation errors

### Related Configuration

**Files to Review During Upgrade**:
- `runtime/*/src/lib.rs` - ParachainSystem config (Lines 750-763 in moonbase)
- `node/service/src/lib.rs` - Consensus setup (Lines 983-1092)
- `runtime/*/src/lib.rs` - Block time constants (Line 181)
- `runtime/*/src/lib.rs` - PoV size constants (Lines 171-179)

**No changes needed** to these files, but awareness of their interaction with the new multi-block PoV capability is valuable.

## Conclusion

**Impact Level: MEDIUM** ‚ö†Ô∏è

This PR introduces significant infrastructure changes to core parachain components that Moonbeam depends on. However, the implementation's backwards/forwards compatibility means there are **no breaking changes** and **no required actions**.

The main value of this PR for Moonbeam is:
1. ‚úÖ Maintains compatibility with current single-block-per-PoV operation
2. üöÄ Opens future path to faster block times (3s or less) without relay chain changes
3. üîß No immediate work required
4. üìä Transparent upgrade with existing workflows

**Risk Level: LOW** - The compatibility design and extensive testing in the upstream PR minimize risk.

**Recommendation**: Proceed with normal stable2506 upgrade process. No special handling required for this PR specifically, but maintain standard testing protocols.
