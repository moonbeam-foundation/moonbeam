# PR #6312: DeprecationInfo Propagate `#[allow(deprecated)]` Attribute

## Overview

**PR**: https://github.com/paritytech/polkadot-sdk/pull/6312
**Status**: Merged April 9, 2025
**Labels**: R0-no-crate-publish-required, D1-medium
**Impact Level**: **MINIMAL** - Quality of life improvement

## Summary

This PR automatically adds `#[allow(deprecated)]` attributes to macro-generated code to suppress deprecation warnings in generated implementations while preserving deprecation information in metadata. The changes affect:

- `frame-support-procedural` (no version bump)
- `frame-support` (no version bump)
- `sp-api-proc-macro` (no version bump)
- `sp-api` (no version bump)

## Technical Changes

### What Changed

The PR modifies procedural macros to wrap generated code with `#[allow(deprecated)]` attributes in several contexts:

1. **Derive Macros** (`NoBound` derives): Added to generated `impl` blocks for:
   - Clone, Debug, Default, Eq, Ord, PartialEq, PartialOrd

2. **Pallet Expansion**:
   - `call.rs`: Applied to call dispatch code
   - `constants.rs`: Applied to constant value encoding
   - `error.rs`: Applied to Debug impl, From impl, and error_metadata function
   - `event.rs`: Applied to deposit_event and From impl blocks
   - `config.rs`: Removes deprecated attributes before expansion

3. **construct_runtime Modules**:
   - `metadata.rs`: Added to metadata_ir() function
   - `outer_enums.rs`: Added to From and TryInto impl blocks
   - `mod.rs`: Added to tt_call! macro invocations

4. **Runtime API Macros**:
   - Added deprecation attribute handling infrastructure

### Implementation Details

New utility function `extract_or_return_allow_attrs()` in `deprecation.rs` that:
- Converts `#[deprecated]` into `#[allow(deprecated)]`
- Passes through existing `#[allow(...)]` attributes
- Filters and transforms attributes for macro-generated code

## Impact on Moonbeam

### Current Deprecation Usage

Moonbeam currently has **2 deprecated items**:

1. **`TIMESTAMP_NOW` constant** (`/Users/manuelmauro/Workspace/moonbeam/core-primitives/src/lib.rs:56-59`)
   ```rust
   #[deprecated]
   /// Can be removed after runtime 4000
   pub const TIMESTAMP_NOW: &[u8] =
       &hex!["f0c365c3cf59d671eb72da0e7a4113c49f1f0515f462cdcf84e0f1d6045dfcbb"];
   ```

   **Usage**: Referenced in `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:1064-1065`
   ```rust
   #[allow(deprecated)]
   moonbeam_core_primitives::well_known_relay_keys::TIMESTAMP_NOW.to_vec(),
   ```
   **Status**: Already manually suppressed with `#[allow(deprecated)]`

2. **`DelegatorStatus::Leaving` enum variant** (`/Users/manuelmauro/Workspace/moonbeam/pallets/parachain-staking/src/types.rs:1115-1116`)
   ```rust
   #[allow(deprecated)]
   #[derive(Clone, PartialEq, Encode, Decode, RuntimeDebug, TypeInfo)]
   pub enum DelegatorStatus {
       Active,
       #[deprecated(note = "must only be used for backwards compatibility reasons")]
       Leaving(RoundIndex),
   }
   ```

   **Usage**: Used in `CollatorStatus::Leaving(RoundIndex)` throughout the parachain-staking pallet
   **Status**: Enum wrapped with `#[allow(deprecated)]` at type level (line 1109)

### Macro Usage in Moonbeam

Moonbeam extensively uses the affected macros:

1. **`construct_runtime!`**: Used in all 3 runtime variants
   - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs`
   - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs`
   - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs`

2. **`#[pallet]` macro**: Used in parachain-staking pallet
   - `/Users/manuelmauro/Workspace/moonbeam/pallets/parachain-staking/src/lib.rs:78`

3. **`impl_runtime_apis!`**: Used in all runtimes
   - All 3 runtime files plus `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/apis.rs`

4. **Derive macros**: Extensively used throughout the codebase with types containing deprecated fields

### Existing Manual Suppressions

Moonbeam already has manual `#[allow(deprecated)]` attributes in:
- `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs` (line 1064)
- `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lazy_loading/mod.rs`
- `/Users/manuelmauro/Workspace/moonbeam/client/rpc/trace/src/lib.rs`
- `/Users/manuelmauro/Workspace/moonbeam/client/rpc/debug/src/lib.rs`
- `/Users/manuelmauro/Workspace/moonbeam/precompiles/relay-encoder/src/lib.rs`
- `/Users/manuelmauro/Workspace/moonbeam/pallets/parachain-staking/src/types.rs` (line 1109)

### Build Status

**Current Build**: âœ… No deprecation warnings
```bash
cargo build --release -p moonbase-runtime
# Completed successfully with no deprecation warnings
```

## Concrete Impact Assessment

### Immediate Impact: **NONE**

**Reason**: Moonbeam has already manually added `#[allow(deprecated)]` attributes where needed. The current codebase:
- Compiles without deprecation warnings
- Has proper suppressions in place for both deprecated items
- Uses manual attributes at both the usage site and type definition level

### Future Benefits: **LOW TO MODERATE**

This PR will provide value in the following scenarios:

1. **When adding new deprecated items**: Reduces boilerplate by automatically suppressing warnings in generated code
   - Example: If adding a new deprecated storage item, the macro-generated metadata code won't emit warnings

2. **When using deprecated types in derive macros**: The `NoBound` derives will automatically suppress warnings
   - Currently: `DelegatorStatus` is wrapped with `#[allow(deprecated)]` at enum level
   - With PR: Individual derive implementations would also be suppressed (defense in depth)

3. **Cleaner migration paths**: When deprecating runtime APIs or pallet calls
   - Warnings only appear in user code, not in macro-generated implementations
   - Makes it easier to identify actual usage vs. metadata/boilerplate code

### Migration Requirements: **NONE**

- No code changes required
- No runtime upgrade needed
- No storage migrations needed
- Existing `#[allow(deprecated)]` attributes remain valid and can optionally be removed in the future

## Recommendations

### Action Required: **NONE**

This PR is a transparent quality-of-life improvement that requires no action from the Moonbeam team.

### Optional Cleanup (Future)

After upgrading to stable2506, consider removing redundant `#[allow(deprecated)]` attributes:

1. **Keep**: Usage-site suppressions like in `node/service/src/lib.rs:1064`
   - These document intentional use of deprecated APIs

2. **Consider removing**: Type-level suppressions like in `pallets/parachain-staking/src/types.rs:1109`
   - The macro-generated code will now be automatically suppressed
   - However, keeping them provides backward compatibility with older SDK versions

**Recommendation**: Leave existing attributes in place for now. They're harmless and provide compatibility.

## Testing Notes

No specific testing required for this PR. The changes are internal to macro expansion and don't affect runtime behavior or API compatibility.

## References

- **PRDoc**: `/Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_6312.prdoc`
- **PR Discussion**: https://github.com/paritytech/polkadot-sdk/pull/6312
- **Affected Files**:
  - `substrate/frame/support/procedural/src/deprecation.rs` (new utility)
  - Derive macros: `clone.rs`, `debug.rs`, `default.rs`, `ord.rs`, `partial_eq.rs`, `partial_ord.rs`
  - Pallet expansion: `call.rs`, `constants.rs`, `error.rs`, `event.rs`, `config.rs`
  - Runtime construction: `metadata.rs`, `outer_enums.rs`
  - Runtime APIs: `common.rs`, `decl_runtime_apis.rs`, `impl_runtime_apis.rs`

## Conclusion

PR #6312 has **minimal immediate impact** on Moonbeam as the codebase already has proper deprecation warning suppressions in place. The PR provides future value by reducing the need for manual `#[allow(deprecated)]` attributes when deprecating items used in macro-generated code. No action is required, and the upgrade is risk-free.
