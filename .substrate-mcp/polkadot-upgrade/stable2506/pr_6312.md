# PR #6312: DeprecationInfo Propagate `#[allow(deprecated)]` Attribute

## Metadata

- **PR**: [paritytech/polkadot-sdk#6312](https://github.com/paritytech/polkadot-sdk/pull/6312)
- **Labels**: R0-no-crate-publish-required, D1-medium
- **Audience**: Runtime Dev, Runtime User
- **Crates Modified**:
  - `frame-support-procedural` (bump: none)
  - `frame-support` (bump: none)
  - `sp-api-proc-macro` (bump: none)
  - `sp-api` (bump: none)

## Summary

This PR improves the developer experience by automatically propagating or adding `#[allow(deprecated)]` attributes in macro-generated code for deprecated pallet items (Constants, RuntimeApis, Runtime Calls, and enum variants). This reduces compiler warning noise when maintaining deprecated functionality for backwards compatibility.

## Technical Details

### What Changed

The PR modifies the FRAME macro expansion system to intelligently handle deprecation warnings:

1. **Macro Expansion Enhancement**: When the `#[pallet]`, `construct_runtime!`, or `impl_runtime_apis!` macros expand code that references deprecated items, they now automatically add `#[allow(deprecated)]` to the generated code.

2. **Preservation of Metadata**: The deprecation information (`DeprecationInfo`) is still preserved in the runtime metadata, ensuring that external tools and users are aware of deprecated functionality.

3. **Selective Application**: The `#[allow(deprecated)]` attribute is only applied to macro-generated code, not user-written code. This means:
   - Users will still see warnings if they explicitly call deprecated items in their own code
   - Internal macro-generated code (like trait implementations) won't generate warnings
   - Deprecation metadata is still available for documentation and tooling

### Affected Components

The changes affect procedural macros in:
- **frame-support-procedural**: Pallet macro expansion (for `#[pallet::call]`, `#[pallet::event]`, `#[pallet::constant]`)
- **sp-api-proc-macro**: Runtime API macro expansion (for `impl_runtime_apis!`)

## Impact on Moonbeam

### Current Status

**Moonbeam is currently on polkadot-sdk `moonbeam-polkadot-stable2503`** (as seen in `/Users/manuelmauro/Workspace/moonbeam/Cargo.toml:136`). This PR is part of the `stable2506` release and is **NOT yet in Moonbeam's current dependencies**.

### Impact Category: **POSITIVE - Quality of Life Improvement**

When Moonbeam upgrades to `stable2506` or later, this PR will provide the following benefits:

#### 1. Reduced Compiler Warning Noise

**Evidence**: Moonbeam has deprecated items that currently trigger warnings:

**File**: `/Users/manuelmauro/Workspace/moonbeam/pallets/parachain-staking/src/types.rs`
```rust
#[allow(deprecated)]
#[derive(Clone, PartialEq, Encode, Decode, RuntimeDebug, TypeInfo)]
pub enum DelegatorStatus {
    /// Active with no scheduled exit
    Active,
    /// Schedule exit to revoke all ongoing delegations
    #[deprecated(note = "must only be used for backwards compatibility reasons")]
    Leaving(RoundIndex),
}
```

**File**: `/Users/manuelmauro/Workspace/moonbeam/core-primitives/src/lib.rs`
```rust
pub mod well_known_relay_keys {
    use hex_literal::hex;

    #[deprecated]
    /// Can be removed after runtime 4000
    pub const TIMESTAMP_NOW: &[u8] =
        &hex!["f0c365c3cf59d671eb72da0e7a4113c49f1f0515f462cdcf84e0f1d6045dfcbb"];
}
```

**Current Behavior**: These deprecated items are used in `pallet-parachain-staking` which is included in all three Moonbeam runtimes (moonbase, moonbeam, moonriver) via the `construct_runtime!` macro. The manual `#[allow(deprecated)]` attribute on the `DelegatorStatus` enum prevents warnings, but this needs to be added manually by developers.

**Post-PR Behavior**: After this PR, the macro-generated code will automatically suppress these warnings without requiring manual `#[allow(deprecated)]` attributes, making the codebase cleaner.

#### 2. Cleaner Backwards Compatibility Maintenance

The `DelegatorStatus::Leaving` variant is marked as deprecated "for backwards compatibility reasons" - this is exactly the use case this PR addresses. The variant needs to remain in the code for storage migrations and existing data compatibility, but shouldn't clutter the build output with warnings.

#### 3. Runtime Configuration

**Evidence**: Moonbeam's runtime configuration includes the affected pallet:

**File**: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs:1429`
```rust
ParachainStaking: pallet_parachain_staking::{Pallet, Call, Storage, Event<T>, Config<T>} = 12,
```

The `construct_runtime!` macro generates code that includes all the Event variants, Call variants, and types from `pallet_parachain_staking`, which includes the deprecated `DelegatorStatus` enum.

### Concrete Benefits for Moonbeam

1. **No Action Required**: The existing manual `#[allow(deprecated)]` attributes in the codebase (like on `DelegatorStatus`) can remain or be removed - the PR provides automatic handling.

2. **Future Deprecations**: When Moonbeam developers need to deprecate pallet calls, events, or constants in the future, they won't need to manually add `#[allow(deprecated)]` to suppress internal warnings.

3. **Build Output Cleanliness**: Reduced warning noise during `cargo build` and `cargo clippy` runs, making it easier to spot actual issues.

4. **No Breaking Changes**: This is purely a developer experience improvement with no impact on runtime behavior, storage, or external APIs.

## Migration Requirements

**None** - This is a transparent improvement that requires no code changes in Moonbeam.

## Verification

To verify the current state:

```bash
# Check for deprecated items in the codebase
rg '#\[deprecated' /Users/manuelmauro/Workspace/moonbeam

# Check ParachainStaking pallet usage
rg 'ParachainStaking' /Users/manuelmauro/Workspace/moonbeam/runtime/*/src/lib.rs

# Check current polkadot-sdk version
rg 'branch.*stable' /Users/manuelmauro/Workspace/moonbeam/Cargo.toml | head -5
```

## Recommendation

**Action**: No immediate action required. This improvement will be automatically available when upgrading to `stable2506`.

**Priority**: Low - This is a quality-of-life improvement that makes development more pleasant but doesn't fix bugs or add features.

**Testing**: No additional testing needed beyond standard upgrade testing, as this only affects compile-time warnings, not runtime behavior.

## Related Files

- `/Users/manuelmauro/Workspace/moonbeam/pallets/parachain-staking/src/types.rs` - Contains deprecated enum variant
- `/Users/manuelmauro/Workspace/moonbeam/core-primitives/src/lib.rs` - Contains deprecated constant
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs` - Runtime configuration
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs` - Runtime configuration
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs` - Runtime configuration
- `/Users/manuelmauro/Workspace/moonbeam/Cargo.toml` - Dependency configuration

## Additional Context

This PR is part of ongoing efforts to improve the FRAME macro system's developer experience. It builds on the existing deprecation metadata infrastructure while reducing the maintenance burden of keeping deprecated items for backwards compatibility.

The change is particularly valuable for projects like Moonbeam that maintain multiple production runtimes (mainnet on Polkadot, Moonriver on Kusama, and Moonbase Alpha on Westend) and need to carefully manage deprecations across long-lived chains with existing state.
