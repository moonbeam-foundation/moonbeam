# PR #6324 Impact Analysis: Introduce `#[pallet::authorize(...)]` macro attribute and `AuthorizeCall` system transaction extension

## Overview

**PR Title:** Introduce `#[pallet::authorize(...)]` macro attribute and `AuthorizeCall` system transaction extension

**PR URL:** https://github.com/paritytech/polkadot-sdk/pull/6324

**Labels:** T1-FRAME

**Audience:** Runtime Dev

**Status:** Part of stable2506 release (Moonbeam currently on stable2503)

## Summary

This PR introduces a new authorization mechanism for calls that need validation without requiring a signed origin. It adds a `#[pallet::authorize(...)]` macro attribute and a new `AuthorizeCall` transaction extension to replace the `ValidateUnsigned` pattern. This is part of the broader effort to phase out unsigned transactions in the Polkadot SDK ecosystem.

## Impact Classification

**MEDIUM IMPACT - REQUIRED RUNTIME CHANGES**

### Rationale:
1. **Breaking Change:** This is a MAJOR version bump for `frame-support` and `frame-system`
2. **Required Action:** All runtimes MUST add `AuthorizeCall` to their transaction extension pipeline
3. **Functional Impact:** Moonbeam uses `apply_authorized_upgrade` which will use this new mechanism
4. **No Custom Migration:** No custom pallets use `ValidateUnsigned`, reducing complexity

## Changes Introduced

### Core Changes

1. **New Pallet Attributes:**
   - `#[pallet::authorize(...)]` - Accepts a function defining call validity logic
   - `#[pallet::weight_of_authorize(...)]` - Specifies pre-dispatch weight for authorization

2. **New Transaction Extension:**
   - `frame_system::AuthorizeCall<Runtime>` - Must be added to the TxExtension pipeline
   - Suggested to be placed first in the pipeline

3. **New Trait:**
   - `Authorize` trait implemented on calls for pallets and runtime

4. **New Origin Variant:**
   - `Origin::Authorized` - Similar to `Unsigned` but for general transactions

5. **Helper Method:**
   - `ensure_authorized` - For checking authorization status

### Affected Crates

- `frame-support` - **major** bump
- `frame-system` - **major** bump
- `sp-runtime` - minor bump
- `frame-executive` - none
- `frame-benchmarking` - minor bump
- `frame-support-procedural` - **major** bump
- All system parachain runtimes - **major** bump

## Concrete Evidence of Impact on Moonbeam

### 1. Transaction Extension Pipeline Requires Modification

**Current State (all three runtimes):**

**Moonbase Runtime** (`/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs:1494-1507`):
```rust
pub type TxExtension = cumulus_pallet_weight_reclaim::StorageWeightReclaim<
	Runtime,
	(
		frame_system::CheckNonZeroSender<Runtime>,
		frame_system::CheckSpecVersion<Runtime>,
		frame_system::CheckTxVersion<Runtime>,
		frame_system::CheckGenesis<Runtime>,
		frame_system::CheckEra<Runtime>,
		frame_system::CheckNonce<Runtime>,
		frame_system::CheckWeight<Runtime>,
		pallet_transaction_payment::ChargeTransactionPayment<Runtime>,
		frame_metadata_hash_extension::CheckMetadataHash<Runtime>,
	),
>;
```

**Moonbeam Runtime** (`/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs:1585-1599`):
```rust
pub type TxExtension = cumulus_pallet_weight_reclaim::StorageWeightReclaim<
	Runtime,
	(
		frame_system::CheckNonZeroSender<Runtime>,
		frame_system::CheckSpecVersion<Runtime>,
		frame_system::CheckTxVersion<Runtime>,
		frame_system::CheckGenesis<Runtime>,
		frame_system::CheckEra<Runtime>,
		frame_system::CheckNonce<Runtime>,
		frame_system::CheckWeight<Runtime>,
		pallet_transaction_payment::ChargeTransactionPayment<Runtime>,
		BridgeRejectObsoleteHeadersAndMessages,
		frame_metadata_hash_extension::CheckMetadataHash<Runtime>,
	),
>;
```

**Moonriver Runtime** (`/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs:1584-1598`):
```rust
pub type TxExtension = cumulus_pallet_weight_reclaim::StorageWeightReclaim<
	Runtime,
	(
		frame_system::CheckNonZeroSender<Runtime>,
		frame_system::CheckSpecVersion<Runtime>,
		frame_system::CheckTxVersion<Runtime>,
		frame_system::CheckGenesis<Runtime>,
		frame_system::CheckEra<Runtime>,
		frame_system::CheckNonce<Runtime>,
		frame_system::CheckWeight<Runtime>,
		pallet_transaction_payment::ChargeTransactionPayment<Runtime>,
		BridgeRejectObsoleteHeadersAndMessages,
		frame_metadata_hash_extension::CheckMetadataHash<Runtime>,
	),
>;
```

**Required Change:**
All three runtimes must add `frame_system::AuthorizeCall<Runtime>` to the pipeline, preferably at the beginning of the tuple.

### 2. System Pallet Authorized Upgrade Functionality Used

**Evidence:** Moonbeam actively uses `apply_authorized_upgrade` and `authorize_upgrade` calls from `frame_system`.

**Weight Functions Present:**

`/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/weights/frame_system.rs:152`:
```rust
fn authorize_upgrade() -> Weight {
	// Proof Size summary in bytes:
	//  Measured:  `0`
```

`/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/weights/frame_system.rs:176`:
```rust
fn apply_authorized_upgrade() -> Weight {
	// Proof Size summary in bytes:
	//  Measured:  `190`
	//  Estimated: `67035`
```

Similar weight functions exist in:
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/weights/frame_system.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/weights/frame_system.rs`

### 3. Runtime Upgrade Tests Will Be Affected

**Test Files Using `applyAuthorizedUpgrade`:**

1. **Chopsticks Test** (`/Users/manuelmauro/Workspace/moonbeam/test/suites/chopsticks/test-upgrade-chain.ts`):
```typescript
await context.setStorage({
  module: "system",
  method: "authorizedUpgrade",
  methodParams: `${rtHash}01`, // 01 is for the RT ver check = true
});
await context.createBlock();

await api.tx.system.applyAuthorizedUpgrade(rtHex).signAndSend(signer);
```

2. **Zombie Test** (`/Users/manuelmauro/Workspace/moonbeam/test/suites/zombie/test_para.ts`):
```typescript
await paraApi.tx.system.applyAuthorizedUpgrade(rtHex).signAndSend(alith);
```

3. **Lazy Loading Test** (`/Users/manuelmauro/Workspace/moonbeam/test/suites/lazy-loading/test-runtime-upgrade.ts`):
```typescript
const { result } = await context.createBlock(
  api.tx.system.applyAuthorizedUpgrade(runtimeWasmHex)
);
```

4. **Fee Test** (`/Users/manuelmauro/Workspace/moonbeam/test/suites/dev/moonbase/test-fees/test-fee-multiplier-max.ts`):
```typescript
// send an applyAuthorizedUpgrade. we expect this to fail, but we just want to see that it
// was included in a block (not rejected) and was charged based on its length
await context.polkadotJs().tx.system.applyAuthorizedUpgrade(hex).signAndSend(baltathar);
```

**Test Scripts Affected:**

- `/Users/manuelmauro/Workspace/moonbeam/test/scripts/preapprove-rt-rawspec.ts` - Sets up `AuthorizedUpgrade` storage
- `/Users/manuelmauro/Workspace/moonbeam/test/scripts/prepare-lazy-loading-overrides.ts` - Prepares authorized upgrades

### 4. No Custom ValidateUnsigned Implementation Found

**Positive Finding:** Grep search for `ValidateUnsigned` across the entire Moonbeam codebase returned zero matches:

```bash
$ rg "ValidateUnsigned" /Users/manuelmauro/Workspace/moonbeam
# No matches found
```

This means Moonbeam does not have custom pallets that rely on the old `ValidateUnsigned` pattern, significantly reducing migration complexity.

### 5. Current Dependency Version

```bash
$ cargo tree -p frame-system --depth 0
frame-system v40.2.0 (https://github.com/moonbeam-foundation/polkadot-sdk?branch=moonbeam-polkadot-stable2503#f1c87aa3)
```

Moonbeam is currently on `stable2503`. This PR is part of `stable2506`, the next major upgrade.

## Required Actions

### 1. Update Transaction Extension Pipeline (CRITICAL)

**Priority:** HIGH - Required for runtime to work correctly

**All Three Runtimes Must Be Updated:**

Add `frame_system::AuthorizeCall<Runtime>` to the transaction extension pipeline. Suggested placement at the beginning:

**Example for Moonbase:**
```rust
pub type TxExtension = cumulus_pallet_weight_reclaim::StorageWeightReclaim<
	Runtime,
	(
		frame_system::AuthorizeCall<Runtime>,  // ADD THIS LINE
		frame_system::CheckNonZeroSender<Runtime>,
		frame_system::CheckSpecVersion<Runtime>,
		frame_system::CheckTxVersion<Runtime>,
		frame_system::CheckGenesis<Runtime>,
		frame_system::CheckEra<Runtime>,
		frame_system::CheckNonce<Runtime>,
		frame_system::CheckWeight<Runtime>,
		pallet_transaction_payment::ChargeTransactionPayment<Runtime>,
		frame_metadata_hash_extension::CheckMetadataHash<Runtime>,
	),
>;
```

**Files to Modify:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs` (line ~1494)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs` (line ~1585)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs` (line ~1584)

### 2. Run Comprehensive Tests

**Priority:** HIGH - Verify authorization mechanism works

Test the following areas thoroughly:

1. **Runtime Upgrade Tests:**
   ```bash
   cd test
   pnpm moonwall test dev_moonbase -d "test-runtime-upgrade"
   pnpm moonwall test dev_moonbase -d "test-upgrade-chain"
   ```

2. **Zombie Tests:**
   ```bash
   pnpm moonwall test zombie_moonbase -d "test_para"
   ```

3. **Fee Tests:**
   ```bash
   pnpm moonwall test dev_moonbase -d "test-fee-multiplier-max"
   ```

4. **Full Test Suite:**
   ```bash
   cargo test -p moonbase-runtime
   cargo test -p moonbeam-runtime
   cargo test -p moonriver-runtime
   ```

### 3. Update Benchmarks (MEDIUM PRIORITY)

**Priority:** MEDIUM - May need re-benchmarking

The weight functions for `authorize_upgrade` and `apply_authorized_upgrade` may need to be regenerated:

```bash
./scripts/run-benches-for-runtime.sh moonbase release
```

Verify that the weight functions still accurately reflect the execution cost with the new authorization mechanism.

### 4. Review Test Scripts

**Priority:** LOW - Verification only

Review the test preparation scripts to ensure they're compatible with the new authorization mechanism:

- `/Users/manuelmauro/Workspace/moonbeam/test/scripts/preapprove-rt-rawspec.ts`
- `/Users/manuelmauro/Workspace/moonbeam/test/scripts/prepare-lazy-loading-overrides.ts`

These scripts set up the `AuthorizedUpgrade` storage key, which should remain compatible, but verification is recommended.

## Migration Risk Assessment

### Low Risk Factors:
1. No custom `ValidateUnsigned` implementations to migrate
2. Well-defined migration path in PRDoc
3. Clear documentation on how to add `AuthorizeCall`
4. Only affects existing authorized upgrade functionality, which is already tested

### Medium Risk Factors:
1. Breaking change requiring runtime modification
2. All three runtimes need simultaneous update
3. Tests must be updated to verify new behavior
4. Potential weight function changes

### High Risk Factors:
**None identified** - This is a straightforward migration with clear upgrade path

## Testing Strategy

### Pre-Deployment Testing:

1. **Unit Tests:**
   - Verify System pallet configuration compiles
   - Run full runtime test suite for all three runtimes

2. **Integration Tests:**
   - Test `applyAuthorizedUpgrade` in dev mode
   - Verify authorization storage interaction
   - Test upgrade flow end-to-end

3. **Chopsticks Tests:**
   - Fork mainnet state
   - Test runtime upgrade with new mechanism
   - Verify no regressions

4. **Zombie Tests:**
   - Test in parachain context
   - Verify relay chain interaction still works

### Post-Deployment Verification:

1. Monitor runtime upgrade transactions on testnet
2. Verify `applyAuthorizedUpgrade` calls succeed
3. Check event emissions for authorization
4. Validate weight calculation accuracy

## Timeline Recommendation

1. **Immediate (with stable2506 upgrade):**
   - Add `AuthorizeCall` to all runtime TxExtension pipelines
   - Update runtime version
   - Run full test suite

2. **Before Deployment:**
   - Run chopsticks tests on forked mainnet
   - Verify all upgrade tests pass
   - Review weight functions

3. **Post-Deployment:**
   - Monitor first runtime upgrade
   - Validate authorization mechanism

## Additional Notes

### Related PRs:
This PR is part of a series:
- PR #6323: Adds `TransactionSource` to validation
- PR #6324: This PR (authorize attribute)
- PR #6325: Migrates system tasks
- PR #6326: Migrates unsigned calls across SDK

### Upstream References:
- Issue #2415: Broader plan for extrinsics
- Part of "Tx ext stage 2" work (2/4)

### Documentation:
The Rust documentation for `pallet::authorize` will provide detailed usage examples. Review this when implementing.

## Conclusion

PR #6324 introduces a cleaner authorization mechanism for calls that previously relied on `ValidateUnsigned`. For Moonbeam, the impact is **MEDIUM** with clear, straightforward migration steps:

1. Add `AuthorizeCall` to the transaction extension pipeline in all three runtimes
2. Test runtime upgrade functionality thoroughly
3. Potentially re-benchmark affected weight functions

The migration is low-risk due to:
- No custom `ValidateUnsigned` implementations in Moonbeam
- Well-documented upgrade path
- Extensive existing test coverage for `applyAuthorizedUpgrade`

**Recommended Action:** Implement the required changes as part of the stable2506 upgrade cycle and run comprehensive tests before deployment.
