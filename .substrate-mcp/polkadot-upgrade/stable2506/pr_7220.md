# PR #7220: Yet Another Parachain Runtime - Impact Analysis

## Executive Summary

**Impact Level:** MEDIUM - Changes to weight calculation mechanisms in block authoring and transaction extensions

**PR Title:** Yet Another Parachain Runtime

**PR Description:** Introduces "Yet Another Parachain" (YAP), a testing runtime for Spammening events, with accompanying changes to core authorship and transaction handling mechanisms.

**Affected Components:**
- Block authoring weight calculations
- Transaction pool performance optimizations
- Network transaction propagation
- frame-system transaction extensions

## Changes Overview

### Core Modifications

1. **sc-basic-authorship** - Modified extrinsic weight calculation logic
   - Changed from using `ExtrinsicBaseWeight` to signature check weight
   - Prevents double-counting of transaction extension weights
   - Affects how blocks are authored and extrinsics are weighted

2. **sc-transaction-pool** - Performance optimizations for high-throughput scenarios
   - Enhanced validated pool handling
   - Supports increased transaction volumes (500k+ transactions)

3. **sc-network-transactions** - Transaction propagation improvements
   - Batched transaction notifications
   - More efficient network transmission

4. **sc-service & sc-network** - Configuration updates
   - Increased RPC connection limits
   - Enhanced pool capacity

5. **frame-system** - Minor bump related to weight calculation changes

## Impact on Moonbeam

### 1. Block Authoring - MEDIUM IMPACT

**Evidence:**

Moonbeam uses `sc-basic-authorship::ProposerFactory` in three critical locations:

**Location 1:** `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:1011`
```rust
let proposer_factory = sc_basic_authorship::ProposerFactory::with_proof_recording(
    task_manager.spawn_handle(),
    client.clone(),
    transaction_pool,
    prometheus_registry,
    telemetry.clone(),
);
```

**Location 2:** `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:1231`
```rust
let mut env = sc_basic_authorship::ProposerFactory::with_proof_recording(
    task_manager.spawn_handle(),
    client.clone(),
    transaction_pool.clone(),
    prometheus_registry.as_ref(),
    telemetry.as_ref().map(|x| x.handle()),
);
env.set_soft_deadline(SOFT_DEADLINE_PERCENT);
```

**Location 3:** `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lazy_loading/mod.rs:486`
```rust
let mut env = sc_basic_authorship::ProposerFactory::with_proof_recording(
    task_manager.spawn_handle(),
    client.clone(),
    transaction_pool.clone(),
    prometheus_registry.as_ref(),
    telemetry.as_ref().map(|x| x.handle()),
);
env.set_soft_deadline(SOFT_DEADLINE_PERCENT);
```

**Analysis:**

The weight calculation changes in `sc-basic-authorship` directly affect how Moonbeam's collators:
- Calculate extrinsic weights during block production
- Determine which transactions fit in a block
- Account for transaction extension overhead

The change from `ExtrinsicBaseWeight` to signature check weight is a more precise accounting method that avoids double-counting transaction extension weights.

### 2. Weight Configuration - MEDIUM IMPACT

**Evidence:**

All three Moonbeam runtimes define and use `EXTRINSIC_BASE_WEIGHT`:

**moonbase-runtime:** `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs:235`
```rust
pub const EXTRINSIC_BASE_WEIGHT: Weight = Weight::from_parts(10000 * WEIGHT_PER_GAS, 0);

pub struct RuntimeBlockWeights;
impl Get<frame_system::limits::BlockWeights> for RuntimeBlockWeights {
    fn get() -> frame_system::limits::BlockWeights {
        frame_system::limits::BlockWeights::builder()
            .for_class(DispatchClass::Normal, |weights| {
                weights.base_extrinsic = EXTRINSIC_BASE_WEIGHT;
                weights.max_total = NORMAL_WEIGHT.into();
            })
            // ...
    }
}
```

**moonriver-runtime:** `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs:242`
```rust
pub const EXTRINSIC_BASE_WEIGHT: Weight = Weight::from_parts(10000 * WEIGHT_PER_GAS, 0);
// Same RuntimeBlockWeights implementation
```

**moonbeam-runtime:** `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs:235`
```rust
pub const EXTRINSIC_BASE_WEIGHT: Weight = Weight::from_parts(10000 * WEIGHT_PER_GAS, 0);
// Same RuntimeBlockWeights implementation
```

**Analysis:**

While Moonbeam's runtimes continue to define `EXTRINSIC_BASE_WEIGHT`, the changed behavior in `sc-basic-authorship` means the actual weight accounting during block production may differ from the configured base weight. This is because the authorship crate now uses signature check weights from transaction extensions instead.

### 3. EVM Compatibility Tests - MEDIUM IMPACT

**Evidence:**

All three runtimes have tests verifying base_extrinsic compatibility with EVM gas costs:

**moonbase-runtime:** `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs:1851`
```rust
#[test]
fn configured_base_extrinsic_weight_is_evm_compatible() {
    let min_ethereum_transaction_weight = WeightPerGas::get() * 21_000;
    let base_extrinsic = <Runtime as frame_system::Config>::BlockWeights::get()
        .get(frame_support::dispatch::DispatchClass::Normal)
        .base_extrinsic;
    assert!(base_extrinsic.ref_time() <= min_ethereum_transaction_weight.ref_time());
}
```

**moonriver-runtime:** `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs:2026`
```rust
#[test]
fn configured_base_extrinsic_weight_is_evm_compatible() {
    let min_ethereum_transaction_weight = WeightPerGas::get() * 21_000;
    let base_extrinsic = <Runtime as frame_system::Config>::BlockWeights::get()
        .get(frame_support::dispatch::DispatchClass::Normal)
        .base_extrinsic;
    assert!(base_extrinsic.ref_time() <= min_ethereum_transaction_weight.ref_time());
}
```

**moonbeam-runtime:** `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs:2027`
```rust
#[test]
fn configured_base_extrinsic_weight_is_evm_compatible() {
    let min_ethereum_transaction_weight = WeightPerGas::get() * 21_000;
    let base_extrinsic = <Runtime as frame_system::Config>::BlockWeights::get()
        .get(frame_support::dispatch::DispatchClass::Normal)
        .base_extrinsic;
    assert!(base_extrinsic.ref_time() <= min_ethereum_transaction_weight.ref_time());
}
```

**Analysis:**

These tests ensure that the base extrinsic weight doesn't exceed Ethereum's minimum transaction cost (21,000 gas). The change in how weights are calculated could affect this relationship, though the tests themselves remain valid and should continue to pass.

### 4. Fee Calculation - MEDIUM IMPACT

**Evidence:**

All three runtimes implement `TransactionPaymentAsGasPrice` which bridges Substrate weights to EVM gas prices:

**moonbase-runtime:** `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs:453`
```rust
pub struct TransactionPaymentAsGasPrice;
impl FeeCalculator for TransactionPaymentAsGasPrice {
    fn min_gas_price() -> (U256, Weight) {
        // note: transaction-payment uses both a congestion modifier (next_fee_multiplier, which is
        //       updated once per block in on_finalize) and a 'WeightToFee' implementation. Our
        //       runtime implements this as a 'ConstantModifier', so we can get away with a simple
        //       multiplication here.
        // ...
    }
}

impl pallet_evm::Config for Runtime {
    type FeeCalculator = TransactionPaymentAsGasPrice;
    type GasWeightMapping = pallet_evm::FixedGasWeightMapping<Self>;
    type WeightPerGas = WeightPerGas;
    // ...
}
```

**Similar implementations in moonriver and moonbeam runtimes**

**Analysis:**

Changes to weight calculation in the authorship layer could indirectly affect how fees are calculated, especially if the effective weight of transactions differs from the configured base weight. This is particularly important for Moonbeam's Ethereum compatibility, where gas prices must remain predictable.

### 5. Transaction Extensions - MEDIUM IMPACT

**Evidence:**

Moonbeam has benchmarked weights for transaction extensions:

**File:** `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/weights/frame_system_extensions.rs`
```rust
/// Weights for `frame_system_extensions`.
pub struct WeightInfo<T>(PhantomData<T>);
impl<T: frame_system::Config> frame_system::ExtensionsWeightInfo for WeightInfo<T> {
    fn check_genesis() -> Weight {
        Weight::from_parts(4_257_000, 0)
    }
    fn check_mortality_mortal_transaction() -> Weight {
        Weight::from_parts(7_108_000, 0)
    }
    fn check_mortality_immortal_transaction() -> Weight {
        Weight::from_parts(7_138_000, 0)
    }
    fn check_non_zero_sender() -> Weight {
        Weight::from_parts(575_000, 0)
    }
    // ...
}
```

**Analysis:**

The PR's change to use signature check weights instead of `ExtrinsicBaseWeight` directly relates to these transaction extension weights. The new approach uses these more precise weights, which are already benchmarked in Moonbeam, avoiding double-counting.

### 6. Transaction Pool - LOW IMPACT

**Evidence:**

Transaction pool configuration in `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs:1056`:
```rust
fn transaction_pool(&self, is_dev: bool) -> Result<sc_service::config::TransactionPoolOptions> {
    self.base.base.transaction_pool(is_dev)
}
```

**Analysis:**

Moonbeam uses the default transaction pool configuration from `sc-service`. The performance optimizations in `sc-transaction-pool` will be inherited automatically and should improve throughput without requiring code changes.

### 7. Network Propagation - LOW IMPACT

**Evidence:**

No direct usage of `sc-network-transactions` found in Moonbeam codebase. The crate is used internally by `sc-service` and `sc-network`.

**Analysis:**

The batched transaction notification improvements are internal optimizations that will be inherited transparently through the `sc-service` and `sc-network` dependencies.

## Dependency Analysis

### Direct Dependencies

From `/Users/manuelmauro/Workspace/moonbeam/Cargo.toml`:
```toml
frame-system = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2503", default-features = false }
frame-system-benchmarking = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2503", default-features = false }
frame-system-rpc-runtime-api = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2503", default-features = false }
sc-basic-authorship = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2503" }
sc-network = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2503" }
sc-service = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2503" }
sc-transaction-pool = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2503" }
```

### Usage Statistics

- **frame-system**: Used in 20+ pallets/precompiles + all 3 runtimes
- **sc-basic-authorship**: 3 critical usages in node service
- **sc-transaction-pool**: Used in node service and CLI
- **sc-network**: Used in node service and CLI
- **sc-service**: Used in node service and CLI

## Risk Assessment

### Technical Risks

1. **Weight Calculation Changes** - MEDIUM RISK
   - The shift from `ExtrinsicBaseWeight` to signature check weights changes how block space is calculated
   - Could affect block fullness and transaction inclusion rates
   - May impact fee calculations if weights differ from expectations

2. **EVM Gas Compatibility** - MEDIUM RISK
   - Moonbeam's EVM compatibility depends on precise weight-to-gas conversions
   - Changes in weight accounting could affect gas price calculations
   - Existing tests should catch major issues, but subtle differences may emerge

3. **Block Production Performance** - LOW RISK
   - The soft deadline setting (100%) means blocks are authored to full capacity
   - More accurate weight accounting could slightly change transaction packing efficiency
   - Performance optimizations in transaction pool should improve overall throughput

### Behavioral Risks

1. **Transaction Inclusion** - MEDIUM RISK
   - More precise weight accounting may change which transactions fit in blocks
   - Could affect transaction ordering and inclusion timing
   - Impact on both Substrate and EVM transactions

2. **Fee Variations** - LOW RISK
   - Small changes in effective weights could cause minor fee variations
   - Moonbeam's constant fee multiplier reduces volatility
   - EVM transactions may see slight gas price adjustments

## Testing Requirements

### Essential Tests

1. **Block Production Tests**
   - Verify collators can produce full blocks
   - Check transaction inclusion rates remain consistent
   - Validate block weights are calculated correctly

2. **EVM Compatibility Tests**
   - Run existing EVM gas compatibility tests
   - Verify Ethereum transaction costs remain correct
   - Test `TransactionPaymentAsGasPrice` calculations

3. **Weight Calculation Tests**
   - Verify `configured_base_extrinsic_weight_is_evm_compatible` tests pass
   - Check transaction extension weights are applied correctly
   - Validate block weight limits are respected

4. **Performance Tests**
   - Measure transaction throughput before/after upgrade
   - Test transaction pool under high load
   - Verify network propagation performance

### Test Commands

```bash
# Runtime tests
cargo test -p moonbase-runtime configured_base_extrinsic_weight_is_evm_compatible
cargo test -p moonriver-runtime configured_base_extrinsic_weight_is_evm_compatible
cargo test -p moonbeam-runtime configured_base_extrinsic_weight_is_evm_compatible

# Integration tests
cd test
pnpm moonwall test dev_moonbase
pnpm moonwall test smoke_moonbase

# Specific EVM fee tests
pnpm moonwall test dev_moonbase -d "test-fee" -d "test-gas"
```

## Migration Requirements

### Code Changes

**NO CODE CHANGES REQUIRED**

The changes are internal to the Polkadot SDK crates and should be transparent to Moonbeam's runtime and node code. The existing weight configurations and fee calculations should continue to work.

### Runtime Upgrade

**NO RUNTIME UPGRADE REQUIRED**

This PR does not change runtime logic or storage. The `frame-system` bump is related to weight calculation APIs that are used by the client, not the runtime itself.

### Configuration Changes

**NO CONFIGURATION CHANGES REQUIRED**

Existing weight configurations, fee parameters, and transaction pool settings remain valid.

## Recommendations

### Pre-Upgrade Actions

1. **Baseline Measurements**
   - Record current transaction throughput metrics
   - Document current gas price calculations
   - Capture block production statistics

2. **Test Suite Execution**
   - Run full Rust test suite
   - Execute integration tests on testnet
   - Perform load testing on development node

3. **Monitoring Preparation**
   - Set up alerts for unusual weight calculations
   - Monitor transaction inclusion rates
   - Track gas price variations

### Post-Upgrade Monitoring

1. **Block Production Metrics**
   - Monitor block weight utilization
   - Track transaction inclusion rates
   - Verify block production times remain stable

2. **Fee Calculation Metrics**
   - Monitor EVM gas prices
   - Track transaction fee variations
   - Verify fee calculator behavior

3. **Performance Metrics**
   - Measure transaction throughput
   - Monitor transaction pool size
   - Track network propagation latency

### Contingency Planning

1. **Rollback Preparation**
   - Document current Polkadot SDK version
   - Keep previous node binaries available
   - Plan for quick rollback if issues arise

2. **Issue Response**
   - Monitor for weight calculation discrepancies
   - Watch for transaction inclusion problems
   - Be prepared to adjust weight parameters if needed

## Conclusion

PR #7220 introduces performance optimizations and more accurate weight accounting mechanisms that will affect Moonbeam's block production and transaction processing. The changes are primarily internal improvements that should be transparent to runtime code, but require careful testing due to Moonbeam's unique Ethereum compatibility requirements.

**Key Points:**

1. **No code changes required** - Changes are internal to SDK crates
2. **Medium impact on weight calculations** - More precise accounting may affect block production
3. **Testing is critical** - EVM compatibility tests must verify gas calculations remain correct
4. **Performance benefits expected** - Transaction pool optimizations should improve throughput
5. **Monitoring is essential** - Track metrics before and after upgrade to catch any subtle differences

**Overall Assessment:** This PR should be beneficial for Moonbeam, providing better performance and more accurate weight accounting. However, thorough testing is required to ensure Ethereum compatibility is maintained and that the weight calculation changes don't negatively impact transaction processing.
