# PR #7556: Add Trie Cache Warmup - Impact Analysis

## PR Overview

**Title**: Add trie cache warmup
**PR Link**: https://github.com/paritytech/polkadot-sdk/pull/7556
**Labels**: T0-node
**Status**: Merged (May 28, 2025)

**Purpose**: Implements trie cache warmup functionality to enhance performance of smart contracts on AssetHub by reducing storage access time. The cache can be populated at node startup via a CLI flag.

## Changes Summary

### Modified Crates
- `sc-cli` (major bump)
- `sc-service` (major bump)
- `sc-client-db` (minor bump)

### Key Changes

1. **CLI Parameters** (`sc-cli`)
   - Added `--warm-up-trie-cache` flag with optional strategy (blocking/non-blocking)
   - New `TrieCacheWarmUpStrategy` enum
   - Added `warm_up_trie_cache()` method to `CliConfiguration` trait

2. **Service Configuration** (`sc-service`)
   - Added `warm_up_trie_cache: Option<TrieCacheWarmUpStrategy>` field to `Configuration` struct
   - Implemented cache warmup logic in `builder.rs`

3. **Database Layer** (`sc-client-db`)
   - Added memory availability checks before initializing trie cache
   - Added `sysinfo` dependency for memory introspection

## Impact on Moonbeam

### Severity: MEDIUM (Breaking Changes Required)

### 1. Compilation Breaking Changes

#### Test Code - Configuration Construction
**Location**: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:1793`

The `test_config()` function manually constructs a `Configuration` struct. The new `warm_up_trie_cache` field will break this exhaustive initialization.

**Current Code**:
```rust
Configuration {
    impl_name: String::from("test-impl"),
    impl_version: String::from("0.1"),
    role: Role::Full,
    tokio_handle: runtime.handle().clone(),
    transaction_pool: Default::default(),
    network: network_config,
    keystore: KeystoreConfig::Path {
        path: "key".into(),
        password: None,
    },
    database: DatabaseSource::RocksDb {
        path: "db".into(),
        cache_size: 128,
    },
    trie_cache_maximum_size: Some(16777216),
    state_pruning: Default::default(),
    blocks_pruning: sc_service::BlocksPruning::KeepAll,
    chain_spec: Box::new(spec),
    executor: Default::default(),
    wasm_runtime_overrides: Default::default(),
    rpc: RpcConfiguration { /* ... */ },
    data_path: Default::default(),
    prometheus_config: None,
    telemetry_endpoints: None,
    offchain_worker: Default::default(),
    force_authoring: false,
    disable_grandpa: false,
    dev_key_seed: None,
    tracing_targets: None,
    tracing_receiver: Default::default(),
    announce_block: true,
    base_path: BasePath::new(Path::new("")),
}
```

**Required Fix**:
```rust
Configuration {
    // ... existing fields ...
    warm_up_trie_cache: None,  // Add this line
}
```

#### Trait Implementation - CliConfiguration
**Location**: `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs:997`

The `CliConfiguration` trait implementation for `RelayChainCli` will need to implement the new `warm_up_trie_cache()` method.

**Current Implementation** (lines 997-1095):
```rust
impl CliConfiguration<Self> for RelayChainCli {
    fn shared_params(&self) -> &SharedParams { /* ... */ }
    fn import_params(&self) -> Option<&ImportParams> { /* ... */ }
    // ... other methods ...
}
```

**Required Fix**:
```rust
impl CliConfiguration<Self> for RelayChainCli {
    // ... existing methods ...

    fn warm_up_trie_cache(&self) -> Result<Option<sc_service::config::TrieCacheWarmUpStrategy>> {
        // Relay chain doesn't need trie cache warmup for Moonbeam's use case
        Ok(None)
    }
}
```

### 2. Runtime Impact

**None** - This is a node-level change only. No runtime pallets or runtime APIs are affected.

### 3. Performance Considerations

#### For Moonbeam Operators
The trie cache warmup feature is **completely optional** and provides potential benefits:

- **Use Case**: Operators running collators with large state (like AssetHub scenario) may benefit from cache warmup
- **Trade-off**: 1.5-2 minutes startup time (based on Polkadot AssetHub benchmarks with 5.4M keys)
- **Memory**: Cache size is already configurable via existing flags
- **Default Behavior**: No change - cache warmup is disabled by default

#### Moonbeam-Specific Context
- Moonbeam has relatively smaller state compared to AssetHub
- EVM execution patterns may benefit less from trie cache warmup
- Most benefit would be for storage-heavy operations during block import

### 4. API/Breaking Changes Summary

| Component | Change Type | Impact |
|-----------|-------------|--------|
| `Configuration` struct | Breaking (new field) | Test code needs update |
| `CliConfiguration` trait | Breaking (new method) | Relay chain CLI implementation needs update |
| CLI flags | Additive | No impact (optional flag) |
| Database behavior | Non-breaking | Enhanced with memory checks |

## Required Actions

### Immediate (Compilation Fixes)
1. Add `warm_up_trie_cache: None` to `test_config()` function in `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs`
2. Implement `warm_up_trie_cache()` method in `RelayChainCli` implementation in `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs`

### Optional (Feature Adoption)
Consider testing the `--warm-up-trie-cache` flag on development nodes to evaluate:
- Impact on collator startup time
- Memory usage patterns
- Performance improvement for storage-heavy operations

### Documentation
Update operator documentation if the feature is deemed beneficial for Moonbeam's use case.

## Migration Complexity

**Low to Medium**
- Code changes are straightforward (add field, implement method)
- No complex logic migration required
- Testing needed to ensure relay chain CLI continues to work correctly

## Recommendations

1. **Accept the breaking changes** - Add the required field and method implementation
2. **Default to None** - Don't enable trie cache warmup by default for Moonbeam
3. **Document the option** - Make operators aware of the `--warm-up-trie-cache` flag for future use
4. **Test on devnet** - Evaluate the feature on development environments before considering for production

## Code Locations to Update

1. `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:1793` - Add field to Configuration struct
2. `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs:997` - Add method to CliConfiguration impl
3. Test suite - Verify all tests pass after changes

## References

- PRDoc: `/Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_7556.prdoc`
- GitHub PR: https://github.com/paritytech/polkadot-sdk/pull/7556
- Related Issue: #7533 (AssetHub smart contracts launch)
