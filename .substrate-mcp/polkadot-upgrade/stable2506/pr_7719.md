# PR #7719 Impact Analysis: Add `export-chain-spec` substrate CLI command

## PR Overview

**Title**: Add `export-chain-spec` substrate CLI command
**GitHub**: https://github.com/paritytech/polkadot-sdk/pull/7719
**Labels**: I5-enhancement, T9-cumulus, T17-Templates
**Status**: Merged (May 6, 2025)
**Audience**: Runtime Dev

### Summary

This PR introduces a new `export-chain-spec` command to export raw chain specs directly from the node binary. The `build-spec` command enters a deprecation path and will display warnings encouraging migration to `export-chain-spec`.

### Key Changes

1. **New Command**: `export-chain-spec` added to `sc-cli` for exporting chain specifications
2. **Deprecation**: `build-spec` command is deprecated (still functional but shows warnings)
3. **New Trait**: `ExtraSubcommand` trait for composable CLI extensions in polkadot-omni-node-lib
4. **Affected Crates**:
   - `sc-cli` (minor bump)
   - `polkadot-cli` (major bump)
   - `polkadot-parachain-bin` (patch)
   - `polkadot-omni-node-lib` (minor)
   - `polkadot-omni-node` (patch)

---

## Impact Assessment for Moonbeam

### Impact Level: MEDIUM

**Direct Code Impact**: LOW
**Script Impact**: MEDIUM
**Migration Urgency**: LOW (Future consideration)

---

## Detailed Impact Analysis

### 1. Direct Code Impact: LOW

Moonbeam has a **custom CLI implementation** that wraps the standard Substrate CLI commands.

#### Current Implementation

**File**: `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/cli.rs`

```rust
// Line 62: BuildSpec subcommand definition
BuildSpec(BuildSpecCommand),

// Lines 98-112: Custom BuildSpecCommand wrapper
#[derive(Debug, Parser)]
pub struct BuildSpecCommand {
	#[clap(flatten)]
	pub base: sc_cli::BuildSpecCmd,  // <-- Uses sc_cli::BuildSpecCmd

	/// Number of accounts to be funded in the genesis
	#[clap(long, conflicts_with = "chain")]
	pub accounts: Option<u32>,

	/// Mnemonic from which we can derive funded accounts in the genesis
	#[clap(long, conflicts_with = "chain")]
	pub mnemonic: Option<String>,
}
```

**File**: `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs`

```rust
// Lines 234-266: BuildSpec command handler
Some(Subcommand::BuildSpec(params)) => {
	let runner = cli.create_runner(&params.base)?;
	runner.sync_run(|config| {
		if params.mnemonic.is_some() || params.accounts.is_some() {
			// Custom logic for development specs
			// ...
		} else {
			params.base.run(config.chain_spec, config.network)
		}
	})
}
```

**Why LOW impact**:
- Moonbeam extends `sc_cli::BuildSpecCmd` but doesn't directly use `polkadot-omni-node` or related crates
- The underlying `BuildSpecCmd` will continue to work (just with deprecation warnings)
- The custom wrapper adds Moonbeam-specific parameters (`accounts`, `mnemonic`) on top
- No breaking changes to the API of `BuildSpecCmd`

---

### 2. Script Impact: MEDIUM

Multiple scripts actively use the `build-spec` command which is now deprecated.

#### Scripts Using `build-spec`

**File**: `/Users/manuelmauro/Workspace/moonbeam/scripts/generate-parachain-specs.sh`

```bash
# Line 6
$MOONBEAM_BINARY build-spec \
  --disable-default-bootnode \
  --chain 'moonbase-local' \
  | grep '\"code\"' \
  | head -n1 > $ALPHANET_PARACHAIN_SPEC_TMP

# Line 18
$MOONBEAM_BINARY build-spec \
  --disable-default-bootnode \
  --raw \
  --chain $ALPHANET_PARACHAIN_SPEC_PLAIN \
  > $ALPHANET_PARACHAIN_SPEC_RAW
```

**File**: `/Users/manuelmauro/Workspace/moonbeam/test/scripts/prepare-chainspecs-for-zombie.sh`

```bash
# Line 32
tmp/moonbeam_rt build-spec --chain $CHAIN-local > tmp/$CHAIN\-plain-spec.json
tmp/moonbeam_rt build-spec --chain tmp/$CHAIN\-modified-spec.json --raw > tmp/$CHAIN\-raw-spec.json
```

**Impact**:
- Scripts will work but generate deprecation warnings
- Warnings may cause confusion in CI/CD logs
- Eventually `build-spec` may be fully removed in future SDK versions

---

### 3. New Features Not Currently Used

#### ExtraSubcommand Trait

The PR introduces a new `ExtraSubcommand` trait for composable CLI extensions:

```rust
// From polkadot-omni-node-lib
pub trait ExtraSubcommand {
    // Trait for custom subcommand injection
}
```

**Status in Moonbeam**: NOT USED
- Moonbeam doesn't use `polkadot-omni-node-lib`
- They have their own node implementation
- This trait is not relevant to Moonbeam's current architecture

---

## Recommendations

### Immediate Actions: NONE REQUIRED

The changes are backward compatible. Current implementation continues to work.

### Short-term (Next 3-6 months)

1. **Monitor deprecation warnings** during builds
2. **Test the new `export-chain-spec` command** to verify it works with Moonbeam's custom chain specs
3. **Evaluate migration complexity** for the custom `BuildSpecCommand` wrapper

### Medium-term (6-12 months)

1. **Migrate scripts to `export-chain-spec`**:
   - Update `/Users/manuelmauro/Workspace/moonbeam/scripts/generate-parachain-specs.sh`
   - Update `/Users/manuelmauro/Workspace/moonbeam/test/scripts/prepare-chainspecs-for-zombie.sh`

2. **Consider CLI refactoring**:
   - Evaluate if custom `BuildSpecCommand` wrapper should migrate to `export-chain-spec`
   - Assess if `accounts` and `mnemonic` parameters can be integrated with new command
   - Check if the new command supports all current use cases

### Long-term Considerations

1. **Future SDK updates** may fully remove `build-spec`
2. **Monitor polkadot-sdk releases** for complete `build-spec` removal timeline
3. **Align with upstream patterns** to reduce maintenance burden

---

## Migration Guide (When Ready)

### Before Migration

Verify current `build-spec` usage:
```bash
# Test current build-spec command
./target/release/moonbeam build-spec --chain moonbase-local

# Test with custom parameters
./target/release/moonbeam build-spec --chain moonbase-local --accounts 10 --mnemonic "..."
```

### Migration Steps

1. **Update Moonbeam CLI** (when ready):
   ```rust
   // In node/cli/src/cli.rs
   pub enum Subcommand {
       // Old (deprecated)
       BuildSpec(BuildSpecCommand),

       // New (to be added)
       ExportChainSpec(ExportChainSpecCommand),
   }
   ```

2. **Update scripts**:
   ```bash
   # Old
   $MOONBEAM_BINARY build-spec --chain moonbase-local

   # New
   $MOONBEAM_BINARY export-chain-spec --chain moonbase-local
   ```

3. **Test thoroughly**:
   - Verify chain spec generation still works
   - Ensure custom parameters (`accounts`, `mnemonic`) are preserved or adapted
   - Test all chain variants (moonbeam, moonriver, moonbase)

---

## Technical Details

### Files Changed in Polkadot-SDK PR #7719

**New Files**:
- `substrate/client/cli/src/commands/export_chain_spec_cmd.rs`
- `cumulus/polkadot-omni-node/lib/src/extra_subcommand.rs`

**Modified Files**:
- `substrate/client/cli/src/commands/mod.rs`
- `substrate/client/cli/src/lib.rs`
- `cumulus/polkadot-omni-node/lib/src/command.rs`
- `cumulus/polkadot-parachain/src/main.rs`

### Moonbeam Files Affected

**Directly using deprecated code**:
- `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/cli.rs` (line 101: uses `sc_cli::BuildSpecCmd`)
- `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs` (lines 234-266: handles BuildSpec)

**Scripts to update eventually**:
- `/Users/manuelmauro/Workspace/moonbeam/scripts/generate-parachain-specs.sh`
- `/Users/manuelmauro/Workspace/moonbeam/test/scripts/prepare-chainspecs-for-zombie.sh`

**Dependencies**:
- `sc-cli` (used in `node/cli/Cargo.toml`, `node/service/Cargo.toml`)

---

## Testing Checklist

When migrating to `export-chain-spec`:

- [ ] Verify `export-chain-spec` command is available in updated Substrate version
- [ ] Test chain spec generation for all networks (moonbeam, moonriver, moonbase)
- [ ] Verify custom parameters (`--accounts`, `--mnemonic`) work or have alternatives
- [ ] Test both plain and raw chain spec generation
- [ ] Update and test all scripts in `/scripts` and `/test/scripts`
- [ ] Verify CI/CD pipelines work with new command
- [ ] Check zombienet integration still functions
- [ ] Update documentation and developer guides

---

## Conclusion

**Impact Summary**: MEDIUM

While the PR doesn't break any existing Moonbeam functionality immediately, it does deprecate the `build-spec` command that Moonbeam actively uses in its CLI and scripts. The impact is medium because:

1. **No immediate action required** - current code continues to work
2. **Deprecation warnings** will appear but don't block functionality
3. **Scripts need updating** eventually to avoid future compatibility issues
4. **Custom CLI wrapper** needs careful consideration for migration
5. **Timeline is flexible** - migration can be planned strategically

The migration should be treated as a **medium-priority technical debt item** to be addressed in an upcoming Substrate upgrade cycle, likely within 6-12 months depending on when polkadot-sdk fully removes `build-spec`.
