# PR #7719: Add `export-chain-spec` substrate CLI command

**Analysis Date:** 2025-10-22
**Moonbeam Version:** master (upgrading from stable2503 to stable2506)
**PR Link:** https://github.com/paritytech/polkadot-sdk/pull/7719
**Labels:** I5-enhancement, T9-cumulus, T17-Templates

---

## Executive Summary

**Impact Level:** Medium (Client/Tooling)

PR #7719 introduces a new `export-chain-spec` CLI command as the preferred method for exporting chain specifications, while deprecating the existing `build-spec` command. This is a **client-side tooling change** with no runtime impact, but it affects multiple scripts, CI workflows, and the custom CLI implementation in Moonbeam.

**Key Takeaway:** This is a soft deprecation - `build-spec` continues to work with warning messages. However, Moonbeam should plan migration to avoid future breakage and align with upstream best practices.

---

## Changes Introduced

### What Changed

1. **New Command Added:**
   - `export-chain-spec` - New dedicated command for exporting embedded chain specs to JSON files
   - Implemented via an `ExtraSubcommand` trait for extensibility

2. **Deprecation Notice:**
   - `build-spec` command displays deprecation warnings
   - Command remains functional (soft deprecation)
   - Timeline for removal not yet determined (suggested 1-3 months in community discussion)

3. **Crate Updates:**
   - `sc-cli` - minor version bump
   - `polkadot-cli` - major version bump
   - `polkadot-parachain-bin` - patch bump
   - `polkadot-omni-node-lib` - minor bump

### Technical Implementation

- Changed from `clap::Parser` to `clap::Subcommand` trait for extra subcommand integration
- Boot node functionality intentionally excluded from initial implementation
- Trait-based approach enables custom nodes to extend subcommands

---

## Impact on Moonbeam

### Affected Components

#### 1. Custom CLI Implementation

**File:** `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/cli.rs`

Moonbeam has a custom `BuildSpecCommand` wrapper that extends `sc_cli::BuildSpecCmd`:

```rust
#[derive(Debug, Parser)]
pub struct BuildSpecCommand {
    #[clap(flatten)]
    pub base: sc_cli::BuildSpecCmd,

    /// Number of accounts to be funded in the genesis
    #[clap(long, conflicts_with = "chain")]
    pub accounts: Option<u32>,

    /// Mnemonic from which we can derive funded accounts in the genesis
    #[clap(long, conflicts_with = "chain")]
    pub mnemonic: Option<String>,
}
```

**Custom Features:**
- `--accounts`: Specifies number of funded accounts in genesis
- `--mnemonic`: Provides mnemonic for deriving funded accounts
- Both flags imply development spec and override explicit chain specs

**Usage in Command Handler:** `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs:234-266`

The custom implementation creates development chain specs for moonbeam, moonriver, or moonbase runtimes based on the parameters.

#### 2. Test Scripts

**File:** `/Users/manuelmauro/Workspace/moonbeam/test/scripts/prepare-chainspecs-for-zombie.sh:32,34`

```bash
tmp/moonbeam_rt build-spec --chain $CHAIN-local > tmp/$CHAIN\-plain-spec.json
tmp/moonbeam_rt build-spec --chain tmp/$CHAIN\-modified-spec.json --raw > tmp/$CHAIN\-raw-spec.json
```

**Purpose:** Generates chain specs for Zombienet testing infrastructure

#### 3. TypeScript Build Script

**File:** `/Users/manuelmauro/Workspace/moonbeam/test/scripts/compile-wasm.ts:83,89`

```typescript
const generateChainSpecCmd = `${binaryPath} build-spec --chain ${args.argv.Chain} > tmp/${args.argv.Chain}.json`;
const generateRawChainSpecCmd = `${binaryPath} build-spec --chain tmp/${args.argv.Chain}.json --raw > tmp/${args.argv.Chain}-raw.json`;
```

**Purpose:** Compiles WASM runtime and generates chain specs for testing

#### 4. CI/CD Workflows

**File:** `/Users/manuelmauro/Workspace/moonbeam/.github/workflows/build.yml:867,869`

```yaml
tmp/moonbeam_rt build-spec --chain ${{ matrix.chain }}-local > tmp/${{ matrix.chain }}-plain-spec.json
tmp/moonbeam_rt build-spec --chain tmp/${{ matrix.chain }}-modified-spec.json --raw > tmp/${{ matrix.chain }}-raw-spec.json
```

**Purpose:** Zombie upgrade tests in CI for moonbeam, moonriver, and moonbase chains

#### 5. Parachain Spec Generation

**File:** `/Users/manuelmauro/Workspace/moonbeam/scripts/generate-parachain-specs.sh:6,18`

```bash
$MOONBEAM_BINARY build-spec \
  --disable-default-bootnode \
  --chain 'moonbase-local' \
  | grep '\"code\"' \
  | head -n1 > $ALPHANET_PARACHAIN_SPEC_TMP

$MOONBEAM_BINARY build-spec \
  --disable-default-bootnode \
  --raw \
  --chain $ALPHANET_PARACHAIN_SPEC_PLAIN \
  > $ALPHANET_PARACHAIN_SPEC_RAW
```

**Purpose:** Generates Alphanet parachain specifications

#### 6. Dependencies

**File:** `/Users/manuelmauro/Workspace/moonbeam/node/cli/Cargo.toml:21`

```toml
sc-cli = { workspace = true }
```

Currently points to `moonbeam-polkadot-stable2503` branch.

---

## Concrete Evidence

### Current Build-Spec Usage Locations

| Location | Line(s) | Usage Pattern |
|----------|---------|---------------|
| `test/scripts/prepare-chainspecs-for-zombie.sh` | 32, 34 | Direct CLI invocation for Zombienet |
| `test/scripts/compile-wasm.ts` | 83, 89 | TypeScript spawn command |
| `.github/workflows/build.yml` | 867, 869 | CI zombie upgrade tests |
| `scripts/generate-parachain-specs.sh` | 6, 18 | Parachain spec generation |

### CLI Structure Dependencies

| Component | File | Dependency |
|-----------|------|------------|
| `BuildSpecCommand` struct | `node/cli/src/cli.rs:99-112` | `sc_cli::BuildSpecCmd` |
| Command handler | `node/cli/src/command.rs:234-266` | `params.base.run()` |
| CLI dependency | `node/cli/Cargo.toml:21` | `sc-cli` workspace |

---

## Technical Analysis

### Backward Compatibility

**Status:** Fully backward compatible

- `build-spec` command continues to work with deprecation warnings
- No breaking changes in the current release
- Moonbeam's custom CLI wrapper will continue to function

### Migration Path

The upstream PR suggests:

1. **Short-term (Current):**
   - `build-spec` works with deprecation warnings
   - No immediate action required

2. **Medium-term (1-3 months):**
   - Community discussion on omni node channel to determine removal timeline
   - Migration window for downstream projects

3. **Long-term:**
   - `build-spec` removal in future release
   - `export-chain-spec` becomes the standard

### Custom Implementation Considerations

Moonbeam's `BuildSpecCommand` wrapper adds custom parameters (`--accounts`, `--mnemonic`) that enable development chain spec generation. These features are specific to Moonbeam and not part of upstream `sc-cli`.

**Key Question:** Does the new `export-chain-spec` command support similar extensibility?

From the PR description, the new command uses an `ExtraSubcommand` trait approach, which should allow Moonbeam to maintain similar custom functionality.

---

## Risk Assessment

### Risk Level: Low-Medium

| Risk Category | Level | Details |
|---------------|-------|---------|
| Runtime Breaking | None | Client-side only, no runtime impact |
| API Changes | Low | Soft deprecation, backward compatible |
| Custom Code Impact | Medium | Custom CLI wrapper needs evaluation |
| Migration Effort | Low-Medium | Multiple scripts need updating |
| Testing Impact | Low | Test scripts use deprecated command |

### Specific Risks

1. **Deprecation Timeline Uncertainty:**
   - No firm date for `build-spec` removal
   - Risk of sudden breakage in future upstream releases
   - Moonbeam should track community discussions

2. **Custom Parameter Support:**
   - Need to verify `export-chain-spec` supports custom parameters
   - May require adapting the `BuildSpecCommand` wrapper
   - Potential loss of `--accounts` and `--mnemonic` functionality

3. **CI/CD Warnings:**
   - Deprecation warnings will appear in logs
   - May be flagged as issues in automated tooling
   - Could mask other important warnings

4. **Documentation Drift:**
   - Moonbeam documentation may reference `build-spec`
   - External developer guides need updates
   - Community scripts may use deprecated command

---

## Required Actions

### Immediate (Stable2506 Upgrade)

- [ ] **No immediate breaking changes** - Current code will continue to work
- [ ] Expect deprecation warnings in logs when using `build-spec`
- [ ] Review upstream `export-chain-spec` implementation for feature parity

### Short-term (Next 1-2 Releases)

1. **Investigate Export-Chain-Spec:**
   - [ ] Test `export-chain-spec` command functionality
   - [ ] Verify support for custom parameters via `ExtraSubcommand` trait
   - [ ] Determine if `--accounts` and `--mnemonic` can be preserved

2. **Plan Migration Strategy:**
   - [ ] Create migration plan for all `build-spec` usages
   - [ ] Identify any edge cases or custom behavior dependencies
   - [ ] Consider implementing `ExtraSubcommand` for custom parameters

3. **Update Documentation:**
   - [ ] Mark `build-spec` usage as deprecated in internal docs
   - [ ] Document timeline for migration
   - [ ] Update developer guides to reference `export-chain-spec`

### Medium-term (Before Stable2506 Removal)

1. **Migrate All Usages:**
   - [ ] Update `test/scripts/prepare-chainspecs-for-zombie.sh`
   - [ ] Update `test/scripts/compile-wasm.ts`
   - [ ] Update `.github/workflows/build.yml`
   - [ ] Update `scripts/generate-parachain-specs.sh`

2. **Adapt Custom CLI:**
   - [ ] Refactor `BuildSpecCommand` to use `export-chain-spec`
   - [ ] Implement custom parameters via `ExtraSubcommand` trait if needed
   - [ ] Maintain backward compatibility during transition

3. **Testing:**
   - [ ] Verify all chain spec generation works with new command
   - [ ] Test Zombienet integration with new specs
   - [ ] Validate CI/CD pipelines after migration

---

## Migration Code Examples

### Current Usage Pattern

```bash
# Current (deprecated)
moonbeam build-spec --chain moonbase-local > moonbase.json
moonbeam build-spec --chain moonbase.json --raw > moonbase-raw.json
```

### Expected New Pattern

```bash
# New (recommended)
moonbeam export-chain-spec --chain moonbase-local > moonbase.json
moonbeam export-chain-spec --chain moonbase.json --raw > moonbase-raw.json
```

### Custom CLI Implementation

**Current Approach:**

```rust
pub struct BuildSpecCommand {
    #[clap(flatten)]
    pub base: sc_cli::BuildSpecCmd,
    // Custom parameters...
}
```

**Potential New Approach (requires investigation):**

```rust
// May need to implement ExtraSubcommand trait for custom parameters
pub struct ExportChainSpecCommand {
    #[clap(flatten)]
    pub base: sc_cli::ExportChainSpecCmd,
    // Custom parameters preserved
    pub accounts: Option<u32>,
    pub mnemonic: Option<String>,
}
```

---

## Recommendations

### Priority 1: Track Upstream

- Monitor polkadot-sdk discussions on deprecation timeline
- Subscribe to issues related to `build-spec` removal
- Track `sc-cli` changelog in future releases

### Priority 2: Proactive Migration

Rather than waiting for forced migration:

1. **Investigate Now:** Test `export-chain-spec` functionality in stable2506
2. **Plan Early:** Create migration strategy while `build-spec` still works
3. **Gradual Rollout:** Update scripts incrementally to minimize risk
4. **Maintain Compatibility:** Support both commands during transition period

### Priority 3: Custom Feature Preservation

- Ensure `--accounts` and `--mnemonic` functionality is preserved
- Document any behavior differences between commands
- Consider upstreaming useful custom features to `sc-cli`

---

## Testing Strategy

### Pre-Migration Testing

1. **Verify Current Behavior:**
   ```bash
   # Test existing build-spec still works (with warnings)
   ./target/release/moonbeam build-spec --chain moonbase-local
   ```

2. **Test Export-Chain-Spec:**
   ```bash
   # Verify new command produces identical output
   ./target/release/moonbeam export-chain-spec --chain moonbase-local
   ```

3. **Compare Outputs:**
   ```bash
   # Ensure spec files are byte-identical
   diff moonbase-build.json moonbase-export.json
   ```

### Post-Migration Testing

1. **Script Integration:** Run all test scripts with new command
2. **CI/CD Validation:** Verify workflow passes with updated commands
3. **Zombienet Tests:** Ensure zombie upgrade tests work with new specs
4. **Custom Parameter Testing:** Validate `--accounts` and `--mnemonic` if preserved

---

## Related Pallets/Components

### No Runtime Impact

This PR affects only client/CLI tooling:
- No changes to any runtime pallets
- No changes to XCM configuration
- No changes to EVM or Ethereum pallets
- No changes to consensus mechanisms

### Affected Client Components

| Component | Impact |
|-----------|--------|
| `sc-cli` | Updated with new command |
| `node/cli` | Uses deprecated `BuildSpecCmd` |
| Test scripts | Call deprecated `build-spec` |
| CI workflows | Use deprecated command |

---

## Additional Notes

### Community Context

From the PR discussion:
- Initial implementation excludes boot node functionality
- Deprecation timeline to be determined via community discussion
- Suggestion is 1-3 month migration window
- `ExtraSubcommand` trait enables extensibility for custom nodes

### Moonbeam-Specific Considerations

1. **Three Runtime Variants:**
   - Must test migration for moonbeam, moonriver, and moonbase
   - Each has separate chain spec generation

2. **Development Specs:**
   - Custom `--accounts` and `--mnemonic` parameters are critical for dev workflows
   - Zombienet testing depends on these features
   - Must preserve this functionality in migration

3. **Docker Images:**
   - Chain spec generation scripts run in CI
   - Docker images may cache old binary behavior
   - Ensure updated commands work in containerized environments

---

## Conclusion

PR #7719 introduces a forward-looking improvement to chain spec management while maintaining backward compatibility. For Moonbeam, this presents an opportunity to align with upstream best practices without immediate pressure.

**Recommended Approach:**
- Accept the stable2506 upgrade with current code (deprecation warnings are acceptable)
- Begin investigation of `export-chain-spec` functionality in parallel
- Plan migration for next release cycle (before upstream removes `build-spec`)
- Ensure custom CLI features are preserved or reimplemented

**Critical Success Factor:** Verify that the new `export-chain-spec` command supports Moonbeam's custom `--accounts` and `--mnemonic` parameters through the `ExtraSubcommand` trait mechanism. If not supported, consider either:
1. Implementing custom support via `ExtraSubcommand`
2. Maintaining a parallel custom command for development specs
3. Contributing the functionality upstream to `sc-cli`

---

## References

- **PR:** https://github.com/paritytech/polkadot-sdk/pull/7719
- **Related Issue:** #5567 (omni node export-chain-spec command)
- **Affected Files in Moonbeam:**
  - `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/cli.rs:99-112`
  - `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs:234-266`
  - `/Users/manuelmauro/Workspace/moonbeam/test/scripts/prepare-chainspecs-for-zombie.sh:32,34`
  - `/Users/manuelmauro/Workspace/moonbeam/test/scripts/compile-wasm.ts:83,89`
  - `/Users/manuelmauro/Workspace/moonbeam/.github/workflows/build.yml:867,869`
  - `/Users/manuelmauro/Workspace/moonbeam/scripts/generate-parachain-specs.sh:6,18`
