# PR #7730: Nest Errors in pallet-xcm

**PR**: https://github.com/paritytech/polkadot-sdk/pull/7730
**Labels**: T6-XCM
**Audience**: Runtime Dev
**Crate Bumps**: pallet-xcm (major), staging-xcm (minor), staging-xcm-builder (patch), staging-xcm-executor (patch)

## Summary

This PR enhances XCM error reporting by introducing `LocalExecutionIncompleteWithError`, which nests detailed `ExecutionError` information within the previously vague `LocalExecutionIncomplete` error. It also introduces the `InstructionError` type that includes both an instruction index and the underlying `XcmError`, providing precise context about where and why XCM execution failed.

## Key Changes

### 1. Error Type Restructuring
- **Renamed**: `LocalExecutionIncomplete` â†’ `LocalExecutionIncompleteWithError { index, error: XcmError }`
- **New Type**: `InstructionError { index: u32, error: XcmError }`
- **Purpose**: Provides specific error details (e.g., insufficient balance, asset transaction failures) instead of generic failure messages

### 2. ExecuteXcm Trait API Changes
The `prepare()` method signature changed:
```rust
// OLD
fn prepare(message: Xcm<C>) -> Result<Self::Prepared, Xcm<C>>

// NEW
fn prepare(_: Xcm<C>, _: Weight) -> Result<Self::Prepared, InstructionError>
```

### 3. Outcome Enum Updates
- `Outcome::Incomplete` now contains `InstructionError` instead of bare `XcmError`
- `Outcome::Error` similarly wraps `InstructionError`

## Impact on Moonbeam

### ðŸ”´ BREAKING - Custom XCM Executor Implementation

**File**: `/Users/manuelmauro/Workspace/moonbeam/pallets/erc20-xcm-bridge/src/xcm_holding_ext.rs`

Moonbeam has a custom `XcmExecutorWrapper` that implements the `ExecuteXcm` trait to inject ERC20 origin tracking functionality. This implementation **will break** due to:

1. **Method signature mismatch** (lines 109-113):
   ```rust
   fn prepare(
       message: xcm::latest::Xcm<Config::RuntimeCall>,
   ) -> Result<Self::Prepared, xcm::latest::Xcm<Config::RuntimeCall>> {
       InnerXcmExecutor::prepare(message)
   }
   ```

   **Required fix**: Update to accept `Weight` parameter and return `InstructionError`:
   ```rust
   fn prepare(
       message: xcm::latest::Xcm<Config::RuntimeCall>,
       weight_credit: Weight,
   ) -> Result<Self::Prepared, InstructionError> {
       InnerXcmExecutor::prepare(message, weight_credit)
   }
   ```

**Used by all three production runtimes**:
- moonbase: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/xcm_config.rs` (line 318)
- moonriver: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/xcm_config.rs` (line 296)
- moonbeam: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/xcm_config.rs` (line 288)

### ðŸ”´ BREAKING - Integration Tests

**Files with error assertions that need updating**:

1. `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/tests/integration_test.rs` (line 1644)
   ```rust
   pallet_xcm::Error::<Runtime>::LocalExecutionIncomplete
   ```

2. `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/tests/integration_test.rs` (line 1158)
   ```rust
   pallet_xcm::Error::<Runtime>::LocalExecutionIncomplete
   ```

3. `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/tests/integration_test.rs` (line 1164)
   ```rust
   pallet_xcm::Error::<Runtime>::LocalExecutionIncomplete
   ```

**Required fix**: Update error variant name and handle the nested error structure:
```rust
// OLD
pallet_xcm::Error::<Runtime>::LocalExecutionIncomplete

// NEW
pallet_xcm::Error::<Runtime>::LocalExecutionIncompleteWithError
```

### ðŸŸ¡ MODERATE - TypeScript API Bindings

**Auto-generated files requiring regeneration**:
- `/Users/manuelmauro/Workspace/moonbeam/typescript-api/src/moonbase/interfaces/augment-api-errors.ts` (line 909)
- `/Users/manuelmauro/Workspace/moonbeam/typescript-api/src/moonbase/interfaces/lookup.ts`
- `/Users/manuelmauro/Workspace/moonbeam/typescript-api/src/moonbase/interfaces/types-lookup.ts`
- Same files for moonriver and moonbeam runtimes

These files will be automatically regenerated when running:
```bash
pnpm substrate-types-from-chain
```

**Note**: TypeScript integration tests don't directly reference the error type by name, so no manual test updates needed.

### ðŸŸ¢ LOW - XCM Mock Test Infrastructure

Multiple mock test files reference `XcmExecutor` but use the standard implementation without custom overrides:
- `/Users/manuelmauro/Workspace/moonbeam/runtime/*/tests/xcm_mock/parachain.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/*/tests/xcm_mock/statemint_like.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/*/tests/xcm_mock/relay_chain.rs`
- Precompile mock files

These should automatically work with the upstream changes.

### ðŸŸ¢ LOW - Outcome Usage in Tests

The file `/Users/manuelmauro/Workspace/moonbeam/precompiles/xtokens/src/tests.rs` uses `Outcome::Complete` in event assertions but doesn't interact with error variants, so no changes needed.

## Action Items

### Required Changes

1. **Update XcmExecutorWrapper implementation**
   - [ ] Modify `prepare()` method signature in `/pallets/erc20-xcm-bridge/src/xcm_holding_ext.rs`
   - [ ] Add `Weight` parameter
   - [ ] Update return type to use `InstructionError`
   - [ ] Forward both parameters to `InnerXcmExecutor::prepare()`

2. **Update integration test assertions**
   - [ ] Replace `LocalExecutionIncomplete` with `LocalExecutionIncompleteWithError` in:
     - runtime/moonbase/tests/integration_test.rs
     - runtime/moonriver/tests/integration_test.rs
     - runtime/moonbeam/tests/integration_test.rs
   - [ ] Consider asserting on the nested error details for better test coverage

3. **Regenerate TypeScript bindings**
   - [ ] Run `pnpm substrate-types-from-chain` after runtime updates
   - [ ] Verify generated bindings include new error variant

### Testing Strategy

1. **Compilation checks**:
   ```bash
   cargo build --release -p pallet-erc20-xcm-bridge
   cargo build --release -p moonbase-runtime
   cargo build --release -p moonriver-runtime
   cargo build --release -p moonbeam-runtime
   ```

2. **Unit tests**:
   ```bash
   cargo test -p pallet-erc20-xcm-bridge
   ```

3. **Integration tests**:
   ```bash
   cargo test -p moonbase-runtime integration_test
   cargo test -p moonriver-runtime integration_test
   cargo test -p moonbeam-runtime integration_test
   ```

4. **XCM tests**:
   ```bash
   cargo test -p moonbase-runtime xcm_tests
   cd test && pnpm moonwall test dev_moonbase
   ```

## Benefits

This change will **improve Moonbeam's XCM debugging capabilities** by:
- Providing specific error causes instead of generic "incomplete" messages
- Including instruction indices to pinpoint exact failure locations in XCM programs
- Enabling better error handling in precompiles and runtime code
- Improving developer experience when troubleshooting XCM issues

## Risk Assessment

**Risk Level**: ðŸŸ¡ MODERATE

- **Breaking API changes**: Yes, but limited scope
- **Custom code affected**: Yes (XcmExecutorWrapper)
- **Test coverage**: Good - failures will be caught by integration tests
- **Mitigation**: Straightforward fix with clear upgrade path

## References

- PRDoc: `/Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_7730.prdoc`
- GitHub PR: https://github.com/paritytech/polkadot-sdk/pull/7730
- Merged: May 31, 2025
