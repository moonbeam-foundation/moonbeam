# PR #7730: Nest Errors in pallet-xcm

## Overview

**PR Title**: Nest Errors in pallet-xcm
**GitHub URL**: https://github.com/paritytech/polkadot-sdk/pull/7730
**Labels**: T6-XCM
**Severity**: HIGH - Breaking Changes Required
**Impact Category**: CRITICAL COMPILATION BREAKS + API CHANGES

## Summary

This PR introduces better error reporting in `pallet-xcm` by:
1. Adding `LocalExecutionIncompleteWithError(ExecutionError)` to provide detailed nested error information
2. Converting `XcmError::FailedToTransactAsset` from accepting string parameters to a unit variant
3. Enhancing debugging by logging detailed error strings separately while keeping errors within FRAME's 4-byte limit

The changes are marked as a **major version bump** for `pallet-xcm` and will cause **compilation failures** in Moonbeam's custom XCM integration code.

## Concrete Evidence of Impact

### 1. COMPILATION BREAKS (HIGH SEVERITY - REQUIRED FIXES)

#### Location 1: `/pallets/moonbeam-foreign-assets/src/evm.rs`

**Current Code** (Lines 64-95):
```rust
impl From<EvmError> for XcmError {
	fn from(error: EvmError) -> XcmError {
		match error {
			EvmError::BurnFromFail(err) => {
				log::debug!("BurnFromFail error: {:?}", err);
				XcmError::FailedToTransactAsset("Erc20 contract call burnFrom fail")  // ❌ BREAKS
			}
			EvmError::BalanceOfFail(err) => {
				log::debug!("BalanceOfFail error: {:?}", err);
				XcmError::FailedToTransactAsset("Erc20 contract call balanceOf fail")  // ❌ BREAKS
			}
			EvmError::ContractReturnInvalidValue => {
				XcmError::FailedToTransactAsset("Erc20 contract return invalid value")  // ❌ BREAKS
			}
			EvmError::DispatchError(err) => {
				log::debug!("dispatch error: {:?}", err);
				Self::FailedToTransactAsset("storage layer error")  // ❌ BREAKS
			}
			EvmError::EvmCallFail(err) => {
				log::debug!("EvmCallFail error: {:?}", err);
				XcmError::FailedToTransactAsset("Fail to call erc20 contract")  // ❌ BREAKS
			}
			EvmError::MintIntoFail(err) => {
				log::debug!("MintIntoFail error: {:?}", err);
				XcmError::FailedToTransactAsset("Erc20 contract call mintInto fail+")  // ❌ BREAKS
			}
			EvmError::TransferFail(err) => {
				log::debug!("TransferFail error: {:?}", err);
				XcmError::FailedToTransactAsset("Erc20 contract call transfer fail")  // ❌ BREAKS
			}
		}
	}
}
```

**Issue**: All 7 uses of `XcmError::FailedToTransactAsset` pass string parameters. After PR #7730, `FailedToTransactAsset` becomes a unit variant and will not accept parameters.

**Required Fix**:
- Change all instances to `XcmError::FailedToTransactAsset` (no parameter)
- Keep the `log::debug!` calls for debugging (already present in most cases)
- Consider using the new `ExecutionError` enum for more specific error variants if available

---

#### Location 2: `/pallets/erc20-xcm-bridge/src/errors.rs`

**Current Code** (Lines 33-50):
```rust
impl From<Erc20TransferError> for XcmError {
	fn from(error: Erc20TransferError) -> XcmError {
		match error {
			Erc20TransferError::ContractTransferFail => {
				XcmError::FailedToTransactAsset("Erc20 contract transfer fail")  // ❌ BREAKS
			}
			Erc20TransferError::ContractReturnInvalidValue => {
				XcmError::FailedToTransactAsset("Erc20 contract return invalid value")  // ❌ BREAKS
			}
			Erc20TransferError::DispatchError(err) => {
				log::debug!("dispatch error: {:?}", err);
				Self::FailedToTransactAsset("storage layer error")  // ❌ BREAKS
			}
			Erc20TransferError::EvmCallFail => {
				XcmError::FailedToTransactAsset("Fail to call erc20 contract")  // ❌ BREAKS
			}
		}
	}
}
```

**Issue**: All 4 uses of `FailedToTransactAsset` will break.

**Required Fix**: Same as Location 1 - remove string parameters and rely on logging.

---

#### Location 3: `/pallets/erc20-xcm-bridge/src/lib.rs`

**Current Code** (Lines 189-198, 248-250):
```rust
Err(DrainError::NotEnoughFounds) => Err(XcmError::FailedToTransactAsset(
	"not enough founds in xcm holding",  // ❌ BREAKS
)),
Err(DrainError::SplitError) => Err(XcmError::FailedToTransactAsset(
	"SplitError: each withdrawal of erc20 tokens must be deposited at once",  // ❌ BREAKS
)),

// ... and later ...

.ok_or(XcmError::FailedToTransactAsset(
	"missing erc20 executor context",  // ❌ BREAKS (appears twice)
))?
```

**Issue**: 4 uses of `FailedToTransactAsset` with string parameters will break.

**Required Fix**: Remove string parameters and add appropriate logging statements.

---

### 2. RUNTIME TEST UPDATES (REQUIRED - TEST FAILURES)

#### Affected Test Files:

**File 1**: `/runtime/moonriver/tests/integration_test.rs`
```rust
// Line 1158
assert_noop!(
	PolkadotXcm::transfer_assets(...),
	pallet_xcm::Error::<Runtime>::LocalExecutionIncomplete  // ❌ Needs update
);
```

**File 2**: `/runtime/moonbeam/tests/integration_test.rs`
```rust
// Line 1164
assert_noop!(
	PolkadotXcm::transfer_assets(...),
	pallet_xcm::Error::<Runtime>::LocalExecutionIncomplete  // ❌ Needs update
);
```

**File 3**: `/runtime/moonbase/tests/integration_test.rs`
```rust
// Line 1644
assert_noop!(
	PolkadotXcm::transfer_assets(...),
	pallet_xcm::Error::<Runtime>::LocalExecutionIncomplete  // ❌ Needs update
);
```

**Context**: These tests verify that XCM transfers fail with `LocalExecutionIncomplete` when the default XCM version is not set. After setting the version, the transfers succeed.

**Issue**: The error variant is being renamed from `LocalExecutionIncomplete` to `LocalExecutionIncompleteWithError(ExecutionError)`. The tests need to match against the new nested error structure.

**Required Fix**: Update test assertions to match the new error variant. The exact syntax depends on whether the tests need to check the inner `ExecutionError` or just verify the outer error type.

---

### 3. TYPESCRIPT API REGENERATION (REQUIRED - BREAKING API CHANGES)

#### Affected Files:

All three runtime TypeScript API definitions will change:

**Moonbase Runtime**:
- `/typescript-api/src/moonbase/interfaces/lookup.ts` (Line 5969)
- `/typescript-api/src/moonbase/interfaces/types-lookup.ts` (Line 7252)
- `/typescript-api/src/moonbase/interfaces/augment-api-errors.ts` (Line 909)

**Moonriver Runtime**:
- `/typescript-api/src/moonriver/interfaces/lookup.ts` (Line 6711)
- `/typescript-api/src/moonriver/interfaces/types-lookup.ts` (Line 7929)
- `/typescript-api/src/moonriver/interfaces/augment-api-errors.ts` (Line 1081)

**Moonbeam Runtime**:
- `/typescript-api/src/moonbeam/interfaces/lookup.ts` (Line 6711)
- `/typescript-api/src/moonbeam/interfaces/types-lookup.ts` (Line 7929)
- `/typescript-api/src/moonbeam/interfaces/augment-api-errors.ts` (Line 1081)

**Current API Structure**:
```typescript
interface PalletXcmError extends Enum {
  // ... other variants ...
  readonly isLocalExecutionIncomplete: boolean;
  readonly type:
    | "LocalExecutionIncomplete"
    | /* other variants */;
}
```

**Expected New Structure** (after PR #7730):
```typescript
interface PalletXcmError extends Enum {
  // ... other variants ...
  readonly isLocalExecutionIncompleteWithError: boolean;
  readonly asLocalExecutionIncompleteWithError: ExecutionError;
  readonly type:
    | "LocalExecutionIncompleteWithError"
    | /* other variants */;
}
```

**Issue**: TypeScript applications checking for `isLocalExecutionIncomplete` will break.

**Required Action**:
1. Regenerate TypeScript API bindings after upgrading to stable2506
2. Run: `pnpm build` in the project root to regenerate TypeScript APIs
3. Update any TypeScript tests or applications that check for this specific error

---

## Additional Observations

### XcmError Usage Across Codebase

The following files use `XcmError` but do NOT use `FailedToTransactAsset` with strings, so they should not break:

✅ `/pallets/xcm-weight-trader/src/lib.rs` - Uses unit variants only (`XcmError::AssetNotFound`, `XcmError::Overflow`, etc.)
✅ `/pallets/xcm-weight-trader/src/tests.rs` - Uses unit variants only
✅ `/pallets/xcm-transactor/src/lib.rs` - Only references `XcmError` in an event, doesn't construct it with strings
✅ Runtime XCM weight files - Only reference `XcmError` as a type parameter

---

## Required Action Items

### CRITICAL (Blocks Compilation):

1. **Fix `pallet-moonbeam-foreign-assets`**:
   - File: `/pallets/moonbeam-foreign-assets/src/evm.rs`
   - Action: Remove string parameters from 7 `FailedToTransactAsset` calls
   - Keep debug logging for observability

2. **Fix `pallet-erc20-xcm-bridge` (errors.rs)**:
   - File: `/pallets/erc20-xcm-bridge/src/errors.rs`
   - Action: Remove string parameters from 4 `FailedToTransactAsset` calls
   - Keep debug logging for observability

3. **Fix `pallet-erc20-xcm-bridge` (lib.rs)**:
   - File: `/pallets/erc20-xcm-bridge/src/lib.rs`
   - Action: Remove string parameters from 4 `FailedToTransactAsset` calls
   - Add debug logging where needed

### HIGH PRIORITY (Blocks Tests):

4. **Update integration tests**:
   - Files: All three runtime `tests/integration_test.rs` files
   - Action: Update error assertions from `LocalExecutionIncomplete` to match new nested structure
   - Test: Run `cargo test -p moonbase-runtime`, `cargo test -p moonriver-runtime`, `cargo test -p moonbeam-runtime`

### REQUIRED (Post-Upgrade):

5. **Regenerate TypeScript APIs**:
   - Command: `pnpm i && pnpm build` from project root
   - Verify: Check that TypeScript builds succeed
   - Update: Any downstream applications checking for `LocalExecutionIncomplete`

---

## Recommended Migration Strategy

1. **Before Upgrade**:
   - Document all current uses of `FailedToTransactAsset` with strings
   - Plan logging strategy for error details

2. **During Upgrade**:
   - Apply code fixes to all 3 pallets simultaneously
   - Update all integration tests
   - Ensure logging covers previously-returned error details

3. **After Upgrade**:
   - Regenerate TypeScript APIs
   - Run full test suite: `cargo test`
   - Run TypeScript integration tests: `pnpm moonwall test dev_moonbase`
   - Verify error logging provides sufficient debugging information

4. **Validation**:
   - Test XCM transfers end-to-end
   - Verify error messages appear in logs
   - Confirm client applications can handle new error structure

---

## Impact Summary

| Category | Impact Level | Files Affected | Required Action |
|----------|-------------|----------------|-----------------|
| Rust Compilation | **CRITICAL** | 3 pallets, 15 total usages | Remove string parameters from `FailedToTransactAsset` |
| Runtime Tests | **HIGH** | 3 integration test files | Update error assertions |
| TypeScript API | **HIGH** | All 3 runtime APIs | Regenerate bindings |
| Runtime Logic | **NONE** | N/A | No pallet-xcm configuration changes needed |
| Client/Node | **NONE** | N/A | No client-side changes needed |

---

## Notes

- This PR is part of broader XCM error handling improvements in the Polkadot ecosystem
- The changes enable better observability of XCM execution failures
- String error details are still available through logging, maintaining debuggability
- The nested error structure provides programmatic access to failure reasons
- FRAME's 4-byte error limit is respected through compact enum design

---

## Testing Recommendations

1. **Unit Tests**: Verify error conversions still work correctly
2. **Integration Tests**: Ensure XCM transfers fail appropriately with new error variants
3. **End-to-End Tests**: Test cross-chain transfers and verify error reporting
4. **Logging Tests**: Confirm detailed error information appears in node logs
5. **TypeScript Tests**: Verify client applications can decode new error structure
