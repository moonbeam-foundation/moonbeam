# PR #7867: Storage Benchmark Accuracy Improvements

## Overview
**Title**: benchmark/storage Make read/write benchmarks more accurate
**PR**: https://github.com/paritytech/polkadot-sdk/pull/7867
**Labels**: T12-benchmarks
**Audience**: Runtime Dev, Node Dev

## Summary
This PR improves the accuracy of storage read/write benchmarks by introducing batching to compute amortized costs and adding optional proof-of-validity (PoV) recorder support for parachain-realistic measurements.

### Key Changes
1. **Batching mechanism**: Storage root computation now occurs once per batch instead of per-operation, calculating amortized per-key costs
2. **PoV recorder support**: New `--enable-pov-recorder` flag enables proof-of-validity recording during benchmarks
3. **API changes**: Storage benchmark command signature updated to accept `shared_trie_cache` parameter
4. **New CLI flags**: `--batch-size` (default: 100,000) and `--enable-pov-recorder`

### Modified Crates
- `sc-client-db` (major bump) - Added `expose_shared_trie_cache()` method gated by `runtime-benchmarks` feature
- `frame-benchmarking-cli` (major bump) - Updated storage benchmark implementation
- `polkadot-cli` (major bump) - Updated benchmark command integration
- `polkadot-omni-node-lib` (major bump) - Updated benchmark command integration

## Impact Assessment

### Impact Level: **MUST**

### Rationale
Moonbeam **must** update its storage benchmark command handling code to maintain compilation compatibility.

### Evidence

#### 1. Direct Dependency
Moonbeam depends on `frame-benchmarking-cli`:
```toml
# node/cli/Cargo.toml:20
frame-benchmarking-cli = { workspace = true }
```

#### 2. Storage Benchmark Implementation
Moonbeam implements storage benchmark command handling in `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs` (lines 609-674):

```rust
#[cfg(feature = "runtime-benchmarks")]
BenchmarkCmd::Storage(cmd) => {
    let chain_spec = &runner.config().chain_spec;
    let rpc_config = cli.run.new_rpc_config();
    match chain_spec {
        #[cfg(feature = "moonriver-native")]
        spec if spec.is_moonriver() => {
            return runner.sync_run(|mut config| {
                let params = moonbeam_service::new_partial::<
                    moonbeam_service::moonriver_runtime::RuntimeApi,
                    moonbeam_service::MoonriverCustomizations,
                >(
                    &mut config,
                    &rpc_config,
                    false,
                    cli.run.legacy_block_import_strategy,
                )?;

                let db = params.backend.expose_db();
                let storage = params.backend.expose_storage();

                cmd.run(config, params.client, db, storage)  // OLD SIGNATURE (4 params)
            })
        }
        // Similar for moonbeam and moonbase runtimes...
    }
}
```

#### 3. Breaking API Change
The storage benchmark command's `run` method signature changed:

**Before:**
```rust
cmd.run(config, params.client, db, storage)
```

**After:**
```rust
cmd.run(config, params.client, db, storage, shared_trie_cache)
```

Where `shared_trie_cache` is obtained via:
```rust
let shared_trie_cache = params.backend.expose_shared_trie_cache();
```

#### 4. Active Usage
Moonbeam actively uses storage benchmarks to generate DB weights:
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/weights/db/rocksdb.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/weights/db/rocksdb.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/weights/db/rocksdb.rs`

These files contain auto-generated weights from storage benchmarks, as evidenced by the command header:
```rust
// Executed Command:
//   ./moonbeam
//   benchmark
//   storage
//   --db=rocksdb
//   --state-version=1
//   ...
```

## Required Changes

### 1. Update Storage Benchmark Command Handler
**File**: `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs`

For each runtime variant (moonriver, moonbeam, moonbase), update the storage benchmark invocation:

```rust
let db = params.backend.expose_db();
let storage = params.backend.expose_storage();
let shared_trie_cache = params.backend.expose_shared_trie_cache();  // ADD THIS

cmd.run(config, params.client, db, storage, shared_trie_cache)  // ADD 5th parameter
```

This change needs to be made in **three locations** (lines ~630, ~649, ~668) for each runtime variant.

### 2. Verify Backend Compatibility
Moonbeam uses `TFullBackend<Block>` from `sc-service`, which internally uses `sc-client-db`. The new `expose_shared_trie_cache()` method is available on this backend type when the `runtime-benchmarks` feature is enabled.

**File**: `/Users/manuelmauro/Workspace/moonbeam/node/service/Cargo.toml:59`
```toml
sc-client-db = { workspace = true }
```

The method is gated by the `runtime-benchmarks` feature, which Moonbeam already supports:
```toml
# node/cli/Cargo.toml
[features]
runtime-benchmarks = [
    "moonbeam-service/runtime-benchmarks",
    "polkadot-service/runtime-benchmarks",
]
```

### 3. Optional: Update Storage Benchmark Workflow
Consider updating any documentation or scripts that run storage benchmarks to leverage the new flags:
- `--enable-pov-recorder` for parachain-realistic measurements
- `--batch-size 100000` for amortized cost calculations

These parameters are **optional** but recommended for more accurate benchmarks.

## Testing Recommendations

1. **Compilation test**: Verify that the code compiles with `runtime-benchmarks` feature:
   ```bash
   cargo build --release --features runtime-benchmarks
   ```

2. **Storage benchmark test**: Run a storage benchmark to ensure the new signature works:
   ```bash
   ./target/release/moonbeam benchmark storage --db=rocksdb --chain=moonbase-dev
   ```

3. **Optional accuracy improvement**: Test with new flags for comparison:
   ```bash
   ./target/release/moonbeam benchmark storage \
     --db=rocksdb \
     --chain=moonbase-dev \
     --enable-pov-recorder \
     --batch-size 100000
   ```

## Migration Path

1. **Immediate**: Update `command.rs` to fix compilation errors
2. **Optional**: Regenerate storage weights using new accuracy parameters
3. **Documentation**: Update any internal documentation about running storage benchmarks

## Notes

- The PR improves benchmark accuracy by computing amortized costs across batched operations
- Previous benchmark results may be less accurate due to including per-operation overhead for shared operations
- New benchmarks with `--enable-pov-recorder` and `--batch-size` will better reflect production parachain performance
- The `expose_shared_trie_cache()` method is only available when compiled with `runtime-benchmarks` feature

## References

- PRDoc: `/Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_7867.prdoc`
- GitHub PR: https://github.com/paritytech/polkadot-sdk/pull/7867
- Moonbeam Storage Weights: `runtime/*/src/weights/db/rocksdb.rs`
- Command Handler: `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs:609-674`
