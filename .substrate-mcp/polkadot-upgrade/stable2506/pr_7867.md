# PR #7867 Impact Analysis: Storage Benchmark Accuracy Improvements

**PR Title:** benchmark/storage Make read/write benchmarks more accurate
**GitHub:** https://github.com/paritytech/polkadot-sdk/pull/7867
**Labels:** T12-benchmarks
**Audience:** Runtime Dev, Node Dev

## Executive Summary

**Impact Level:** **HIGH** - Breaking API changes required

PR #7867 introduces significant improvements to storage benchmarking accuracy but **requires mandatory code changes** in Moonbeam's storage benchmark command handling. The PR affects both `frame-benchmarking-cli` (major bump) and `sc-client-db` (major bump), both of which are directly used by Moonbeam.

## Changes Overview

### What Changed

1. **POV Recorder Integration**: Benchmarks now optionally run with POV (Proof-of-Validity) recorder enabled via `--enable-pov-recorder` flag to accurately reflect parachain execution conditions
2. **Batch Operations**: New `--batch-size` parameter (default: 100,000) amortizes storage root computation costs across multiple key operations
3. **Improved Read Accuracy**: Batched reads now reuse the same POV recorder instance instead of creating new ones per operation
4. **Child Key Warmup Fix**: Fixed child key warmup that previously failed even when `--include-child-trees` was enabled

### Why It Matters for Parachains

Without the POV recorder, benchmarks can directly access keys from the value cache. With the recorder (as in production parachains), operations must walk through the trie using the node cache. This distinction is **critical** for accurate weight calculations on parachains like Moonbeam.

## Affected Crates in Moonbeam

### Direct Dependencies

1. **frame-benchmarking-cli** (major bump)
   - **Location:** `/Users/manuelmauro/Workspace/moonbeam/node/cli/Cargo.toml` (line 20)
   - **Usage:** Storage benchmarking command implementation
   - **Breaking Change:** YES

2. **sc-client-db** (major bump)
   - **Location:** `/Users/manuelmauro/Workspace/moonbeam/node/service/Cargo.toml` (line 59)
   - **Usage:** Database backend for client operations
   - **Breaking Change:** YES (new API method)

## Breaking API Changes

### 1. StorageCmd::run() Method Signature

**Current Implementation in Moonbeam:**
```rust
// File: /Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs
// Lines 627-630, 646-649, and equivalent for moonbase

let db = params.backend.expose_db();
let storage = params.backend.expose_storage();

cmd.run(config, params.client, db, storage)  // ❌ OLD SIGNATURE
```

**Required New Signature:**
```rust
let db = params.backend.expose_db();
let storage = params.backend.expose_storage();
let shared_trie_cache = params.backend.expose_shared_trie_cache();

cmd.run(config, params.client, db, storage, shared_trie_cache)  // ✅ NEW SIGNATURE
```

### 2. New sc-client-db API Method

**Added to Backend<Block>:**
```rust
#[cfg(feature = "runtime-benchmarks")]
pub fn expose_shared_trie_cache(&self)
    -> Option<sp_trie::cache::SharedTrieCache<HashingFor<Block>>>
```

This method is only available when the `runtime-benchmarks` feature is enabled.

### 3. New CLI Parameters

**StorageParams additions:**
- `--enable-pov-recorder` (or `--disable-pov-recorder`): Boolean flag to enable/disable POV recorder
- `--batch-size <SIZE>`: Number of keys to process before computing storage root (default: 100,000)

## Required Code Changes

### File: `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs`

**Locations to Update:**
1. Lines 627-630 (Moonriver runtime)
2. Lines 646-649 (Moonbeam runtime)
3. Lines 665-668 (Moonbase runtime)

**Change Pattern for Each Runtime:**
```rust
// Add this line after expose_storage()
let shared_trie_cache = params.backend.expose_shared_trie_cache();

// Update the cmd.run() call
cmd.run(config, params.client, db, storage, shared_trie_cache)?
```

### Example for Moonbeam Runtime Section

**BEFORE:**
```rust
#[cfg(feature = "moonbeam-native")]
spec if spec.is_moonbeam() => {
    return runner.sync_run(|mut config| {
        let params = moonbeam_service::new_partial::<
            moonbeam_service::moonbeam_runtime::RuntimeApi,
            moonbeam_service::MoonbeamCustomizations,
        >(
            &mut config,
            &rpc_config,
            false,
            cli.run.legacy_block_import_strategy,
        )?;

        let db = params.backend.expose_db();
        let storage = params.backend.expose_storage();

        cmd.run(config, params.client, db, storage)
    })
}
```

**AFTER:**
```rust
#[cfg(feature = "moonbeam-native")]
spec if spec.is_moonbeam() => {
    return runner.sync_run(|mut config| {
        let params = moonbeam_service::new_partial::<
            moonbeam_service::moonbeam_runtime::RuntimeApi,
            moonbeam_service::MoonbeamCustomizations,
        >(
            &mut config,
            &rpc_config,
            false,
            cli.run.legacy_block_import_strategy,
        )?;

        let db = params.backend.expose_db();
        let storage = params.backend.expose_storage();
        let shared_trie_cache = params.backend.expose_shared_trie_cache();

        cmd.run(config, params.client, db, storage, shared_trie_cache)
    })
}
```

Apply this same pattern to all three runtime variants (Moonbeam, Moonriver, Moonbase).

## Impact on Moonbeam Operations

### Current Storage Benchmark Usage

Moonbeam actively uses storage benchmarking:
- **Last Run:** September 22, 2025 (see `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/weights/db/rocksdb.rs`)
- **Latest Update:** Commit d105244dda (September 26, 2025) - "Update storage benchmarks (#3459)"

**Current Command (from weight files):**
```bash
./moonbeam benchmark storage \
  --db=rocksdb \
  --state-version=1 \
  --mul=1.1 \
  --weight-path ./benchmarks/storage/20250922-082315/disk-weights-rocksdb-moonbeam.rs \
  --chain moonbeam \
  --base-path /mnt/disk3-6000-256/rocksdb-moonbeam-data \
  --keys-limit 50000000 \
  --random-seed 1024
```

### Recommended New Command

After upgrading, consider using the new accuracy features:

```bash
./moonbeam benchmark storage \
  --db=rocksdb \
  --state-version=1 \
  --mul=1.1 \
  --enable-pov-recorder \
  --batch-size 100000 \
  --weight-path ./benchmarks/storage/YYYYMMDD-HHMMSS/disk-weights-rocksdb-moonbeam.rs \
  --chain moonbeam \
  --base-path /mnt/disk3-6000-256/rocksdb-moonbeam-data \
  --keys-limit 50000000 \
  --random-seed 1024
```

**Why use `--enable-pov-recorder`?**
Moonbeam is a parachain. The POV recorder flag replicates the exact execution environment used in production, where direct value cache access isn't available. This produces more accurate weights that better reflect real-world costs.

**Batch Size Considerations:**
The default 100,000 keys per batch amortizes the cost of storage root computation, which only happens once per block in production. Larger batch sizes may produce more accurate per-key costs for write operations.

## Runtime Impact

### Expected Weight Changes

After re-running storage benchmarks with `--enable-pov-recorder`, expect changes to:

**File:** All three runtimes' `src/weights/db/rocksdb.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/weights/db/rocksdb.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/weights/db/rocksdb.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/weights/db/rocksdb.rs`

**Current Weights (from Sept 2025):**
```rust
pub const RocksDbWeight: RuntimeDbWeight = RuntimeDbWeight {
    read: 59_217 * constants::WEIGHT_REF_TIME_PER_NANOS,
    write: 96_315 * constants::WEIGHT_REF_TIME_PER_NANOS,
};
```

The new weights may be **higher** since POV recorder operations require trie walks, more accurately reflecting real parachain execution costs.

### Test Updates Required

Based on the September 2025 storage benchmark update (commit d105244dda), expect to update:

**Rust Tests:**
- `runtime/moonbase/tests/integration_test.rs`
- `runtime/moonbeam/tests/integration_test.rs`
- `runtime/moonriver/tests/integration_test.rs`

**TypeScript Tests (23 files updated in Sept):**
- `test/helpers/constants.ts` - Update `STORAGE_READ_COST`
- Weight limit tests in various test suites
- XCM weight target tests
- POV-related tests in `test-pov/` directory
- Staking reward auto-compound POV tests
- Fee multiplier tests

## Compilation Status

### Build Test Results

✅ **Compilation succeeds** with the current `moonbeam-polkadot-stable2503` branch
⚠️ **Will fail** after upgrading to stable2506 without code changes

The breaking changes in this PR mean that Moonbeam's code will not compile against stable2506 until the `cmd.run()` calls are updated to include the `shared_trie_cache` parameter.

## Migration Checklist

- [ ] **Update command.rs**: Add `shared_trie_cache` parameter to all three `cmd.run()` calls
- [ ] **Verify compilation**: Build with `--features runtime-benchmarks`
- [ ] **Re-run storage benchmarks**: Use new `--enable-pov-recorder` flag
- [ ] **Update weight files**: All three runtimes' `src/weights/db/rocksdb.rs`
- [ ] **Update Rust tests**: Integration tests with new weight values
- [ ] **Update TypeScript tests**: All snapshots and weight-dependent test assertions
- [ ] **Test benchmark command**: Verify `moonbeam benchmark storage` works with new parameters
- [ ] **Document changes**: Update any internal documentation about benchmarking procedures

## Recommendations

### Priority: HIGH

1. **Immediate Action Required**: This PR introduces breaking changes that will cause compilation failures. Update must be coordinated with the stable2506 upgrade.

2. **Enable POV Recorder**: For a parachain like Moonbeam, always use `--enable-pov-recorder` when running storage benchmarks. This ensures weights accurately reflect production conditions.

3. **Benchmark Timing**: Plan to re-run storage benchmarks shortly after upgrading to stable2506, as the improved accuracy may result in different weight values.

4. **Test Coverage**: The September 2025 benchmark update touched 23 test files. Expect similar scope for post-upgrade test updates.

5. **Document Process**: Update internal benchmarking procedures to include the new flags in standard commands.

## Related PRs

- **PR #8069**: "Benchmark storage access on block validation" - Additional storage benchmarking improvements
- **PR #7682**: Contains related trie caching improvements that benefit benchmarking operations

## Conclusion

PR #7867 significantly improves storage benchmark accuracy for parachains but requires **mandatory code changes** before Moonbeam can upgrade to stable2506. The changes are straightforward (adding one line and one parameter), but the impact is substantial: more accurate weights that better reflect real-world parachain execution costs.

**Action Required:** Update storage benchmark command handling in `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs` before upgrading to stable2506.
