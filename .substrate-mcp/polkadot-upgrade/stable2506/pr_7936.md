# PR #7936: Replace Validator FullIdentification from `Exposure` to `Existence`

## Summary

This PR introduces a new type in `pallet-staking` called `ExistenceOf` which replaces `ExposureOf` for validator identification in historical sessions. This change allows runtimes to identify validators by their presence alone rather than using full exposure data, which is particularly useful for configuring `pallet_session::historical`.

**Impact on Moonbeam: NONE**

## PR Details

- **GitHub PR**: https://github.com/paritytech/polkadot-sdk/pull/7936
- **Labels**: I4-refactor, T2-pallets
- **Audience**: Runtime Dev
- **Affected Crates**:
  - `pallet-staking` (major bump)
  - `pallet-babe` (patch)
  - `pallet-beefy` (patch)
  - `pallet-grandpa` (patch)
  - `pallet-offences-benchmarking` (patch)
  - `pallet-root-offences` (patch)
  - `pallet-session-benchmarking` (patch)
  - `westend-runtime` (minor)

## Changes Introduced

### New Types in pallet-staking

1. **`Existence`**: A new lightweight type representing validator presence
2. **`ExistenceOf`**: Type alias that replaces `ExposureOf` for validator identification
3. **`ExistenceOrLegacyExposureOf`**: A compatibility type that supports both legacy `Exposure` and new `Existence` types through custom encoder/decoder

### Configuration Pattern

**New recommended pattern**:
```rust
impl pallet_session::historical::Config for Runtime {
    type FullIdentification = pallet_staking::Existence;
    type FullIdentificationOf = pallet_staking::ExistenceOf<Runtime>;
}
```

**Backward compatibility pattern** (for runtimes with stored Exposure data in pallet-offences):
```rust
impl pallet_session::historical::Config for Runtime {
    type FullIdentification = pallet_staking::ExistenceOrLegacy;
    type FullIdentificationOf = pallet_staking::ExistenceOrLegacyExposureOf<Runtime>;
}
```

## Impact Analysis on Moonbeam

### 1. Runtime Configuration Check

**Finding**: Moonbeam does NOT use any of the affected pallets in their runtime.

**Evidence**:
- Examined `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs`
- Verified `construct_runtime!` macro at lines 1414-1484
- **Pallets NOT present in Moonbeam runtime**:
  - `pallet_staking`
  - `pallet_session`
  - `pallet_session::historical`
  - `pallet_offences`
  - `pallet_babe`
  - `pallet_beefy`
  - `pallet_grandpa`

**Moonbeam uses instead**:
- `pallet_parachain_staking` (custom staking implementation for collators)
- Cumulus/parachain consensus pallets
- No historical session tracking requiring validator exposure data

### 2. Type Usage Check

**Finding**: Moonbeam only uses pallet-staking types for encoding relay chain calls, and these types are NOT affected by this PR.

**Evidence**:
Searched for affected types across the codebase:
```bash
# No usage of affected types
- Exposure/ExposureOf: Only false positives (ExistenceRequirement from frame_support)
- Existence/ExistenceOf: Not used
- FullIdentification: Only in TypeScript API files (generated types)
```

**Actual pallet-staking usage**:
Location: `/Users/manuelmauro/Workspace/moonbeam/runtime/relay-encoder/`

Files affected:
- `src/westend.rs` (lines 46, 55, 61)
- `src/kusama.rs` (lines 45, 54, 60)
- `src/polkadot.rs` (lines 46, 55, 61)

Types used:
```rust
// In StakeCall enum definitions
Bond(..., pallet_staking::RewardDestination<AccountId32>)
Validate(pallet_staking::ValidatorPrefs)
SetPayee(pallet_staking::RewardDestination<AccountId32>)
```

**These types are NOT modified by PR #7936**. The PR only changes:
- `Exposure` → `Existence`
- `ExposureOf` → `ExistenceOf`
- Configuration of `FullIdentification` in `pallet_session::historical`

### 3. Relay Encoder Context

**Purpose**: The relay-encoder module is used to encode calls that will be sent to relay chains (Polkadot, Kusama, Westend) via XCM. These are calls that Moonbeam users want to execute on the relay chain (e.g., staking operations).

**Dependency**:
- Found in `/Users/manuelmauro/Workspace/moonbeam/runtime/relay-encoder/Cargo.toml`
- `pallet-staking = { workspace = true }` (line 17)
- Used only for type definitions of relay chain calls

**Impact**: NONE - The relay-encoder only uses public call types (`RewardDestination`, `ValidatorPrefs`) which remain unchanged.

### 4. Test Files Check

**Test files using pallet-staking**:
- `/Users/manuelmauro/Workspace/moonbeam/runtime/relay-encoder/src/westend.rs` (tests)
  - Uses `westend_runtime::Runtime` and `pallet_staking::Call` for encoding verification
  - All tests check encoding of staking calls (bond, unbond, validate, nominate, etc.)
  - Tests compare Moonbeam's encoder output against actual Westend runtime call encoding

**Impact**: Tests should continue to work as they only verify call encoding, not internal validator identification types.

### 5. Compilation Verification

**Status**: The relay-encoder module uses only stable public API types from pallet-staking that are not affected by this refactor.

**No changes required**:
- `RewardDestination<AccountId32>` - Public enum unchanged
- `ValidatorPrefs` - Public struct unchanged
- Call encoding patterns - Unchanged

## Migration Requirements

**For Moonbeam: NONE**

This PR does not require any changes to Moonbeam because:

1. ✅ Moonbeam does not use `pallet_staking` in their runtime
2. ✅ Moonbeam does not use `pallet_session::historical`
3. ✅ Moonbeam does not configure `FullIdentification` types
4. ✅ Moonbeam's relay-encoder only uses public call types that remain unchanged
5. ✅ No storage migrations needed (Moonbeam doesn't store affected types)

## Recommendations

### Immediate Actions
- **NONE REQUIRED** - This PR has no impact on Moonbeam

### Future Considerations
- If Moonbeam ever decides to add `pallet_session::historical` for any reason, they should use the new `ExistenceOf` type pattern
- Continue monitoring relay chain runtime changes to ensure relay-encoder remains compatible with actual relay chain call encoding

## Risk Assessment

**Risk Level: NONE**

**Justification**:
- Moonbeam is an Ethereum-compatible parachain that uses its own staking mechanism (`pallet_parachain_staking`)
- No direct usage of affected pallets or types
- Only indirect dependency through relay-encoder for XCM call encoding
- Types used in relay-encoder are stable public APIs unaffected by this refactor

## Testing Recommendations

### Verification Steps
1. ✅ **Compilation**: Ensure relay-encoder compiles successfully
2. ✅ **Unit Tests**: Run relay-encoder tests to verify encoding still works
   ```bash
   cargo test -p moonbeam-relay-encoder
   ```
3. ⚠️ **Integration Tests** (Optional): If relay chain encodings are tested in integration tests, verify they still pass

### Expected Results
All existing tests should pass without modifications since:
- Relay chain call structure remains unchanged
- Public types used by Moonbeam are unaffected
- Only internal validator identification mechanism changed

## Conclusion

**PR #7936 has NO IMPACT on Moonbeam.**

This is a pallet-staking internal refactor that:
- Changes how validators are identified in historical sessions
- Introduces lighter-weight types for validator existence tracking
- Primarily affects validator-based Substrate chains using full staking systems

Moonbeam is unaffected because:
- Uses custom collator staking (`pallet_parachain_staking`)
- Doesn't track historical validator sessions
- Only uses pallet-staking types for encoding XCM calls to relay chains
- Those specific types remain unchanged

**No action required.**
