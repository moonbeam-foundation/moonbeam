# PR #7944: Allow to set a worst case buy execution fee asset and weight

## Overview

**PR**: [#7944](https://github.com/paritytech/polkadot-sdk/pull/7944)
**Title**: Allow to set a worst case buy execution fee asset and weight
**Labels**: T6-XCM
**Merged**: April 23, 2025 (commit `c800a0d`)
**Breaking**: Yes (major version bump for `pallet-xcm-benchmarks`)

## Summary

This PR addresses a benchmarking gap in XCM's `BuyExecution` instruction by enhancing configurability in `pallet-xcm-benchmarks`. Previously, benchmarks assumed a best-case scenario where the `WeightLimit::Unlimited` meant the Trader logic wasn't exercised at all. This PR allows runtime developers to configure worst-case scenarios for more accurate benchmarking, particularly for chains with complex trader hierarchies.

## Changes

### Breaking Change: Function Signature Update

The `pallet_xcm_benchmarks::generic::Config` trait was modified:

**Old signature (pre-PR):**
```rust
fn fee_asset() -> Result<Asset, BenchmarkError>
```

**New signature (post-PR):**
```rust
fn worst_case_for_trader() -> Result<(Asset, WeightLimit), BenchmarkError>
```

**Key modifications:**
- Function renamed from `fee_asset` to `worst_case_for_trader`
- Return type expanded from single `Asset` to tuple `(Asset, WeightLimit)`
- Allows specifying both the worst-case execution asset and its associated weight limit

### Implementation Pattern

Typical implementation in polkadot-sdk runtimes:
```rust
fn worst_case_for_trader() -> Result<(Asset, WeightLimit), BenchmarkError> {
    Ok((
        Asset {
            id: AssetId(Location::parent()),
            fun: Fungible(1_000_000_000_000_000)
        },
        WeightLimit::Limited(Weight::from_parts(5000, 5000)),
    ))
}
```

## Impact on Moonbeam

### Current Status: INHERITED

**The breaking change was already handled in a previous upgrade (stable2412).**

### Evidence

1. **Function already exists**: Moonbeam's codebase already has `worst_case_for_trader()` with the correct signature:
   ```rust
   // File: /Users/manuelmauro/Workspace/moonbeam/runtime/common/src/apis.rs:1049
   fn worst_case_for_trader() -> Result<(Asset, WeightLimit), BenchmarkError> {
       Err(BenchmarkError::Skip)
   }
   ```

2. **Historical context**:
   - The signature change was introduced in commit `b943e2ee09` (June 23, 2025) during the stable2412 upgrade
   - This commit removed the custom `moonbeam-xcm-benchmarks` pallet in favor of using `pallet-xcm-benchmarks` directly
   - At that time, the function was renamed from `fee_asset()` to `worst_case_for_trader()` with the new signature

3. **Current implementation**: Moonbeam returns `Err(BenchmarkError::Skip)`, which is a valid implementation that skips this particular benchmark

### Locations in Codebase

- **Primary implementation**: `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/apis.rs` (line 1049)
  - Used by all three runtimes (moonbase, moonbeam, moonriver) via the `impl_runtime_apis_plus_common!` macro
- **Dependency**: `pallet-xcm-benchmarks` is included as optional dependency in all runtime Cargo.toml files
- **Feature flag**: Enabled via `runtime-benchmarks` feature

## Recommendation

### No Action Required for Compilation

The signature is already correct and will compile without changes when upgrading to stable2506.

### Optional Enhancement

Consider implementing the actual worst-case logic instead of skipping the benchmark. This would provide more accurate weight measurements for XCM operations involving asset trading on Moonbeam.

**Reference implementation** (from commit `6838bb84e9` - not yet merged to master):
```rust
fn worst_case_for_trader() -> Result<(Asset, WeightLimit), BenchmarkError> {
    let location: Location = GeneralIndex(99).into();
    Ok((
        Asset {
            id: AssetId(Location::parent()),
            fun: Fungible(1_000_000_000_000_000 as u128)
        },
        WeightLimit::Limited(Weight::from_parts(5000, 5000)),
    ))
}
```

**Benefits of implementing:**
- More accurate benchmarking for `BuyExecution` instruction
- Better weight estimates for XCM operations involving fee payment
- Particularly relevant given Moonbeam's custom `pallet-xcm-weight-trader` implementation

**Trade-offs:**
- Currently skipping the benchmark has no negative impact on functionality
- Implementation would need to account for Moonbeam's specific trader configuration
- Should align with the assets and weights actually used in production

## Related Components

- **pallet-xcm-weight-trader**: Moonbeam's custom trader implementation for XCM fee handling
- **XCM benchmarks**: Weight files at `runtime/{moonbase,moonbeam,moonriver}/src/weights/xcm/`
- **XCM configuration**: Runtime XCM executor configs that use the trader

## Testing Considerations

If implementing the actual logic (not skipping):
1. Ensure the specified asset and weight limit reflect realistic worst-case scenarios
2. Run XCM benchmarks to verify the weights are accurate
3. Test with various asset types that Moonbeam accepts for fee payment
4. Verify compatibility with the custom `pallet-xcm-weight-trader` logic

## Conclusion

**Impact Classification**: **INHERITED**

This PR's breaking changes were already incorporated into Moonbeam during the stable2412 upgrade. The current implementation is valid and will work correctly with stable2506.

**Optional follow-up**: Consider implementing the actual worst-case logic (instead of skipping) to improve benchmark accuracy, using commit `6838bb84e9` as a reference.
