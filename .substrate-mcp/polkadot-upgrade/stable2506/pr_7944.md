# PR #7944 Impact Analysis: Allow to set a worst case buy execution fee asset and weight

## PR Overview

**Title:** Allow to set a worst case buy execution fee asset and weight
**GitHub PR:** https://github.com/paritytech/polkadot-sdk/pull/7944
**Labels:** T6-XCM
**Crates Affected:** pallet-xcm-benchmarks (major bump)
**Audience:** Runtime Dev

## Summary

This PR introduces a breaking change to `pallet-xcm-benchmarks` by modifying the benchmarking configuration trait for the `BuyExecution` XCM instruction. Previously, the benchmark assumed a best-case scenario where the Trader logic was not even executed. This PR allows developers to configure a worst-case scenario for more accurate benchmarking.

### Breaking Change

The benchmarking helper trait method was changed from:
```rust
fn fee_asset() -> Result<Asset, BenchmarkError>
```

To:
```rust
fn worst_case_for_trader() -> Result<(Asset, WeightLimit), BenchmarkError>
```

The new method returns both the fee asset AND a weight limit, allowing benchmarks to test scenarios where the Trader actually executes (using `WeightLimit::Limited` instead of `WeightLimit::Unlimited`).

## Impact on Moonbeam

### Current Status: ALREADY ADAPTED ✓

Moonbeam has **already implemented** the required changes from PR #7944.

### Implementation Details

**Location:** `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/apis.rs` (lines 1049-1051)

**Current Implementation:**
```rust
impl pallet_xcm_benchmarks::generic::Config for Runtime {
    // ... other methods ...

    fn worst_case_for_trader() -> Result<(Asset, WeightLimit), BenchmarkError> {
        Err(BenchmarkError::Skip)
    }
}
```

### Adaptation History

1. **PR #3318** (Commit: `b943e2ee099b7074c35f793ff12374bf7a24eb6d`, June 23, 2025)
   - Title: "Remove `moonbeam-xcm-benchmarks` and only use `pallet-xcm-benchmarks`"
   - Changed method signature from `fee_asset()` to `worst_case_for_trader()`
   - Removed custom `moonbeam-xcm-benchmarks` pallet
   - Switched to using upstream `pallet-xcm-benchmarks` directly
   - Added `WeightLimit` to imports
   - Status: **Merged to master**

2. **WIP Branch** (`tarekkma/xcm-fungible-benchmarks`)
   - Commit: `6838bb84e9d42de23578d55d438dd345605bec27` (June 27, 2025)
   - Implements actual worst-case scenario instead of returning `Skip`:
     ```rust
     Ok((
         Asset {
             id: AssetId(Location::parent()),
             fun: Fungible(1_000_000_000_000_000 as u128)
         },
         WeightLimit::Limited(Weight::from_parts(5000, 5000)),
     ))
     ```
   - Status: **Not yet merged** (in feature branch only)

### Affected Components

1. **All Three Runtimes:** moonbase, moonbeam, moonriver
   - All use the shared implementation in `runtime/common/src/apis.rs`
   - The benchmarking configuration applies to all runtime variants

2. **Benchmarking Only:**
   - This change only affects runtime benchmarking when the `runtime-benchmarks` feature is enabled
   - No impact on production runtime behavior
   - No impact on live XCM message execution

### Dependencies

The change was part of a larger refactoring where Moonbeam:
- Removed their custom `pallets/moonbeam-xcm-benchmarks` directory (entire pallet deleted)
- Migrated to using upstream `pallet-xcm-benchmarks` exclusively
- Reorganized XCM weight files into `runtime/{moonbase,moonbeam,moonriver}/src/weights/xcm/`

### Current Polkadot SDK Version

**Master Branch:** `moonbeam-polkadot-stable2503`
**Target Upgrade:** `moonbeam-polkadot-stable2506`

The changes from PR #7944 were proactively implemented in Moonbeam even before they upgraded to stable2506, as part of their alignment with upstream benchmarking patterns.

## Required Actions

### For stable2506 Upgrade: NONE ✓

No action is required for this PR as Moonbeam has already implemented the necessary changes. The method signature is correct and matches what will be in stable2506.

### Optional Enhancement

The Moonbeam team may consider merging the implementation from branch `tarekkma/xcm-fungible-benchmarks` which provides an actual worst-case scenario instead of skipping the benchmark. This would provide more accurate benchmark weights for the `BuyExecution` instruction, but it's not required for the upgrade.

**Benefit of implementing worst-case:**
- More accurate benchmark weights when buying execution in XCM messages
- Better representation of actual Trader execution costs
- Aligns with the intent of PR #7944

**Current approach (returning Skip):**
- Valid and acceptable approach
- The benchmark will use default/minimal values
- Simpler maintenance

## Technical Details

### Why This Change Matters

The `BuyExecution` instruction in XCM is used to pay for execution weight on the destination chain. The benchmarking helper needs to test the worst-case scenario where:
1. The fee asset needs to be looked up and validated
2. The Trader logic must execute to convert the asset to execution weight
3. The weight limit is checked and enforced

Previously, using `WeightLimit::Unlimited` meant the Trader logic was not executed during benchmarking, resulting in artificially low benchmark weights that didn't reflect real-world costs.

### Integration Points

The `worst_case_for_trader()` method is called by:
- `pallet-xcm-benchmarks` generic benchmarks
- Specifically the `BuyExecution` instruction benchmark
- Only during benchmark execution (gated by `#[cfg(feature = "runtime-benchmarks")]`)

## Testing Recommendations

### Verification (Already Passing)

The change has been tested as part of:
- PR #3318 integration tests
- Runtime benchmarking suite (when enabled)
- All three runtime variants build successfully

### For Future Development

If implementing the actual worst-case scenario (from WIP branch):
1. Run benchmarks to generate new weights:
   ```bash
   ./scripts/run-benches-for-runtime.sh moonbase release
   ```
2. Verify benchmark completes without errors
3. Review generated weights for `BuyExecution` instruction
4. Test on all three runtime variants

## Summary Assessment

**Impact Level:** ✓ ALREADY RESOLVED
**Risk Level:** NONE
**Action Required:** NONE
**Breaking Change:** Previously adapted in PR #3318

Moonbeam proactively adapted to this breaking change from upstream polkadot-sdk before upgrading to stable2506. The implementation is correct and will work seamlessly with the stable2506 upgrade. The team may optionally enhance the implementation to provide actual worst-case values instead of skipping the benchmark, but this is not required for the upgrade.
