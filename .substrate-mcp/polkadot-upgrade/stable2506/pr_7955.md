# PR #7955: Add ApprovedPeer UMP Signal

## Overview

**PR:** https://github.com/paritytech/polkadot-sdk/pull/7955
**Labels:** T8-polkadot
**Audience:** Runtime Developers, Node Developers
**Impact:** Transparent Forward-Compatible Enhancement

## Summary

This PR introduces a new UMP (Upward Message Passing) signal variant called `ApprovedPeer` that enables parachains to specify which peer ID should be credited for authoring and supplying a candidate. This signal is part of the new collator protocol implementation designed to improve collator reputation tracking and reward distribution.

## Technical Details

### What Changed

**New Signal Type:**
```rust
pub enum UmpSignal {
    // ... existing variants
    ApprovedPeer(PeerId),  // NEW: Credits a specific collator
}
```

The `ApprovedPeer` signal allows parachain runtimes to communicate to the relay chain which collator (identified by their peer ID) should receive credit for producing and supplying a candidate block. This enables more accurate reputation tracking and potentially better collator selection in future block production.

**Key Implementation Points:**
1. Signal validation occurs exclusively during the backing phase (not during disputes)
2. Runtime sanitizes invalid candidates if backed before the feature is fully enabled
3. Backward compatible - old validators ignore the signal, new validators validate it
4. Candidates should NOT emit this signal until the `CandidateReceiptV2` node feature is enabled

**Related Issue:** polkadot-sdk#7731

### Affected Crates

#### Major Version Bumps
- **polkadot-primitives** (major): Core Polkadot protocol primitives including UMP signal definitions
- **polkadot-node-primitives** (major): Node-level primitives for candidate validation

#### Patch Version Bumps
- **polkadot-node-collation-generation** (patch): Collator logic for generating candidates
- **polkadot-node-core-candidate-validation** (patch): Validates candidates including signal parsing
- **polkadot-statement-distribution** (patch): Statement distribution during backing
- **polkadot-runtime-parachains** (patch): Relay chain runtime pallet for parachain management
- **cumulus-pallet-parachain-system** (patch): Core parachain system pallet

## Impact on Moonbeam

### Classification

**Category:** Transparent Forward-Compatible Enhancement
**Type:** Protocol Extension (T8-polkadot)
**Action Required:** None (automatic on upgrade)

### Affected Components

#### 1. Core Parachain System Pallet (Transparent Impact)

All three Moonbeam runtimes use `cumulus-pallet-parachain-system`, which receives a patch bump:

**Files:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/Cargo.toml` (line 155)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/Cargo.toml` (line 155)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/Cargo.toml` (line 155)

**Runtime Configuration:**
```rust
// /Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs:750
impl cumulus_pallet_parachain_system::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type OnSystemEvent = ();
    type SelfParaId = ParachainInfo;
    type ReservedDmpWeight = ReservedDmpWeight;
    type OutboundXcmpMessageSource = XcmpQueue;
    type XcmpMessageHandler = XcmpQueue;
    type ReservedXcmpWeight = ReservedXcmpWeight;
    type CheckAssociatedRelayNumber = EmergencyParaXcm;
    type ConsensusHook = ConsensusHook;
    type DmpQueue = frame_support::traits::EnqueueWithOrigin<MessageQueue, RelayOrigin>;
    type WeightInfo = moonbase_weights::cumulus_pallet_parachain_system::WeightInfo<Runtime>;
    type SelectCore = cumulus_pallet_parachain_system::DefaultCoreSelector<Runtime>;  // <-- Relevant
}
```

**Key Point:** The `SelectCore` type is set to `DefaultCoreSelector<Runtime>` across all three runtimes:
- moonbase: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs:762`
- moonriver: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs:761`
- moonbeam: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs:718`

Moonbeam does not use a custom core selector, so the ApprovedPeer signal support is inherited transparently from the default implementation.

#### 2. Collation Info API (Indirect Impact)

Moonbeam runtimes implement the `CollectCollationInfo` trait:

**File:** `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/apis.rs:711`
```rust
impl cumulus_primitives_core::CollectCollationInfo<Block> for Runtime {
    fn collect_collation_info(
        header: &<Block as BlockT>::Header
    ) -> cumulus_primitives_core::CollationInfo {
        ParachainSystem::collect_collation_info(header)
    }
}
```

This API delegates to `ParachainSystem`, which now has internal support for handling the new UMP signal format. No changes required to Moonbeam's implementation.

#### 3. Dependencies (Transparent Updates)

**Workspace Dependencies:**
```toml
# /Users/manuelmauro/Workspace/moonbeam/Cargo.toml
polkadot-primitives = { git = "...", branch = "moonbeam-polkadot-stable2503" }
cumulus-pallet-parachain-system = { git = "...", branch = "moonbeam-polkadot-stable2503" }
```

**Node Service Usage:**
```rust
// /Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:59
use polkadot_primitives::{AbridgedHostConfiguration, AsyncBackingParams, Slot, UpgradeGoAhead};
```

The node imports from `polkadot_primitives` but doesn't directly interact with UMP signal definitions. The major version bump is transparent.

#### 4. Test Dependencies (Dev-Only Impact)

`polkadot-runtime-parachains` is used only in dev-dependencies for XCM testing:

**Files:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/Cargo.toml:190` (dev-dependencies)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/Cargo.toml:206` (dev-dependencies)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/Cargo.toml:205` (dev-dependencies)

**Usage in Tests:**
```rust
// /Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/tests/xcm_mock/mod.rs:26
use polkadot_runtime_parachains::configuration::{
    HostConfiguration as RelayHostConfiguration, ...
};
// Line 29
use polkadot_runtime_parachains::paras::{ParaGenesisArgs, ParaKind};
// Line 262
pub type Hrmp = polkadot_runtime_parachains::hrmp::Pallet<relay_chain::Runtime>;
```

These test utilities construct mock relay chains for XCM testing. The patch bump to `polkadot-runtime-parachains` will be applied automatically with no breaking changes.

### What Moonbeam Does NOT Do

**Evidence from codebase search:**

1. **No Custom Collation Generation:**
   - Search for `collation_generation|CollationGenerationConfig` found no results in `/Users/manuelmauro/Workspace/moonbeam/node`
   - Moonbeam uses the standard Cumulus collation infrastructure

2. **No Direct UMP Signal Handling:**
   - Search for `UmpSignal|UpwardMessage|upward_message` found no direct usage in runtime code
   - Only found references in generated TypeScript API bindings

3. **No Custom Node Primitives:**
   - Search for `polkadot-node-primitives|polkadot_node_primitives` only found entries in `Cargo.lock`
   - Not a direct dependency of any Moonbeam crate

4. **No CandidateReceiptV2 References:**
   - Search found zero matches in the codebase
   - Moonbeam is not yet using the new candidate receipt format

## Why This Doesn't Affect Moonbeam Now

### Forward-Compatible Design

The PR explicitly states:
> "Candidates should still not emit any UMP signals until the CandidateReceiptV2 node feature is enabled."

This means:
1. **Current State:** Moonbeam collators continue operating as before, without emitting the new signal
2. **Relay Chain Processing:** The relay chain can now recognize and validate the signal when present
3. **Backward Compatibility:** Old validators ignore the signal; new validators validate it
4. **Future Activation:** When `CandidateReceiptV2` is enabled network-wide, collators can start using it

### Signal Flow

The `ApprovedPeer` signal is processed at the **relay chain level**, not by parachain runtimes:
- Collators emit the signal (future capability)
- Relay chain validators process it during backing
- Parachain runtimes are unaware of the signal's existence

Since Moonbeam:
- Uses `DefaultCoreSelector` (no custom implementation)
- Doesn't customize collation generation
- Doesn't process UMP signals in runtime logic

The change is **completely transparent** to Moonbeam's operations.

## Related Collator Protocol Changes

This PR is part of a broader set of collator protocol improvements in stable2506:

### PR #8134: Separate Validation and Collation Protocols
- Removes validation protocol versions 1 and 2
- Separates validation from collation protocols
- Cleans up outdated validation messages
- **Impact:** Transparent, protocol-level cleanup

### PR #8230: Parachain Block Validation Metrics
- Adds metrics for collation fetching time
- Tracks backing and inclusion latency
- Monitors expired collations
- **Impact:** Improved observability (no functional changes)

### PR #8370: Fix Unneeded Collator Connections
- Prevents collators from connecting when no cores assigned
- Reduces log spam: "An unneeded collator connected"
- **Impact:** Better resource management and cleaner logs

**Collective Impact:** These changes modernize the collator protocol infrastructure while maintaining full backward compatibility.

## Benefits for Moonbeam

While the feature is not yet active, the infrastructure is being prepared for:

### 1. Better Collator Reputation Tracking
Once activated, the relay chain will accurately track which collators are producing high-quality candidates, enabling:
- More informed collator selection
- Better rewards distribution
- Improved parachain block production efficiency

### 2. Enhanced Protocol Robustness
The signal validation during backing (not disputes) means:
- Faster feedback on candidate quality
- Reduced wasted validation work
- More predictable block production times

### 3. Future-Proof Architecture
By preparing this infrastructure now, Moonbeam:
- Avoids disruptive protocol changes later
- Benefits from gradual network-wide rollout
- Maintains compatibility during transition periods

## Verification Testing

### Recommended Tests

#### 1. Basic Collator Operations
```bash
# Verify dev node collation still works
./target/release/moonbeam --dev --alice --sealing 6000 --rpc-port 9944

# Check logs for any UMP signal related errors (should be none)
# Verify block production continues normally
```

#### 2. Parachain System Functionality
```typescript
// test/suites/dev/moonbase/
// Run existing parachain system tests
pnpm moonwall test dev_moonbase

// Verify:
// - Block production
// - XCM message passing
// - Parachain validation
```

#### 3. XCM Integration Tests
```bash
# Run XCM mock tests that use polkadot-runtime-parachains
cd runtime/moonbase
cargo test --test xcm_tests

# These tests verify:
// - HRMP channel operations
// - Relay chain interactions
// - Parachain system pallet integration
```

#### 4. Collation Info API
```typescript
// Verify CollectCollationInfo still works
const collationInfo = await api.rpc.state.call(
  'CollectCollationInfo_collect_collation_info',
  header
);
// Should return valid collation info without errors
```

#### 5. Runtime Upgrade Simulation
```bash
# In a test environment:
# 1. Deploy current runtime
# 2. Upgrade to stable2506
# 3. Verify no disruption to:
#    - Block production
#    - XCM operations
#    - Collator operations
```

### What to Monitor

**No New Errors Expected:**
- UMP signal processing happens transparently in cumulus-pallet-parachain-system
- No new signal emission from Moonbeam collators (feature not yet active)
- Existing logs and metrics should remain unchanged

**Success Criteria:**
- All existing tests pass without modification
- Block production continues at normal rate
- No new warnings or errors in collator logs
- XCM operations function normally

## Risk Assessment

### Risk Level: **VERY LOW**

**Justification:**

1. **Protocol Extension, Not Modification**
   - Adds new capability without changing existing behavior
   - Old and new validators coexist safely
   - Feature not yet active for parachains

2. **No Moonbeam Code Changes Required**
   - Uses default implementations throughout
   - No custom UMP signal handling
   - No custom collation generation logic

3. **Transparent Dependency Updates**
   - Patch bump for cumulus-pallet-parachain-system
   - Major bumps to primitives are internal changes
   - Dev-only dependency updates for test crates

4. **Designed for Gradual Rollout**
   - Awaits `CandidateReceiptV2` network-wide feature flag
   - Signal validation only during backing (safe failure mode)
   - Runtime sanitizes invalid candidates before disputes

5. **Battle-Tested Design**
   - Zombienet integration tests included in PR
   - Mixed validator version testing completed
   - Signal validation logic is isolated and well-defined

### Potential Issues

**None Identified for Moonbeam's Current Configuration**

The PR explicitly designs for:
- Backward compatibility (old validators ignore signal)
- Forward compatibility (new validators validate when present)
- Safe rollout (no emission until feature flag enabled)

## Migration Guide

### Required Actions

**NONE** - This PR requires no code changes, configuration updates, or runtime migrations.

### Automatic Updates

When upgrading to stable2506:

1. **Dependency Updates** (Automatic)
   ```toml
   # Cargo.toml dependencies will update to new versions
   cumulus-pallet-parachain-system = { ... }  # Patch bump
   polkadot-primitives = { ... }              # Major bump (transparent)
   polkadot-runtime-parachains = { ... }      # Patch bump (dev-deps)
   ```

2. **Runtime Compilation** (Automatic)
   - Runtimes will compile with updated pallet versions
   - No trait implementations need modification
   - No Config type changes required

3. **Test Suite** (Automatic)
   - Mock relay chain tests use updated parachains runtime
   - No test modifications needed
   - Existing XCM tests continue to pass

### Optional Actions

**Monitoring Preparation:**
When the `CandidateReceiptV2` feature is eventually enabled network-wide (future release), consider:

1. **Add Metrics Monitoring** (PR #8230 related)
   - Monitor collation fetch times
   - Track backing latency
   - Observe inclusion rates

2. **Collator Performance Tracking**
   - Once ApprovedPeer signals are active, monitor which collators are credited
   - Correlate with block production efficiency
   - Use data for collator set optimization

## Future Considerations

### When CandidateReceiptV2 Activates

At some point in the future (not in stable2506), the relay chain will activate the `CandidateReceiptV2` feature flag. At that point:

**What Will Happen:**
1. Collators will start emitting `ApprovedPeer` UMP signals
2. Relay chain validators will validate these signals during backing
3. Collator reputation tracking will become more accurate

**What Moonbeam Needs to Do:**
- **Nothing** - the cumulus-pallet-parachain-system will handle this automatically
- DefaultCoreSelector will work with the new signal format
- Existing collator infrastructure is compatible

**Monitoring Recommendations:**
- Watch for collator reputation metrics on relay chain
- Observe if certain collators consistently receive credit
- Use data to inform collator selection strategies

### Collator Selection Strategy

Once the feature is active, Moonbeam could optionally:

1. **Analyze Reputation Data**
   - Query relay chain for collator reputation scores
   - Identify high-performing collators
   - Optimize collator rotation strategies

2. **Custom Core Selection** (Advanced)
   - If desired, implement a custom `SelectCore` type
   - Could prioritize high-reputation collators
   - Would require runtime upgrade and testing

**Note:** This is entirely optional. The default implementation works well for most parachains.

## Related PRs and Issues

- **Issue:** polkadot-sdk#7731 (Core selector infrastructure)
- **Related PR #8134:** Separate validation and collation protocols
- **Related PR #8230:** Add parachain block validation metrics
- **Related PR #8370:** Fix unneeded collator connections

## Conclusion

PR #7955 introduces the `ApprovedPeer` UMP signal as part of a modernized collator protocol infrastructure. For Moonbeam, this change is:

**Completely Transparent:**
- No code changes required
- No configuration updates needed
- No runtime migrations necessary
- No test modifications required

**Forward-Compatible:**
- Infrastructure prepared for future activation
- Gradual network-wide rollout planned
- Backward compatibility maintained throughout

**Low Risk:**
- Uses default implementations throughout
- No custom signal handling in Moonbeam
- Transparent dependency updates only
- Battle-tested with mixed validator versions

### Verification Summary

| Component | Status | Evidence |
|-----------|--------|----------|
| Runtime Config | No Changes | Uses DefaultCoreSelector, no custom implementations |
| Collation Generation | Transparent | No custom collation logic in Moonbeam |
| UMP Signal Handling | N/A | No direct signal processing in runtime |
| Test Suite | Compatible | Dev-deps update automatically |
| Node Service | Transparent | Uses primitives but not signal definitions |

### Recommendation

**APPROVE** - This PR can be safely integrated into the stable2506 upgrade with no concerns. The changes:
- Prepare infrastructure for future collator protocol improvements
- Maintain full backward compatibility
- Require no action from the Moonbeam team
- Pose no risk to current operations

The ApprovedPeer signal represents thoughtful protocol evolution that benefits the ecosystem while respecting deployment complexity. Moonbeam will automatically benefit from these improvements when the feature is activated network-wide in a future release.
