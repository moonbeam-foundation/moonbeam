# PR #7955: Add ApprovedPeer UMP signal

## Summary

This PR introduces a new `ApprovedPeer` UMP (Upward Message Passing) signal variant that allows parachains to specify which peer should be credited for authoring and supplying a candidate. This is designed to support the new collator protocol implementation by enabling reputation promotion for collators.

**GitHub PR**: https://github.com/paritytech/polkadot-sdk/pull/7955
**Labels**: T8-polkadot

## Changes Overview

### Core Changes

1. **New UMP Signal Variant**
   - Added `ApprovedPeer(ApprovedPeerId)` variant to the `UMPSignal` enum in `polkadot-primitives`
   - `ApprovedPeerId` is defined as `BoundedVec<u8, ConstU32<64>>`

2. **Cumulus Pallet ParachainSystem** (`cumulus-pallet-parachain-system`)
   - Modified `validate_block/implementation.rs` to handle the new signal type
   - Added validation logic ensuring all `ApprovedPeer` signals in a block reference the same peer ID
   - Panics if conflicting peer identifiers are detected within a single block

3. **Node-side Changes**
   - Updated candidate validation subsystem to parse and validate UMP signals
   - Modified collation generation to extract signals using `ump_signals()` method
   - Enhanced statement distribution to handle the new signal type

4. **Version Bumps**
   - `polkadot-primitives`: major bump
   - `polkadot-node-primitives`: major bump
   - `cumulus-pallet-parachain-system`: patch bump

### Code Example

The validation logic added to `cumulus-pallet-parachain-system`:

```rust
let mut approved_peer = None;

upward_message_signals.iter().for_each(|s| {
    match UMPSignal::decode(&mut &s[..]) {
        // ... CoreSelector handling ...
        UMPSignal::ApprovedPeer(new_approved_peer) => match &approved_peer {
            Some(approved_peer) if *approved_peer != new_approved_peer => {
                panic!("All `ApprovedPeer` signals need to select the same peer_id...")
            },
            Some(_) => {},
            None => { approved_peer = Some(new_approved_peer); },
        },
    }
});
```

## Impact on Moonbeam

### Direct Impact

**Affected Components**:
- All three Moonbeam runtimes (moonbeam, moonriver, moonbase) use `cumulus-pallet-parachain-system`
- The pallet is configured with `DefaultCoreSelector<Runtime>` in all runtimes
- Located at:
  - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs`
  - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs`
  - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs`

**Current Configuration**:
```rust
impl cumulus_pallet_parachain_system::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type OnSystemEvent = ();
    type SelfParaId = ParachainInfo;
    type ReservedDmpWeight = ReservedDmpWeight;
    type OutboundXcmpMessageSource = XcmpQueue;
    type XcmpMessageHandler = XcmpQueue;
    type ReservedXcmpWeight = ReservedXcmpWeight;
    type CheckAssociatedRelayNumber = EmergencyParaXcm;
    type ConsensusHook = ConsensusHook;
    type DmpQueue = frame_support::traits::EnqueueWithOrigin<MessageQueue, RelayOrigin>;
    type WeightInfo = moonbase_weights::cumulus_pallet_parachain_system::WeightInfo<Runtime>;
    type SelectCore = cumulus_pallet_parachain_system::DefaultCoreSelector<Runtime>;
}
```

### Analysis

**No Action Required** - This change is backward compatible:

1. **Automatic Inheritance**: The new validation logic in `cumulus-pallet-parachain-system` will be inherited when updating dependencies. No code changes needed.

2. **Opt-in Feature**: The `ApprovedPeer` signal is optional. Parachains don't need to emit these signals unless they want to participate in the new collator reputation system.

3. **Standard Implementation**: Moonbeam uses the standard `DefaultCoreSelector` and doesn't have custom UMP signal handling, so no custom code needs updating.

4. **No Breaking Changes**: Adding a new enum variant doesn't break existing functionality. The validation code only activates when `ApprovedPeer` signals are present.

5. **Node Dependencies**: Moonbeam's node service depends on `polkadot-primitives` but only imports specific types (`AbridgedHostConfiguration`, `AsyncBackingParams`, `Slot`, `UpgradeGoAhead`), none of which are affected by this change.

### Evidence from Codebase

**Grep Results**:
- Moonbeam does NOT use `UMPSignal` directly anywhere in the codebase
- Moonbeam does NOT have custom collation generation logic that would need updating
- Moonbeam uses standard `cumulus-client-cli::CollatorOptions` without modifications

**Dependencies**:
```toml
# From /Users/manuelmauro/Workspace/moonbeam/Cargo.toml
polkadot-primitives = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2503" }
```

## Recommendation

**Impact Level**: **INHERITED**

**Action Items**:
- No code changes required
- No configuration changes required
- The feature is automatically inherited through dependency updates
- Moonbeam can optionally implement `ApprovedPeer` signal emission in the future if desired for collator reputation management

**Testing Considerations**:
- Standard integration tests should verify that the updated `cumulus-pallet-parachain-system` works correctly
- No specific tests for `ApprovedPeer` signal handling are needed unless Moonbeam decides to emit such signals

## Technical Notes

### Backward Compatibility

The PR includes Zombienet tests demonstrating compatibility between upgraded and non-upgraded validators. Older validators ignore the new signal while newer ones process it correctly, ensuring no consensus issues during mixed-version deployments.

### Future Opportunities

If Moonbeam wants to participate in the new collator reputation system, they could:
1. Implement logic to emit `ApprovedPeer` signals during block authoring
2. Coordinate with their collator operators to ensure proper peer identification
3. This would require custom implementation in the collation process

However, this is entirely optional and can be considered in future development if deemed beneficial.

## References

- PR: https://github.com/paritytech/polkadot-sdk/pull/7955
- Related Issue: #7731
- PRDoc: /Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_7955.prdoc
