# PR #7960 Impact Analysis: Stabilize pallet view functions

## Overview

**PR:** [#7960 - Stabilize pallet view functions](https://github.com/paritytech/polkadot-sdk/pull/7960)
**Labels:** T1-FRAME, T4-runtime_API
**Audience:** Runtime Dev
**Impact Level:** LOW - No immediate action required

## Summary

This PR stabilizes the pallet view functions feature by renaming the `view_functions_experimental` macro to `view_functions`, officially removing its experimental status and recommending its use for production runtimes.

## What Are View Functions?

View functions are read-only methods that provide stable, version-safe access to pallet state:

- **Read-Only Nature**: Must return output and cannot modify state
- **Stable Interface**: Provide a maintained contract for state queries that remains stable across runtime upgrades
- **External Query Access**: Enable lightweight state inspection through runtime APIs without executing transactions
- **Abstraction Layer**: Applications query through defined methods rather than directly accessing storage structures

## Changes Introduced

### Affected Crates
- `frame-support-procedural` (major bump)
- `frame-support` (minor bump)
- `pallet-example-view-functions` (no bump)
- `pallet-proxy` (no bump)

### Key Changes
1. Macro renamed from `view_functions_experimental` to `view_functions`
2. Feature officially moved from experimental to stable status
3. Documentation updated to recommend usage in production

## Impact on Moonbeam

### Current State Analysis

**Finding:** Moonbeam does not currently use pallet view functions.

**Evidence:**
```bash
# Search for view function usage
$ rg "#\[pallet::view\]" pallets/
# No matches found

$ rg "view_functions" pallets/
# No matches found
```

**Current Query Pattern:** Moonbeam uses traditional runtime APIs for read-only state queries.

### Example: XCM Weight Trader Pallet

The `pallet-xcm-weight-trader` demonstrates Moonbeam's current pattern for exposing read-only queries:

**File:** `/Users/manuelmauro/Workspace/moonbeam/pallets/xcm-weight-trader/src/lib.rs`

```rust
impl<T: Config> Pallet<T> {
    // Read-only query methods exposed via runtime API
    pub fn query_acceptable_payment_assets(
        xcm_version: xcm::Version,
    ) -> Result<Vec<VersionedAssetId>, XcmPaymentApiError> {
        let v5_assets = [VersionedAssetId::from(XcmAssetId::from(
            T::NativeLocation::get(),
        ))]
        .into_iter()
        .chain(
            SupportedAssets::<T>::iter().filter_map(|(asset_location, (enabled, _))| {
                enabled.then(|| VersionedAssetId::from(XcmAssetId(asset_location)))
            }),
        )
        .collect::<Vec<_>>();
        // ... version conversion logic
    }

    pub fn query_weight_to_asset_fee(
        weight: Weight,
        asset: VersionedAssetId,
    ) -> Result<u128, XcmPaymentApiError> {
        // ... query logic
    }

    pub fn get_asset_relative_price(location: &Location) -> Option<u128> {
        if let Some((true, ratio)) = SupportedAssets::<T>::get(location) {
            Some(ratio)
        } else {
            None
        }
    }
}
```

**Runtime API Integration:**

**File:** `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/apis.rs`

```rust
impl xcm_runtime_apis::fees::XcmPaymentApi<Block> for Runtime {
    fn query_acceptable_payment_assets(
        xcm_version: xcm::Version
    ) -> Result<Vec<VersionedAssetId>, XcmPaymentApiError> {
        XcmWeightTrader::query_acceptable_payment_assets(xcm_version)
    }

    fn query_weight_to_asset_fee(
        weight: Weight, asset: VersionedAssetId
    ) -> Result<u128, XcmPaymentApiError> {
        XcmWeightTrader::query_weight_to_asset_fee(weight, asset)
    }
    // ... additional API methods
}
```

### Moonbeam's Custom Pallets

Moonbeam has 8 custom pallets with dispatchable calls:
1. `/Users/manuelmauro/Workspace/moonbeam/pallets/xcm-transactor/src/lib.rs`
2. `/Users/manuelmauro/Workspace/moonbeam/pallets/parachain-staking/src/lib.rs`
3. `/Users/manuelmauro/Workspace/moonbeam/pallets/moonbeam-foreign-assets/src/lib.rs`
4. `/Users/manuelmauro/Workspace/moonbeam/pallets/crowdloan-rewards/src/lib.rs`
5. `/Users/manuelmauro/Workspace/moonbeam/pallets/xcm-weight-trader/src/lib.rs`
6. `/Users/manuelmauro/Workspace/moonbeam/pallets/moonbeam-orbiters/src/lib.rs`
7. `/Users/manuelmauro/Workspace/moonbeam/pallets/moonbeam-lazy-migrations/src/lib.rs`
8. `/Users/manuelmauro/Workspace/moonbeam/pallets/ethereum-xcm/src/lib.rs`

**Note:** All of these use `#[pallet::call]` for state-modifying operations, not view functions for queries.

## Assessment

### Immediate Impact: NONE

- **No Breaking Changes**: Since Moonbeam doesn't use view functions, there's nothing to update
- **No Migration Required**: The feature is opt-in; existing code continues to work
- **No Dependencies**: None of Moonbeam's dependencies are affected by the stabilization

### Future Opportunities: MODERATE

The stabilization of view functions opens up opportunities for future development:

#### Potential Benefits

1. **Simplified Query Interface**: View functions could provide a simpler alternative to runtime APIs for some use cases
2. **Better Abstraction**: Encapsulate storage access patterns with stable public interfaces
3. **Dual Approach**: Use view functions for simple queries while keeping runtime APIs for complex operations
4. **Client Integration**: External tools could query pallet state more easily through standardized view functions

#### Potential Use Cases in Moonbeam

1. **XCM Weight Trader**: Query methods like `get_asset_relative_price` could be exposed as view functions
2. **Parachain Staking**: State queries for collator/delegator information
3. **Foreign Assets**: Asset metadata and balance queries
4. **Crowdloan Rewards**: Reward status and claim information queries

#### Comparison: View Functions vs Runtime APIs

| Aspect | View Functions | Runtime APIs |
|--------|---------------|--------------|
| **Complexity** | Lower - defined in pallet | Higher - requires separate API trait |
| **Flexibility** | Limited to pallet scope | Full runtime context access |
| **Versioning** | Implicit through pallet | Explicit API versioning |
| **Best For** | Simple state queries | Complex cross-pallet operations |
| **Client Access** | Through metadata | Through custom RPC |

## Recommendations

### Short Term (Current Release)
‚úÖ **No Action Required** - This PR has zero impact on existing Moonbeam code

### Medium Term (Future Consideration)
üîç **Consider Evaluation** - When adding new pallets or query functionality:

1. **Evaluate View Functions** for simple read-only queries that don't need cross-pallet coordination
2. **Keep Runtime APIs** for complex queries requiring full runtime context (like XCM operations)
3. **Consider Hybrid Approach** - Use view functions for simple queries, runtime APIs for complex ones

### Example Future Implementation

If Moonbeam decides to adopt view functions, here's how the xcm-weight-trader queries might look:

```rust
#[pallet]
pub mod pallet {
    // Existing storage and calls...

    #[pallet::view_functions]
    impl<T: Config> Pallet<T> {
        #[pallet::view]
        pub fn get_asset_relative_price(location: Location) -> Option<u128> {
            if let Some((true, ratio)) = SupportedAssets::<T>::get(&location) {
                Some(ratio)
            } else {
                None
            }
        }

        #[pallet::view]
        pub fn is_asset_supported(location: Location) -> bool {
            SupportedAssets::<T>::contains_key(&location)
        }
    }
}
```

## Technical Details

### Macro Change
- **Before:** `#[pallet::view_functions_experimental]`
- **After:** `#[pallet::view_functions]`

### Documentation
- [View Functions Documentation](https://paritytech.github.io/polkadot-sdk/master/frame_support/pallet_macros/attr.view_functions.html)
- [Example Pallet](https://github.com/paritytech/polkadot-sdk/tree/master/substrate/frame/examples/view-functions)

## Conclusion

**Status:** ‚úÖ No immediate action required
**Risk Level:** None
**Future Consideration:** Low priority opportunity for adoption

This PR stabilizes a feature that Moonbeam doesn't currently use. While view functions offer an interesting alternative for exposing read-only pallet state, Moonbeam's existing runtime API pattern works well and doesn't require changes. View functions could be considered for future pallets or features where a simpler query interface would be beneficial, but there's no pressure to adopt them immediately.

The stabilization primarily signals that the feature is production-ready for teams that want to use it, removing the "experimental" designation that might have previously discouraged adoption.
