# PR #7995 Impact Analysis: Add `PureKilled` event to `pallet-proxy`

## PR Summary

**Title**: Add event to pure proxy deletion
**PR Number**: #7995
**Labels**: T2-pallets, T10-tests, T14-system_parachains
**Status**: Merged (April 29, 2025)

### What Changed
- Added a new `PureKilled` event to `pallet-proxy` that is emitted when the `kill_pure` extrinsic is called
- This complements the existing `PureCreated` event, enabling complete tracking of pure proxy lifecycle
- Marked as a **major version bump** for pallet-proxy

### Why This Matters
Previously, only pure proxy creation was tracked via events. Now deletion events are also recorded, improving transparency and auditing capabilities for pure proxy management operations.

---

## Impact on Moonbeam

### 1. TypeScript API Bindings - ACTION REQUIRED

**Impact Level**: Medium
**Status**: Requires Regeneration

The TypeScript API definitions currently only include the `PureCreated` event but not the new `PureKilled` event.

**Files Affected**:
```
/typescript-api/src/moonbase/interfaces/augment-api-events.ts
/typescript-api/src/moonbase/interfaces/types-lookup.ts
/typescript-api/src/moonbase/interfaces/lookup.ts
/typescript-api/src/moonriver/interfaces/augment-api-events.ts
/typescript-api/src/moonriver/interfaces/types-lookup.ts
/typescript-api/src/moonriver/interfaces/lookup.ts
/typescript-api/src/moonbeam/interfaces/augment-api-events.ts
/typescript-api/src/moonbeam/interfaces/types-lookup.ts
/typescript-api/src/moonbeam/interfaces/lookup.ts
```

**Current State** (from `/typescript-api/src/moonbase/interfaces/augment-api-events.ts`):
```typescript
proxy: {
  Announced: AugmentedEvent<...>;
  DepositPoked: AugmentedEvent<...>;
  ProxyAdded: AugmentedEvent<...>;
  ProxyExecuted: AugmentedEvent<...>;
  ProxyRemoved: AugmentedEvent<...>;
  PureCreated: AugmentedEvent<
    ApiType,
    [
      pure: AccountId20,
      who: AccountId20,
      proxyType: MoonbaseRuntimeProxyType,
      disambiguationIndex: u16
    ],
    { ... }
  >;
  // PureKilled event is MISSING
}
```

**Action Required**:
Regenerate TypeScript API bindings after the Polkadot SDK upgrade to include the new `PureKilled` event. Use the command from CLAUDE.md:
```bash
pnpm build
```

---

### 2. Runtime Integration Tests - NO ACTION REQUIRED

**Impact Level**: Low
**Status**: Currently Sufficient

The integration tests verify that `kill_pure` is allowed by the `NormalFilter` in all three runtimes:

**Location**:
- `/runtime/moonbase/tests/integration_test.rs:474-492`
- `/runtime/moonriver/tests/integration_test.rs:497-516`
- `/runtime/moonbeam/tests/integration_test.rs:498-516`

**Test Code**:
```rust
#[test]
fn verify_normal_filter_allow_pure_proxy() {
    ExtBuilder::default().build().execute_with(|| {
        assert!(NormalFilter::contains(&RuntimeCall::Proxy(
            pallet_proxy::Call::<Runtime>::create_pure {
                proxy_type: ProxyType::Any,
                delay: 0,
                index: 0,
            }
        )));
        assert!(NormalFilter::contains(&RuntimeCall::Proxy(
            pallet_proxy::Call::<Runtime>::kill_pure {
                spawner: AccountId::from(ALICE),
                proxy_type: ProxyType::Any,
                index: 0,
                height: 0,
                ext_index: 0,
            }
        )));
    });
}
```

**Analysis**: The tests verify that `kill_pure` calls are allowed, but they don't check for event emission. This is acceptable since the event addition is a non-breaking additive change.

**Optional Enhancement**: Consider adding test cases that verify the `PureKilled` event is emitted correctly when `kill_pure` is called, similar to how the precompile tests check for `ProxyAdded` and `ProxyRemoved` events.

---

### 3. Proxy Precompile - NO IMPACT

**Impact Level**: None
**Status**: No Changes Needed

The proxy precompile does NOT expose `kill_pure` or `create_pure` functions to EVM users. These functions are only accessible via Substrate extrinsics.

**Location**: `/precompiles/proxy/src/lib.rs`

**Exposed Functions**:
- `addProxy(address,uint8,uint32)` - Line 165
- `removeProxy(address,uint8,uint32)` - Line 219
- `removeProxies()` - Line 252
- `proxy(address,address,bytes)` - Line 269
- `proxyForceType(address,uint8,address,bytes)` - Line 294
- `isProxy(address,address,uint8,uint32)` - Line 325

**Analysis**: Since EVM users cannot call `kill_pure` through the precompile, the new `PureKilled` event won't be visible to them. However, users calling `kill_pure` via Substrate extrinsics (e.g., through governance or direct calls) will now receive the event.

---

### 4. Precompile Tests - NO ACTION REQUIRED

**Impact Level**: None
**Status**: Tests Already Check Proxy Events

The precompile tests already verify event emission for proxy operations:

**Location**: `/precompiles/proxy/src/tests.rs`

**Example Test Pattern**:
```rust
assert_event_emitted!(RuntimeEvent::Proxy(ProxyEvent::ProxyAdded {
    delegator: Alice.into(),
    delegatee: Bob.into(),
    proxy_type: ProxyType::Something,
    delay: 0
}));

assert_event_emitted!(RuntimeEvent::Proxy(ProxyEvent::ProxyRemoved {
    delegator: Alice.into(),
    delegatee: Bob.into(),
    proxy_type: ProxyType::Something,
    delay: 0
}));
```

**Analysis**: Since the precompile doesn't expose `kill_pure`, no tests need to be added for the `PureKilled` event at the precompile level.

---

### 5. TypeScript Integration Tests - NO ACTION REQUIRED

**Impact Level**: None
**Status**: No Changes Needed

TypeScript tests check for proxy events in precompile operations:

**Location**: `/test/suites/dev/common/test-precompile/test-precompile-proxy.ts`

**Example Test Pattern**:
```typescript
const proxyAddedEvents = result!.events.reduce((acc, e) => {
  if (context.polkadotJs().events.proxy.ProxyAdded.is(e.event)) {
    acc.push({
      account: e.event.data[0].toString(),
      proxyType: e.event.data[2].toHuman(),
    });
  }
  return acc;
}, []);
```

**Analysis**: No TypeScript tests currently use `create_pure` or `kill_pure` functions, so no test updates are needed. After TypeScript API regeneration, tests could be added if needed.

---

### 6. Benchmark Weights - NO ACTION REQUIRED

**Impact Level**: None
**Status**: Weights Already Defined

Benchmark weights for `kill_pure` are already defined in all three runtimes:

**Location**:
- `/runtime/moonbase/src/weights/pallet_proxy.rs:208-218`
- `/runtime/moonriver/src/weights/pallet_proxy.rs`
- `/runtime/moonbeam/src/weights/pallet_proxy.rs`

**Weight Function**:
```rust
fn kill_pure(p: u32, ) -> Weight {
    // Proof Size summary in bytes:
    //  Measured:  `174 + p * (25 Â±0)`
    //  Estimated: `4310`
    // Minimum execution time: 23_003_000 picoseconds.
    Weight::from_parts(24_060_210, 4310)
        // Standard Error: 1_215
        .saturating_add(Weight::from_parts(29_410, 0).saturating_mul(p.into()))
        .saturating_add(T::DbWeight::get().reads(1_u64))
        .saturating_add(T::DbWeight::get().writes(1_u64))
}
```

**Analysis**: The event emission adds minimal overhead and shouldn't require rebenchmarking. The weight function already accounts for storage reads/writes, and event emission is a lightweight operation.

---

### 7. Runtime Configuration - NO ACTION REQUIRED

**Impact Level**: None
**Status**: No Changes Needed

The pallet-proxy configuration in all three runtimes is complete and doesn't require updates:

**Location**: `/runtime/moonbase/src/lib.rs:1161-1181`

```rust
impl pallet_proxy::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type RuntimeCall = RuntimeCall;
    type Currency = Balances;
    type ProxyType = ProxyType;
    type ProxyDepositBase = ConstU128<{ currency::deposit(1, 8) }>;
    type ProxyDepositFactor = ConstU128<{ currency::deposit(0, 21) }>;
    type MaxProxies = ConstU32<32>;
    type WeightInfo = moonbase_weights::pallet_proxy::WeightInfo<Runtime>;
    type MaxPending = ConstU32<32>;
    type CallHasher = BlakeTwo256;
    type AnnouncementDepositBase = ConstU128<{ currency::deposit(1, 8) }>;
    type AnnouncementDepositFactor = ConstU128<{ currency::deposit(0, 56) }>;
    type BlockNumberProvider = System;
}
```

**Analysis**: The configuration already has `RuntimeEvent` properly configured, which will automatically include the new `PureKilled` event.

---

### 8. Smoke Tests - NO IMPACT

**Impact Level**: None
**Status**: No Changes Needed

**Location**: `/test/suites/smoke/test-proxy-consistency.ts`

**Test Purpose**: Verifies proxy consistency by checking:
- Maximum proxy limits (32 proxies per account)
- Proxy accounts are only for non-smart contract addresses

**Analysis**: This smoke test doesn't interact with `kill_pure` or check for specific events, so no changes are needed.

---

## Summary

### Required Actions

1. **Regenerate TypeScript API Bindings** (Required)
   - Command: `pnpm build` (from project root)
   - This will update all TypeScript interfaces to include the new `PureKilled` event
   - Verify the event appears in `/typescript-api/src/moonbase/interfaces/augment-api-events.ts` and related files

### Optional Enhancements

1. **Add Event Verification Tests** (Optional)
   - Consider adding integration tests that verify `PureKilled` event emission
   - Would match the existing pattern in precompile tests that check `ProxyAdded` and `ProxyRemoved` events

### No Action Required

- Runtime configuration: Already properly configured
- Benchmark weights: Already defined and sufficient
- Precompile: Doesn't expose `kill_pure`, no changes needed
- Existing tests: Currently sufficient for the change
- Smoke tests: Not affected by this change

### Risk Assessment

**Overall Risk**: Low

This is an additive, non-breaking change that only adds event emission. The major version bump indicates API surface changes (new event type), but this doesn't affect existing functionality. The primary impact is ensuring TypeScript clients can access the new event type through regenerated bindings.

### Files to Monitor During Upgrade

1. TypeScript API generation output
2. Runtime compilation (should succeed without issues)
3. Integration test results (should pass without changes)

### Verification Steps Post-Upgrade

1. Confirm TypeScript API includes `PureKilled` event definition
2. Run full test suite: `cargo test` and `pnpm moonwall test`
3. Verify no unexpected event emission in existing proxy operations
4. (Optional) Test that `kill_pure` calls now emit `PureKilled` events on a dev node
