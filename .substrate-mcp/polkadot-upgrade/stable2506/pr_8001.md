# PR #8001: Structured Logging for Transaction Pool

## Overview

**PR Title:** Structured Logging for transaction pool

**Labels:** R0-no-crate-publish-required, T0-node

**Crate:** `sc-transaction-pool` (minor bump)

**Audience:** Node Dev

## Summary

This PR migrates the transaction pool (`sc-transaction-pool`) from the `log` crate to the `tracing` crate for structured logging. This is part of a broader initiative (issue #5490, following PR #6897) to implement structured logging across the Polkadot SDK codebase. The change enhances observability by adding contextual fields like `tx_hash` to log records instead of using generic format strings.

## Changes

### Core Implementation

The PR replaces all `log` crate invocations with `tracing` instrumentation across the transaction pool implementation:

1. **Logging Framework Migration**: Converts logging statements from `log::debug!()`, `log::info!()`, etc. to their `tracing` equivalents
2. **Structured Fields**: Adds contextual data fields to log records:
   - `tx_hash`: Transaction hash for transaction-specific logs
   - Other contextual fields for better filtering and analysis
3. **Affected Modules**:
   - Base pool implementations
   - Transaction validation and revalidation logic
   - Common API interfaces
   - Pool state management

### Technical Details

The migration maintains the same log levels and general behavior but enhances logs with structured data that can be:
- Parsed and filtered programmatically
- Aggregated for metrics and monitoring
- Correlated across different components
- Exported to structured logging backends (JSON, etc.)

## Impact on Moonbeam

### LOW-MEDIUM IMPACT

This change has **moderate positive impact** on Moonbeam's observability and debugging capabilities:

### 1. Transaction Pool Usage

**Evidence:**
- File: `/Users/manuelmauro/Workspace/moonbeam/node/service/Cargo.toml` (line 72)
  ```toml
  sc-transaction-pool = { workspace = true }
  ```
- File: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs` (lines 558-565)
  ```rust
  let transaction_pool = sc_transaction_pool::Builder::new(
      task_manager.spawn_essential_handle(),
      client.clone(),
      config.role.is_authority().into(),
  )
  .with_options(config.transaction_pool.clone())
  .with_prometheus(config.prometheus_registry())
  .build();
  ```

**Impact:**
Moonbeam uses the standard `sc-transaction-pool` implementation directly and will automatically benefit from improved logging.

### 2. Ethereum Transaction Pool RPC

**Evidence:**
- File: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/rpc.rs` (line 345)
  ```rust
  io.merge(TxPool::new(Arc::clone(&client), graph).into_rpc())?;
  ```
- File: `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/apis.rs` (lines 388-410)
  - Implements `TxPoolRuntimeApi` for filtering Ethereum transactions from the pool
- Git history: Commit f62d483688 "Replace TxPool RPC with Frontier implementation (#3218)"

**Impact:**
Moonbeam uses Frontier's `TxPool` RPC implementation (enabled with `txpool` feature in `fc-rpc`). This RPC relies on `sc-transaction-pool` internally and will benefit from structured logging when:
- Diagnosing transaction pool issues
- Debugging stuck or delayed transactions
- Monitoring pool health and performance
- Correlating EVM transaction behavior with pool state

### 3. Observability Infrastructure

**Evidence:**
- File: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs` (lines 493-549)
  - Uses `TelemetryWorker` and `TelemetryHandle` for node telemetry
  - Configures Prometheus metrics (line 452-456)
  - Uses `sc-tracing` with log prefix decorators (line 668): `#[sc_tracing::logging::prefix_logs_with("ðŸŒ—")]`
- File: `/Users/manuelmauro/Workspace/moonbeam/node/service/Cargo.toml` (line 71)
  ```toml
  sc-tracing = { workspace = true }
  ```

**Impact:**
Moonbeam already uses structured logging infrastructure:
- Has telemetry and Prometheus monitoring in place
- Uses `sc-tracing` for logging configuration
- Can leverage structured transaction pool logs for better monitoring dashboards
- Structured logs can be exported to log aggregation systems (Loki, Elasticsearch, etc.)

### 4. EVM Tracing and Debugging

**Evidence:**
- File: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/rpc/tracing.rs` (line 30)
  - Implements specialized EVM tracing for debug and trace RPC methods
- File: `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/cli.rs` (lines 244-295)
  - Provides CLI flags for EVM tracing configuration
  - `tracing_raw_max_memory_usage` configuration

**Impact:**
While Moonbeam has custom EVM tracing, the transaction pool structured logging complements this by:
- Providing better correlation between pool state and EVM execution
- Enabling tracking of transaction lifecycle from pool to execution
- Supporting debugging of transaction ordering and validation issues

### 5. Parachain Operations

**Evidence:**
- File: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs` (multiple locations)
  - Transaction pool used in collation (line 966)
  - Transaction pool used for block authorship (line 1011-1017)
  - Import notification stream monitored (line 1245)

**Impact:**
Structured logging helps diagnose parachain-specific transaction pool issues:
- Transaction validation during block production
- Pool maintenance during fork scenarios
- Transaction lifecycle in async backing scenarios
- Coordination with relay chain state

## Benefits for Moonbeam

### 1. Enhanced Debugging Capabilities

**Before (with `log` crate):**
```
[DEBUG] Transaction added to pool: 0x1234...
[DEBUG] Validation failed
```

**After (with `tracing` crate):**
```json
{
  "level": "DEBUG",
  "message": "Transaction added to pool",
  "tx_hash": "0x1234...",
  "pool_size": 150,
  "timestamp": "2025-10-22T12:00:00Z"
}
```

The structured format enables:
- Filtering logs by transaction hash
- Correlating events across components
- Building monitoring dashboards
- Automated alerting based on log data

### 2. Improved Production Monitoring

Operators can now:
- Query logs by specific transaction hash without regex parsing
- Build metrics from structured log data
- Export logs to structured logging backends
- Create better alerting rules based on context

### 3. Better Integration with Modern Observability Tools

Structured logs integrate better with:
- **Prometheus**: Can extract metrics from log fields
- **Grafana Loki**: Better log querying with structured fields
- **OpenTelemetry**: Enhanced tracing correlation
- **Elasticsearch**: More efficient log indexing and querying

### 4. No Functional Changes

This is a pure observability improvement:
- No API changes
- No behavior changes
- No migration required
- No performance impact (tracing is zero-cost when disabled)

## Technical Details

### Affected Components

1. **Transaction Pool** (`sc-transaction-pool`):
   - Type: `sc_transaction_pool::TransactionPoolHandle<Block, Client>`
   - Used in: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs` (line 105)
   - Also in lazy loading: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lazy_loading/mod.rs` (line 300)

2. **RPC Layer**:
   - TxPool RPC: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/rpc.rs` (line 345)
   - Runtime API: `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/apis.rs` (line 388)

3. **Logging Configuration**:
   - Existing `sc-tracing` usage ensures compatibility
   - Log level filtering works the same way
   - Existing RUST_LOG environment variable configuration still applies

### Compatibility

The `tracing` crate is backward compatible with the `log` crate:
- Existing log subscribers continue to work
- Log filtering by target and level remains unchanged
- Can gradually adopt structured logging features
- No breaking changes to dependent crates

### Migration Required

**No migration required** - This is an internal implementation change in `sc-transaction-pool`.

## Recommendations

### 1. Log Configuration Review

Consider enhancing RUST_LOG configuration to take advantage of structured logging:
```bash
# Before (works the same)
RUST_LOG=sc_transaction_pool=debug

# After (can add structured filtering in future)
RUST_LOG=sc_transaction_pool=debug
```

### 2. Monitoring Dashboard Updates

Once upgraded to stable2506, consider:
- Adding transaction pool log widgets to Grafana
- Creating alerts based on structured log fields
- Using Loki's LogQL to query transaction-specific logs
- Exporting structured logs to aggregation systems

### 3. Documentation Updates

Update node operator documentation to mention:
- Structured logging capabilities in transaction pool
- How to query logs by transaction hash
- Available structured fields in logs
- Integration with log aggregation tools

### 4. Testing Approach

After upgrade, verify:
- Transaction pool logs appear with expected structure
- Existing log filtering continues to work
- Log levels behave as expected
- No performance degradation in logging

### 5. Development Benefits

Developers can leverage structured logging for:
- Local debugging with better log filtering
- Integration tests that check log output
- Better understanding of transaction pool behavior
- Troubleshooting production issues

## Potential Concerns

### None Identified

This is a low-risk change:
- âœ… No functional changes
- âœ… No API changes
- âœ… Backward compatible with existing logging configuration
- âœ… Minor version bump (no breaking changes)
- âœ… Part of broader Polkadot SDK logging improvement initiative
- âœ… Extensively reviewed (12 commits, multiple maintainer reviews)

## Concrete Evidence Summary

### Direct Usage
- âœ… Moonbeam depends on `sc-transaction-pool` (node/service/Cargo.toml:72)
- âœ… Uses standard transaction pool builder (node/service/src/lib.rs:558-565)
- âœ… Uses transaction pool in multiple contexts (RPC, collation, authoring)

### Observability Infrastructure
- âœ… Uses `sc-tracing` for logging (node/service/Cargo.toml:71)
- âœ… Configures Prometheus metrics (node/service/src/lib.rs:452-456)
- âœ… Uses telemetry infrastructure (node/service/src/lib.rs:493-549)
- âœ… Log prefix decorators (node/service/src/lib.rs:668)

### Transaction Pool Features
- âœ… TxPool RPC enabled via Frontier (node/service/src/rpc.rs:345)
- âœ… Custom TxPoolRuntimeApi implementation (runtime/common/src/apis.rs:388-410)
- âœ… Recent TxPool work (git commit f62d483688: "Replace TxPool RPC")

### Testing
- âœ… Comprehensive txpool integration tests in `/Users/manuelmauro/Workspace/moonbeam/test/suites/dev/moonbase/test-txpool/`
- 10 test files covering various txpool scenarios (limits, pending, future, fairness, etc.)

## Conclusion

PR #8001 is a **beneficial observability improvement** for Moonbeam with no functional changes or migration requirements. The structured logging migration in `sc-transaction-pool` will enhance:
- Production debugging capabilities
- Monitoring and alerting quality
- Integration with modern observability tools
- Developer troubleshooting efficiency

This is a **low-risk, medium-value** change that aligns with Moonbeam's existing observability infrastructure and provides a foundation for better transaction pool monitoring in production environments.

### Key Takeaways
- âœ… No action required for upgrade
- âœ… No breaking changes
- âœ… Improved observability out of the box
- âœ… Optional: Enhance monitoring to leverage structured logs
- âœ… Consider updating documentation for operators
