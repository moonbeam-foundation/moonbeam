# PR #8021: XCMP Batching Implementation

## Overview
- **PR**: https://github.com/paritytech/polkadot-sdk/pull/8021
- **Title**: XCMP: use batching when enqueuing inbound messages
- **Labels**: T6-XCM, I9-optimisation
- **Status**: Merged (April 23, 2025)
- **Audience**: Runtime Dev

## Summary
This PR implements batching for XCMP inbound message enqueueing, delivering approximately 75x performance improvement (from 10181us to 134us for 1000 3-byte messages). The changes introduce batched message processing in the XCMP queue pallet and improved weight metering accuracy.

## Key Changes

### 1. Crate Version Bumps
- `cumulus-pallet-xcmp-queue`: **major** (breaking changes)
- `pallet-message-queue`: **minor** (additions)
- `frame-support`: **major** (breaking trait changes)
- Various runtime crates: **patch** (weight updates)

### 2. Breaking Changes

#### Trait Refactoring
- **New trait**: `QueueFootprintQuery` added to `frame-support/traits/messages.rs`
  - Moves the `footprint()` method out of `EnqueueMessage` trait
  - Provides dedicated interface for querying queue footprint information

- **Removed method**: `HandleMessage::footprint()` removed from `EnqueueMessage` trait
  - Code using `EnqueueMessage::footprint()` must now use `QueueFootprintQuery::footprint()`

#### API Changes in `cumulus-pallet-xcmp-queue`
- **Old**: `enqueue_xcmp_message(id, msg)` - single message
- **New**: `enqueue_xcmp_messages(id, &[msg], &mut meter)` - batched messages with weight metering
  - Accepts slice of messages instead of single message
  - Requires mutable `WeightMeter` reference for accurate weight tracking

#### Benchmark Updates
- `enqueue_2_empty_xcmp_messages()` → `enqueue_n_empty_xcmp_messages()`
- New benchmarks added:
  - `enqueue_n_full_pages()`
  - `enqueue_1000_small_xcmp_messages()`

### 3. Modified Files
- **Core pallets**:
  - `cumulus/pallets/xcmp-queue/src/{lib.rs, benchmarking.rs, tests.rs, weights.rs}`
  - `substrate/frame/message-queue/src/{lib.rs, tests.rs}`
  - `substrate/frame/support/src/traits/messages.rs`

- **Runtime weights**: Updated across multiple parachains (asset-hub, bridge-hub, collectives, coretime, people, etc.)

## Impact on Moonbeam

### Direct Usage Analysis

#### 1. XcmpQueue Pallet Configuration
**Location**: All three runtimes (moonbase, moonriver, moonbeam)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/{moonbase,moonriver,moonbeam}/src/xcm_config.rs`

**Configuration**:
```rust
impl cumulus_pallet_xcmp_queue::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type ChannelInfo = ParachainSystem;
    type VersionWrapper = PolkadotXcm;
    type XcmpQueue = TransformOrigin<MessageQueue, AggregateMessageOrigin, ParaId, ParaIdToSibling>;
    type MaxInboundSuspended = sp_core::ConstU32<1_000>;
    type ControllerOrigin = EnsureRoot<AccountId>;
    type ControllerOriginConverter = XcmOriginToTransactDispatchOrigin;
    type WeightInfo = moonbase_weights::cumulus_pallet_xcmp_queue::WeightInfo<Runtime>;
    type PriceForSiblingDelivery = polkadot_runtime_common::xcm_sender::NoPriceForMessageDelivery<ParaId>;
    type MaxActiveOutboundChannels = ConstU32<128>;
    type MaxPageSize = MessageQueueHeapSize;
}
```

**Impact**: Standard pallet configuration - NO CHANGES REQUIRED to Config implementation.

#### 2. MessageQueue Pallet Configuration
**Location**: All three runtimes (moonbase, moonriver, moonbeam)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/{moonbase,moonriver,moonbeam}/src/xcm_config.rs`

**Configuration**:
```rust
impl pallet_message_queue::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type MessageProcessor = pallet_ethereum_xcm::MessageProcessorWrapper<
        xcm_builder::ProcessXcmMessage<AggregateMessageOrigin, XcmExecutor, RuntimeCall>
    >;
    type Size = u32;
    type HeapSize = MessageQueueHeapSize;
    type MaxStale = MessageQueueMaxStale;
    type ServiceWeight = MessageQueueServiceWeight;
    type QueueChangeHandler = NarrowOriginToSibling<XcmpQueue>;
    type QueuePausedQuery = EmergencyParaXcm;
    type WeightInfo = moonbase_weights::pallet_message_queue::WeightInfo<Runtime>;
    type IdleMaxServiceWeight = MessageQueueServiceWeight;
}
```

**Impact**: Standard pallet configuration - NO CHANGES REQUIRED to Config implementation.

#### 3. Custom Bridge Implementation
**Location**: `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/bridge.rs`

**Code Using `EnqueueMessage` trait**:
```rust
impl<
    MQ: EnqueueMessage<AggregateMessageOrigin>,
    OurPlace: Get<InteriorLocation>,
    OurPlaceBridgeInstance: Get<Option<InteriorLocation>>,
> DispatchBlob for LocalBlobDispatcher<MQ, OurPlace, OurPlaceBridgeInstance>
{
    fn dispatch_blob(blob: Vec<u8>) -> Result<(), DispatchBlobError> {
        // ... blob decoding logic ...

        MQ::enqueue_message(
            msg.as_bounded_slice(),
            AggregateMessageOrigin::Here,
        );

        Ok(())
    }
}
```

**Impact**: Uses `EnqueueMessage::enqueue_message()` method which remains unchanged. The trait refactoring only moved `footprint()` to a separate trait. **NO CHANGES REQUIRED**.

**Code Using `footprint()` method**:
```rust
impl<Runtime: pallet_message_queue::Config> pallet_xcm_bridge::LocalXcmChannelManager
    for CongestionManager<Runtime>
where
    <Runtime as pallet_message_queue::Config>::MessageProcessor:
        ProcessMessage<Origin = AggregateMessageOrigin>,
{
    fn is_congested(_with: &Location) -> bool {
        let book_state =
            pallet_message_queue::Pallet::<Runtime>::footprint(AggregateMessageOrigin::Here);

        book_state.ready_pages >= MESSAGE_QUEUE_CONGESTION_THRESHOLD
    }
}
```

**Impact**: Calls `Pallet::<Runtime>::footprint()` directly on the pallet, not through a trait. This is a pallet method that should remain unchanged. **NO CHANGES REQUIRED**.

#### 4. Weight Files
**Existing weight files**:
- `/Users/manuelmauro/Workspace/moonbeam/runtime/{moonbase,moonriver,moonbeam}/src/weights/cumulus_pallet_xcmp_queue.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/{moonbase,moonriver,moonbeam}/src/weights/pallet_message_queue.rs`

**Current benchmark date**: 2025-09-02

**Impact**: Weight files contain implementations for benchmarks. Need to verify if new benchmark functions exist:
- Current: `enqueue_n_bytes_xcmp_message()`, `enqueue_2_empty_xcmp_messages()`, etc.
- PR adds: `enqueue_n_empty_xcmp_messages()`, `enqueue_n_full_pages()`, `enqueue_1000_small_xcmp_messages()`

**ACTION REQUIRED**: Must regenerate weights to include new benchmark functions and updated weight calculations.

#### 5. Test Mocks
**Location**: XCM mock test files
- `/Users/manuelmauro/Workspace/moonbeam/runtime/{moonbase,moonriver,moonbeam}/tests/xcm_mock/relay_chain.rs`

**Impact**: Mock implementations use standard trait bounds. The trait refactoring is backward compatible for standard usage. **NO CHANGES REQUIRED** to mock configurations.

## Required Actions

### MUST DO

1. **Regenerate Runtime Weights** ⚠️ CRITICAL
   - Weights must be regenerated for both `cumulus-pallet-xcmp-queue` and `pallet-message-queue`
   - New benchmark functions were added in the PR
   - Weight calculations have been updated for batching operations
   - **Command**:
     ```bash
     ./scripts/run-benches-for-runtime.sh moonbase release
     ./scripts/run-benches-for-runtime.sh moonriver release
     ./scripts/run-benches-for-runtime.sh moonbeam release
     ```
   - **Affected files**:
     - `runtime/moonbase/src/weights/cumulus_pallet_xcmp_queue.rs`
     - `runtime/moonbase/src/weights/pallet_message_queue.rs`
     - `runtime/moonriver/src/weights/cumulus_pallet_xcmp_queue.rs`
     - `runtime/moonriver/src/weights/pallet_message_queue.rs`
     - `runtime/moonbeam/src/weights/cumulus_pallet_xcmp_queue.rs`
     - `runtime/moonbeam/src/weights/pallet_message_queue.rs`

2. **Runtime Version Bump**
   - Bump spec_version in all affected runtimes (moonbase, moonriver, moonbeam)
   - Weight changes affect runtime behavior and require version increment

### OPTIONAL

1. **Performance Testing**
   - Test XCM message throughput to verify the 75x performance improvement
   - Run existing XCM integration tests to ensure batching doesn't break functionality
   - Test suite location: `/Users/manuelmauro/Workspace/moonbeam/test/suites/dev/moonbase/test-xcm-*`

2. **Update TypeScript API**
   - If new extrinsics or storage items were added to XcmpQueue or MessageQueue pallets
   - Regenerate TypeScript bindings: `pnpm build` in typescript-api
   - Files: `typescript-api/src/{moonbase,moonriver,moonbeam}/interfaces/`

## Testing Recommendations

### Existing Tests to Run
1. **XCM Integration Tests**:
   ```bash
   cd test
   pnpm moonwall test dev_moonbase
   ```
   Focus on: `test-xcm-v3/`, `test-xcm-erc20-fees-and-trap.ts`

2. **Rust Tests**:
   ```bash
   cargo test -p moonbase-runtime
   cargo test -p moonriver-runtime
   cargo test -p moonbeam-runtime
   ```

3. **Bridge Tests** (if applicable):
   ```bash
   cargo test -p moonbeam-runtime-common bridge
   ```

### New Tests to Consider
1. Test batched message enqueueing under high load
2. Verify weight metering accuracy with batch operations
3. Test congestion detection in bridge code still works correctly

## Risk Assessment

### Low Risk
- No configuration changes required
- No custom trait implementations affected
- Standard pallet usage pattern

### Medium Risk
- Weight calculations have changed significantly
- Must regenerate weights to ensure accurate fee calculation and block weight management
- Performance characteristics have changed (75x improvement) - may expose edge cases

### Mitigation
- Regenerate and review weight files carefully
- Run full integration test suite
- Consider testing on testnet (Moonbase Alpha) before mainnet deployment
- Monitor XCM message processing after deployment

## Conclusion

**Impact Level**: MUST (Weight regeneration required)

**Summary**: This PR introduces significant performance improvements to XCMP message processing through batching. Moonbeam uses both affected pallets (XcmpQueue and MessageQueue) in standard configuration. No code changes are required to runtime configuration or custom implementations, but weight files MUST be regenerated to include new benchmark functions and updated weight calculations.

**Recommendation**:
1. Regenerate all weight files for affected pallets
2. Bump runtime spec_version
3. Test thoroughly on Moonbase Alpha testnet
4. Monitor performance improvements after deployment

**Migration Path**: Straightforward - regenerate weights, bump version, test, deploy.
