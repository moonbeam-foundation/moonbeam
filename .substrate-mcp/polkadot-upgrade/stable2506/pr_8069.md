# PR #8069: Benchmark Storage Access on Block Validation

## Overview

**PR Title:** Benchmark storage access on block validation
**PR URL:** https://github.com/paritytech/polkadot-sdk/pull/8069
**Labels:** T12-benchmarks
**Audience:** Runtime Dev, Node Dev

## Summary

This PR improves the accuracy of storage weight benchmarking by measuring storage access costs during actual block validation rather than standard storage operations. This addresses a critical discrepancy where blocks with high TrieCache hits would produce 20% faster than they validate, leading to inaccurate weight calculations.

### Problem Solved

1. **Issue #7987**: Improving accuracy of parachain weight benchmarking
2. **Issue #7868**: Discrepancy between block production and validation performance

The previous benchmarking methodology didn't accurately measure storage access costs during actual block validation, resulting in weights that didn't reflect real-world validator performance.

### Technical Changes

The PR introduces a new benchmarking mode that simulates "on_block_validation" conditions by:
- Measuring storage access as it occurs during block validation
- Capturing actual validator hardware behavior
- Providing more consistent and predictable performance metrics

Testing on asset-hub-westend showed:
- **Read performance**: Average of ~11,495 cycles (vs. 24,538 on master) - ~53% improvement
- **Consistency**: Much lower standard deviation
- Hardware: Apple MacBook M2 Pro reference system

## Affected Crates

| Crate | Bump | Used by Moonbeam |
|-------|------|------------------|
| `cumulus-pallet-parachain-system` | minor | ✅ Yes - All 3 runtimes |
| `frame-benchmarking-cli` | minor | ✅ Yes - Node CLI |
| `frame-storage-access-test-runtime` | major | ❌ No |

## Impact on Moonbeam

### 1. Direct Usage - cumulus-pallet-parachain-system

**Evidence:** All three Moonbeam runtimes use this pallet:

```toml
# /Users/manuelmauro/Workspace/moonbeam/Cargo.toml
cumulus-pallet-parachain-system = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2503", default-features = false }
```

**Runtime Integration:**
- **Moonbeam**: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs:1413`
- **Moonriver**: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs:1417`
- **Moonbase**: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs:1423`

All runtimes:
1. Include ParachainSystem in `construct_runtime!`
2. Enable `runtime-benchmarks` feature
3. Include ParachainSystem in benchmark definitions

**Current Benchmark Weights:**

Moonbeam maintains benchmark weights for this pallet:
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/weights/cumulus_pallet_parachain_system.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/weights/cumulus_pallet_parachain_system.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/weights/cumulus_pallet_parachain_system.rs`

Example from Moonbase (generated Sept 2, 2025):
```rust
//! Autogenerated weights for `cumulus_pallet_parachain_system`
//!
//! THIS FILE WAS AUTO-GENERATED USING THE SUBSTRATE BENCHMARK CLI VERSION 48.0.0
//! DATE: 2025-09-02, STEPS: `50`, REPEAT: `20`, LOW RANGE: `[]`, HIGH RANGE: `[]`
//! WORST CASE MAP SIZE: `1000000`
//! HOSTNAME: `ip-10-0-0-198`, CPU: `Intel(R) Xeon(R) Platinum 8375C CPU @ 2.90GHz`
//! WASM-EXECUTION: Compiled, CHAIN: None, DB CACHE: 1024

// Executed Command:
// ./frame-omni-bencher v1 benchmark pallet
// --runtime=./target/production/wbuild/moonbase-runtime/moonbase_runtime.wasm
// --genesis-builder=runtime --genesis-builder-preset=development
// --steps=50 --repeat=20
// --pallet=cumulus_pallet_parachain_system --extrinsic=*
// --wasm-execution=compiled
```

### 2. Direct Usage - frame-benchmarking-cli

**Evidence:** Used in node CLI for running benchmarks:

```toml
# /Users/manuelmauro/Workspace/moonbeam/node/cli/Cargo.toml
frame-benchmarking-cli = { workspace = true }
```

**Storage Benchmark Integration:**

The CLI supports storage benchmarking (from `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs:610-674`):

```rust
#[cfg(feature = "runtime-benchmarks")]
BenchmarkCmd::Storage(cmd) => {
    let chain_spec = &runner.config().chain_spec;
    let rpc_config = cli.run.new_rpc_config();
    match chain_spec {
        spec if spec.is_moonbeam() => {
            return runner.sync_run(|mut config| {
                let params = moonbeam_service::new_partial::<
                    moonbeam_service::moonbeam_runtime::RuntimeApi,
                    moonbeam_service::MoonbeamCustomizations,
                >(&mut config, &rpc_config, false, cli.run.legacy_block_import_strategy)?;

                let db = params.backend.expose_db();
                let storage = params.backend.expose_storage();

                cmd.run(config, params.client, db, storage)
            })
        }
        // ... similar for moonriver and moonbase
    }
}
```

### 3. Storage Weight Configuration

**Current Storage Weights:**

All runtimes use RocksDB storage weights defined in `/Users/manuelmauro/Workspace/moonbeam/runtime/{runtime}/src/weights/db/rocksdb.rs`

Example from Moonbase (from Sept 22, 2025 benchmark run):
```rust
//! THIS FILE WAS AUTO-GENERATED USING THE SUBSTRATE BENCHMARK CLI VERSION 48.0.0
//! DATE: 2025-09-22 (Y/M/D)
//! HOSTNAME: `ip-10-0-0-176`, CPU: `Intel(R) Xeon(R) Platinum 8375C CPU @ 2.90GHz`
//!
//! DATABASE: `RocksDb`, RUNTIME: `Moonbeam`
//! BLOCK-NUM: `BlockId::Number(12630729)`
//! SKIP-WRITE: `false`, SKIP-READ: `false`, WARMUPS: `1`
//! STATE-VERSION: `V1`, STATE-CACHE-SIZE: ``
//! WEIGHT-PATH: `./benchmarks/storage/20250922-082315/disk-weights-rocksdb-moonbeam.rs`
//! METRIC: `Average`, WEIGHT-MUL: `1.1`, WEIGHT-ADD: `0`

// Executed Command:
//   ./moonbeam benchmark storage --db=rocksdb --state-version=1 --mul=1.1
//   --weight-path ./benchmarks/storage/20250922-082315/disk-weights-rocksdb-moonbeam.rs
//   --chain moonbeam --base-path /mnt/disk3-6000-256/rocksdb-moonbeam-data
//   --keys-limit 50000000 --random-seed 1024

pub const RocksDbWeight: RuntimeDbWeight = RuntimeDbWeight {
    // Time to read one storage item: 59,217 ns (Average: 53,833 ns)
    read: 59_217 * constants::WEIGHT_REF_TIME_PER_NANOS,

    // Time to write one storage item: 96,315 ns (Average: 87,559 ns)
    write: 96_315 * constants::WEIGHT_REF_TIME_PER_NANOS,
};
```

**Usage in Runtime:**
```rust
// /Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs:299
type DbWeight = moonbase_weights::db::rocksdb::constants::RocksDbWeight;
```

These weights are used throughout the runtime for calculating storage costs.

### 4. Historical Context

Moonbeam recently updated storage benchmarks in commit d105244dda (Sept 26, 2025) - **PR #3459**:
- Updated all three runtime storage benchmark weights
- Adjusted multiple test snapshots to reflect new storage costs
- Updated constants like `STORAGE_READ_COST` in tests
- Modified XCM weight calculations

This shows active maintenance of storage weights and awareness of their importance.

## Concrete Impact Analysis

### Direct Impact: ✅ HIGH

**Why this matters for Moonbeam:**

1. **As a Parachain:** Moonbeam is a parachain that relies on `cumulus-pallet-parachain-system` for core parachain functionality. Accurate storage weights during block validation are critical for:
   - Proper block execution time estimation
   - Avoiding block production/validation mismatches
   - Ensuring blocks don't exceed PoV (Proof of Validity) limits

2. **Storage-Heavy Operations:** Moonbeam is an EVM-compatible chain with significant storage access patterns:
   - EVM state reads/writes
   - Account balances and nonces
   - Smart contract storage
   - Cross-chain message handling (XCM)

3. **Weight Accuracy Critical:** Incorrect storage weights could lead to:
   - Blocks that validate slower than they produce (validator rejections)
   - Underutilization of block space (if weights are too conservative)
   - Potential DoS vectors (if weights are too lenient)

### Performance Implications

**Expected Improvements:**
- More accurate storage weights reflecting actual block validation costs
- Better consistency between different benchmark runs
- Reduced standard deviation in measurements

**Based on upstream results (~53% improvement in read performance):**
- Current Moonbase read weight: 59,217 ns
- Potential new weight: ~27,712 ns (if similar improvement applies)
- This would significantly affect weight calculations across all storage-heavy operations

### Breaking Changes

**None expected** - This is a minor bump to both affected crates. The changes are:
- Internal improvements to benchmarking methodology
- Enhanced accuracy without API changes
- No migration required

## Action Items

### Required Actions

1. **Re-run Storage Benchmarks** (RECOMMENDED)

   After upgrading to stable2506, re-run storage benchmarks using the new methodology:

   ```bash
   # Build with benchmarking enabled
   cargo build --release --features=runtime-benchmarks

   # Run storage benchmarks for each runtime
   ./target/release/moonbeam benchmark storage \
     --db=rocksdb \
     --state-version=1 \
     --mul=1.1 \
     --chain moonbeam \
     --base-path <path-to-moonbeam-data> \
     --keys-limit 50000000 \
     --random-seed 1024

   # Repeat for moonriver and moonbase
   ```

   The new benchmarking methodology will automatically be used if the upgrade includes this PR.

2. **Update Storage Weight Files**

   After benchmarking, update:
   - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/weights/db/rocksdb.rs`
   - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/weights/db/rocksdb.rs`
   - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/weights/db/rocksdb.rs`

3. **Re-run Pallet Benchmarks for ParachainSystem**

   Update weights for cumulus-pallet-parachain-system:

   ```bash
   ./scripts/run-benches-for-runtime.sh moonbase release
   ```

   This will regenerate weights for all pallets including ParachainSystem.

4. **Update Test Snapshots**

   Based on PR #3459, storage weight changes affect:
   - Rust integration tests: `runtime/{runtime}/tests/integration_test.rs`
   - TypeScript test constants: `test/helpers/constants.ts`
   - Inline snapshots in various test files

   Run tests and update snapshots as needed:
   ```bash
   cargo test
   cd test && pnpm moonwall test dev_moonbase
   ```

5. **Verify XCM Weight Calculations**

   Storage weight changes may affect XCM operation costs. Review and test:
   - `/Users/manuelmauro/Workspace/moonbeam/runtime/{runtime}/src/weights/xcm/generic.rs`
   - XCM-related tests in test suite

### Testing Recommendations

1. **Benchmark Comparison:**
   - Run benchmarks before and after upgrade
   - Compare the differences in read/write weights
   - Document significant changes (>10% difference)

2. **Integration Testing:**
   - Run full test suite to catch weight-related test failures
   - Pay special attention to:
     - Fee calculation tests
     - PoV size tests
     - XCM cost tests
     - Block weight limit tests

3. **DevNet Validation:**
   - Deploy updated weights to a test network
   - Monitor block production and validation times
   - Ensure no performance regressions

## Technical Details

### Files to Review

**Core Runtime Files:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs` (line 1413, 1548)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs` (line 1417, 1547)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs` (line 1423, 1554)

**Weight Files:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/*/src/weights/cumulus_pallet_parachain_system.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/*/src/weights/db/rocksdb.rs`

**CLI Implementation:**
- `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs` (lines 605-674)

**Benchmark Scripts:**
- `/Users/manuelmauro/Workspace/moonbeam/scripts/run-benches-for-runtime.sh`
- `/Users/manuelmauro/Workspace/moonbeam/scripts/benchmarking.sh`

### Cargo Dependencies

```toml
# Current version
cumulus-pallet-parachain-system v0.20.0
  (https://github.com/moonbeam-foundation/polkadot-sdk?branch=moonbeam-polkadot-stable2503)

# After upgrade to stable2506
cumulus-pallet-parachain-system v0.20.x (minor bump expected)
```

## Risk Assessment

**Risk Level:** 🟡 MEDIUM

**Risks:**
1. **Weight Changes:** New benchmarking methodology may produce different weights
   - Could affect block capacity calculations
   - May require test snapshot updates

2. **Testing Effort:** Significant testing required to validate new weights
   - Re-run all benchmarks
   - Update test expectations
   - Validate on test networks

**Mitigation:**
- This is a methodology improvement, not a breaking change
- Changes are well-tested upstream
- Moonbeam has recent experience updating storage weights (PR #3459)
- Follow established benchmarking procedures

## Priority Assessment

**Priority:** 🟢 MEDIUM-HIGH

**Rationale:**
1. **Accuracy Improvement:** Significantly improves weight accuracy (53% improvement in reads)
2. **Parachain Critical:** Affects core parachain functionality
3. **Performance Impact:** Better weights = better block space utilization
4. **Non-Breaking:** Minor version bumps, no migrations required

**Recommended Timeline:**
- Review: During stable2506 upgrade planning
- Implementation: Part of normal upgrade cycle
- Testing: Before production deployment
- Deployment: With stable2506 upgrade

## Related PRs

- **Issue #7987:** Improving accuracy of parachain weight benchmarking
- **Issue #7868:** Block production vs validation performance discrepancy
- **Moonbeam PR #3459:** Recent storage benchmark update (Sept 2025)

## References

- **PRDoc:** `/Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_8069.prdoc`
- **GitHub PR:** https://github.com/paritytech/polkadot-sdk/pull/8069
- **Moonbeam Project:** `/Users/manuelmauro/Workspace/moonbeam`

## Conclusion

PR #8069 represents a significant improvement in benchmarking accuracy for parachains. For Moonbeam:

✅ **Direct Impact:** Uses both affected crates extensively
✅ **Relevance:** Critical for parachain block validation
✅ **Action Required:** Re-run benchmarks after upgrade
✅ **Risk:** Manageable with proper testing
✅ **Priority:** Should be included in stable2506 upgrade

The improved benchmarking methodology will result in more accurate storage weights, leading to better block space utilization and more predictable validator performance. The main work required is re-running benchmarks and updating test expectations, which aligns with Moonbeam's existing benchmark maintenance practices.
