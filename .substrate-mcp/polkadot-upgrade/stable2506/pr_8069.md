# PR #8069: Benchmark Storage Access on Block Validation

## Overview
**Title**: Benchmark storage access on block validation
**PR**: https://github.com/paritytech/polkadot-sdk/pull/8069
**Labels**: T12-benchmarks
**Audience**: Runtime Dev, Node Dev

## Summary
This PR adds benchmarking capabilities to measure storage read/write costs during block validation, enabling more accurate performance measurements that capture validator-side behavior. Previously, storage benchmarks only measured block import performance, which differs from validation.

### Key Changes
1. **Block validation mode**: New `StorageBenchmarkMode` enum supporting both `ImportBlock` and `ValidateBlock` modes
2. **Public APIs**: Made `trie_cache` and `trie_recorder` modules public in `cumulus-pallet-parachain-system` to support validation benchmarking
3. **Test runtime**: New `frame-storage-access-test-runtime` for benchmarking storage access patterns
4. **Infrastructure**: Added `validate_block_rounds` parameter and `MAX_BATCH_SIZE_FOR_BLOCK_VALIDATION` constant

### Modified Crates
- `cumulus-pallet-parachain-system` (minor bump) - Exposed internal modules for benchmarking
- `frame-benchmarking-cli` (minor bump) - Added block validation benchmarking support
- `frame-storage-access-test-runtime` (major bump) - New test runtime crate

### Performance Impact
Benchmark results showed significant improvements (nearly 50% reduction in read costs) on asset-hub-westend when measuring validation vs. import performance, leading to follow-up optimizations (PR #8606) that yielded additional 40% read cost and 20% write cost improvements.

## Impact Assessment

### Impact Level: **INHERITED**

### Rationale
Moonbeam will **inherit** this functionality through dependency updates with no required changes. The PR introduces additive features that enhance benchmarking capabilities without breaking existing APIs.

### Evidence

#### 1. Dependency Usage
Moonbeam uses both affected crates:

**Runtime dependency on cumulus-pallet-parachain-system:**
```toml
# runtime/moonbase/Cargo.toml:155
cumulus-pallet-parachain-system = { workspace = true }
```

**CLI dependency on frame-benchmarking-cli:**
```toml
# node/cli/Cargo.toml:20
frame-benchmarking-cli = { workspace = true }
```

#### 2. Storage Benchmark Implementation
Moonbeam implements and actively uses storage benchmarking in `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs` (lines 605-674):

```rust
#[cfg(feature = "runtime-benchmarks")]
BenchmarkCmd::Storage(cmd) => {
    let chain_spec = &runner.config().chain_spec;
    let rpc_config = cli.run.new_rpc_config();
    match chain_spec {
        #[cfg(feature = "moonriver-native")]
        spec if spec.is_moonriver() => {
            return runner.sync_run(|mut config| {
                let params = moonbeam_service::new_partial::<
                    moonbeam_service::moonriver_runtime::RuntimeApi,
                    moonbeam_service::MoonriverCustomizations,
                >(...)?;

                let db = params.backend.expose_db();
                let storage = params.backend.expose_storage();

                cmd.run(config, params.client, db, storage)
            })
        }
        // Similar for moonbeam and moonbase runtimes...
    }
}
```

#### 3. Active Storage Benchmark Usage
Moonbeam actively generates storage weights from benchmarks, as evidenced by auto-generated files:

**Storage weights files:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/weights/db/rocksdb.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/weights/db/rocksdb.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/weights/db/rocksdb.rs`

**Example from moonbase rocksdb.rs (lines 28-44):**
```rust
// Executed Command:
//   ./moonbeam
//   benchmark
//   storage
//   --db=rocksdb
//   --state-version=1
//   --mul=1.1
//   --weight-path
//   ./benchmarks/storage/20250922-082315/disk-weights-rocksdb-moonbeam.rs
//   --chain
//   moonbeam
//   --base-path
//   /mnt/disk3-6000-256/rocksdb-moonbeam-data
//   --keys-limit
//   50000000
//   --random-seed
//   1024
```

Last updated: 2025-09-22

#### 4. Changes Analysis

**cumulus-pallet-parachain-system changes (minor bump):**
- Made `trie_cache` module public (exposing `TrieCache` and `CacheProvider`)
- Made `trie_recorder` module public (exposing `SizeOnlyRecorder` and `SizeOnlyRecorderProvider`)
- These are **additive changes** that expose more APIs without breaking existing ones

**frame-benchmarking-cli changes (minor bump):**
- Added new `StorageBenchmarkMode` enum with `ImportBlock` and `ValidateBlock` variants
- Added `validate_block_rounds` parameter for controlling validation benchmark iterations
- Default mode remains `ImportBlock`, maintaining backward compatibility
- These are **additive features** that don't affect existing storage benchmark invocations

#### 5. No Breaking Changes
The existing storage benchmark command signature remains unchanged:
```rust
cmd.run(config, params.client, db, storage, shared_trie_cache)
```

The new functionality is **opt-in** through CLI flags and does not affect current Moonbeam usage.

## Available Enhancements (Optional)

While no changes are required, Moonbeam could optionally benefit from the new features:

### 1. Block Validation Benchmarking
The new validation mode provides more accurate measurements for parachain validators:

```bash
# Current usage (import mode - default)
./target/release/moonbeam benchmark storage \
  --db=rocksdb \
  --chain=moonbase-dev

# New validation mode (optional)
./target/release/moonbeam benchmark storage \
  --db=rocksdb \
  --chain=moonbase-dev \
  --mode=validate-block \
  --validate-block-rounds=20
```

### 2. Performance Comparison
The validation mode can reveal discrepancies between import and validation costs, potentially leading to:
- More accurate weight calibration for validators
- Identification of optimization opportunities (as demonstrated by the 50% improvement on asset-hub-westend)

### 3. Documentation Update
If Moonbeam decides to use validation benchmarking, update internal documentation to include the new flags.

## No Action Required

### Why INHERITED, Not MUST:
1. **Minor version bumps**: Both affected crates received minor bumps, indicating backward compatibility
2. **Additive changes**: New APIs and modes are additions, not modifications to existing interfaces
3. **No compilation errors**: Existing code will compile without modifications
4. **Opt-in functionality**: New features require explicit CLI flags to activate
5. **Default behavior unchanged**: Without new flags, storage benchmarks work exactly as before

### Moonbeam's Current Implementation:
- Uses storage benchmarking via `BenchmarkCmd::Storage`
- Calls `cmd.run(config, params.client, db, storage, shared_trie_cache)` with existing signature
- This continues to work without modification after the upgrade
- The new `ValidateBlock` mode and public trie APIs are available but not required

## Testing Recommendations

### Verification (Optional):
1. **Confirm existing functionality**: Run current storage benchmark commands to ensure they still work:
   ```bash
   cargo build --release --features runtime-benchmarks
   ./target/release/moonbeam benchmark storage --db=rocksdb --chain=moonbase-dev
   ```

2. **Explore new mode** (optional): Test validation benchmarking to compare performance:
   ```bash
   ./target/release/moonbeam benchmark storage \
     --db=rocksdb \
     --chain=moonbase-dev \
     --mode=validate-block \
     --validate-block-rounds=20
   ```

## Related Changes

This PR addresses issues #7987 and #7868 regarding parachain weight benchmarking accuracy. A follow-up PR (#8606) used these benchmarking results to optimize storage backend implementations, yielding 40% read and 20% write cost improvements.

## References

- PRDoc: `/Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_8069.prdoc`
- GitHub PR: https://github.com/paritytech/polkadot-sdk/pull/8069
- Related PR #7867: Storage benchmark accuracy improvements (MUST - breaking API changes)
- Related PR #8606: Storage backend optimizations based on these benchmarks
- Moonbeam Storage Command: `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs:605-674`
- Storage Weights: `runtime/*/src/weights/db/rocksdb.rs`
