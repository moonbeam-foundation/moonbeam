# PR #8072: RFC-0008 - Store Parachain Bootnodes in Relay Chain DHT

## Overview

**Title**: RFC-0008: Store parachain bootnodes in the relay chain DHT
**Labels**: T0-node, T9-cumulus
**Audience**: Node Dev

This PR implements RFC-0008, which fundamentally changes how parachain nodes discover and connect to each other by storing bootnode information in the relay chain's Distributed Hash Table (DHT) instead of requiring hardcoded bootnodes in chainspecs.

## What Changed

### Core Mechanism
- **Every parachain node can now act as a bootnode**: When a node's peer ID is close to the parachain key for the current relay chain epoch, it becomes discoverable via the relay chain DHT
- **Automatic bootnode discovery**: Parachain nodes can discover bootnodes dynamically through DHT queries
- **New request-response protocol**: A `/paranode` protocol was added for direct bootnode information requests
- **Enabled by default**: The DHT bootnode functionality is active by default for all parachain nodes

### New CLI Flags
- `--no-dht-bootnode`: Disables a node's DHT bootnode advertising capability
- `--no-dht-bootnode-discovery`: Disables DHT-based bootnode discovery

### Breaking Changes
The PR includes **MAJOR version bumps** for:
- `cumulus-client-cli` (major)
- `sc-network` (major)

And **minor version bumps** for numerous cumulus and networking crates:
- `cumulus-relay-chain-inprocess-interface`
- `cumulus-relay-chain-interface`
- `cumulus-relay-chain-minimal-node`
- `cumulus-relay-chain-rpc-interface`
- `cumulus-client-service`
- `cumulus-client-network`
- `cumulus-client-consensus-common`
- Multiple other cumulus crates

## Impact on Moonbeam

### 1. Direct Code Impact - CONFIRMED

#### CLI Integration (HIGH IMPACT)
**Evidence**: `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/cli.rs`

Moonbeam's CLI wraps `cumulus_client_cli::RunCmd`:
```rust
// Line 154
pub base: cumulus_client_cli::RunCmd,

// Lines 388-393
impl std::ops::Deref for RunCmd {
    type Target = cumulus_client_cli::RunCmd;
    fn deref(&self) -> &Self::Target {
        &self.base
    }
}
```

**Impact**: The MAJOR version bump in `cumulus-client-cli` indicates breaking API changes that may affect:
- Command line argument parsing
- Configuration options
- The new flags (`--no-dht-bootnode` and `--no-dht-bootnode-discovery`) are now available to Moonbeam nodes

#### Network Layer (HIGH IMPACT)
**Evidence**: Multiple locations use `sc_network::NetworkWorker`

```rust
// node/service/src/lib.rs:1115
start_node_impl::<RuntimeApi, Customizations, sc_network::NetworkWorker<_, _>>(

// node/cli/src/command.rs:801, 816, 831, 871
sc_network::NetworkWorker<_, _>
```

**Impact**: The MAJOR version bump in `sc-network` affects Moonbeam's network initialization and operation.

### 2. Chainspec Configurations - SIGNIFICANT CHANGES POSSIBLE

#### Existing Bootnode Configurations
**Evidence**: Moonbeam maintains hardcoded bootnodes in all network chainspecs

**Moonbeam MainNet** (`/Users/manuelmauro/Workspace/moonbeam/specs/moonbeam/parachain-embedded-specs.json`):
```json
"bootNodes": [
  "/dns4/del-moonbeam-boot-1.moonbeam.ol-infra.network/tcp/30333/p2p/12D3KooWCSHmCQYeSpt7LC8B6sePi6zN89saSWEhBs9VbkDvxHar",
  "/dns4/fro-moonbeam-boot-1.moonbeam.ol-infra.network/tcp/30333/p2p/12D3KooWN9HEoJHEi6VzemrFgyiY2vjTPhcSMKAb4qQ9hUyRKQsU",
  "/dns4/ukl-moonbeam-boot-1.moonbeam.ol-infra.network/tcp/30333/p2p/12D3KooWAHrxxSWaV2WGaP2a3Fyueurxi6SAMCRzgjzUtVZSu9Zx",
  "/dns4/sino-moonbeam-boot-1.moonbeam.ol-infra.network/tcp/30333/p2p/12D3KooWREsu1J1T76YGHL77BLrJYTdfWZBd4eY4Kbwfa2DqUhoh",
  ... (15+ bootnodes total)
]
```

Similar configurations exist for:
- Moonriver: `/Users/manuelmauro/Workspace/moonbeam/specs/moonriver/parachain-embedded-specs.json`
- Alphanet: `/Users/manuelmauro/Workspace/moonbeam/specs/alphanet/parachain-embedded-specs-v8.json`

**Impact**: With DHT-based bootnode discovery:
- These hardcoded bootnodes become **optional** rather than required
- The network becomes more resilient (no single point of failure)
- Any Moonbeam collator can serve as a bootnode for new nodes

### 3. Operational Impact - MEDIUM

#### Build Scripts
**Evidence**: `/Users/manuelmauro/Workspace/moonbeam/scripts/generate-parachain-specs.sh`

The script already generates bootnode-free versions:
```bash
# Lines 38-41
grep -v '/p2p/' $ALPHANET_PARACHAIN_EMBEDDED_SPEC > \
  $ALPHANET_BUILD_FOLDER/parachain-embedded-no-bootnodes-specs.json
grep -v '/p2p/' $ALPHANET_ROCOCO_EMBEDDED_SPEC > \
  $ALPHANET_BUILD_FOLDER/rococo-embedded-no-bootnodes-specs.json
```

**Impact**: This infrastructure can now be leveraged for DHT-based discovery.

#### Local Development Scripts
**Evidence**:
- `/Users/manuelmauro/Workspace/moonbeam/scripts/run-moonbase-dev.sh` (line 27)
- `/Users/manuelmauro/Workspace/moonbeam/scripts/run-alphanet-parachain.sh` (lines 47, 64)

These scripts use `--bootnodes` flags for local testing networks.

**Impact**: Local development workflows remain unchanged; the `--bootnodes` flag still works alongside DHT discovery.

### 4. Dependencies - REQUIRES UPDATE

**Evidence**: `/Users/manuelmauro/Workspace/moonbeam/Cargo.toml`

Current dependencies that need updating:
```toml
cumulus-client-cli = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2503" }
sc-network = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2503" }
```

**Impact**: These must be updated to stable2506 which includes PR #8072.

## Benefits for Moonbeam

1. **Improved Decentralization**: Removes dependency on hardcoded bootnode infrastructure
2. **Better Resilience**: Network discovery doesn't rely on specific servers being online
3. **Simplified Operations**: Less bootnode infrastructure to maintain
4. **Automatic Scaling**: As the network grows, more nodes automatically become available for discovery
5. **Backwards Compatible**: Existing hardcoded bootnodes still work; this adds a complementary discovery mechanism

## Required Actions

### 1. Code Updates
- **REQUIRED**: Update to stable2506 branch (includes all dependency version bumps)
- **VERIFY**: Ensure no breaking changes in `cumulus-client-cli` API usage
- **VERIFY**: Ensure no breaking changes in `sc-network` usage
- **COMPILE**: Run `cargo build --release` to catch any API incompatibilities

### 2. Configuration Review
- **EVALUATE**: Whether to keep, reduce, or remove hardcoded bootnodes from chainspecs
- **CONSIDER**: For production networks (Moonbeam, Moonriver), keeping some hardcoded bootnodes initially for redundancy may be prudent
- **DOCUMENT**: Update network documentation to explain DHT-based bootnode discovery

### 3. Testing Requirements
- **TEST**: Node startup with DHT bootnode discovery enabled (default behavior)
- **TEST**: Node startup with `--no-dht-bootnode-discovery` flag
- **TEST**: Verify nodes can discover each other via DHT in testnet environments
- **TEST**: Ensure existing `--bootnodes` flag still works correctly
- **TEST**: Network formation from genesis with minimal or no hardcoded bootnodes

### 4. Operational Planning
- **MONITOR**: DHT bootnode discovery effectiveness in testnet (Alphanet/Moonbase)
- **DOCUMENT**: Update operator documentation with new CLI flags
- **COMMUNICATE**: Inform node operators about the new discovery mechanism
- **GRADUAL ROLLOUT**: Consider phased approach:
  1. Enable DHT discovery alongside existing bootnodes
  2. Monitor network health and connectivity
  3. Potentially reduce hardcoded bootnodes in future releases

### 5. Documentation Updates
- **CLI Reference**: Add new flags to Moonbeam CLI documentation
- **Network Architecture**: Update documentation explaining DHT-based discovery
- **Migration Guide**: Document transition from hardcoded to DHT-based bootnodes
- **Operator Guide**: Explain when to use `--no-dht-bootnode` or `--no-dht-bootnode-discovery`

## Risk Assessment

**Risk Level**: MEDIUM

### Risks
1. **API Compatibility**: MAJOR version bumps may introduce breaking changes
2. **Network Formation**: DHT discovery effectiveness in production needs validation
3. **Relay Chain Dependency**: DHT discovery requires functional relay chain connection

### Mitigations
1. **Comprehensive Testing**: Test DHT discovery in testnet environments first
2. **Keep Redundancy**: Maintain hardcoded bootnodes initially as fallback
3. **Gradual Migration**: Don't remove existing bootnodes until DHT discovery proven reliable
4. **Monitoring**: Add metrics to track DHT vs hardcoded bootnode connection success rates

## Timeline Recommendation

1. **Immediate**: Update dependencies and compile with stable2506
2. **Week 1**: Comprehensive testing on local and testnet environments
3. **Week 2-3**: Deploy to Moonbase Alpha/Alphanet with monitoring
4. **Week 4+**: Evaluate results before considering changes to production networks
5. **Future**: Consider reducing (but not eliminating) hardcoded bootnodes based on DHT performance

## References

- RFC-0008: https://polkadot-fellows.github.io/RFCs/approved/0008-parachain-bootnodes-dht.html
- PRDoc: `/Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_8072.prdoc`
- GitHub PR: https://github.com/paritytech/polkadot-sdk/pull/8072

## Conclusion

PR #8072 represents a significant architectural improvement for parachain networking. For Moonbeam, the impact is **MEDIUM-HIGH**:

- **Code changes required**: Dependency updates and potential API adjustments
- **Infrastructure benefits**: Improved decentralization and resilience
- **Deployment strategy**: Incremental rollout recommended
- **Risk level**: MEDIUM with proper testing and gradual deployment

The DHT bootnode discovery mechanism complements rather than replaces existing infrastructure, allowing for a smooth transition and improved network robustness over time.
