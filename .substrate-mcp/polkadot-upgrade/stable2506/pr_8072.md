# PR 8072: RFC-0008: Store Parachain Bootnodes in the Relay Chain DHT

## Overview

**PR**: https://github.com/paritytech/polkadot-sdk/pull/8072
**Labels**: T0-node, T9-cumulus
**Impact Level**: **INHERITED**

## Summary

This PR implements RFC-0008, which introduces a decentralized bootnode discovery mechanism for parachains via the relay chain DHT. Instead of requiring hardcoded bootnodes in chain specifications, parachain nodes can now discover each other dynamically through the relay chain's distributed hash table (DHT).

## Technical Changes

### New Components

1. **New Crate: `cumulus-client-bootnodes`**
   - Handles parachain bootnode registration and discovery
   - Implements request-response protocol (`/paranode`)
   - Provides background tasks for DHT advertisement and discovery
   - Protocol buffer definitions for bootnode responses

2. **CLI Integration**
   - Added two new CLI flags to `cumulus-client-cli`:
     - `--no-dht-bootnode`: Disable DHT bootnode advertisement
     - `--no-dht-bootnode-discovery`: Disable DHT bootnode discovery
   - Mechanism is **enabled by default** (opt-out)

3. **Service Layer Changes**
   - `cumulus-client-service`: Integrated bootnode tasks into parachain service startup
   - `start_relay_chain_tasks`: May have signature changes to support new functionality

4. **Network Layer Changes**
   - `sc-network`: Extended DHT event types with new events:
     - `StartedProviding`
     - `NoMoreProviders`
     - `AddressesFound`
     - Peer discovery queries

### Crate Version Impacts

**MAJOR Bumps (Breaking Changes)**:
- `cumulus-client-cli`: MAJOR bump - likely changes to `CollatorOptions` struct
- `sc-network`: MAJOR bump - network event API changes

**MINOR Bumps**:
- `cumulus-relay-chain-interface`: Minor bump
- `cumulus-relay-chain-inprocess-interface`: Minor bump
- `cumulus-client-service`: Minor bump
- Various other cumulus crates: Minor bumps

## Moonbeam-Specific Analysis

### Current Moonbeam Architecture

1. **Dependency Usage**:
   ```rust
   // node/service/src/lib.rs:27
   use cumulus_client_cli::CollatorOptions;

   // node/service/src/lib.rs:32-35
   use cumulus_client_service::{
       prepare_node_config, start_relay_chain_tasks, CollatorSybilResistance, DARecoveryProfile,
       ParachainHostFunctions, StartRelayChainTasksParams,
   };

   // node/service/src/lib.rs:66
   use sc_network::{config::FullNetworkConfiguration, NetworkBackend, NetworkBlock};
   ```

2. **CollatorOptions Usage**:
   ```rust
   // node/cli/src/command.rs:757
   let collator_options = cli.run.collator_options();

   // node/service/src/lib.rs:638, 672, 1100
   // CollatorOptions passed to service initialization functions
   ```

3. **Relay Chain Tasks**:
   ```rust
   // node/service/src/lib.rs:934-949
   start_relay_chain_tasks(StartRelayChainTasksParams {
       client: client.clone(),
       announce_block: announce_block.clone(),
       para_id,
       relay_chain_interface: relay_chain_interface.clone(),
       task_manager: &mut task_manager,
       da_recovery_profile: if collator {
           DARecoveryProfile::Collator
       } else {
           DARecoveryProfile::FullNode
       },
       import_queue: import_queue_service,
       relay_chain_slot_duration,
       recovery_handle: Box::new(overseer_handle.clone()),
       sync_service: sync_service.clone(),
   })?;
   ```

### Current Bootnode Management

Moonbeam currently maintains **hardcoded bootnodes** in chain specification files:

**Evidence**:
- `/specs/moonbeam/parachain-embedded-specs.json`: 15 bootnodes configured
- `/specs/moonriver/parachain-embedded-specs.json`: Similar bootnode configuration
- `/specs/alphanet/parachain-embedded-specs-v8.json`: Testnet bootnodes

**Example bootnodes**:
```json
[
  "/dns4/del-moonbeam-boot-1.moonbeam.ol-infra.network/tcp/30333/p2p/12D3KooWCSHmCQYeSpt7LC8B6sePi6zN89saSWEhBs9VbkDvxHar",
  "/dns4/fro-moonbeam-boot-1.moonbeam.ol-infra.network/tcp/30333/p2p/12D3KooWN9HEoJHEi6VzemrFgyiY2vjTPhcSMKAb4qQ9hUyRKQsU",
  "/dns4/ukl-moonbeam-boot-1.moonbeam.ol-infra.network/tcp/30333/p2p/12D3KooWAHrxxSWaV2WGaP2a3Fyueurxi6SAMCRzgjzUtVZSu9Zx"
]
```

**Maintenance History**:
Moonbeam has a significant history of bootnode updates, showing this is an ongoing operational concern:
- c315e70dce: Update bootnodes (#3057) - Nov 2024
- bec007bf02: chore: removes Onfinality offline bootnodes (#3050)
- 7a437ac690: add bootnode to moonbeam (#2995)
- c1417e62a7: added Onfinality bootnodes (#2771)
- 553ddea2e3: Update Moonriver and Moonbeam bootnodes (#2749)
- And many more throughout 2022-2024

## Impact Assessment

### Why INHERITED?

1. **Mandatory Dependency Updates**:
   - `cumulus-client-cli` (MAJOR bump) is a direct dependency that must be updated
   - `sc-network` (MAJOR bump) is a core dependency that must be updated
   - These updates are required as part of the stable2506 upgrade

2. **Compilation Requirements**:
   - Changes to `CollatorOptions` may require code adjustments
   - Network event handling might need updates if Moonbeam processes DHT events
   - `StartRelayChainTasksParams` may have new fields (though cumulus-client-service only has minor bump)

3. **Default Behavior**:
   - The DHT bootnode mechanism is **enabled by default**
   - Moonbeam will automatically get this functionality upon upgrade
   - No explicit action required to enable, but can be disabled via CLI flags if needed

4. **No Runtime Changes**:
   - This is a client-side only change
   - No pallet modifications required
   - No runtime upgrade needed

### Required Actions

#### Compilation/Code Changes

**Likely Required**:
1. Handle new fields in `CollatorOptions` struct (from cumulus-client-cli)
2. Verify compatibility with updated `sc-network` API
3. Test that `start_relay_chain_tasks` works with the new version

**Code Locations to Review**:
- `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs:757` - CollatorOptions usage
- `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:934-949` - start_relay_chain_tasks call
- `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:638,672,1100` - CollatorOptions parameter passing

#### Configuration Changes

**Optional**:
- Consider whether to disable DHT bootnode features via CLI flags for specific deployments
- Evaluate if hardcoded bootnodes should remain in chain specs or can be removed
- Test DHT discovery mechanism in development/testnet environments

**CLI Flags Available**:
```bash
# Disable DHT bootnode advertisement
--no-dht-bootnode

# Disable DHT bootnode discovery
--no-dht-bootnode-discovery
```

#### Testing Requirements

**Critical**:
1. Test node startup with default DHT bootnode enabled
2. Verify existing bootnodes still work alongside DHT discovery
3. Test node discovery in isolated environments (dev, testnet, mainnet)
4. Monitor peer discovery metrics after upgrade

**Recommended**:
1. Test with `--no-dht-bootnode` and `--no-dht-bootnode-discovery` flags
2. Verify collator behavior with DHT bootnode mechanism
3. Test network resilience during relay chain epoch changes
4. Monitor DHT provider advertisement and discovery logs

### Benefits for Moonbeam

1. **Reduced Operational Overhead**: No more need to maintain and update bootnode lists (as seen in commit history)
2. **Improved Network Resilience**: Decentralized discovery eliminates single points of failure
3. **Better Decentralization**: Any node can serve as a bootnode, reducing infrastructure dependencies
4. **Automatic Discovery**: New nodes can discover the network without hardcoded bootnodes

### Risks and Considerations

1. **Breaking Changes**: MAJOR version bumps may require code modifications
2. **Network Behavior**: DHT discovery adds complexity to peer discovery process
3. **Backwards Compatibility**: Older nodes without DHT support will still rely on hardcoded bootnodes
4. **Testing Burden**: Need to verify DHT discovery works correctly across all network environments
5. **Epoch Dependencies**: DHT bootnode availability tied to relay chain epoch, may affect discovery timing

## Recommendation

**Action Required**: Update code to handle breaking changes in `cumulus-client-cli` and `sc-network`.

**Priority**: Medium-High
- Blocking for stable2506 upgrade (dependency updates required)
- Code changes likely needed for compilation
- Testing required before deployment

**Next Steps**:
1. Update dependencies to stable2506 versions
2. Fix compilation errors related to `CollatorOptions` and `sc-network` changes
3. Add comprehensive testing for DHT bootnode discovery
4. Document new CLI flags for operators
5. Consider gradual rollout strategy (test in dev → alphanet → moonriver → moonbeam)
6. Monitor network peer discovery metrics post-upgrade

## Additional Resources

- RFC-0008: https://polkadot-fellows.github.io/RFCs/approved/0008-parachain-bootnodes-dht.html
- PR Discussion: https://github.com/paritytech/polkadot-sdk/pull/8072
- Moonbeam Bootnode History: Multiple commits updating bootnode configurations (2022-2024)

## Files Referenced

- `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs`
- `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs`
- `/Users/manuelmauro/Workspace/moonbeam/node/service/Cargo.toml`
- `/Users/manuelmauro/Workspace/moonbeam/node/cli/Cargo.toml`
- `/Users/manuelmauro/Workspace/moonbeam/Cargo.toml`
- `/Users/manuelmauro/Workspace/moonbeam/specs/moonbeam/parachain-embedded-specs.json`
- `/Users/manuelmauro/Workspace/moonbeam/specs/moonriver/parachain-embedded-specs.json`
- `/Users/manuelmauro/Workspace/moonbeam/specs/alphanet/parachain-embedded-specs-v8.json`
