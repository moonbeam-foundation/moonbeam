# PR #8102: Make min_peers_to_start_warp_sync Configurable

## Overview

**PR**: https://github.com/paritytech/polkadot-sdk/pull/8102
**Labels**: T0-node
**Impact Level**: INHERITED

## Summary

This PR converts the hardcoded `min_peers_to_start_warp_sync` constant into a configurable parameter within the network configuration. For parachains, Cumulus automatically sets this value to 1 (down from the previous default), enabling warp synchronization with just a single trusted peer.

## Changes Made

### Core Changes

1. **substrate/client/network/src/config.rs**
   - Added new optional field: `pub min_peers_to_start_warp_sync: Option<usize>`
   - Defaults to `None` (preserves existing behavior for relay chains)

2. **cumulus/client/service/src/lib.rs**
   - Modified `prepare_node_config()` to automatically set `min_peers_to_start_warp_sync = Some(1)` for parachains
   - Rationale: Parachains derive their target block from the relay chain, so they only need one peer for warp sync

3. **substrate/client/cli/src/params/network_params.rs**
   - Integrated the new field into CLI network parameters (not exposed as CLI option by design)

4. **substrate/client/network/sync/src/strategy/polkadot.rs**
   - Propagates the configuration value to warp sync initialization

## Impact on Moonbeam

### Current State Analysis

**File**: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs`

```rust
// Line 686
let mut parachain_config = prepare_node_config(parachain_config);
```

Moonbeam's `start_node_impl()` function calls `cumulus_client_service::prepare_node_config()`, which means it will automatically inherit the new behavior.

**Current Dependencies**:
```toml
cumulus-client-service = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2503" }
```

### Why This is INHERITED

1. **Automatic Application**: The change is automatically applied through `prepare_node_config()`, which Moonbeam already uses
2. **No Custom Configuration**: Moonbeam does not override or customize `min_peers_to_start_warp_sync`
3. **Default Warp Sync Config**: Both dev service and regular parachain service use `warp_sync_config: None` (default behavior)
4. **No Breaking Changes**: The API remains backward compatible with `Option<usize>` defaulting to `None`

### Behavioral Change

**Before (stable2503)**:
- Moonbeam required the hardcoded default number of peers (typically 3+) to start warp sync

**After (stable2506)**:
- Moonbeam will require only 1 peer to start warp sync
- This is beneficial for parachain sync performance, especially in scenarios with limited peers
- Aligns with the parachain architecture where the relay chain provides the authoritative sync target

## Benefits for Moonbeam

1. **Faster Initial Sync**: Can start warp sync with just one trusted bootnode
2. **Improved Reliability**: Less dependent on having multiple peers available simultaneously
3. **Better Development Experience**: Easier to test and debug sync issues with minimal peer requirements
4. **No Code Changes Required**: Automatically inherited through dependency update

## Risk Assessment

### Low Risk

- **Non-Breaking**: Existing configuration structure remains intact
- **Tested Upstream**: Change has been integrated and tested in polkadot-sdk
- **Graceful Degradation**: If sync fails with one peer, traditional sync mechanisms still apply
- **Production-Ready**: Aligns with cumulus best practices for parachain synchronization

### Considerations

- **Network Topology**: Ensure at least one reliable bootnode is configured in chain spec
- **Monitoring**: No change needed to existing sync monitoring, but faster warp sync initiation may be observed

## Required Actions

**NONE** - This change is automatically inherited and requires no action from Moonbeam developers.

## Testing Recommendations

1. **Sync Testing**: Verify warp sync behavior with a single bootnode in testnet environments
2. **Monitoring**: Observe sync metrics after upgrade to confirm improved sync initiation times
3. **Regression Testing**: Ensure existing sync behavior remains functional across all network configurations (dev, local, mainnet)

## Additional Context

### Design Decision
The PR intentionally excludes this parameter from CLI options, restricting configurability to project developers rather than end users. This prevents misconfiguration that could impact sync reliability.

### Related Files in Moonbeam
- `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs` (line 686: uses `prepare_node_config`)
- `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lazy_loading/mod.rs` (line 447: warp_sync_config)

## Conclusion

PR #8102 is a beneficial node-level optimization that Moonbeam will automatically inherit through the standard cumulus dependency update. It improves parachain sync performance without requiring any code changes or configuration adjustments from the Moonbeam team.
