# PR #8122 Impact Analysis: Update to frame-metadata 21.0

## PR Information
- **Title**: Update to frame-metadata 21.0
- **GitHub**: https://github.com/paritytech/polkadot-sdk/pull/8122
- **Labels**: R0-no-crate-publish-required, T4-runtime_API
- **Merged**: April 8, 2025

## Summary
This PR updates the Polkadot SDK to use frame-metadata version 21.0.0, representing the latest iteration of unstable V16 metadata. The update includes a corresponding bump to merkleized-metadata version 0.5.0 and breaking changes to sp-metadata-ir primitives.

## Changes Made

### Dependency Updates
- **frame-metadata**: 20.0.0 -> 21.0.0
- **merkleized-metadata**: 0.4.0 -> 0.5.0
- **sp-metadata-ir**: Major version bump (breaking changes)

### Code Changes (substrate/primitives/metadata-ir/src/unstable.rs)

1. **Import refactoring**:
   - Removed: `OuterEnumsIR`, `RuntimeApiMethodParamMetadataIR`
   - Added: `MetaForm` from scale_info, `Compact` from codec

2. **Type replacements**:
   - `PalletViewFunctionParamMetadata` converted to `FunctionParamMetadata<MetaForm>`
   - Extension indexes now wrapped with `Compact()` for encoding

3. **Removed implementations**:
   - Deleted `OuterEnumsIR` -> `OuterEnums` conversion implementation

## Impact Assessment: INHERITED

### Evidence from Moonbeam Codebase

#### 1. Metadata System Usage
Moonbeam implements the standard Metadata runtime API in all three runtimes:

**File**: `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/apis.rs` (lines 64-76)
```rust
impl sp_api::Metadata<Block> for Runtime {
    fn metadata() -> OpaqueMetadata {
        OpaqueMetadata::new(Runtime::metadata().into())
    }

    fn metadata_at_version(version: u32) -> Option<OpaqueMetadata> {
        Runtime::metadata_at_version(version)
    }

    fn metadata_versions() -> Vec<u32> {
        Runtime::metadata_versions()
    }
}
```

**Status**: The Metadata runtime API trait definition (from sp-api) remains unchanged in PR #8122. These methods continue to work identically.

#### 2. Dependency Analysis

**Direct Dependencies**:
```toml
# Cargo.toml (workspace)
frame-metadata = { version = "20.0.0", default-features = false, features = ["current"] }
frame-metadata-hash-extension = { git = "...", branch = "moonbeam-polkadot-stable2503", ... }

# Runtime Cargo.toml files (moonbase, moonriver, moonbeam)
[dependencies]
frame-metadata-hash-extension = { workspace = true }  # Runtime dependency

[dev-dependencies]
frame-metadata = { workspace = true }  # Test dependency only
```

**Transitive Dependencies** (only in Cargo.lock):
- `sp-metadata-ir` (used internally by sp-api and frame-support)
- `merkleized-metadata` (used by substrate-wasm-builder)

**Analysis**:
- Moonbeam uses `frame-metadata` only as a dev-dependency for testing
- `frame-metadata-hash-extension` is a runtime dependency but will be updated as part of the SDK upgrade
- `sp-metadata-ir` and `merkleized-metadata` are transitive dependencies with no direct usage in Moonbeam code

#### 3. CheckMetadataHash Extension Usage

All three Moonbeam runtimes use `CheckMetadataHash` as a signed extension:

**moonbase** (`runtime/moonbase/src/lib.rs:1505`):
```rust
pub type SignedExtra = (
    // ... other extensions ...
    frame_metadata_hash_extension::CheckMetadataHash<Runtime>,
);
```

**moonriver** (`runtime/moonriver/src/lib.rs:1596`):
```rust
pub type SignedExtra = (
    // ... other extensions ...
    frame_metadata_hash_extension::CheckMetadataHash<Runtime>,
);
```

**moonbeam** (`runtime/moonbeam/src/lib.rs:1597`):
```rust
pub type SignedExtra = (
    // ... other extensions ...
    frame_metadata_hash_extension::CheckMetadataHash<Runtime>,
);
```

**Status**: The `CheckMetadataHash` extension will be updated as part of the Polkadot SDK upgrade. The public API of this extension remains stable, with internal changes handled by the SDK.

#### 4. Code Search Results

**sp-metadata-ir usage**:
```bash
$ rg "sp-metadata-ir" --type rust
# No matches in source files - only found in Cargo.lock
```

**merkleized-metadata usage**:
```bash
$ rg "merkleized-metadata|merkleized" --type rust
# No matches in source files - only found in Cargo.lock
```

**metadata-ir imports**:
```bash
$ rg "metadata_ir|MetadataIR" --type rust
# No matches in source files
```

**Conclusion**: Moonbeam code does not directly import or use any APIs from `sp-metadata-ir` or `merkleized-metadata`.

### Technical Analysis

#### What Changed
The PR updates internal metadata representation types in the Polkadot SDK:

1. **Metadata Version**: V16 metadata format continues to evolve (still unstable)
2. **Internal Types**: Changes to intermediate representation types used during metadata generation
3. **Encoding**: Minor adjustments to how extension indexes are encoded (now uses `Compact()`)

#### What Did NOT Change
1. **Metadata Runtime API**: The `sp_api::Metadata` trait interface remains stable
2. **Public APIs**: No breaking changes to public-facing APIs that runtimes implement
3. **CheckMetadataHash**: The extension's public interface remains compatible
4. **Runtime Behavior**: No changes to how metadata is generated or exposed to clients

#### Why This Works for Moonbeam
Moonbeam's interaction with the metadata system is through stable, high-level APIs:
- Implements `sp_api::Metadata<Block>` trait (unchanged)
- Uses `frame_metadata_hash_extension::CheckMetadataHash` (compatible)
- Does not directly call any `sp-metadata-ir` functions
- All internal metadata generation is handled by frame-support macros

### Rationale for INHERITED Classification

This PR represents an internal refactoring of the metadata subsystem within the Polkadot SDK. While it includes breaking changes to `sp-metadata-ir`, these are internal primitives used by the SDK's macro expansion and metadata generation systems.

**Key factors**:

1. **No Direct Usage**: Moonbeam does not directly depend on or import `sp-metadata-ir` or `merkleized-metadata`
2. **Stable APIs**: The public runtime APIs remain unchanged
3. **Automatic Updates**: Dependencies like `frame-metadata-hash-extension` will be updated by the SDK upgrade
4. **Transitive Only**: Both affected crates are transitive dependencies handled by Cargo
5. **Compatibility**: The changes maintain backward compatibility at the public API level

## Action Items

### Required
- None

### Recommended
- After upgrading to stable2506, regenerate TypeScript bindings to pick up any metadata format changes:
  ```bash
  cd typescript-api
  pnpm run build
  ```

### Testing Considerations
- Standard runtime upgrade testing will verify metadata system functionality
- Metadata APIs (`metadata()`, `metadata_at_version()`, `metadata_versions()`) should be tested via RPC calls
- Verify that `CheckMetadataHash` extension continues to work correctly in signed transactions

## Additional Notes

### Frame Metadata Version History
- **v20.0.0**: Released February 20, 2025 - Added Runtime API version to v16 metadata
- **v21.0.0**: Internal version in polkadot-sdk (this PR) - Refactored unstable V16 representation
- **v23.0.0**: Current version in polkadot-sdk master

These version numbers represent internal SDK versions, not published crate versions. The frame-metadata crate repository currently shows v20.0.0 as the latest published release.

### Unstable V16 Metadata
The PR description notes: "Metadata version 16 is currently unstable and can be enabled using the unstable feature flag." This means:
- V16 metadata is still evolving
- Breaking changes are expected in this metadata version
- Production chains typically use stable metadata versions (V14/V15)
- Moonbeam's metadata generation will automatically adapt to changes

### Commit Details
- **b00262d**: Primary update migrating frame-metadata to version 21.0.0
- **43f9b7c**: Lockfile synchronization following the dependency upgrade
- **7a6750f**: Code formatting adjustments

## Related Documentation
- [Polkadot SDK Metadata Documentation](https://docs.substrate.io/build/runtime-metadata/)
- [Frame Metadata Repository](https://github.com/paritytech/frame-metadata)
- [sp-api Metadata trait](https://github.com/paritytech/polkadot-sdk/blob/master/substrate/primitives/api/src/lib.rs)
