# PR #8127 Impact Analysis: Async Staking Module (AHM)

## PR Overview

**Title:** [AHM] Async Staking module across AH and RC
**GitHub:** https://github.com/paritytech/polkadot-sdk/pull/8127
**Labels:** T2-pallets
**PRDoc:** /Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_8127.prdoc

## Summary

This PR introduces a comprehensive architectural change to enable staking functionality on parachains (specifically Asset Hub) while maintaining compatibility with relay chains. It represents the culmination of multi-year development work to move the staking system from relay chains to Asset Hub parachains, with validator sets reported back to the relay chain via XCM.

## Key Changes

### New Pallets Added
- **pallet-election-provider-multi-block**: Four-pallet suite for async, multi-page election provider
- **pallet-staking-async**: Parachain-adapted fork of pallet-staking without direct access to timestamps, session management, or authorship modules
- **pallet-staking-async-ah-client** & **pallet-staking-async-rc-client**: XCM communication facilitators between relay chain and Asset Hub
- **pallet-ahm-test**: E2E testing infrastructure
- **Test runtimes**: pallet-staking-async-rc-runtime and pallet-staking-async-parachain-runtime

### Modified Components

#### pallet-staking (MAJOR bump)
- Internal architectural changes to support async staking
- Changes to `FullIdentification` mechanism - now uses `DefaultExposureOf` instead of full exposure data
- Maintains backward compatibility for types like `RewardDestination` and `ValidatorPrefs`

#### pallet-bags-list (MAJOR bump)
- New "Locked" feature preventing updates during multi-page snapshots
- Enhanced `rebag` transaction for node addition/removal

#### westend-runtime (MAJOR bump)
- Integration of `pallet-staking-async-ah-client` for validator rewards, offences, and session management
- Delegates to old `pallet-staking` as `Fallback` (preparatory step for AHM)
- Should not introduce logical changes, only architectural preparation

#### Other Breaking Changes
- pallet-election-provider-multi-phase (MAJOR)
- pallet-root-offences (MAJOR)
- pallet-session (MAJOR)
- frame-election-provider-support (MAJOR)
- sp-npos-elections (MAJOR)

## Impact on Moonbeam

### Critical Assessment: LOW TO MEDIUM IMPACT

Moonbeam does **not** use the relay chain staking system directly, but has **indirect dependencies** through the relay-encoder module.

### Direct Dependencies

#### 1. relay-encoder Module (Type Dependencies)

**Location:** `/Users/manuelmauro/Workspace/moonbeam/runtime/relay-encoder/`

**Dependencies:**
```rust
pallet-staking = { workspace = true }  // Used for types only
westend-runtime = { workspace = true }  // Test dependency
polkadot-runtime-parachains = { workspace = true }
```

**Usage Pattern:**
Moonbeam's relay-encoder uses pallet-staking **only for type definitions**, not runtime integration:

1. **`pallet_staking::RewardDestination<AccountId32>`**
   - Used in: `/polkadot.rs`, `/kusama.rs`, `/westend.rs`
   - Purpose: Encoding staking calls for XCM transactor
   - Variants used: `Staked`, `Stash`, `Controller` (deprecated), `Account`, `None`
   - **Impact**: No breaking changes expected to this enum structure

2. **`pallet_staking::ValidatorPrefs`**
   - Used in: All three relay encoders
   - Purpose: Encoding validator preference calls
   - **Impact**: No breaking changes expected to this type

**Evidence:**
```rust
// From /runtime/relay-encoder/src/polkadot.rs
pub enum StakeCall {
    Bond(
        #[codec(compact)] Balance,
        pallet_staking::RewardDestination<AccountId32>,
    ),
    Validate(pallet_staking::ValidatorPrefs),
    SetPayee(pallet_staking::RewardDestination<AccountId32>),
    // ... other calls
}
```

#### 2. relay-encoder Precompile

**Location:** `/Users/manuelmauro/Workspace/moonbeam/precompiles/relay-encoder/`

**Impact:**
- Provides EVM interface for encoding relay staking calls
- Uses `RewardDestinationWrapper` to handle Solidity codec
- Maps EVM calls to relay chain staking operations
- **No changes required** as underlying types remain compatible

**Evidence:**
```rust
// From /precompiles/relay-encoder/src/lib.rs
impl solidity::Codec for RewardDestinationWrapper {
    fn read(reader: &mut solidity::codec::Reader) -> MayRevert<Self> {
        match enum_selector[0] {
            0u8 => Ok(RewardDestinationWrapper(RewardDestination::Staked)),
            1u8 => Ok(RewardDestinationWrapper(RewardDestination::Stash)),
            2u8 => Ok(RewardDestinationWrapper(RewardDestination::Controller)),
            3u8 => Ok(RewardDestinationWrapper(RewardDestination::Account(...))),
            4u8 => Ok(RewardDestinationWrapper(RewardDestination::None)),
            // ...
        }
    }
}
```

### Test Dependencies

**westend-runtime Usage:**
Moonbeam's tests extensively use `westend_runtime::Runtime` and `westend_runtime::Staking` to verify encoding correctness:

**Files:**
- `/runtime/relay-encoder/src/westend.rs` (196 test functions)
- Tests verify pallet indices and call encoding match westend runtime

**Potential Impact:**
- Westend runtime had MAJOR changes (integrated pallet-staking-async-ah-client)
- However, changes delegate to old pallet-staking as Fallback
- **Risk**: Pallet indices may have shifted if new pallets were added
- **Action Required**: Run tests to verify encoding still matches

**Evidence:**
```rust
// Tests verify pallet indices match
let index = <westend_runtime::Runtime as frame_system::Config>::PalletInfo::index::<
    westend_runtime::Staking,
>()
```

### Components NOT Affected

Moonbeam does **NOT** use:
- ✗ pallet-bags-list
- ✗ pallet-election-provider-multi-phase
- ✗ frame-election-provider-support
- ✗ pallet-root-offences
- ✗ sp-npos-elections
- ✗ New async staking pallets (pallet-staking-async, etc.)

Moonbeam uses its own custom staking system (`pallet-parachain-staking`), not the relay chain staking.

## Breaking Changes Analysis

### API Compatibility

The PR makes **major version bumps** to several crates, but the specific types Moonbeam depends on appear to maintain backward compatibility:

1. **RewardDestination enum**: No structural changes mentioned
2. **ValidatorPrefs struct**: No structural changes mentioned
3. **Call encoding**: Should remain compatible, but pallet indices may shift

### Migration Requirements

**For Moonbeam:** No runtime migrations required as Moonbeam doesn't use the affected pallets in its runtime.

**For Relay Chains (Reference):**
The PR describes migration steps for actual relay chains:
1. Trigger `pallet_staking_async_ah_client::on_migration_start()`
2. Filter `staking::bond`, set `Forcing` to `ForceNone`
3. Complete with `on_migration_end()` and runtime config updates

These do not apply to Moonbeam.

## Testing Strategy

### Required Tests

1. **Relay Encoder Unit Tests**
   ```bash
   cargo test -p moonbeam-relay-encoder
   ```
   **Expected:** All tests pass, verifying encoding matches relay chain expectations

2. **Relay Encoder Integration Tests**
   ```bash
   # Test westend encoder
   cargo test -p moonbeam-relay-encoder --test westend
   ```
   **Risk Area:** Pallet indices may have changed in westend-runtime

3. **Precompile Tests**
   ```bash
   cargo test -p pallet-evm-precompile-relay-encoder
   ```
   **Expected:** EVM encoding/decoding still works correctly

4. **Build Verification**
   ```bash
   cargo build --release -p moonbeam-runtime
   cargo build --release -p moonriver-runtime
   cargo build --release -p moonbase-runtime
   ```
   **Expected:** Clean compilation with no type errors

### Test Coverage Focus

- Verify `RewardDestination` encoding/decoding
- Verify `ValidatorPrefs` encoding/decoding
- Check pallet indices in test runtimes haven't shifted
- Ensure XCM transactor still correctly encodes relay calls

## Recommendations

### Priority: MEDIUM

While Moonbeam doesn't directly use the staking system changes, the test dependencies on westend-runtime and type dependencies on pallet-staking warrant careful verification.

### Action Items

1. **Immediate:**
   - ✓ Run full test suite for relay-encoder module
   - ✓ Verify westend-runtime tests still pass
   - ✓ Check for any deprecation warnings related to pallet-staking types

2. **Before Merge:**
   - ✓ Confirm no changes to `RewardDestination` or `ValidatorPrefs` structure
   - ✓ Verify pallet indices in westend-runtime if tests fail
   - ✓ Update relay encoder indices if westend runtime structure changed

3. **Post-Merge Monitoring:**
   - Monitor for any runtime upgrade issues on Westend
   - Watch for changes to staking API in future SDK updates
   - Track async staking migration on relay chains for reference

### Code Changes Required

**Expected:** NONE, unless:
- Westend runtime pallet indices changed (would require updating constants in relay-encoder)
- Type definitions changed (unlikely based on PR description)

### Risk Assessment

| Risk Category | Level | Justification |
|--------------|-------|---------------|
| Compilation Errors | Low | Only type dependencies, no runtime integration |
| Test Failures | Medium | Westend runtime changes may affect test assertions |
| Runtime Compatibility | Low | No direct usage of modified pallets |
| User Impact | Very Low | Changes are internal to relay chain, not parachain |
| XCM Compatibility | Low | Relay chain calls should maintain same encoding |

## Additional Notes

### Future Considerations

1. **Async Staking Awareness:**
   - While not immediately relevant, Moonbeam team should understand AHM architecture
   - May influence future cross-chain staking integrations
   - Useful reference if considering liquid staking integrations with relay chains

2. **Westend Runtime Dependency:**
   - Consider if test dependency on full westend-runtime is necessary
   - May want to mock or use lighter-weight test runtime in future
   - Watch for continued westend runtime evolution as AHM rolls out

3. **Type Version Pinning:**
   - Currently uses workspace dependencies
   - May want to explicitly track pallet-staking version for stability
   - Monitor for deprecation of `Controller` variant in `RewardDestination`

### Related PRs

Reference PR #3107 for RuntimeDebug → Debug changes (mentioned in PRDoc but separate work)

## Conclusion

**Overall Impact: LOW**

PR #8127 introduces significant architectural changes to the relay chain staking system, but Moonbeam's limited usage pattern (types only, no runtime integration) minimizes direct impact. The main concern is ensuring test compatibility with the updated westend-runtime, which should be straightforward to verify.

**Recommended Approach:**
1. Run existing test suite
2. Fix any pallet index mismatches if tests fail
3. Proceed with SDK upgrade once tests pass

No code changes anticipated beyond potential test assertion updates.
