# PR #8127: [AHM] Async Staking Module Across AH and RC

## Overview

**PR Link**: https://github.com/paritytech/polkadot-sdk/pull/8127
**Labels**: T2-pallets
**Status**: Merged on April 22, 2025

## Summary

This PR introduces an async staking system enabling parachains (specifically AssetHub) to host staking functionality while reporting validator sets to relay chains via XCM messages. The development represents multi-year work to make pallet-staking compatible with parachains by decoupling it from relay-chain-specific components (pallet-session, pallet-authorship, secure timestamps).

## Key Changes

### New Pallets (Not Used by Moonbeam)
- `pallet-election-provider-multi-block`: Multi-page async election provider
- `pallet-staking-async`: Parachain-compatible fork of pallet-staking
- `pallet-staking-async-ah-client` and `pallet-staking-async-rc-client`: XCM communication pallets
- Test infrastructure and runtimes

### Modified Pallets

#### Major Bumps (Not Used by Moonbeam)
- `pallet-staking` (major): Identification mechanism changes, multi-page support
- `pallet-bags-list` (major): New locking capability during snapshots
- `pallet-election-provider-multi-phase` (major): Multi-page compatibility
- `pallet-session` (major): Integration with async staking client
- `pallet-root-offences` (major): Updated for new identification
- `frame-election-provider-support` (major): Multi-page traits

#### Minor/Patch Bumps (Not Used by Moonbeam)
- `pallet-babe`, `pallet-beefy`, `pallet-grandpa`: Session and validator set changes
- `pallet-nomination-pools`, `pallet-fast-unstake`: Integration updates

## Moonbeam Impact Analysis

### Direct Pallet Usage
Moonbeam does **NOT** use any of the following in its runtime:
- pallet-staking (uses custom `pallet-parachain-staking` instead)
- pallet-session (parachain, no consensus)
- pallet-babe, pallet-grandpa, pallet-beefy (parachain, no consensus)
- pallet-bags-list
- pallet-election-provider-multi-block/multi-phase
- pallet-nomination-pools
- pallet-fast-unstake

Verified by checking `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs` construct_runtime! macro (lines 1408-1507).

### Indirect Usage

**Location**: `/Users/manuelmauro/Workspace/moonbeam/precompiles/relay-encoder/src/lib.rs`

Moonbeam's relay-encoder precompile imports two types from pallet-staking:
```rust
use pallet_staking::RewardDestination;
// Also uses pallet_staking::ValidatorPrefs
```

**Purpose**: The relay-encoder precompile provides EVM functions to encode relay chain staking calls that are sent from Moonbeam to the relay chain via XCM. Examples:
- `encode_bond(amount, reward_destination)` - Encode bond call
- `encode_set_payee(reward_destination)` - Encode set payee call
- `encode_validate(commission, blocked)` - Encode validate call

**Type Usage**: These types are used purely for:
1. Encoding relay chain staking calls
2. Type definitions in test mocks
3. No runtime storage or state management

### Analysis of Type Changes

According to the PRDoc, the main changes to pallet-staking are:
1. **Identification mechanism**: Changed `FullIdentification` and `FullIdentificationOf` - NOT used by relay-encoder
2. **Multi-page election support**: Internal pallet changes - NOT exposed in types used by Moonbeam
3. **XCM integration**: For parachain-hosted staking - NOT applicable to relay-encoder

**Critical Finding**: The PRDoc does NOT mention changes to `RewardDestination` or `ValidatorPrefs` types. These remain stable types used for call encoding.

## Impact Classification: INHERITED

**Reasoning**:
1. Moonbeam only uses stable type definitions from pallet-staking for encoding relay chain calls
2. These types (`RewardDestination`, `ValidatorPrefs`) were not modified in this PR
3. The relay-encoder precompile targets the actual relay chain's pallet-staking, not a local instance
4. Changes will be inherited automatically during Polkadot SDK dependency upgrade
5. No Moonbeam code changes required

## Required Actions

**None**

The changes in this PR do not require any modifications to Moonbeam's codebase:
- No runtime pallets are affected
- Type imports remain compatible
- Relay-encoder precompile continues to work as-is
- Dependency version bump will automatically include fixes

## Testing Recommendations

### Minimal Verification
After upgrading to stable2506, verify the relay-encoder precompile still compiles and works:

1. **Compilation Check**:
   ```bash
   cargo build --release -p moonbeam-runtime
   ```

2. **Test Relay Encoder**:
   ```bash
   cargo test -p pallet-evm-precompile-relay-encoder
   ```

3. **Integration Test** (Optional):
   - Test encoding bond call via EVM
   - Test encoding validate call via EVM
   - Verify encoded output matches expected relay chain format

### Expected Result
All tests should pass without modifications. If any issues arise, they would be compilation errors due to type signature changes (unlikely based on PRDoc analysis).

## Additional Notes

### Why Moonbeam Doesn't Need pallet-staking-async

Moonbeam already has its own staking solution:
- Uses custom `pallet-parachain-staking` for collator selection
- Does not participate in relay chain validator selection
- The relay-encoder precompile is for user-initiated staking on the relay chain via XCM
- Async staking is for AssetHub to host relay chain staking, which is a different use case

### Dependency Chain

```
moonbeam-runtime
  └─> pallet-evm-precompile-relay-encoder
        └─> pallet_staking::{RewardDestination, ValidatorPrefs} (type imports only)
              └─> Used for encoding, not runtime execution
```

## References

- PR Doc: `/Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_8127.prdoc`
- Moonbeam Runtime: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs`
- Relay Encoder: `/Users/manuelmauro/Workspace/moonbeam/precompiles/relay-encoder/src/lib.rs`
- GitHub PR: https://github.com/paritytech/polkadot-sdk/pull/8127

## Conclusion

PR #8127 introduces significant changes to the Substrate staking infrastructure for AssetHub migration, but has **no impact on Moonbeam** beyond the automatic dependency update. Moonbeam's limited use of pallet-staking types for relay chain call encoding remains unaffected by the core architectural changes in this PR.
