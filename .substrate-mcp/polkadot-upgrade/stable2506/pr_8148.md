# PR #8148: [revive] eth-rpc refactoring

## PR Information

- **Title:** [revive] eth-rpc refactoring
- **URL:** https://github.com/paritytech/polkadot-sdk/pull/8148
- **Status:** Merged (April 22, 2025)
- **Audience:** Runtime Dev
- **Affected Crates:**
  - `pallet-revive-eth-rpc` (patch)
  - `pallet-revive` (patch)

## Summary

This PR refactors the Ethereum RPC implementation for the Revive smart contract platform. The changes include:

1. **Storage Migration**: Removes in-memory caching in favor of SQLite-based persistent storage, with in-memory database support for non-archive nodes
2. **Block Tracking**: Implements dual tracking of both best and finalized blocks to properly handle transaction receipt indexing during relay chain reorganizations
3. **Finalized Block Reference**: Maintains a reference to the latest finalized block for queries using the `finalized` block tag
4. **Indexing Parameter**: Adds `--index-last-n-blocks` CLI parameter enabling selective re-indexing of recent blocks on server startup
5. **Gas Estimation Fix**: Corrects gas estimation calculations for EIP1559 transaction types

The refactoring addresses issues with transaction receipt queries (paritytech/contract-issues#35) and other RPC functionality (paritytech/contract-issues#33).

## Impact Assessment

**Sentiment: DON'T CARE**

This PR has **NO impact** on Moonbeam because:

### Moonbeam's EVM Architecture

Moonbeam uses the **Frontier** framework for Ethereum compatibility, not the Revive pallet:

**Evidence from `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/Cargo.toml` (lines 128-140):**
```toml
# Frontier
fp-evm = { workspace = true }
fp-rpc = { workspace = true }
fp-self-contained = { workspace = true, features = ["serde"] }
pallet-ethereum = { workspace = true, features = ["forbid-evm-reentrancy"] }
pallet-evm = { workspace = true, features = ["forbid-evm-reentrancy"] }
pallet-evm-precompile-blake2 = { workspace = true }
pallet-evm-precompile-bls12381 = {workspace = true}
pallet-evm-precompile-bn128 = { workspace = true }
pallet-evm-precompile-modexp = { workspace = true }
pallet-evm-precompile-sha3fips = { workspace = true }
pallet-evm-precompile-simple = { workspace = true }
precompile-utils = { workspace = true }
```

### No Revive Usage

Codebase search confirms zero usage of the affected pallets:
- **Search for `pallet-revive`**: Found only in `.substrate-mcp/` analysis documents, not in actual Moonbeam source code
- **Runtime dependencies**: All three Moonbeam runtimes (moonbeam, moonriver, moonbase) use Frontier, not Revive

### Different Smart Contract Platforms

- **Revive**: A smart contract platform for Polkadot SDK (separate from Frontier)
- **Moonbeam**: Uses Frontier's `pallet-evm` and `pallet-ethereum` for full Ethereum compatibility as a parachain

## Analysis

### What Changed

PR #8148 refactors the internal architecture of pallet-revive-eth-rpc:
- Replaces in-memory transaction/receipt cache with SQLite storage
- Improves block finality handling for better reorg support
- Adds CLI parameter for historical block re-indexing
- Fixes EIP1559 gas price calculations

### Why Moonbeam Is Unaffected

1. **Different Technology Stack**: Moonbeam is built on Frontier (pallet-evm/pallet-ethereum), while this PR affects Revive pallets
2. **No Dependency**: Neither runtime nor node dependencies include pallet-revive or pallet-revive-eth-rpc
3. **Separate RPC Implementation**: Moonbeam uses Frontier's RPC layer, not Revive's eth-rpc

### Verification

Comprehensive search across all Moonbeam Cargo.toml files and source code confirmed:
- ✓ 32 files reference Frontier components (pallet-evm, pallet-ethereum)
- ✗ 0 files in actual source code reference pallet-revive (only in analysis docs)

## Evidence

### Codebase Search Results

**Search: `pallet-revive` in Moonbeam source**
```
Found 6 files
/Users/manuelmauro/Workspace/moonbeam/.substrate-mcp/polkadot-upgrade/stable2506/pr_8248.md
/Users/manuelmauro/Workspace/moonbeam/.substrate-mcp/polkadot-upgrade/stable2506/pr_8234.md
/Users/manuelmauro/Workspace/moonbeam/.substrate-mcp/polkadot-upgrade/stable2506/pr_8163.md
/Users/manuelmauro/Workspace/moonbeam/.substrate-mcp/polkadot-upgrade/stable2506/pr_7857.md
/Users/manuelmauro/Workspace/moonbeam/.substrate-mcp/polkadot-upgrade/stable2506/pr_7762.md
/Users/manuelmauro/Workspace/moonbeam/.substrate-mcp/polkadot-upgrade/stable2506/TRACKING.md
```
*Note: All matches are in analysis documents, not source code*

**Search: `pallet-evm|pallet-ethereum|frontier` in Cargo.toml files**
```
Found 32 files including:
- /Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/Cargo.toml
- /Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/Cargo.toml
- /Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/Cargo.toml
- /Users/manuelmauro/Workspace/moonbeam/node/service/Cargo.toml
- All precompile packages
```

## Recommendation

**No action required.** This PR can be safely ignored during the Polkadot SDK stable2506 upgrade as it does not affect any components used by Moonbeam.
