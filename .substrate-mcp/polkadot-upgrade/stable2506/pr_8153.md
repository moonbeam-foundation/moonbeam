# PR #8153: Introduce `SelectCore` Digest in Cumulus

## Overview

**PR:** https://github.com/paritytech/polkadot-sdk/pull/8153
**Labels:** T9-cumulus
**Audience:** Node Developers
**Impact:** Transparent Performance Enhancement

## Summary

This PR introduces a new `SelectCore` digest item in Cumulus that embeds core selection information directly into block headers. Previously, nodes needed to execute an entire block and call the `selected_core` runtime API to determine which core processed a block. This optimization allows nodes to read core information directly from the header digest, significantly improving performance for validation and proof recording operations.

## Technical Details

### What Changed

**New Digest Type:**
```rust
// In cumulus-primitives-core
pub enum CumulusDigestItem {
    // ... existing variants
    SelectCore {
        selector: u32,           // Identifies which core processes the block
        claim_queue_offset: u32, // Position in the claim queue
    }
}
```

**Key Implementation Points:**
1. **Header-Based Access**: Core information now available in block headers without execution
2. **UMP Signal Preserved**: Core information still sent as UMPSignal; digest is additional optimization
3. **Proof Recording**: Enables better PoV sharing identification for blocks on same core
4. **Performance**: Eliminates need for runtime API call and block execution overhead

### Affected Crates

#### Minor Version Bumps
- **cumulus-pallet-parachain-system** (minor): Core parachain system pallet
- **cumulus-primitives-core** (minor): Core Cumulus primitives including digest types
- **polkadot-primitives** (minor): Polkadot protocol primitives

All bumps are minor because the change is additive and non-breaking.

## Impact on Moonbeam

### Classification

**Category:** Transparent Performance Enhancement
**Type:** Infrastructure Optimization (T9-cumulus)
**Action Required:** None (automatic on upgrade)

### Affected Components

#### 1. Core Parachain System Pallet (Transparent Impact)

All three Moonbeam runtimes use `cumulus-pallet-parachain-system`:

**Files:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/Cargo.toml`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/Cargo.toml`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/Cargo.toml`

**Runtime Configuration:**
```rust
// /Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs:750-763
impl cumulus_pallet_parachain_system::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type OnSystemEvent = ();
    type SelfParaId = ParachainInfo;
    type ReservedDmpWeight = ReservedDmpWeight;
    type OutboundXcmpMessageSource = XcmpQueue;
    type XcmpMessageHandler = XcmpQueue;
    type ReservedXcmpWeight = ReservedXcmpWeight;
    type CheckAssociatedRelayNumber = EmergencyParaXcm;
    type ConsensusHook = ConsensusHook;
    type DmpQueue = frame_support::traits::EnqueueWithOrigin<MessageQueue, RelayOrigin>;
    type WeightInfo = moonbase_weights::cumulus_pallet_parachain_system::WeightInfo<Runtime>;
    type SelectCore = cumulus_pallet_parachain_system::DefaultCoreSelector<Runtime>;  // <-- Relevant
}
```

**Key Observation:** Moonbeam uses `DefaultCoreSelector<Runtime>` across all runtimes:
- **moonbase:** `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs:762`
- **moonriver:** `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs:761`
- **moonbeam:** `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs:718`

The `DefaultCoreSelector` will automatically generate the `SelectCore` digest when processing blocks, requiring no custom implementation.

#### 2. Cumulus Primitives Usage (Indirect Impact)

Moonbeam extensively uses `cumulus-primitives-core`:

**Runtime Usage:**
```rust
// /Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs:63
use cumulus_primitives_core::{relay_chain, AggregateMessageOrigin};
```

**Node Service Usage:**
```rust
// /Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:36-38
use cumulus_primitives_core::{
    relay_chain::{self, well_known_keys, CollatorPair},
    CollectCollationInfo, ParaId,
};
```

The minor bump to `cumulus-primitives-core` adds the new digest variant but maintains backward compatibility. Moonbeam's imports (`ParaId`, `CollectCollationInfo`, `relay_chain` modules) are unaffected.

#### 3. Polkadot Primitives Dependencies (Transparent)

**Node Service Imports:**
```rust
// /Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:59
use polkadot_primitives::{AbridgedHostConfiguration, AsyncBackingParams, Slot, UpgradeGoAhead};
```

These specific imports don't relate to core selection or digest handling. The minor bump to `polkadot-primitives` is transparent.

#### 4. Test Infrastructure (Dev-Only)

Mock runtimes in precompile tests also use `DefaultCoreSelector`:

**Files:**
- `/Users/manuelmauro/Workspace/moonbeam/precompiles/relay-encoder/src/mock.rs`
- `/Users/manuelmauro/Workspace/moonbeam/precompiles/crowdloan-rewards/src/mock.rs`

These will automatically pick up the new digest behavior with no test modifications needed.

### What Moonbeam Does NOT Do

**Evidence from codebase analysis:**

1. **No Custom Core Selection Logic:**
   - Search for `SelectCore` found only type configuration lines
   - No custom implementation of core selection algorithms
   - Uses `DefaultCoreSelector` everywhere

2. **No Direct Digest Processing in Node:**
   - Search for `CumulusDigestItem` found no usage in node code
   - Node doesn't read or process SelectCore digests explicitly
   - Digest handling is transparent at runtime level

3. **No Manual Block Execution for Core Info:**
   - Search for `selected_core` runtime API calls found no results
   - Moonbeam doesn't currently optimize around core information
   - This PR prepares infrastructure for future optimizations

4. **No PoV-Level Optimizations:**
   - Node service uses `max_pov_percentage` for resource management
   - No explicit PoV sharing or core-based optimization logic
   - Potential future enhancement area

## Performance Benefits for Moonbeam

### Immediate Benefits

1. **Faster Block Validation:**
   - Validators can determine core assignment without executing blocks
   - Reduces validation overhead on relay chain
   - Improves overall parachain block processing efficiency

2. **Improved Proof Recording:**
   - Nodes can identify blocks sharing the same core without execution
   - Enables better PoV deduplication strategies
   - Reduces redundant validation work

3. **Reduced API Overhead:**
   - Eliminates need for `selected_core` runtime API calls
   - One less API boundary crossing for core information
   - Lower computational overhead for validation operations

### Future Optimization Opportunities

While the benefits are currently transparent, this PR enables:

1. **Collator Optimization:**
   - Collators could use core information for block production strategies
   - Better understanding of core assignment patterns
   - Potential for optimized block proposal timing

2. **Node-Level Caching:**
   - Nodes can cache core assignments by header
   - Faster lookups for historical block analysis
   - Improved debugging and monitoring capabilities

3. **Multi-Block PoV Context:**
   - Related to PR #6137 (multi-block PoVs)
   - Core information helps group blocks correctly
   - Better resource accounting across blocks

## Risk Assessment

### Risk Level: **VERY LOW**

**Justification:**

1. **Additive Change Only**
   - New digest variant added, existing behavior unchanged
   - Backward compatible: old nodes ignore new digest
   - Forward compatible: new nodes handle missing digest gracefully

2. **No Breaking Changes**
   - All affected crates receive minor bumps
   - No API changes to existing functionality
   - No configuration updates required

3. **Transparent to Applications**
   - Moonbeam's EVM layer unaffected
   - Smart contracts see no changes
   - RPC interfaces unchanged
   - Precompiles continue working identically

4. **Uses Default Implementation**
   - Moonbeam doesn't customize core selection
   - Default implementation battle-tested in Cumulus
   - No custom logic to update or test

5. **Infrastructure-Level Change**
   - Optimization happens in block authoring/validation
   - Runtime logic unaffected
   - No state migrations needed

### Potential Issues

**None Identified** - The change is purely additive and transparent.

**Monitoring Recommendations:**
- No new errors expected related to this change
- Existing metrics and logs continue working
- SelectCore digest appears in block headers (observable but not critical)

## Related Context

### Connection to Multi-Block PoVs (PR #6137)

This PR complements PR #6137's multi-block PoV support:

**PR #6137 Context:**
- Enables multiple parachain blocks per PoV
- Blocks share same resource constraints
- Core assignment matters for block grouping

**PR #8153 Enhancement:**
- Provides efficient core information access
- Helps identify blocks for same core/PoV
- Improves proof recording for multi-block scenarios

**Combined Impact:**
- Better infrastructure for faster block times
- More efficient validation processes
- Prepares for future performance enhancements

### Connection to Collator Protocol (PR #7955)

PR #7955 introduced `ApprovedPeer` UMP signal for collator reputation:

**Relationship:**
- Both are UMP signal enhancements
- Both add information to block metadata
- Both prepare for improved collator selection

**SelectCore vs ApprovedPeer:**
- SelectCore: Core assignment (optimization)
- ApprovedPeer: Collator credit (reputation)
- Both transparent to parachain operations

## Verification Testing

### Recommended Tests

#### 1. Basic Block Production
```bash
# Verify dev node continues working normally
./target/release/moonbeam --dev --alice --sealing 6000 --rpc-port 9944

# Check logs for:
# - Normal block production
# - No digest-related errors
# - Successful collation submission
```

#### 2. Runtime Tests
```bash
# Run full runtime test suite
cargo test -p moonbase-runtime
cargo test -p moonriver-runtime
cargo test -p moonbeam-runtime

# All existing tests should pass without modification
```

#### 3. Integration Tests
```bash
cd test
pnpm moonwall test dev_moonbase
pnpm moonwall test smoke_moonbase

# Verify:
# - Block production continues
# - XCM operations work
# - EVM transactions execute
# - No new warnings/errors
```

#### 4. Precompile Tests
```bash
# Test mock runtimes with DefaultCoreSelector
cargo test -p pallet-evm-precompile-relay-encoder
cargo test -p pallet-evm-precompile-crowdloan-rewards

# These use mock ParachainSystem configs
```

#### 5. Header Inspection (Optional)
```typescript
// Verify SelectCore digest appears in headers
const block = await api.rpc.chain.getBlock();
const digests = block.block.header.digest.logs;

// Look for new Cumulus digest item
// Should see SelectCore variant after upgrade
console.log(digests);
```

### Expected Behavior

**Success Criteria:**
- ✅ All existing tests pass without modification
- ✅ Block production maintains normal rate
- ✅ No new errors or warnings in logs
- ✅ XCM message passing continues normally
- ✅ EVM transactions execute successfully
- ✅ Collator operations unchanged

**New Observable Behavior:**
- Headers may contain SelectCore digest (not visible to most operations)
- No functional changes to any user-facing features
- Performance may slightly improve (not easily measurable)

## Migration Guide

### Required Actions

**NONE** - This PR requires no code changes, configuration updates, or runtime migrations.

### Automatic Updates

When upgrading to stable2506:

1. **Dependency Updates** (Automatic)
   ```toml
   # Cargo.toml workspace dependencies update automatically
   cumulus-pallet-parachain-system = { ... }  # Minor bump
   cumulus-primitives-core = { ... }          # Minor bump
   polkadot-primitives = { ... }              # Minor bump
   ```

2. **Runtime Compilation** (Automatic)
   - Runtimes compile with updated pallet versions
   - No trait implementations need modification
   - No Config type changes required
   - DefaultCoreSelector gains new capability transparently

3. **Block Production** (Automatic)
   - Collators automatically include SelectCore digest
   - Validators automatically recognize new digest
   - No coordination required between upgrades

4. **Test Suite** (Automatic)
   - Mock runtimes use updated ParachainSystem
   - No test modifications needed
   - Existing tests validate new behavior

### Deployment Strategy

**Standard Upgrade Process:**
1. Deploy to Moonbase Alpha testnet first
2. Monitor for 24-48 hours
3. Verify normal operations (no special SelectCore checks needed)
4. Proceed with Moonriver and Moonbeam upgrades

**No Special Handling Required:**
- No runtime migration needed
- No coordinated collator upgrade needed
- No breaking changes to address

## Future Considerations

### Potential Optimizations

Once this infrastructure is in place, Moonbeam could optionally:

1. **Custom Core Selection Strategy** (Advanced)
   - Implement custom `SelectCore` type
   - Could optimize for specific workload patterns
   - Requires careful testing and validation
   - **Note:** Default implementation works well; customization rarely needed

2. **Node-Level Optimizations** (Future)
   - Read SelectCore digest for caching strategies
   - Optimize block processing based on core assignment
   - Improve monitoring and observability
   - Track core utilization patterns

3. **Integration with Multi-Block PoVs** (When Enabled)
   - Use core information for block grouping
   - Optimize resource allocation across blocks
   - Better collator scheduling strategies

### Monitoring Enhancements

Consider adding monitoring for:
- Core assignment distribution (which cores used most)
- Validation timing improvements (if measurable)
- PoV deduplication effectiveness (future metric)

**Note:** These are optional enhancements. Current configuration works optimally.

## Related PRs and Issues

**Related Infrastructure Changes:**
- **PR #6137:** Multi-block PoV support (foundation for faster block times)
- **PR #7955:** ApprovedPeer UMP signal (collator reputation tracking)
- **PR #8134:** Separate validation/collation protocols (protocol cleanup)
- **PR #8230:** Parachain validation metrics (observability improvements)
- **PR #8370:** Fix unneeded collator connections (resource optimization)

**Cumulus Enhancement Theme:**
These PRs collectively modernize the Cumulus infrastructure for improved performance, observability, and protocol robustness while maintaining full backward compatibility.

## Conclusion

PR #8153 introduces the `SelectCore` digest as a transparent performance optimization in Cumulus. For Moonbeam, this change is:

**Completely Transparent:**
- ✅ No code changes required
- ✅ No configuration updates needed
- ✅ No runtime migrations necessary
- ✅ No test modifications required

**Performance Enhancement:**
- ⚡ Faster core determination without block execution
- ⚡ Improved validation efficiency on relay chain
- ⚡ Better proof recording and deduplication potential
- ⚡ Reduced runtime API overhead

**Low Risk:**
- ✅ Uses default implementations throughout
- ✅ Additive change with no breaking modifications
- ✅ Transparent dependency updates only
- ✅ Battle-tested in Cumulus ecosystem

### Verification Summary

| Component | Status | Evidence |
|-----------|--------|----------|
| Runtime Config | No Changes | Uses DefaultCoreSelector in all runtimes |
| Core Selection | Automatic | DefaultCoreSelector handles digest creation |
| Node Service | Transparent | No explicit digest processing needed |
| Test Suite | Compatible | Mock runtimes use same DefaultCoreSelector |
| Dependencies | Minor Bumps | All affected crates maintain compatibility |

### Recommendation

**APPROVE** - This PR can be safely integrated into the stable2506 upgrade with no concerns. The changes:
- Improve parachain validation efficiency transparently
- Require no action from the Moonbeam team
- Maintain full backward and forward compatibility
- Pose no risk to current operations
- Prepare infrastructure for future optimizations

The SelectCore digest represents thoughtful infrastructure evolution that benefits all parachains automatically while requiring no deployment coordination or custom implementation effort.

---

**Impact Level:** VERY LOW
**Risk Level:** VERY LOW
**Action Required:** NONE
**Testing Priority:** STANDARD (no special testing needed)
