# PR #8153: Introduce `SelectCore` Digest in Cumulus

## Overview

**PR**: [paritytech/polkadot-sdk#8153](https://github.com/paritytech/polkadot-sdk/pull/8153)
**Labels**: T9-cumulus
**Audience**: Node Dev
**Impact**: **INHERITED**

## Summary

This PR introduces a new `SelectCore` digest item in Cumulus that embeds core selection information directly into block headers. Previously, nodes needed to execute blocks and call the `selected_core` runtime API to determine which core a block belongs to. With this change, the selected core information (selector and claim queue offset) is now posted as a digest item in the header, allowing nodes to fetch it directly without block execution.

## Changes Made

### Modified Crates
- `cumulus-pallet-parachain-system` (minor bump)
- `cumulus-primitives-core` (minor bump)
- `polkadot-primitives` (minor bump)

### Key Changes

1. **cumulus/primitives/core/src/lib.rs**:
   - Added new `SelectCore` variant to `CumulusDigestItem` enum:
     ```rust
     #[codec(index = 1)]
     SelectCore {
         selector: CoreSelector,
         claim_queue_offset: ClaimQueueOffset,
     }
     ```
   - Added `find_select_core()` helper method to extract this digest from headers
   - Added `decode_all` validation for digest parsing

2. **cumulus/pallets/parachain-system/src/lib.rs**:
   - Modified `on_finalize` hook to post the SelectCore digest:
     ```rust
     let selected_core = T::SelectCore::selected_core();
     frame_system::Pallet::<T>::deposit_log(
         cumulus_primitives_core::CumulusDigestItem::SelectCore {
             selector: selected_core.0,
             claim_queue_offset: selected_core.1,
         }
         .to_digest_item(),
     );
     ```

3. **polkadot/primitives/src/vstaging/mod.rs**:
   - Changed `RuntimeDebug` to `Debug` for `CoreSelector` and `ClaimQueueOffset` types

## Impact on Moonbeam

### Current Usage

All three Moonbeam runtimes use the parachain-system pallet with standard configuration:

**moonbase/src/lib.rs**, **moonriver/src/lib.rs**, **moonbeam/src/lib.rs**:
```rust
impl cumulus_pallet_parachain_system::Config for Runtime {
    type SelectCore = cumulus_pallet_parachain_system::DefaultCoreSelector<Runtime>;
    // ... other config items
}
```

### Analysis

1. **No Direct Usage**: Moonbeam does not directly use `CumulusDigestItem` enum anywhere in the codebase. There is no pattern matching on this enum type.

2. **No Custom Digest Handling**: Moonbeam does not have any custom logic that processes or parses Cumulus digest items.

3. **Automatic Integration**: The new digest will be automatically posted to block headers through the parachain-system pallet's `on_finalize` hook.

4. **Non-Breaking**: Since this is a new enum variant and Moonbeam doesn't pattern match on `CumulusDigestItem`, there are no breaking changes to handle.

5. **Purely Additive**: This change adds optional information to headers that can be used by node operators and tools but doesn't require any changes to existing code.

### Benefits

- **Better Observability**: Node operators can identify which core a block belongs to by reading the header directly
- **Improved Performance**: No need to execute blocks to determine core selection
- **Proof Recorder Support**: Enables better proof recording by allowing nodes to identify blocks within the same PoV grouping

## Required Actions

**Impact Level**: **INHERITED**

### No Action Required

This change will be automatically inherited when Moonbeam updates to stable2506. No code changes, migrations, or configuration updates are needed because:

1. Moonbeam uses `DefaultCoreSelector` which is compatible with the change
2. No custom digest parsing needs to be updated
3. The functionality is automatically enabled through the parachain-system pallet
4. The change is backward compatible and non-breaking

### Optional Enhancements

While not required, Moonbeam could optionally:
- Add RPC methods to expose the selected core information from headers
- Update documentation to inform node operators about the new digest availability
- Consider using the digest information in any future custom tooling or monitoring

## Testing Recommendations

1. **Verify Digest Presence**: After upgrade, verify that blocks include the SelectCore digest in their headers
2. **Integration Tests**: Ensure existing integration tests continue to pass without modifications
3. **Header Inspection**: Use block explorers or RPC calls to confirm the digest is properly formatted

## Conclusion

PR #8153 is a non-breaking, additive enhancement that Moonbeam will automatically inherit through the polkadot-sdk dependency update. No action is required from the Moonbeam team, but the change provides useful functionality for node operators and future development.
