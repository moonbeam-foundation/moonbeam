# PR #8164 Analysis: [PoP] Add personhood tracking pallets

**PR:** https://github.com/paritytech/polkadot-sdk/pull/8164
**Labels:** T1-FRAME
**Crates Modified:** pallet-dummy-dim (major), pallet-origin-restriction (major), pallet-people (major), frame-support (minor), frame-system (minor)

## Summary

This PR adds the building blocks of a Proof of Personhood (PoP) system by introducing three new pallets and making minor enhancements to existing FRAME infrastructure. The changes include internal refactoring of `frame_system::CheckNonce` and new personhood-related traits.

## Changes Overview

### New Pallets (Optional - Not Used by Moonbeam)

1. **pallet-people**: Stores and manages identifiers of individuals who have proven their personhood, tracks personal IDs, organizes cryptographic keys into rings, and allows contextual aliases.

2. **pallet-origin-restriction**: Tracks certain origins and limits their "fee usage" accumulation. Used to limit on-chain compute for people running free transactions.

3. **pallet-dummy-dim**: Testing utility for controlling PeopleTrait interface through privileged origin. Not for production use.

### Frame-Support Changes (Minor Bump)

**File:** `substrate/frame/support/src/traits/reality.rs` (NEW)

- Adds new module `traits/reality.rs` with personhood-related traits and types:
  - `PersonalId` type alias (u64)
  - `Context`, `Alias`, `RingIndex` type aliases
  - `ContextualAlias` struct
  - `AddOnlyPeopleTrait` and `PeopleTrait` traits

**Impact:** This is a purely additive change - new traits and types that Moonbeam does not use.

### Frame-System Changes (Minor Bump)

**File:** `substrate/frame/system/src/extensions/check_nonce.rs`

Changes made:
1. Added new struct `ValidNonceInfo`:
   ```rust
   pub struct ValidNonceInfo {
       pub provides: Vec<Vec<u8>>,
       pub requires: Vec<Vec<u8>>,
   }
   ```

2. Added two new public utility functions to `CheckNonce<T>`:
   ```rust
   pub fn validate_nonce_for_account(
       who: &T::AccountId,
       nonce: T::Nonce,
   ) -> Result<ValidNonceInfo, TransactionValidityError>

   pub fn prepare_nonce_for_account(
       who: &T::AccountId,
       mut nonce: T::Nonce,
   ) -> Result<(), TransactionValidityError>
   ```

3. Refactored internal implementation of `TransactionExtension` trait methods to use these new utility functions (internal change only).

4. Changed internal `Val` enum variant from `CheckNonce((T::AccountId, T::Nonce))` to `CheckNonce(T::AccountId)` (internal only).

**File:** `substrate/frame/system/src/lib.rs`

- Re-exported `ValidNonceInfo` from `check_nonce` module

## Moonbeam Impact Assessment

### Usage Analysis

**CheckNonce Usage in Moonbeam:**
- Used in all three runtimes (moonbeam, moonriver, moonbase) as part of the transaction extension tuple:
  ```rust
  TxExtension = (
      frame_system::CheckNonZeroSender<Runtime>,
      frame_system::CheckSpecVersion<Runtime>,
      frame_system::CheckTxVersion<Runtime>,
      frame_system::CheckGenesis<Runtime>,
      frame_system::CheckEra<Runtime>,
      frame_system::CheckNonce<Runtime>,  // <-- HERE
      frame_system::CheckWeight<Runtime>,
      pallet_transaction_payment::ChargeTransactionPayment<Runtime>,
      BridgeRejectObsoleteHeadersAndMessages,
      frame_metadata_hash_extension::CheckMetadataHash<Runtime>,
  )
  ```

**Search Results:**
- No custom implementations of `CheckNonce` found in Moonbeam
- No direct usage of `validate_nonce_for_account()` or `prepare_nonce_for_account()`
- No usage of `ValidNonceInfo` struct
- No usage of personhood-related pallets or traits
- No manual nonce manipulation that would depend on internal `CheckNonce` implementation

### Breaking Changes Assessment

**None identified.** The changes to `CheckNonce` are:
1. **Internal refactoring only** - The public API of the `TransactionExtension` trait implementation remains unchanged
2. **Additive utility functions** - New public functions added, but existing functionality preserved
3. **Internal data structure changes** - The `Val` enum is internal and not exposed to runtime developers

### Required Actions

**IMPACT LEVEL: NONE**

No action required. This PR:
- Adds optional new pallets that Moonbeam doesn't use
- Adds new traits that Moonbeam doesn't use
- Makes internal improvements to `CheckNonce` without changing its public API
- Adds utility functions that could be useful for future custom extensions, but are not required

### Testing Recommendations

**Standard testing only:**
- Build all three runtimes (moonbeam, moonriver, moonbase) to ensure no compilation errors
- Run existing test suites to verify transaction processing still works correctly
- No specialized tests needed as no Moonbeam code is affected

### Compatibility Notes

- The changes are fully backward compatible
- No migration needed
- No runtime version bump required (from this PR alone)
- The new `ValidNonceInfo` struct and utility functions are available if Moonbeam wants to create custom transaction extensions that need nonce validation in the future

## Conclusion

**Impact Category:** No Impact

This PR introduces new optional functionality for Proof of Personhood systems and refactors internal implementation of `CheckNonce` without breaking existing APIs. Moonbeam only uses `CheckNonce` as a standard transaction extension and doesn't customize its behavior, so the internal changes are transparent to Moonbeam's runtime.

The PR is safe to include in the upgrade with no code changes required.
