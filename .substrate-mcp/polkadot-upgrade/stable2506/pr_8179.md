# PR #8179: Make pallet-identity benchmarks signature-agnostic

## Overview

**PR Title**: Do not make pallet-identity benchmarks signature-dependent
**GitHub**: https://github.com/paritytech/polkadot-sdk/pull/8179
**Labels**: T2-pallets
**Breaking Change**: Yes (major bump to pallet-identity)

## Summary

This PR introduces a `BenchmarkHelper` configuration trait to `pallet-identity`, abstracting away the explicit dependency on Sr25519 signature scheme in benchmarks. This allows chains using different cryptographic signatures (like ECDSA for Ethereum compatibility) to run accurate benchmarks and calculate proper weights.

## Changes to pallet-identity

### New Configuration Type

A new `BenchmarkHelper` trait is added to the pallet config:

```rust
#[cfg(feature = "runtime-benchmarks")]
pub trait BenchmarkHelper<Public, Signature> {
    fn sign_message(message: &[u8]) -> (Public, Signature);
}
```

### Default Implementation

The PR provides a default implementation for `()` that maintains backward compatibility:

```rust
#[cfg(feature = "runtime-benchmarks")]
impl BenchmarkHelper<sp_runtime::MultiSigner, sp_runtime::MultiSignature> for () {
    fn sign_message(message: &[u8]) -> (sp_runtime::MultiSigner, sp_runtime::MultiSignature) {
        let public = sp_io::crypto::sr25519_generate(0.into(), None);
        let signature = sp_runtime::MultiSignature::Sr25519(
            sp_io::crypto::sr25519_sign(0.into(), &public.into_account()
                .try_into().unwrap(), message).unwrap(),
        );
        (public.into(), signature)
    }
}
```

**Important**: The default implementation uses Sr25519 signatures.

## Impact on Moonbeam

### Required Code Changes

All three Moonbeam runtimes must add the new configuration type to their `pallet_identity::Config` implementations:

**Files to Update**:
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs` (line 637)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs` (line 636)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs` (line 629)

**Required Addition**:
```rust
impl pallet_identity::Config for Runtime {
    // ... existing config items ...
    #[cfg(feature = "runtime-benchmarks")]
    type BenchmarkHelper = ();
}
```

### Signature Scheme Mismatch

**Critical Finding**: Moonbeam uses a fundamentally different signature scheme than the default implementation:

- **Moonbeam's Signature**: `EthereumSignature` (ECDSA-based)
  - Defined in `/Users/manuelmauro/Workspace/moonbeam/core-primitives/src/lib.rs`:
  ```rust
  pub type Signature = EthereumSignature;
  ```
  - Uses `secp256k1_ecdsa_recover` for verification
  - Compatible with Ethereum wallets and tooling

- **Default BenchmarkHelper**: Uses Sr25519 signatures
  - Different cryptographic properties
  - Potentially different computational costs

### Benchmarking Implications

Moonbeam actively runs benchmarks using `frame-omni-bencher`:
- Script: `/Users/manuelmauro/Workspace/moonbeam/scripts/run-benches-for-runtime.sh`
- All three runtimes have generated weight files in `runtime/*/src/weights/pallet_identity.rs`

**Using the default `()` implementation means**:
1. Benchmarks will use Sr25519 signatures during execution
2. Generated weights may not accurately reflect ECDSA signature verification costs
3. Potential for inaccurate weight calculations in production

### Pallet Identity Usage in Moonbeam

Moonbeam has extensive integration with pallet-identity:

1. **Precompile Integration**: `/Users/manuelmauro/Workspace/moonbeam/precompiles/identity/src/lib.rs`
   - Exposes identity functionality to EVM contracts
   - Allows Solidity contracts to interact with Substrate identity features

2. **Current Configuration**:
   - All runtimes implement `pallet_identity::Config`
   - Use `pallet_identity::legacy::IdentityInfo` for identity information
   - Configure deposits, registrars, username features

3. **Testing**:
   - TypeScript tests: `/Users/manuelmauro/Workspace/moonbeam/test/suites/dev/moonbase/test-precompile/test-precompile-identity6.ts`
   - Proxy identity tests: `/Users/manuelmauro/Workspace/moonbeam/test/suites/dev/moonbase/test-proxy/test-proxy-identity.ts`

## Recommendations

### 1. Immediate Action (Required)

Add the `BenchmarkHelper` configuration to all three runtimes:

```rust
#[cfg(feature = "runtime-benchmarks")]
type BenchmarkHelper = ();
```

This will allow compilation but uses Sr25519 signatures in benchmarks.

### 2. Medium-Term Improvement (Recommended)

Implement a custom `BenchmarkHelper` for Ethereum signatures to ensure accurate benchmarking:

**Create in** `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/benchmarking.rs`:

```rust
#[cfg(feature = "runtime-benchmarks")]
pub struct IdentityBenchmarkHelper;

#[cfg(feature = "runtime-benchmarks")]
impl pallet_identity::BenchmarkHelper<
    account::EthereumSigner,
    account::EthereumSignature
> for IdentityBenchmarkHelper {
    fn sign_message(message: &[u8]) -> (account::EthereumSigner, account::EthereumSignature) {
        use sp_core::{ecdsa, Pair};

        // Generate a test keypair
        let pair = ecdsa::Pair::from_seed(&[0u8; 32]);
        let public = pair.public();

        // Hash the message with Keccak256 (Ethereum-style)
        let mut m = [0u8; 32];
        m.copy_from_slice(sha3::Keccak256::digest(message).as_slice());

        // Sign the hashed message
        let signature = pair.sign_prehashed(&m);

        (public.into(), signature.into())
    }
}
```

**Then use in runtimes**:
```rust
#[cfg(feature = "runtime-benchmarks")]
type BenchmarkHelper = moonbeam_runtime_common::benchmarking::IdentityBenchmarkHelper;
```

### 3. Post-Upgrade Action

After upgrading to stable2506:
1. Re-run benchmarks for all runtimes to generate updated weights
2. If using custom `IdentityBenchmarkHelper`, verify weights differ from Sr25519-based benchmarks
3. Test identity precompile functionality to ensure compatibility

## Migration Requirements

**Storage Migrations**: None required
**Runtime Upgrade**: Standard runtime version bump needed
**API Changes**: No breaking changes to identity pallet interface

## Testing Checklist

- [ ] Verify compilation with `type BenchmarkHelper = ()`
- [ ] Run existing identity precompile tests
- [ ] Execute benchmark suite with new configuration
- [ ] Compare weight differences if implementing custom helper
- [ ] Test username functionality (uses signatures)
- [ ] Verify proxy identity operations continue working

## Affected Components

### Direct Impact
- All three runtime configurations (moonbase, moonriver, moonbeam)
- Identity benchmarking infrastructure
- Weight calculation accuracy

### Indirect Impact
- Identity precompile (uses pallet-identity underneath)
- EVM contracts calling identity functions
- Username verification flows

## Benefits for Moonbeam

1. **Compilation Compatibility**: Enables upgrade to stable2506
2. **Potential Accuracy Improvement**: With custom implementation, get weights accurate for ECDSA
3. **Future-Proofing**: Properly abstracts signature scheme for benchmarking
4. **Ecosystem Alignment**: Follows Polkadot SDK best practices for multi-signature support

## Risk Assessment

**Risk Level**: Medium

**Risks**:
- Using default implementation may result in inaccurate weights for ECDSA operations
- Inaccurate weights could lead to incorrect fee calculations or DoS vulnerabilities
- Weight discrepancies might affect identity-related transaction costs

**Mitigation**:
- Implement custom `IdentityBenchmarkHelper` for Ethereum signatures
- Re-run benchmarks after upgrade
- Monitor identity transaction performance in testnet before mainnet deployment

## References

- **PRDoc**: `/Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_8179.prdoc`
- **Moonbeam Signature Definition**: `/Users/manuelmauro/Workspace/moonbeam/core-primitives/src/lib.rs:29`
- **EthereumSignature Implementation**: `/Users/manuelmauro/Workspace/moonbeam/primitives/account/src/lib.rs:141`
- **Identity Precompile**: `/Users/manuelmauro/Workspace/moonbeam/precompiles/identity/src/lib.rs`
- **Benchmark Scripts**: `/Users/manuelmauro/Workspace/moonbeam/scripts/run-benches-for-runtime.sh`

## Conclusion

PR #8179 is a breaking but necessary change that improves pallet-identity's flexibility for chains using non-Sr25519 signatures. Moonbeam must add the `BenchmarkHelper` configuration type to compile. While the default implementation will work, implementing a custom ECDSA-based helper is strongly recommended to ensure accurate weight calculations that reflect Moonbeam's actual Ethereum-compatible signature scheme.
