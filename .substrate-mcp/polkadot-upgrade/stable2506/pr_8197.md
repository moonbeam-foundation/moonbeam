# PR #8197 Analysis: [pallet-revive] add fee_history

## Overview

- **PR Title**: [pallet-revive] add fee_history
- **GitHub**: https://github.com/paritytech/polkadot-sdk/pull/8197
- **PRDoc**: /Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_8197.prdoc
- **Audience**: Runtime Dev
- **Crates Modified**:
  - pallet-revive-eth-rpc (patch)
  - pallet-revive (patch)

## Summary

This PR adds the `eth_feeHistory` RPC method to the pallet-revive Ethereum RPC interface. The implementation provides EIP-1159 compliant fee history data, enabling clients to retrieve historical gas price information across multiple blocks for transaction fee estimation.

## Changes Made

### Core Implementation

1. **New RPC Endpoint** (`execution_apis.rs`)
   - Added `fee_history` method accepting:
     - Block count: number of blocks to query
     - Newest block: starting point for historical query
     - Reward percentiles: optional array for percentile-based fee calculations
   - Returns `FeeHistoryResult` with base fees, gas usage ratios, and reward data

2. **Fee History Provider** (`fee_history_provider.rs` - new file)
   - Implemented caching mechanism via `HashMap`
   - `FeeHistoryCacheItem` struct stores:
     - Base fee per gas
     - Gas usage ratio
     - Reward percentile data
   - Provider handles fee history calculation and retrieval

3. **Client Integration** (`client.rs`)
   - Integrated `FeeHistoryProvider` into RPC client
   - Enhanced block subscription to extract transaction receipts
   - Added `evm_block_from_receipts` for pre-computed receipt data
   - Exposed public `fee_history` method delegating to provider

4. **Type Definitions** (`rpc_types.rs`, `rpc_types_gen.rs`)
   - Added `FeeHistoryResult` type for EIP-1159 compliant responses

### Implementation Details

The PR includes percentile-based reward calculations with the following arithmetic pattern:
```rust
let index = ((p.round() / 2f64) * 2f64) * resolution_per_percentile;
```

This maps user-provided percentile values to reward indices for fee estimation.

## Moonbeam Impact Assessment

### Classification: NOT APPLICABLE

**Rationale:**

Moonbeam does NOT use pallet-revive for Ethereum compatibility. Instead, Moonbeam uses the **Frontier framework** consisting of:
- `pallet-ethereum`
- `pallet-evm`
- Associated Frontier RPC infrastructure

### Evidence

1. **Runtime Dependencies Analysis**
   - Examined `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/Cargo.toml`
   - Examined `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/Cargo.toml`
   - No references to `pallet-revive` or `pallet-revive-eth-rpc` found
   - Confirmed usage of Frontier pallets:
     ```toml
     pallet-ethereum = { workspace = true, features = ["forbid-evm-reentrancy"] }
     pallet-evm = { workspace = true, features = ["forbid-evm-reentrancy"] }
     fp-evm = { workspace = true }
     fp-rpc = { workspace = true }
     ```

2. **Existing Fee History Support**
   - Moonbeam already implements `eth_feeHistory` through Frontier
   - Found in `/Users/manuelmauro/Workspace/moonbeam/node/service/src/rpc.rs`:
     - `fee_history_limit` configuration
     - `fee_history_cache: FeeHistoryCache`
     - `EthTask::fee_history_task` implementation
   - Tests confirm functionality:
     - `/Users/manuelmauro/Workspace/moonbeam/test/suites/dev/moonbase/test-eth-fee/test-eth-fee-history.ts`
     - `/Users/manuelmauro/Workspace/moonbeam/test/suites/smoke/test-historic-compatibility.ts`

3. **Codebase Verification**
   - Grep search for `pallet-revive` across entire Moonbeam repository returned no results in source code
   - Only references found were in analysis files within `.substrate-mcp` directory

### What is pallet-revive?

Pallet-revive appears to be an alternative Ethereum compatibility layer within the Polkadot SDK ecosystem, separate from the Frontier framework. It provides its own:
- EVM execution environment
- Ethereum RPC interface
- Contract execution model

This is distinct from and incompatible with Moonbeam's Frontier-based architecture.

## Action Required

**None** - This change does not affect Moonbeam.

## Additional Notes

- Moonbeam's existing fee history implementation through Frontier is fully functional
- No migration or integration work is needed
- This PR is relevant only for chains using pallet-revive as their Ethereum compatibility layer
- Moonbeam should continue monitoring Frontier framework updates for fee history improvements

## Related Issues

- Fixes: https://github.com/paritytech/contract-issues/issues/39 (pallet-revive specific)

## Recommendation

**No action required.** This PR can be safely ignored for Moonbeam upgrade planning as it pertains to a different Ethereum compatibility framework that Moonbeam does not use.
