# PR Analysis: #8197 - [pallet-revive] add fee_history

## PR Metadata
- **GitHub URL**: https://github.com/paritytech/polkadot-sdk/pull/8197
- **Merged**: April 29, 2025
- **Labels**: R0-no-crate-publish-required, T7-smart_contracts
- **Audience**: Runtime Dev
- **Crates**: pallet-revive-eth-rpc (patch bump), pallet-revive (patch bump)

## Summary

This PR adds the `eth_feeHistory` RPC method to `pallet-revive`'s Ethereum-compatible RPC interface. The implementation provides historical gas price data and effective priority fee metrics for EIP-1159 fee history queries, addressing issue #39 in the contract-issues repository.

## Technical Changes

### Core Additions

**1. New RPC Method** (`substrate/frame/revive/rpc/src/apis/execution_apis.rs`)
```rust
eth_feeHistory(block_count, newest_block, reward_percentiles)
  -> FeeHistoryResult
```
Returns:
- Base fee per gas for requested block range
- Gas used ratio for each block
- Effective priority fee percentiles (when requested)
- Oldest block number in the result set

**2. Fee History Provider** (`substrate/frame/revive/rpc/src/fee_history_provider.rs`)
- New `FeeHistoryProvider` struct for managing cached fee information
- `FeeHistoryCacheItem` containing:
  - Base fee per gas
  - Gas usage ratio
  - Reward data (priority fees)

**3. Client Refactoring** (`substrate/frame/revive/rpc/src/client.rs`)
- Integrated `FeeHistoryProvider` into Client struct
- Refactored block handling to extract transaction and receipt data separately
- Added public `fee_history()` method for historical fee queries
- Updated block subscription logic for fee data collection

**4. Supporting Infrastructure**
- Modified `fee_history.rs` for cache implementation (27 additions)
- Updated RPC type definitions in `rpc_types.rs` and `rpc_types_gen.rs`
- Enhanced receipt handling in `receipt_provider.rs` and `receipt_extractor.rs`

### Modified Crates

- `pallet-revive-eth-rpc` (patch bump) - Added fee_history RPC method
- `pallet-revive` (patch bump) - Supporting changes for fee data

## Impact on Moonbeam

**Impact Level**: INHERITED

**Reasoning**:

Moonbeam is **not affected** by this PR because:

### 1. Different Smart Contract Architecture

**Moonbeam uses `pallet-evm` (Frontier), not `pallet-revive`**

Evidence from runtime configuration:
```rust
// From /Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs:1450
construct_runtime! {
    pub enum Runtime {
        // ...
        EVM: pallet_evm::{Pallet, Config<T>, Call, Storage, Event<T>} = 51,
        Ethereum: pallet_ethereum::{Pallet, Call, Storage, Event, Origin, Config<T>} = 52,
        // ...
    }
}
```

Codebase search confirms no `pallet-revive` usage:
```bash
grep -r "pallet-revive\|pallet_revive" /Users/manuelmauro/Workspace/moonbeam
# Result: Only found in other PR analysis files, not in actual runtime code
```

### 2. Moonbeam Already Has eth_feeHistory

**Moonbeam implements `eth_feeHistory` via Frontier's fc_rpc library**

Implementation evidence:

**RPC Layer** (`/Users/manuelmauro/Workspace/moonbeam/node/service/src/rpc.rs:33`):
```rust
use fc_rpc_core::types::{FeeHistoryCache, FilterPool, TransactionRequest};
```

**Service Configuration** (`/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:568`):
```rust
let filter_pool: Option<FilterPool> = Some(Arc::new(Mutex::new(BTreeMap::new())));
let fee_history_cache: FeeHistoryCache = Arc::new(Mutex::new(BTreeMap::new()));
```

**RPC Parameters** (`/Users/manuelmauro/Workspace/moonbeam/node/service/src/rpc.rs`):
```rust
pub struct EthRpcParams {
    pub fee_history_cache: FeeHistoryCache,
    pub fee_history_limit: u64,
    // ...
}
```

**Integration Tests** (`/Users/manuelmauro/Workspace/moonbeam/test/suites/dev/moonbase/test-eth-fee/test-eth-fee-history.ts`):
```typescript
describeSuite({
  id: "D021001",
  title: "Fee History",
  testCases: ({ context, it, log }) => {
    // Test T01: result length should match spec
    // Test T02: should calculate percentiles
    // Test T03: result length with integer block count
    const result = await customDevRpcRequest("eth_feeHistory", [
      block_count,
      "latest",
      reward_percentiles,
    ]);
  }
});
```

### 3. Architecture Comparison

**PR #8197 (pallet-revive):**
- VM: PolkaVM (WASM-based)
- RPC: Custom pallet-revive-eth-rpc
- Fee History: New implementation in this PR
- Target Chains: Asset Hub, future PolkaVM chains

**Moonbeam:**
- VM: EVM (Ethereum-native)
- RPC: Frontier fc_rpc (fc_rpc_core)
- Fee History: Already implemented via FeeHistoryCache
- Production Status: Tested and deployed on Moonbeam/Moonriver/Moonbase

### 4. No Shared Dependencies

The two implementations are completely separate:

| Component | pallet-revive | Moonbeam |
|-----------|--------------|----------|
| Smart Contract Pallet | pallet-revive | pallet-evm |
| RPC Layer | pallet-revive-eth-rpc | fc-rpc |
| Fee History Provider | FeeHistoryProvider (custom) | FeeHistoryCache (Frontier) |
| Block Data Source | pallet-revive state | pallet-ethereum storage |
| Gas Model | PolkaVM gas | EVM gas |

## Compatibility Assessment

### Current Compatibility: FULLY COMPATIBLE

**Evidence:**

1. **No pallet-revive dependency**
   - Moonbeam does not compile or link against pallet-revive
   - Runtime configuration uses only pallet-evm and pallet-ethereum
   - No imports of pallet-revive types or traits

2. **Independent RPC implementations**
   - Moonbeam: Uses `fc_rpc::Eth` from Frontier
   - pallet-revive: Uses custom `pallet_revive_eth_rpc::Eth`
   - No shared code paths

3. **Existing eth_feeHistory functionality validated**
   - Test suite: `/Users/manuelmauro/Workspace/moonbeam/test/suites/dev/moonbase/test-eth-fee/test-eth-fee-history.ts`
   - Tests validate EIP-1159 compliance
   - Tests verify base fee calculation, gas usage ratios, and percentile calculations
   - Historic compatibility tested in `/Users/manuelmauro/Workspace/moonbeam/test/suites/smoke/test-historic-compatibility.ts`

## Testing Impact

### Existing Tests: NO CHANGES REQUIRED

Moonbeam's eth_feeHistory tests are comprehensive and will continue to work:

**Test Coverage** (`test-eth-fee-history.ts`):
- T01: Result length validation (baseFeePerGas array size = block_count + 1)
- T02: Percentile calculation verification
- T03: Integer block count parameter support

**Test Validation**:
```typescript
// From test-eth-fee-history.ts:96
const result = await customDevRpcRequest("eth_feeHistory", [
  "0x2",        // Block count (hex)
  "latest",     // Newest block
  [20, 50, 70]  // Reward percentiles
]) as FeeHistory;

expect(result.baseFeePerGas.length).toBe(block_count + 1);
expect(result.gasUsedRatio.length).toBe(block_count);
expect(result.reward.length).toBe(block_count);
```

These tests validate identical behavior to what PR #8197 implements for pallet-revive, confirming Moonbeam's implementation is already EIP-1159 compliant.

## Observations

### 1. Implementation Convergence

Both Moonbeam and pallet-revive now provide the same `eth_feeHistory` interface, demonstrating:
- **EIP-1159 Standardization**: Both implementations follow Ethereum's fee history specification
- **Parallel Development**: Moonbeam had this functionality before pallet-revive
- **Different Execution Paths**: Same API, different underlying VMs (EVM vs PolkaVM)

### 2. Future Polkadot SDK Trends

PR #8197 shows that Polkadot SDK is developing Ethereum-compatible features for PolkaVM:
- `eth_feeHistory` (this PR)
- ERC20 support (PR #7762)
- Genesis configuration (PR #8103)

**Implication for Moonbeam**: These features validate Moonbeam's early adoption of Ethereum compatibility, but don't require Moonbeam to change as they target a different VM architecture.

### 3. Testing Pattern Similarity

Comparing test patterns:

**Moonbeam** (TypeScript):
```typescript
const feeResults = await customDevRpcRequest("eth_feeHistory", [
  block_count,
  "latest",
  reward_percentiles
]);
```

**pallet-revive** (would be similar in integration tests):
```typescript
const feeResults = await eth_feeHistory(
  block_count,
  "latest",
  reward_percentiles
);
```

Both test the same EIP-1159 compliance requirements, showing independent but aligned development.

## Action Items

### Required Actions: NONE

No code changes, migrations, runtime updates, or test modifications required.

### Recommended Actions (Optional):

1. **Monitor pallet-revive Development**
   - Track feature parity between pallet-revive and pallet-evm
   - Note which Ethereum RPC methods pallet-revive implements
   - Evaluate if any new patterns/optimizations could benefit Moonbeam

2. **Documentation Awareness**
   - If documenting Moonbeam's Ethereum compatibility, note that similar features exist in pallet-revive
   - Clarify that Moonbeam uses native EVM while Asset Hub/others may use PolkaVM
   - Reference both implementations when discussing Polkadot SDK's Ethereum compatibility story

3. **Cross-Chain Compatibility Considerations**
   - If Moonbeam ever needs to interact with pallet-revive chains
   - Both expose similar Ethereum RPC interfaces
   - Fee history data formats are compatible (EIP-1159 compliant)

## Conclusion

**Impact Level**: INHERITED (No action required)

PR #8197 adds `eth_feeHistory` to pallet-revive but has **zero direct impact** on Moonbeam:

1. **Different Architecture**: pallet-revive (PolkaVM) vs. pallet-evm (EVM)
2. **Already Implemented**: Moonbeam has mature eth_feeHistory via Frontier
3. **No Dependencies**: Completely separate code paths and implementations
4. **Fully Compatible**: Existing tests and functionality unchanged

Moonbeam can upgrade to stable2506 without any changes related to this PR. The new functionality is specific to pallet-revive chains and demonstrates parallel evolution of Ethereum compatibility across different VM architectures in the Polkadot SDK.

## References

### Moonbeam Implementation Files
- RPC Configuration: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/rpc.rs`
- Service Setup: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs`
- Integration Tests: `/Users/manuelmauro/Workspace/moonbeam/test/suites/dev/moonbase/test-eth-fee/test-eth-fee-history.ts`
- Smoke Tests: `/Users/manuelmauro/Workspace/moonbeam/test/suites/smoke/test-historic-compatibility.ts`
- Moonriver Runtime: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs`

### PR #8197 Key Files
- PRDoc: `/Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_8197.prdoc`
- GitHub PR: https://github.com/paritytech/polkadot-sdk/pull/8197
- Diff: https://github.com/paritytech/polkadot-sdk/pull/8197/files

### Modified Polkadot SDK Crates
- `pallet-revive-eth-rpc` (patch bump) - Added eth_feeHistory RPC method
- `pallet-revive` (patch bump) - Supporting fee history infrastructure

### Related PRs
- PR #7762: ERC20 Asset Transactor for pallet-revive
- PR #8103: Genesis configuration for pallet-revive
- Both demonstrate parallel Ethereum compatibility development for PolkaVM

---

**Analysis Date:** 2025-10-23
**Moonbeam Branch:** manuel/substrate-mcp-depup-2025-10-23
**Polkadot SDK Target:** stable2506
