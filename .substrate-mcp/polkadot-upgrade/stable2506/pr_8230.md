# PR #8230: Add Parachain Block Validation Latency Metrics and Logs

## Overview

**PR Title:** collator-protocol: add more collation observability

**GitHub PR:** https://github.com/paritytech/polkadot-sdk/pull/8230

**Labels:** T0-node, T9-cumulus

**Audience:** Node Dev

**Impact Category:** LOW - Observability Enhancement (Non-Breaking)

## Summary

This PR introduces comprehensive observability for the collation lifecycle by adding metrics and logging to track parachain block production and validation performance. The changes enable node operators to monitor:
- Time until collation is fetched by validators
- Backing latency (measured from relay parent and from collation fetch)
- Inclusion latency
- Expired collations (never backed, advertised, or fetched)

These metrics are crucial for diagnosing performance bottlenecks in parachain block production and optimizing collator configurations.

## Changes

### New Metrics

According to the PRDoc and PR description, the following observability features are added:

1. **Time till collation fetched**: Measures the duration from collation creation to when validators request it
2. **Backing latency (from RP)**: Tracks delay from relay parent creation to backing
3. **Backing latency (from fetch)**: Tracks delay from collation retrieval to backing
4. **Inclusion latency**: Measures time from creation to final block inclusion
5. **Expired collations counter**: Identifies collations that were:
   - Not backed
   - Not advertised
   - Not fetched

### New Logging

The PR adds structured logging with collation status labels:
- **"created"**: Initial collation generation
- **"advertised"**: Collation announced to validators
- **"requested"**: Validator has requested the collation

Additional debug logging tracks the validator's view state with `live_head_count` field.

### Affected Crates

- **polkadot-collator-protocol** (patch bump)
- **polkadot-network-bridge** (patch bump)
- **polkadot-node-subsystem-util** (minor bump)

## Impact on Moonbeam

### Classification

**Category:** LOW IMPACT - Observability Enhancement
**Type:** Node-level metrics and logging (T0-node, T9-cumulus)
**Action Required:** None (automatic benefit on upgrade)

### 1. Collator Service Integration - DIRECT BENEFIT

**Evidence:**

Moonbeam uses `CollatorService` from `cumulus-client-collator`, which interfaces with the Polkadot collator protocol subsystems:

```rust
// /Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:28
use cumulus_client_collator::service::CollatorService;

// Lines 1020-1025
let collator_service = CollatorService::new(
    client.clone(),
    Arc::new(task_manager.spawn_handle()),
    announce_block,
    client.clone(),
);

// Line 1072 - Passed to Nimbus consensus
collator_service,
```

**Impact:**
The new metrics will automatically be exposed through Moonbeam's collator service when it creates, advertises, and has its collations fetched by relay chain validators.

### 2. Relay Chain Communication - MONITORING ENABLED

**Evidence:**

Moonbeam maintains a relay chain interface and overseer handle for parachain validation:

```rust
// /Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:41
use cumulus_relay_chain_interface::{OverseerHandle, RelayChainInterface, RelayChainResult};

// Lines 930-932
let overseer_handle = relay_chain_interface
    .overseer_handle()
    .map_err(|e| sc_service::Error::Application(Box::new(e)))?;

// Line 1076 - Passed to consensus
overseer_handle,
```

**Impact:**
The overseer handle is used by the collator protocol subsystem to communicate with relay chain validators. The new metrics track this communication, providing visibility into:
- How quickly validators request Moonbeam's collations
- How long it takes for collations to be backed
- Whether collations are being fetched or ignored

### 3. Asynchronous Backing - PERFORMANCE VISIBILITY

**Evidence:**

Moonbeam uses asynchronous backing for improved block production:

```rust
// /Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:1047
log::info!("Collator started with asynchronous backing.");

// Lines 1366-1367
async_backing_params: AsyncBackingParams {
    // ... configuration ...
```

**Impact:**
With asynchronous backing enabled, these new metrics become even more valuable for monitoring:
- Whether collations are being produced efficiently
- If validators are fetching collations promptly
- Whether the relay chain is backing blocks in a timely manner

### 4. Prometheus Metrics Integration - AUTOMATIC EXPORT

**Evidence:**

Moonbeam already has a comprehensive Prometheus metrics setup with custom "moonbeam_" prefix:

```rust
// /Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:452-466
fn set_prometheus_registry(
    config: &mut Configuration,
    no_prometheus_prefix: bool,
) -> Result<(), sc_service::Error> {
    if let Some(PrometheusConfig { registry, .. }) = config.prometheus_config.as_mut() {
        let prefix = if no_prometheus_prefix {
            None
        } else {
            Some("moonbeam".to_string())
        };
        // ... custom registry with labels ...
        *registry = Registry::new_custom(prefix, Some(labels))?;
    }
    Ok(())
}
```

**Impact:**
The new collation metrics from the Polkadot collator protocol will be automatically registered in Moonbeam's Prometheus registry and exported with appropriate prefixes, making them available for monitoring dashboards.

### 5. Collation Info Collection - EXISTING INTEGRATION POINT

**Evidence:**

```rust
// /Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:38
CollectCollationInfo, ParaId,

// Lines 1382-1386
.collect_collation_info(block, &current_para_head)
.await
{
    Ok(collation_info) => collation_info,
    Err(e) => {
        log::error!("Failed to collect collation info: {:?}", e);
```

**Impact:**
Moonbeam already collects collation information for blocks. The new metrics will track what happens to these collations after they're created, providing end-to-end visibility.

## Benefits for Moonbeam

### Operational Advantages

1. **Performance Monitoring**
   - Identify slow backing times that could delay block finalization
   - Detect if validators are not fetching collations (network issues, collator reputation)
   - Monitor inclusion latency to ensure blocks are finalized promptly

2. **Debugging Capabilities**
   - Diagnose why blocks are not being produced at expected rates
   - Identify patterns in collation expiry (e.g., time-of-day issues, network congestion)
   - Correlate collation metrics with Ethereum transaction throughput

3. **Infrastructure Optimization**
   - Determine if collator hardware needs upgrading based on creation-to-fetch times
   - Validate that network configuration allows validators to reach collators
   - Benchmark different collator setups using concrete metrics

4. **Relay Chain Health Visibility**
   - Monitor relay chain validator responsiveness
   - Detect relay chain congestion by tracking backing latency
   - Understand impact of relay chain upgrades on parachain block production

### Moonbeam-Specific Use Cases

**EVM Transaction Throughput:**
Moonbeam processes Ethereum-compatible transactions. These metrics help correlate:
- High EVM transaction volume → Longer collation creation times
- Complex smart contract execution → Delayed collation advertising
- Network congestion → Extended backing latency

**Collator Decentralization:**
Moonbeam has multiple collators. These metrics enable:
- Comparing performance across different collator operators
- Identifying if specific collators have backing issues
- Ensuring all collators are effectively participating

**Network Monitoring:**
Track metrics across networks:
- Moonbeam (Polkadot parachain)
- Moonriver (Kusama parachain)
- Moonbase Alpha (testnet)

This allows comparing relay chain performance and optimizing for each environment.

## No Action Required

### Why No Changes Are Needed

1. **Automatic Integration**: Metrics are added internally to crates Moonbeam already depends on
2. **Non-Breaking Changes**: Patch/minor version bumps indicate backward compatibility
3. **Transparent Operation**: Metrics collection happens within existing code paths
4. **Prometheus Auto-Export**: Moonbeam's existing Prometheus setup will automatically expose new metrics

### Upgrade Process

1. **Dependency Update**: Update to stable2506 which includes PR #8230
2. **Compile**: Run `cargo build --release`
3. **Deploy**: Standard deployment process, no configuration changes needed
4. **Monitor**: New metrics automatically appear in Prometheus endpoint

## Monitoring Recommendations

### Suggested Metrics to Track

Once upgraded, node operators should monitor:

1. **`polkadot_parachain_collation_time_to_fetch`** (or similar naming)
   - Alert if consistently > 2 seconds (validators not fetching promptly)

2. **`polkadot_parachain_backing_latency_from_rp`**
   - Alert if > 6 seconds (relay slot duration)
   - May indicate relay chain congestion

3. **`polkadot_parachain_backing_latency_from_fetch`**
   - Alert if > 4 seconds
   - Indicates validator backing delays

4. **`polkadot_parachain_inclusion_latency`**
   - Alert if > 12 seconds (two relay slots)
   - Critical for finality guarantees

5. **`polkadot_parachain_expired_collations_total`**
   - Alert if non-zero and increasing
   - Indicates collations being wasted (network/reputation issues)

### Dashboard Queries

Example Prometheus queries for Moonbeam:

```promql
# Average time for validators to fetch collations
rate(moonbeam_polkadot_parachain_collation_time_to_fetch_sum[5m])
  / rate(moonbeam_polkadot_parachain_collation_time_to_fetch_count[5m])

# Percentage of expired collations
rate(moonbeam_polkadot_parachain_expired_collations_total[5m])
  / rate(moonbeam_polkadot_parachain_collations_created_total[5m]) * 100

# 99th percentile backing latency
histogram_quantile(0.99, moonbeam_polkadot_parachain_backing_latency_from_rp)
```

Note: Exact metric names may vary; consult the Prometheus `/metrics` endpoint after upgrade.

## Testing and Validation

### Verification Steps

1. **Metrics Endpoint Check**
   ```bash
   # After deployment, verify new metrics appear
   curl http://localhost:9615/metrics | grep -i collation
   curl http://localhost:9615/metrics | grep -i backing
   ```

2. **Log Monitoring**
   ```bash
   # Check for new structured logs
   journalctl -u moonbeam.service -f | grep -i "collation\|backing"
   ```

3. **Grafana Dashboard**
   - Import or create dashboard to visualize new metrics
   - Set baseline values before any performance tuning
   - Compare across different collators

### Test Scenarios

1. **Normal Operation**
   - All metrics should show healthy values
   - Backing latency < relay slot duration
   - Zero or minimal expired collations

2. **Heavy Load**
   - Simulate high EVM transaction volume
   - Verify collation creation doesn't delay fetching
   - Check if backing latency increases proportionally

3. **Network Issues**
   - Temporarily block validator connections
   - Verify expired collations metric increments
   - Confirm recovery when network restored

## Risk Assessment

### Risk Level: **MINIMAL**

**Justification:**
1. **Observability Only**: No changes to core collation logic
2. **Battle Tested**: Part of Polkadot SDK stable release
3. **Patch/Minor Bumps**: Indicates low-risk, backward-compatible changes
4. **Optional Monitoring**: Metrics collection has negligible performance impact
5. **No Configuration**: Works out-of-the-box with existing setup

### Potential Concerns

**None identified.** This is a pure observability enhancement with no functional changes to collation behavior.

## Related Information

### Issue Context
- **Fixes:** polkadot-sdk#7575 (Parachain block time improvements)
- **Purpose:** Understanding causes and possible improvements for higher parachain block times

### Dependencies
All affected crates are already in Moonbeam's dependency tree:
- `polkadot-collator-protocol`: Via cumulus dependencies
- `polkadot-network-bridge`: Via relay chain interface
- `polkadot-node-subsystem-util`: Via cumulus-relay-chain-* crates

### Documentation
- **PRDoc:** `/Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_8230.prdoc`
- **PR Discussion:** Review comments may contain additional context on metric semantics

## Conclusion

PR #8230 is a **low-risk, high-value observability enhancement** that provides crucial visibility into Moonbeam's parachain block production and validation performance.

### Key Takeaways

1. **Zero Code Changes Required**: Metrics are automatically available after dependency update
2. **Operational Benefits**: Enables proactive monitoring of collator and relay chain performance
3. **Debugging Tools**: Provides data to diagnose block production issues
4. **Production Ready**: Patch/minor version bumps indicate stable, tested changes

### Recommendation

**APPROVE** - This PR should be included in the stable2506 upgrade with enthusiasm. The observability improvements will significantly enhance Moonbeam's operational capabilities with zero implementation effort.

### Next Steps

1. **Immediate**: Include in stable2506 upgrade (no blockers)
2. **Post-Upgrade**: Document actual metric names from `/metrics` endpoint
3. **Week 1**: Create Grafana dashboards for new metrics
4. **Week 2**: Establish baseline values and alert thresholds
5. **Ongoing**: Use metrics to optimize collator infrastructure and monitor relay chain health

---

**Analysis Date:** October 22, 2025
**Analyst Notes:** This is a textbook example of a beneficial upstream improvement that Moonbeam can adopt with zero effort and immediate operational value.
