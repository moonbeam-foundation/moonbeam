# PR #8234 Impact Analysis

## Summary
**Title:** Set a memory limit when decoding an `UncheckedExtrinsic`

**Labels:** I9-optimisation, T17-primitives

**Impact Level:** INHERITED

## Description
This PR introduces a 16 MiB heap memory limit when decoding `UncheckedExtrinsic` to prevent denial-of-service attacks from oversized extrinsic payloads. It also includes refactoring changes:
- Moves `ExtrinsicCall` trait from `frame-support` to `sp-runtime`
- Removes `EnsureInherentsAreFirst` trait, moving its logic to `frame-executive`
- Promotes use of dedicated constructors (`new_signed()`, `new_bare()`, `from_parts()`)

## Changes in Polkadot SDK

### Modified Crates
- `frame-support` (major bump) - removed `ExtrinsicCall` trait
- `sp-runtime` (minor bump) - added `ExtrinsicCall` trait, memory-limited decode for `UncheckedExtrinsic`
- `frame-executive` (minor bump) - absorbed `EnsureInherentsAreFirst` logic
- Various runtime crates (patch bumps)

### Key Technical Changes
1. **Memory Safety**: `UncheckedExtrinsic::decode()` now enforces a 16 MiB heap memory limit
2. **API Movement**: `frame_support::traits::ExtrinsicCall` â†’ `sp_runtime::traits::ExtrinsicCall`
3. **Trait Removal**: `EnsureInherentsAreFirst` removed, checking logic moved to `frame-executive`

## Impact on Moonbeam

### Codebase Analysis

#### UncheckedExtrinsic Usage
All three Moonbeam runtimes (moonbeam, moonriver, moonbase) use `UncheckedExtrinsic` in the following locations:

**Type Definitions:**
```rust
// runtime/{moonbeam,moonriver,moonbase}/src/lib.rs
pub type UncheckedExtrinsic =
    fp_self_contained::UncheckedExtrinsic<Address, RuntimeCall, Signature, TxExtension>;
```

**TransactionConverter Implementation:**
```rust
// Lines 674 (moonbeam), 681 (moonriver), 682 (moonbase)
impl fp_rpc::ConvertTransaction<opaque::UncheckedExtrinsic> for TransactionConverter {
    fn convert_transaction(
        &self,
        transaction: pallet_ethereum::Transaction,
    ) -> opaque::UncheckedExtrinsic {
        let extrinsic = UncheckedExtrinsic::new_bare(
            pallet_ethereum::Call::<Runtime>::transact { transaction }.into(),
        );
        let encoded = extrinsic.encode();
        opaque::UncheckedExtrinsic::decode(&mut &encoded[..])
            .expect("Encoded extrinsic is always valid")
    }
}
```

#### Affected Files
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/apis.rs`
- Various test files

#### Trait Usage
**VERIFIED: No impact from trait changes**
- `ExtrinsicCall` trait: NOT used in Moonbeam codebase
- `EnsureInherentsAreFirst` trait: NOT used in Moonbeam codebase

### Safety Analysis

#### Memory Limit Compliance
Moonbeam's block size configuration (from `/runtime/moonbeam/src/lib.rs:258-259`):
```rust
pub BlockLength: frame_system::limits::BlockLength = frame_system::limits::BlockLength
    ::max_with_normal_ratio(5 * 1024 * 1024, NORMAL_DISPATCH_RATIO);
```

**Maximum block size: 5 MB**
**PR memory limit: 16 MiB (16.777 MB)**

The 16 MiB limit provides a **3.35x safety margin** above Moonbeam's maximum block size. Since individual extrinsics cannot exceed the block size, and Ethereum transactions are typically much smaller, this limit will never be reached under normal operation.

#### Decode Behavior
The `TransactionConverter` encodes and immediately decodes its own constructed extrinsics. The memory limit adds a safety check but does not change the behavior for valid extrinsics. The `.expect()` call is safe because:
1. The extrinsic was just created via `new_bare()`
2. The encoded size is well under limits (Ethereum transaction data)
3. Encoding is deterministic and always produces valid output

### Required Changes

**NONE** - All changes are automatically inherited through dependency updates.

### Reasoning for INHERITED Classification

1. **No Direct API Usage**: Moonbeam doesn't use the moved/removed traits
2. **Compatible Constructor Usage**: Already uses `UncheckedExtrinsic::new_bare()`
3. **Safe Memory Limits**: Block size (5 MB) is well below the decode limit (16 MiB)
4. **Transparent Integration**: Changes apply automatically through `fp_self_contained::UncheckedExtrinsic`
5. **No Compilation Issues**: No import changes needed

## Recommendations

1. **No Action Required**: Changes are backwards compatible and automatically applied via dependency updates

2. **Optional Monitoring**: After upgrade, monitor for any unexpected decode failures in `TransactionConverter`, though none are expected given the analysis above

3. **Future Consideration**: If Moonbeam ever increases block size limits significantly (unlikely given parachain constraints), verify it remains below 16 MiB

## Related PRs

- **PR #9470**: Subsequent PR that relaxed trait bounds due to codec implementation changes from this PR

## References

- PRDoc: `/Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_8234.prdoc`
- GitHub PR: https://github.com/paritytech/polkadot-sdk/pull/8234
- Merged: May 19, 2025
