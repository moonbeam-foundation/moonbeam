# PR #8238 - Impact Analysis for Moonbeam

## PR Summary

**Title:** Add `checked_sqrt` to the `FixedPointNumber` trait
**GitHub:** https://github.com/paritytech/polkadot-sdk/pull/8238
**Labels:** T13-deprecation, R1-breaking_change, T17-primitives
**Affected Crate:** sp-arithmetic (major bump)

### Changes

This PR adds the function `checked_sqrt` to the `FixedPointNumber` trait and deprecates the `const fn try_sqrt` inside the `implement_fixed` macro in favor of a `const fn checked_sqrt` which does the same thing. This affects `FixedI64`, `FixedU64`, `FixedI128`, and `FixedU128` types.

## Impact Assessment: MINIMAL ✅

### Analysis

The impact on Moonbeam is **minimal** because:

1. **No use of deprecated functionality**: Moonbeam does not use the deprecated `try_sqrt` method anywhere in its codebase
2. **Trait-level change only**: The change primarily affects the `FixedPointNumber` trait interface, which Moonbeam imports but does not implement or constrain
3. **No sqrt operations**: Moonbeam does not perform square root calculations on fixed-point numbers
4. **Concrete type usage is unaffected**: The types themselves (`FixedI64`, `FixedU128`) continue to work as before

### Usage in Moonbeam

#### 1. FixedPointNumber Trait Imports

The `FixedPointNumber` trait is imported in all three runtimes:

**File:** `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs`
```rust
use sp_runtime::{
    // ... other imports
    ApplyExtrinsicResult, DispatchErrorWithPostInfo, FixedPointNumber, Perbill, Permill,
    Perquintill,
};
```

**Also in:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs:101`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs:105`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/tests/integration_test.rs:2947`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/tests/integration_test.rs:2843`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/tests/integration_test.rs:2807`

**Impact:** None - The trait is only imported, not implemented or used as a trait bound.

#### 2. FixedI64 Usage in Governance Tracks

Fixed-point types are used to define referendum curves in governance track configurations:

**File:** `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/governance/tracks.rs`
```rust
const fn percent(x: i32) -> sp_runtime::FixedI64 {
    sp_runtime::FixedI64::from_rational(x as u128, 100)
}
const fn permill(x: i32) -> sp_runtime::FixedI64 {
    sp_runtime::FixedI64::from_rational(x as u128, 1000)
}
```

These helper functions are used in governance track definitions to specify approval/support curves:
```rust
min_approval: Curve::make_reciprocal(4, 14, percent(80), percent(50), percent(100)),
min_support: Curve::make_linear(14, 14, permill(5), percent(25)),
```

**Also in:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/governance/tracks.rs:24-28`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/governance/tracks.rs:24-28`

**Impact:** None - Only uses `from_rational` constructor, which is unchanged.

#### 3. FixedU128 Usage in Integration Tests

FixedU128 is used extensively in fee calculation tests:

**File:** `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/tests/integration_test.rs`
```rust
#[test]
fn test_fee_calculation() {
    let multiplier = sp_runtime::FixedU128::from_float(0.999000000000000000);
    // ...
    let expected_fee =
        WeightToFeeImpl::weight_to_fee(&base_extrinsic)
        + multiplier.saturating_mul_int(WeightToFeeImpl::weight_to_fee(
            &Weight::from_parts(extrinsic_weight, 1),
        )) + LengthToFeeImpl::weight_to_fee(&Weight::from_parts(extrinsic_len as u64, 1))
        + tip;
}
```

Key methods used:
- `from_float()` - Constructor
- `from_u32()` - Constructor
- `from_rational()` - Constructor
- `saturating_mul_int()` - Method from `FixedPointNumber` trait

**Also in:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/tests/integration_test.rs:2885+`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/tests/integration_test.rs:2849+`

**Impact:** None - The methods used (`saturating_mul_int`) are not affected by this PR.

#### 4. TypeScript API Types

Auto-generated TypeScript types include Fixed* types:

**File:** `/Users/manuelmauro/Workspace/moonbeam/typescript-api/src/moonbase/interfaces/augment-types.ts`
```typescript
FixedI128: FixedI128;
FixedI64: FixedI64;
FixedU128: FixedU128;
FixedU64: FixedU64;
```

**Impact:** None - These will be regenerated during the upgrade process.

### Methods NOT Used by Moonbeam

✅ No usage of `try_sqrt` (deprecated method)
✅ No usage of `checked_sqrt` (new method)
✅ No usage of any sqrt operations
✅ No custom implementations of `FixedPointNumber` trait
✅ No generic bounds on `FixedPointNumber` trait
✅ No direct `sp-arithmetic` dependency in Cargo.toml files

## Required Actions

### 1. Code Changes
**None required** - Moonbeam does not use the deprecated functionality.

### 2. Testing
- ✅ Verify existing fee calculation tests pass
- ✅ Verify governance track configurations compile
- ✅ Run integration tests to ensure fee multiplier behavior is unchanged

### 3. Documentation
**None required** - No API changes affecting Moonbeam's usage patterns.

## Verification Commands

```bash
# Verify compilation of all runtimes
cargo build --release -p moonbeam-runtime
cargo build --release -p moonriver-runtime
cargo build --release -p moonbase-runtime

# Run integration tests
cargo test -p moonbase-runtime integration_test::test_fee_calculation
cargo test -p moonbase-runtime integration_test::test_min_gas_price_is_deterministic
cargo test -p moonbase-runtime integration_test::test_min_gas_price_has_no_precision_loss_from_saturating_mul_int

# Verify governance tracks compile and test
cargo test -p moonbase-runtime --lib governance::tracks
```

## Migration Guide

**No migration required** for Moonbeam, as the deprecated `try_sqrt` method is not used anywhere in the codebase.

For future reference, if Moonbeam ever needs to compute square roots of fixed-point numbers:
- Use `checked_sqrt()` instead of `try_sqrt()`
- Both return `Option<Self>` with the same semantics
- `checked_sqrt()` is available as both const and non-const versions

## Conclusion

This PR represents a trait evolution in sp-arithmetic that does not impact Moonbeam's current usage patterns. While labeled as a breaking change due to trait modifications, Moonbeam's usage is limited to:
- Importing the trait for re-export
- Using concrete fixed-point types with unaffected methods
- Fee calculations and governance curve definitions

No code changes, migrations, or special handling is required for this PR.

## Related Files

### Runtime Files
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs:114`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/governance/tracks.rs:24-28`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs:101`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/governance/tracks.rs:24-28`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs:105`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/governance/tracks.rs:24-28`

### Test Files
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/tests/integration_test.rs:2947-3082`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/tests/integration_test.rs:2843-2977`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/tests/integration_test.rs:2807-2939`

### TypeScript API (Auto-generated)
- `/Users/manuelmauro/Workspace/moonbeam/typescript-api/src/moonbase/interfaces/augment-types.ts`
- `/Users/manuelmauro/Workspace/moonbeam/typescript-api/src/moonbeam/interfaces/augment-types.ts`
- `/Users/manuelmauro/Workspace/moonbeam/typescript-api/src/moonriver/interfaces/augment-types.ts`
