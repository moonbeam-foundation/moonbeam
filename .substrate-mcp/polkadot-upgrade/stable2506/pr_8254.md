# PR #8254 Impact Analysis: Introduce `remove_upgrade_cooldown`

## Overview

- **PR Title**: Introduce `remove_upgrade_cooldown`
- **Polkadot-SDK PR**: https://github.com/paritytech/polkadot-sdk/pull/8254
- **Audience**: Runtime User
- **Affected Crates**:
  - `polkadot-runtime-parachains` (major bump)
  - `rococo-runtime` (major bump)
  - `westend-runtime` (major bump)
  - `polkadot-runtime-common` (none)
  - `frame-system` (minor bump)

## Change Summary

This PR introduces a new dispatchable function in the relay chain's `Paras` pallet that allows anyone to pay for removing an active upgrade cooldown from a parachain, rather than waiting for the cooldown period to expire naturally.

### Key Features

1. **New Dispatchable**: `Paras::remove_upgrade_cooldown(para_id: ParaId)`
   - Can be called by anyone (permissionless)
   - Removes the active upgrade cooldown for the specified parachain
   - Caller pays a fee based on remaining cooldown time
   - Tokens are burned upon successful removal

2. **Cost Calculation**:
   - Cost = Remaining cooldown time × `CooldownRemovalMultiplier`
   - Westend configured with 1000 tokens per day multiplier (example value, not production recommendation)
   - Payment is in relay chain native tokens (DOT for Polkadot, KSM for Kusama, WND for Westend)

3. **Use Case**:
   - Enables parachains to apply urgent runtime upgrades faster than the standard cooldown period allows
   - Provides an economic mechanism for expedited upgrades when necessary
   - Useful for critical security patches or time-sensitive fixes

## Impact Assessment for Moonbeam

### Impact Level: **BENEFICIAL - NO RUNTIME CHANGES REQUIRED** ✅

### Rationale

This PR is **purely a relay chain feature** that provides a new capability for parachains without requiring any changes to parachain runtime code. It has **no breaking changes** for Moonbeam but offers a **valuable new option** for governance.

## Technical Analysis

### 1. Relay Chain vs Parachain Separation

**The upgrade cooldown mechanism is entirely relay chain-controlled:**

- **Relay Chain Responsibility**: The `Paras` pallet on the relay chain enforces upgrade cooldowns
- **Parachain Perspective**: Parachains see the cooldown configuration via `ParachainSystem::HostConfiguration`
- **No Parachain Code Changes**: Parachains cannot directly modify or bypass the cooldown themselves

**Evidence from Moonbeam codebase:**

`/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/weights/frame_system.rs:170`:
```rust
/// Storage: `ParachainSystem::HostConfiguration` (r:1 w:0)
/// Proof: `ParachainSystem::HostConfiguration` (`max_values`: Some(1), `max_size`: None, mode: `Measured`)
fn apply_authorized_upgrade() -> Weight {
    // Reads host configuration which includes validationUpgradeCooldown
    // ...
}
```

The `HostConfiguration` contains the relay chain's upgrade parameters:

`/Users/manuelmauro/Workspace/moonbeam/typescript-api/src/moonbase/interfaces/lookup.ts`:
```typescript
{
  maxUpwardQueueCount: "u32",
  maxUpwardQueueSize: "u32",
  maxUpwardMessageSize: "u32",
  maxUpwardMessageNumPerCandidate: "u32",
  hrmpMaxMessageNumPerCandidate: "u32",
  validationUpgradeCooldown: "u32",  // ← Relay chain parameter
  validationUpgradeDelay: "u32",
  asyncBackingParams: "PolkadotPrimitivesV8AsyncBackingAsyncBackingParams"
}
```

### 2. Current Upgrade Cooldown Values

**Development/Testing Environment**:

`/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:403`:
```rust
validation_upgrade_cooldown: 6,  // 6 blocks in dev mode (~6 seconds)
validation_upgrade_delay: 6,
```

**Production-like Environment (Lazy Loading)**:

`/Users/manuelmauro/Workspace/moonbeam/node/service/src/lazy_loading/mod.rs:216`:
```rust
validation_upgrade_cooldown: 14_400,  // 14,400 blocks (~2 days at 12s/block)
validation_upgrade_delay: 600,
```

**Actual Production Values** (on Polkadot/Kusama relay chains):
- These are set by relay chain governance
- Typically measured in thousands of blocks
- Example: Polkadot might have ~7 days cooldown

### 3. Moonbeam's Runtime Upgrade Process

Moonbeam uses the standard Substrate parachain upgrade flow:

**Step 1: Authorize Upgrade** (`frame_system::authorize_upgrade`):
```typescript
// From: /Users/manuelmauro/Workspace/moonbeam/tools/github/generate-runtimes-body.ts:11-16
const MOONBASE_PREFIX_SYSTEM_AUTHORIZE_UPGRADE = "0x0009";
const MOONRIVER_PREFIX_SYSTEM_AUTHORIZE_UPGRADE = "0x0009";
const MOONBEAM_PREFIX_SYSTEM_AUTHORIZE_UPGRADE = "0x0009";

function authorizeUpgradeHash(runtimeName: string, srtool: any): string {
  // Computes preimage for governance proposal
}
```

**Step 2: Apply Authorized Upgrade** (`frame_system::apply_authorized_upgrade`):

Weight function analysis from `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/weights/frame_system.rs:160-184`:
```rust
/// Storage: `System::AuthorizedUpgrade` (r:1 w:1)
/// Storage: `MultiBlockMigrations::Cursor` (r:1 w:0)
/// Storage: `ParachainSystem::ValidationData` (r:1 w:0)
/// Storage: `ParachainSystem::UpgradeRestrictionSignal` (r:1 w:0)
/// Storage: `ParachainSystem::PendingValidationCode` (r:1 w:1)
/// Storage: `ParachainSystem::HostConfiguration` (r:1 w:0)  // ← Reads cooldown config
/// Storage: `ParachainSystem::NewValidationCode` (r:0 w:1)
/// Storage: `ParachainSystem::DidSetValidationCode` (r:0 w:1)
fn apply_authorized_upgrade() -> Weight {
    Weight::from_parts(110_134_811_000, 67035)
        .saturating_add(T::DbWeight::get().reads(6_u64))
        .saturating_add(T::DbWeight::get().writes(4_u64))
}
```

**Step 3: Relay Chain Validation**:
- Relay chain's `Paras` pallet receives the new validation code
- Relay chain enforces the upgrade cooldown period
- After cooldown expires, upgrade is enacted

### 4. New Capability from PR #8254

With this PR, if Moonbeam needs to apply a second upgrade before the cooldown expires:

**Before (Current Behavior):**
```
Block 1000: Apply upgrade A → NewValidationCode set
Block 1050: Upgrade A enacted by relay chain
Block 1050 onwards: Cooldown period active (e.g., ~7 days)
Block 1500: Try to apply upgrade B → REJECTED (cooldown still active)
Block 15000: Cooldown expires
Block 15001: Apply upgrade B → SUCCESS
```

**After (With remove_upgrade_cooldown):**
```
Block 1000: Apply upgrade A → NewValidationCode set
Block 1050: Upgrade A enacted by relay chain
Block 1050 onwards: Cooldown period active
Block 1500: Critical bug discovered, need urgent fix
Block 1501: Someone calls Paras::remove_upgrade_cooldown(moonbeam_para_id)
            → Pays fee (e.g., 5 days × 1000 DOT/day = 5000 DOT burned)
            → Cooldown removed immediately
Block 1502: Apply upgrade B (urgent fix) → SUCCESS
```

## Concrete Evidence of Impact

### 1. No Runtime Code Changes Required

**Grep Results** - No references to the new dispatchable or cooldown removal in Moonbeam:
```bash
$ rg "remove.*upgrade.*cooldown|removeUpgradeCooldown" /Users/manuelmauro/Workspace/moonbeam -i
# Only found in: .substrate-mcp/polkadot-upgrade/stable2506/TRACKING.md
# No matches in runtime/, pallets/, or precompiles/
```

**Conclusion**: Moonbeam doesn't need to implement anything. This is a relay chain-only feature.

### 2. TypeScript API Will Be Updated

The auto-generated TypeScript API will include the new call after updating to stable2506:

**Expected Addition** (similar to other relay chain calls):
```typescript
// typescript-api/src/moonbase/interfaces/augment-api-tx.ts
paras: {
  // ... existing calls ...
  removeUpgradeCooldown: AugmentedSubmittable<
    (paraId: u32 | AnyNumber | Uint8Array) => SubmittableExtrinsic<ApiType>,
    [u32]
  >;
}
```

**Note**: This will be in the metadata for completeness, but Moonbeam (as a parachain) cannot directly call relay chain extrinsics. This would need to be called via:
- Relay chain governance
- XCM transact from Moonbeam governance (if configured)
- Any account on the relay chain willing to pay

### 3. Dependency Version Impact

**From PRDoc:**
- `polkadot-runtime-parachains`: **major bump**
- `frame-system`: **minor bump**

**Current Moonbeam Dependencies:**
```toml
# Cargo.toml (effective after stable2506 upgrade)
polkadot-runtime-parachains = { version = "stable2506", ... }
frame-system = { version = "stable2506", ... }
```

**API Compatibility**:
- The major bump in `polkadot-runtime-parachains` is due to adding a new dispatchable
- Existing APIs remain unchanged
- No breaking changes for parachain runtime code

### 4. Relay Chain Metadata Update

**New Call Added** (verified via Westend testnet):

From MCP substrate query on `wss://westend-rpc.polkadot.io`:
```json
{
  "item_type": "call",
  "pallet": "Paras",
  "name": "remove_upgrade_cooldown",
  "details": {
    "docs": [
      "Remove an upgrade cooldown for a parachain.",
      "",
      "The cost for removing the cooldown earlier depends on the time left for the cooldown",
      "multiplied by [`Config::CooldownRemovalMultiplier`]. The paid tokens are burned."
    ],
    "index": 9
  }
}
```

## Benefits for Moonbeam

### 1. Emergency Upgrade Capability

**Scenario**: Critical security vulnerability discovered shortly after a runtime upgrade

**Without this feature:**
- Must wait days/weeks for cooldown to expire
- Network potentially at risk during waiting period
- No way to expedite the fix

**With this feature:**
- Governance can decide if expedited upgrade is worth the cost
- Can remove cooldown immediately by paying the fee
- Apply urgent fix within hours instead of days/weeks
- Economic disincentive prevents abuse (tokens are burned)

### 2. Governance Flexibility

**Options for Moonbeam Governance:**

1. **Via Relay Chain Governance**:
   - Polkadot/Kusama governance could remove cooldown for Moonbeam
   - Useful for ecosystem-wide coordination

2. **Via XCM** (if configured):
   - Moonbeam governance could send XCM message to relay chain
   - Execute `Paras::remove_upgrade_cooldown` via Transact
   - Requires XCM configuration and sufficient relay chain tokens

3. **Third-party**:
   - Any account on relay chain can call this (permissionless)
   - Moonbeam could reimburse via treasury if beneficial

### 3. Cost Consideration

**Example Calculation** (hypothetical Polkadot values):

Assumptions:
- Standard cooldown: 7 days (50,400 blocks at 12s/block)
- Multiplier: 1000 DOT per day
- Need to upgrade after 2 days (5 days remaining)

```
Cost = 5 days remaining × 1000 DOT/day = 5,000 DOT
```

**Governance Decision**: Is 5,000 DOT worth immediate upgrade vs. waiting 5 more days?

- For critical security fix: Likely yes
- For minor feature: Likely no
- Provides clear economic trade-off

## Migration Requirements

### Runtime Changes: **NONE REQUIRED** ✅

No changes needed to Moonbeam's runtime code. The feature is entirely relay chain-side.

### Client Changes: **NONE REQUIRED** ✅

No changes needed to Moonbeam's client code. Parachains don't interact with this feature directly.

### TypeScript API: **AUTO-GENERATED** ✅

TypeScript types will be automatically updated when regenerating from metadata:

```bash
# After upgrading to stable2506
pnpm build  # In typescript-api directory
```

This will include the new `paras.removeUpgradeCooldown` call in the generated types.

### Testing: **OPTIONAL - GOVERNANCE SIMULATION** ⚠️

**Recommended Test** (optional, for governance preparedness):

Test calling `remove_upgrade_cooldown` via XCM from Moonbeam to relay chain in a zombienet or chopsticks environment:

```typescript
// Test scenario: Moonbeam governance removes its own cooldown via XCM
import { RELAY_SOURCE_LOCATION } from "@moonbeam-network/xcm-config";

const xcmMessage = {
  V4: [
    {
      WithdrawAsset: [{ id: RELAY_NATIVE_ASSET, fun: { Fungible: cost } }]
    },
    {
      BuyExecution: {
        fees: { id: RELAY_NATIVE_ASSET, fun: { Fungible: cost } },
        weightLimit: "Unlimited"
      }
    },
    {
      Transact: {
        originKind: "Native",
        call: paras.removeUpgradeCooldown(moonbeamParaId).toHex()
      }
    }
  ]
};

await api.tx.polkadotXcm.send(RELAY_SOURCE_LOCATION, xcmMessage).signAndSend(governance);
```

**Note**: This requires:
1. XCM transact permissions configured on relay chain
2. Moonbeam governance has sufficient relay chain tokens
3. May not be available on Polkadot/Kusama without relay chain governance approval

## Risk Assessment

### Risk Level: **NONE** ✅

**Why No Risk:**

1. **No Code Changes**: Moonbeam doesn't need to modify any code
2. **No API Breaking Changes**: Existing parachain APIs unchanged
3. **Opt-in Feature**: Moonbeam can choose to use it or not
4. **Economic Safety**: Cost mechanism prevents abuse
5. **Relay Chain Controlled**: Cannot affect Moonbeam without explicit action

**Positive Aspects:**

1. **Adds Capability**: New emergency upgrade option
2. **No Downside**: If not needed, simply don't use it
3. **Ecosystem Benefit**: All parachains gain this flexibility
4. **Economic Deterrent**: Burning mechanism prevents frivolous use

## Testing Recommendations

### Required Testing: **NONE** ✅

Since this is a relay chain feature with no parachain code changes, no testing is strictly required.

### Optional Testing (for Governance Preparedness): ⚠️

**Test Scenario 1: Local Development**

Using Moonbeam's dev mode with embedded relay chain mock:

```rust
// Already configured in node/service/src/lib.rs
validation_upgrade_cooldown: 6,  // 6 blocks

// Test steps:
// 1. Apply first runtime upgrade
// 2. Try second upgrade immediately → should fail
// 3. Wait 6 blocks
// 4. Try second upgrade → should succeed
```

**Test Scenario 2: Zombienet Simulation**

Test the new `remove_upgrade_cooldown` call:

```bash
# Launch zombienet with Moonbeam as parachain
pnpm zombienet spawn zombienet/specs/polkadot-local.json

# In relay chain:
# 1. Apply upgrade to Moonbeam
# 2. Call Paras::remove_upgrade_cooldown(moonbeam_para_id)
# 3. Verify cooldown removed
# 4. Apply second upgrade immediately
```

**Test Scenario 3: Chopsticks Fork Testing**

Fork Polkadot/Kusama and simulate the scenario:

```typescript
// 1. Fork Polkadot at recent block
// 2. Apply runtime upgrade to Moonbeam
// 3. Call remove_upgrade_cooldown
// 4. Verify second upgrade can be applied immediately
```

## Governance Considerations

### Decision Framework for Using This Feature

**When to Consider Removing Cooldown:**

✅ **Good Use Cases:**
- Critical security vulnerability discovered
- Consensus-breaking bug requiring immediate fix
- Coordinated ecosystem upgrade with tight deadline
- Emergency response to external threat

❌ **Poor Use Cases:**
- Minor feature additions
- Performance optimizations
- Non-critical bug fixes
- Regular planned upgrades

### Cost-Benefit Analysis Template

```
Remaining Cooldown: [X] days
Cost to Remove: [Y] DOT/KSM
Severity of Issue: [Critical/High/Medium/Low]
Risk of Waiting: [High/Medium/Low]
Alternative Solutions: [List any]

Decision: [Wait / Pay to Remove]
Rationale: [Explanation]
```

### Governance Process Recommendation

1. **Assess Urgency**: Determine if issue warrants expedited upgrade
2. **Calculate Cost**: Compute actual DOT/KSM cost to remove cooldown
3. **Community Discussion**: Transparent debate on cost vs. benefit
4. **Vote**: Formal governance vote on whether to use the feature
5. **Execute**: If approved, call `remove_upgrade_cooldown` via appropriate mechanism
6. **Apply Upgrade**: Execute the urgent runtime upgrade
7. **Post-Mortem**: Document decision and outcome for future reference

## Conclusion

PR #8254 introduces a valuable new capability for parachains to expedite runtime upgrades in emergency situations. For Moonbeam, this PR:

**Impact Summary:**
- ✅ **No runtime code changes required**
- ✅ **No client code changes required**
- ✅ **No breaking API changes**
- ✅ **No testing requirements** (optional testing recommended for governance preparedness)
- ✅ **Adds beneficial emergency upgrade option**
- ✅ **No risks or downsides**

**Recommended Actions:**

1. **Immediate (with stable2506 upgrade):**
   - No action required - changes are relay chain-only
   - TypeScript API will be automatically updated

2. **Medium-term (before next upgrade):**
   - Document governance process for deciding when to use this feature
   - Prepare cost-benefit analysis template
   - Consider testing in zombienet/chopsticks for familiarity

3. **Long-term (ongoing):**
   - Monitor relay chain governance for `CooldownRemovalMultiplier` parameter changes
   - Keep as emergency option in governance playbook
   - Use judiciously only when truly needed

**Final Assessment**: This PR is a **pure benefit** for Moonbeam with **zero implementation cost**. It provides a valuable emergency option that can be used if needed, with no downsides if not used. The economic mechanism ensures it won't be abused while remaining available for critical situations.

---

**Analysis completed**: 2025-10-22
**Moonbeam version**: master (d67d222bb3)
**Polkadot SDK release**: stable2506
**Impact Level**: BENEFICIAL - NO CHANGES REQUIRED
