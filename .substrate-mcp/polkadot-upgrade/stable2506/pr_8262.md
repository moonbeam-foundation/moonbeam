# PR #8262: pallet_revive: Replace adhoc pre-compiles with pre-compile framework

## Overview

**PR Link:** https://github.com/paritytech/polkadot-sdk/pull/8262
**Status:** Merged (April 28, 2025)
**Author:** @athei
**Labels:** T7-smart_contracts
**Audience:** Runtime Dev

## Summary

This PR introduces a comprehensive precompile framework for `pallet-revive`, replacing hardcoded precompiles with an extensible trait-based system. The framework allows custom precompiles to be defined outside the pallet, enforces Solidity ABI compliance, validates address ranges at compile-time, and enables delegate calling semantics matching Ethereum behavior.

## Impact Assessment for Moonbeam

**IMPACT LEVEL: NONE**

This PR has **NO IMPACT** on Moonbeam because:

1. **Different Pallet**: This PR affects `pallet-revive`, which is a PolkaVM-based contract execution pallet. Moonbeam uses `pallet-evm` from the Frontier project for Ethereum compatibility.

2. **Different Architecture**:
   - `pallet-revive` is designed for PolkaVM-based smart contracts
   - Moonbeam uses traditional EVM via `pallet-evm` from Frontier
   - These are completely separate execution environments

3. **Moonbeam's Precompile System**: Moonbeam has its own mature precompile system with 30+ custom precompiles using the `pallet_evm_precompile_*` framework, including:
   - Standard Ethereum precompiles (ECRecover, SHA256, RIPEMD160, Blake2F, BN128, BLS12-381, etc.)
   - Custom Substrate integration precompiles (Staking, Governance, XCM, etc.)
   - Utility precompiles (Batch, CallPermit, Proxy, etc.)

## What Changed in PR #8262

### New Precompile Framework

The PR introduces a new architecture for defining precompiles in `pallet-revive`:

1. **Trait-Based System**: New `Precompile` trait allows custom precompiles to be implemented on any type
2. **Configuration**: Precompiles are passed via `Config::Precompiles` as a tuple of types
3. **Solidity ABI Compliance**: All inputs/outputs use Ethereum ABI encoding
4. **Address Space Safety**: Constrained address ranges prevent collisions
5. **Compile-Time Validation**: Address range overlaps detected at compile time
6. **Standard Execution Model**: Precompiles behave like normal contracts with proper call stack frames

### Technical Changes

**Modified Components:**
- `substrate/frame/revive/src/precompiles.rs` - New framework implementation
- `substrate/frame/revive/src/precompiles/builtin/` - Ported existing precompiles to framework
- `substrate/frame/revive/src/exec.rs` - Updated execution logic
- `substrate/frame/revive/src/lib.rs` - Configuration updates
- Runtime configurations in asset-hub-westend, penpal, and node runtimes

**Deleted Components:**
- `substrate/frame/revive/src/pure_precompiles/` - Legacy implementation removed

**Added Components:**
- New precompile framework in `precompiles` module
- `builtin` submodule containing Ethereum standard precompiles
- Test fixtures for precompile validation
- `CallSetup` type moved outside benchmarking for testing use

### Breaking Changes

All affected crates received **major version bumps**:
- `pallet-revive`
- `pallet-revive-fixtures`
- `asset-hub-westend-runtime`
- `penpal-runtime`

## Key Design Features

### 1. Extensibility
```rust
// Simple implementation - just implement the Precompile trait
impl Precompile for MyCustomPrecompile {
    // Implementation details
}

// Add to config
type Precompiles = (PrecompileOne, PrecompileTwo, MyCustomPrecompile);
```

### 2. Solidity ABI Integration
- Inputs and outputs encoded according to Ethereum ABI
- No custom decoding logic needed
- Trivial consumption from Solidity contracts

### 3. Safety Guarantees
- Address ranges constrained to prevent collisions
- Compile-time overlap detection
- Proper call stack frame handling

### 4. Delegate Call Support
Precompiles can be delegate-called, observing the caller's environment rather than their own (matching Ethereum semantics).

## Related Issues and Follow-ups

**Fixes:**
- #6716 - Replace chain extensions with pre-compile framework

**Follow-up PRs:**
- #8363 - Additional framework enhancements
- #8364 - Testing improvements
- #8362 - API enrichment

## Architectural Context: pallet-revive vs pallet-evm

For context, it's important to understand the difference between these two pallets:

### pallet-revive (This PR)
- **Target:** PolkaVM-based smart contracts
- **VM:** PolkaVM (a new RISC-V based VM)
- **Language:** Contracts compiled to PolkaVM (e.g., via Solidity â†’ RISC-V compiler)
- **Purpose:** Next-generation contract execution with better performance
- **Status:** Experimental/development

### pallet-evm (Moonbeam's Stack)
- **Target:** Traditional Ethereum compatibility
- **VM:** EVM (Ethereum Virtual Machine)
- **Language:** Solidity, Vyper (standard EVM bytecode)
- **Purpose:** Full Ethereum compatibility for existing dApps
- **Status:** Production-ready, battle-tested

## Lessons for Moonbeam

While this PR doesn't affect Moonbeam directly, there are interesting architectural patterns that could inform future work:

1. **Compile-Time Validation**: The approach to detecting address range collisions at compile time is elegant and could inspire improvements to Moonbeam's precompile registry.

2. **Framework Design**: The trait-based extensibility model demonstrates clean separation between core functionality and custom extensions.

3. **ABI Standardization**: Enforcing Solidity ABI compliance at the framework level reduces implementation complexity.

However, Moonbeam's existing precompile framework is already mature and well-suited to its needs, with:
- Extensive production usage
- Comprehensive test coverage
- 30+ custom precompiles already implemented
- Strong integration with Frontier's pallet-evm

## Recommendations

1. **No Action Required**: This PR requires no changes to Moonbeam codebase.

2. **Monitor pallet-revive Development**: While not currently relevant, pallet-revive represents an interesting evolution in Substrate smart contract execution. Worth tracking for future reference.

3. **Continue with pallet-evm**: Moonbeam should continue using pallet-evm from Frontier, which provides the Ethereum compatibility that Moonbeam's ecosystem depends on.

## Files Changed Summary

**Core Framework (23 files modified):**
- Precompile framework implementation
- Builtin precompiles (blake2f, bn128, ecrecover, identity, modexp, point_eval, ripemd160, sha256)
- Execution logic updates
- Test infrastructure

**Runtime Configurations (3 files modified):**
- asset-hub-westend-runtime
- penpal-runtime
- node runtime

**New Fixtures (1 file added):**
- call_and_returncode.rs contract fixture

**Documentation (1 file added):**
- pr_8262.prdoc

## Conclusion

PR #8262 represents a significant architectural improvement for `pallet-revive`, introducing a clean, extensible precompile framework. However, it has **zero impact** on Moonbeam, which operates on an entirely different stack (`pallet-evm` vs `pallet-revive`).

**Sentiment: NEUTRAL**

No action required from Moonbeam development team. This analysis is provided for awareness and architectural reference only.
