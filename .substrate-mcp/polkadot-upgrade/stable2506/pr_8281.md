# PR #8281: workaround: XcmPaymentApi::query_weight_to_asset_fee simple common impl

**Impact**: OPTIONAL
**Confidence**: High
**Affected Components**: Runtime APIs (XcmPaymentApi implementation)

## Changes Detected

This PR adds a common implementation for `XcmPaymentApi::query_weight_to_asset_fee` directly to `pallet-xcm`. Previously, each runtime had to manually implement this API method. The PR provides a workaround that:

1. Uses the configured `WeightTrader` from the XCM executor to compute fees
2. Passes `u128::MAX / 2` to the `WeightTrader` to calculate the weight cost without affecting total issuance
3. Provides a default implementation that runtimes can use instead of implementing their own logic

**Key changes in pallet-xcm:**
- New method `query_weight_to_asset_fee` in `pallet-xcm` that runtimes can call
- Uses the same `WeightTrader` as the XcmExecutor for uniform weight cost calculation

## Project Impact

**Current Moonbeam Implementation:**

Moonbeam currently has a **custom implementation** of the `XcmPaymentApi` in `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/apis.rs`:

```rust
impl xcm_runtime_apis::fees::XcmPaymentApi<Block> for Runtime {
    fn query_acceptable_payment_assets(
        xcm_version: xcm::Version
    ) -> Result<Vec<VersionedAssetId>, XcmPaymentApiError> {
        XcmWeightTrader::query_acceptable_payment_assets(xcm_version)
    }

    fn query_weight_to_asset_fee(
        weight: Weight, asset: VersionedAssetId
    ) -> Result<u128, XcmPaymentApiError> {
        XcmWeightTrader::query_weight_to_asset_fee(weight, asset)  // CUSTOM IMPLEMENTATION
    }

    fn query_xcm_weight(message: VersionedXcm<()>) -> Result<Weight, XcmPaymentApiError> {
        PolkadotXcm::query_xcm_weight(message)  // Uses pallet-xcm
    }

    fn query_delivery_fees(
        destination: VersionedLocation, message: VersionedXcm<()>
    ) -> Result<VersionedAssets, XcmPaymentApiError> {
        PolkadotXcm::query_delivery_fees(destination, message)  // Uses pallet-xcm
    }
}
```

**Analysis:**

1. **Two methods already use pallet-xcm defaults**: `query_xcm_weight` and `query_delivery_fees` delegate to `PolkadotXcm::query_*` methods
2. **Two methods use custom implementation**: `query_acceptable_payment_assets` and `query_weight_to_asset_fee` delegate to Moonbeam's custom `pallet-xcm-weight-trader`

**Impact Assessment:**

This PR is **OPTIONAL** because:
- Moonbeam can **continue using its custom implementation** via `pallet-xcm-weight-trader::Pallet::query_weight_to_asset_fee()`
- The custom implementation provides the same functionality and is specifically tailored to Moonbeam's `pallet-xcm-weight-trader`
- No breaking changes are introduced - the PR only adds a new convenience method to pallet-xcm

**Potential Benefits (if adopted):**

If Moonbeam wanted to switch to the pallet-xcm default implementation, the benefit would be minimal because:
- Moonbeam's `pallet-xcm-weight-trader` already provides a well-tested implementation
- The custom implementation is tightly integrated with Moonbeam's multi-asset fee payment system
- The custom implementation supports both native tokens and foreign assets with relative pricing

**Recommendation:**
- **Keep the current custom implementation** - No action required
- The current implementation is more flexible and specifically designed for Moonbeam's needs
- The pallet-xcm default is designed for simpler use cases

## Evidence & References

### Current Implementation Files

**Runtime API implementation:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/apis.rs:742-746`

**Custom pallet-xcm-weight-trader implementation:**
- `/Users/manuelmauro/Workspace/moonbeam/pallets/xcm-weight-trader/src/lib.rs:302-347`
  - `query_acceptable_payment_assets()` - Returns list of supported fee assets
  - `query_weight_to_asset_fee()` - Computes fee using `Trader::compute_amount_to_charge()`

**XCM Executor configuration uses custom trader:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/xcm_config.rs:279`
  - `type Trader = pallet_xcm_weight_trader::Trader<Runtime>;`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/xcm_config.rs` (similar)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/xcm_config.rs` (similar)

**Test coverage:**
- `/Users/manuelmauro/Workspace/moonbeam/test/suites/dev/moonbase/test-xcm-v5/test-xcm-payment-api.ts`
- `/Users/manuelmauro/Workspace/moonbeam/test/suites/dev/moonbase/test-xcm-v4/test-xcm-payment-api.ts`

### Architecture Notes

Moonbeam's `pallet-xcm-weight-trader` provides:
1. Support for multiple fee payment assets (native + foreign assets)
2. Relative pricing mechanism for foreign assets (stored in `SupportedAssets` storage map)
3. Asset pause/resume functionality for fee payment
4. Integration with `WeightTrader` trait for XCM execution
5. Custom `query_weight_to_asset_fee()` that delegates to `Trader::compute_amount_to_charge()`

This is more sophisticated than the simple pallet-xcm default implementation, which is why keeping the custom implementation is recommended.
