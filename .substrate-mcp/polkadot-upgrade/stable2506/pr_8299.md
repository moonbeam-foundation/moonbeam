# PR #8299: Collator Support for Building on Older Relay Parents

## Overview

**PR**: [paritytech/polkadot-sdk#8299](https://github.com/paritytech/polkadot-sdk/pull/8299)
**Labels**: Runtime Dev
**Audience**: Runtime Dev
**Impact**: **BREAKING - ACTION REQUIRED**

## Summary

This PR introduces mechanisms to build parachain blocks on relay chain parents that are not at the tip of the relay chain. This addresses a critical issue where collators building blocks at rapid pace may construct blocks on incorrect relay chain forks due to timing issues with BABE primary blocks. By building at an offset from the relay chain tip, short-lived forks are eliminated before parachain block construction begins, reducing the likelihood of parachain forks.

The change is particularly beneficial for:
- Parachains using slot-based collator (`--authoring slot-based`)
- Parachains leveraging elastic-scaling
- High-velocity block production environments

## Changes Made

### Modified Crates (Major Bumps)
- `cumulus-pallet-parachain-system`
- `cumulus-client-consensus-aura`
- `cumulus-client-parachain-inherent`
- `cumulus-primitives-core`
- `cumulus-primitives-parachain-inherent`
- `polkadot-primitives`
- All system parachain runtimes (asset-hub, bridge-hub, collectives, coretime, people, etc.)

### Key Changes

1. **New Associated Type in `cumulus_pallet_parachain_system::Config`**:
   - Added required associated type `RelayParentOffset`
   - This type specifies how many relay chain blocks back from the tip to build parachain blocks
   - Setting to `0` maintains legacy behavior
   - Setting to `N > 0` enables the new fork-avoidance mechanism

2. **Block Builder Task Updates**:
   - Implements relay chain parent selection at configurable offset depths
   - Populates parachain inherent data accordingly

3. **`set_validation_data` Inherent Changes**:
   - Enforces the offset by requiring multiple relay parent descendants in the inherent
   - Prevents authors from bypassing the offset requirement

4. **New Runtime API**:
   - Introduces `RelayParentOffsetApi` trait to communicate required offset values from runtime to node

5. **Backward Compatibility**:
   - Maintains legacy `ParachainInherent` format for graceful version transitions

## Impact on Moonbeam

### Current Configuration

All three Moonbeam runtimes currently implement `cumulus_pallet_parachain_system::Config` without the new `RelayParentOffset` associated type:

**moonbase/src/lib.rs** (lines 750-762):
```rust
impl cumulus_pallet_parachain_system::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type OnSystemEvent = ();
    type SelfParaId = ParachainInfo;
    type ReservedDmpWeight = ReservedDmpWeight;
    type OutboundXcmpMessageSource = XcmpQueue;
    type XcmpMessageHandler = XcmpQueue;
    type ReservedXcmpWeight = ReservedXcmpWeight;
    type CheckAssociatedRelayNumber = EmergencyParaXcm;
    type ConsensusHook = ConsensusHook;
    type DmpQueue = frame_support::traits::EnqueueWithOrigin<MessageQueue, RelayOrigin>;
    type WeightInfo = moonbase_weights::cumulus_pallet_parachain_system::WeightInfo<Runtime>;
    type SelectCore = cumulus_pallet_parachain_system::DefaultCoreSelector<Runtime>;
    // Missing: type RelayParentOffset = ...;
}
```

**moonriver/src/lib.rs** (lines 749-762) - Same structure
**moonbeam/src/lib.rs** (lines 706-719) - Same structure

### Async Backing Configuration

All three runtimes use async backing with the following constants:
```rust
const UNINCLUDED_SEGMENT_CAPACITY: u32 = 3;
const BLOCK_PROCESSING_VELOCITY: u32 = 1;

type ConsensusHook = pallet_async_backing::consensus_hook::FixedVelocityConsensusHook<
    Runtime,
    RELAY_CHAIN_SLOT_DURATION_MILLIS,
    BLOCK_PROCESSING_VELOCITY,
    UNINCLUDED_SEGMENT_CAPACITY,
>;
```

### Breaking Changes

1. **Compilation Will Fail**: The code will not compile without adding the `RelayParentOffset` associated type to all three runtime configurations.

2. **Three Mock Runtimes Affected**: The following test/mock files also need updates:
   - `/Users/manuelmauro/Workspace/moonbeam/precompiles/crowdloan-rewards/src/mock.rs` (line 60)
   - `/Users/manuelmauro/Workspace/moonbeam/precompiles/relay-encoder/src/mock.rs` (line 101)
   - `/Users/manuelmauro/Workspace/moonbeam/precompiles/relay-data-verifier/src/mock.rs` (not shown but likely affected)

## Required Actions

**Impact Level**: **BREAKING - ACTION REQUIRED**

### Immediate Action: Add RelayParentOffset Type

To maintain current behavior (recommended for initial upgrade), add the following line to all `cumulus_pallet_parachain_system::Config` implementations:

```rust
impl cumulus_pallet_parachain_system::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type OnSystemEvent = ();
    type SelfParaId = ParachainInfo;
    type ReservedDmpWeight = ReservedDmpWeight;
    type OutboundXcmpMessageSource = XcmpQueue;
    type XcmpMessageHandler = XcmpQueue;
    type ReservedXcmpWeight = ReservedXcmpWeight;
    type CheckAssociatedRelayNumber = EmergencyParaXcm;
    type ConsensusHook = ConsensusHook;
    type DmpQueue = frame_support::traits::EnqueueWithOrigin<MessageQueue, RelayOrigin>;
    type WeightInfo = moonbase_weights::cumulus_pallet_parachain_system::WeightInfo<Runtime>;
    type SelectCore = cumulus_pallet_parachain_system::DefaultCoreSelector<Runtime>;
    type RelayParentOffset = ConstU32<0>;  // NEW: Maintains legacy behavior
}
```

### Files to Update

1. **Production Runtimes** (3 files):
   - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs`
   - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs`
   - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs`

2. **Test/Mock Runtimes** (3 files):
   - `/Users/manuelmauro/Workspace/moonbeam/precompiles/crowdloan-rewards/src/mock.rs`
   - `/Users/manuelmauro/Workspace/moonbeam/precompiles/relay-encoder/src/mock.rs`
   - `/Users/manuelmauro/Workspace/moonbeam/precompiles/relay-data-verifier/src/mock.rs` (if applicable)

### Optional: Consider Enabling Relay Parent Offset

After the initial upgrade, Moonbeam could evaluate enabling the relay parent offset feature to reduce parachain fork risk. This would require:

1. **Configuration Change**:
   ```rust
   type RelayParentOffset = ConstU32<2>;  // Example: 2 relay blocks offset
   ```

2. **Trade-offs to Consider**:
   - **XCM Latency Increase**: Incoming XCM messages will be delayed by `N * 6s` (e.g., 12 seconds for offset=2)
   - **PoV Space Reduction**: Approximately 0.5% of PoV space consumed for relay chain authority proofs
   - **Unincluded Segment Capacity**: Must be increased by `VELOCITY * RP_OFFSET` (currently: 1 * 2 = 2, new total would be 5)

3. **When to Enable**:
   - If experiencing frequent parachain forks due to relay chain timing issues
   - If planning to use elastic scaling with multiple cores
   - If block production velocity increases in the future

## Migration Steps

### Step 1: Update Runtime Configurations

Add `type RelayParentOffset = ConstU32<0>;` to all six `cumulus_pallet_parachain_system::Config` implementations.

### Step 2: Update Mock Configurations

Add the same line to all test mock runtimes to ensure tests compile and pass.

### Step 3: Verify Compilation

```bash
cargo build --release
cargo test
```

### Step 4: Runtime Benchmark (if needed)

If enabling a non-zero offset in the future, re-benchmark the parachain-system pallet:

```bash
./scripts/run-benches-for-runtime.sh moonbase release
# Repeat for moonriver and moonbeam
```

### Step 5: Documentation

Update any runtime documentation to explain the relay parent offset configuration and its implications.

## Testing Recommendations

### Compilation Tests
1. Verify all runtimes compile without errors
2. Verify all test/mock runtimes compile without errors
3. Run full test suite: `cargo test`

### Runtime Tests
1. Verify existing integration tests pass
2. Test parachain block production in development mode
3. Verify XCM message handling remains functional

### Post-Deployment Verification
1. Monitor for any changes in block production timing
2. Verify parachain blocks are still being included in relay chain
3. Monitor XCM message latency (should remain unchanged with offset=0)

## Additional Resources

- **Documentation**: [Handling Parachain Forks Guide](https://paritytech.github.io/polkadot-sdk/master/polkadot_sdk_docs/guides/handling_parachain_forks/index.html)
- **Migration Guide**: Add `type RelayParentOffset = ConstU32<0>;` to maintain current behavior
- **System Parachain Examples**: See asset-hub-rococo, bridge-hub-westend, etc. in polkadot-sdk for reference implementations

## Conclusion

PR #8299 introduces a breaking change that requires immediate action. All Moonbeam runtimes must add the new `RelayParentOffset` associated type to compile with stable2506.

**Recommended Initial Approach**: Set `RelayParentOffset = ConstU32<0>` to maintain current behavior and avoid introducing new complexity during the upgrade. This preserves existing block production timing and XCM latency characteristics.

**Future Consideration**: After the stable2506 upgrade is complete and stable, evaluate whether enabling a non-zero relay parent offset would benefit Moonbeam's specific use case, particularly if experiencing parachain fork issues or planning to leverage elastic scaling features.

The change is well-designed with backward compatibility in mind, and the migration path is straightforward. The polkadot-sdk team has provided clear documentation and migration guidance for parachain teams.
