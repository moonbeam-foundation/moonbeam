# PR #8299: Collator: Support building on older relay parents

**Impact**: INHERITED
**Confidence**: High
**Affected Components**:
- Runtime configuration (all three runtimes: moonbase, moonriver, moonbeam)
- Node service layer (RPC and lazy loading)
- Runtime tests

## Changes Detected

This PR introduces a mechanism for parachains to build blocks on relay chain parents that are not at the tip of the relay chain. The main changes include:

1. **New Config Parameter**: Added `RelayParentOffset` to `cumulus_pallet_parachain_system::Config`
2. **Extended ParachainInherentData**: Added two new fields:
   - `relay_parent_descendants: Vec<relay_chain::Hash>`
   - `collator_peer_id: Option<CollatorId>`
3. **Breaking changes** to cumulus client and pallet APIs (marked as major version bumps)

## Project Impact

**Moonbeam has already implemented all required changes** based on the migration guide. The changes are visible in the current branch:

### Runtime Configuration (✅ COMPLETED)
All three runtimes have added the `RelayParentOffset` configuration parameter set to `0` to maintain existing behavior:

- **moonbase**: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs:758`
  ```rust
  type RelayParentOffset = ConstU32<0>;
  ```

- **moonriver**: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs:758`
  ```rust
  type RelayParentOffset = ConstU32<0>;
  ```

- **moonbeam**: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs:714`
  ```rust
  type RelayParentOffset = ConstU32<0>;
  ```

### Node Service Layer (✅ COMPLETED)
ParachainInherentData construction has been updated with the new fields:

- **RPC Service**: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/rpc.rs:238-245`
  ```rust
  let parachain_inherent_data = ParachainInherentData {
      validation_data: vfp,
      relay_chain_state,
      downward_messages: Default::default(),
      horizontal_messages: Default::default(),
      relay_parent_descendants: Default::default(),
      collator_peer_id: None,
  };
  ```

- **Lazy Loading**: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lazy_loading/mod.rs:331-338`
  ```rust
  let parachain_inherent_data = ParachainInherentData {
      validation_data: vfp,
      relay_chain_state,
      downward_messages: Default::default(),
      horizontal_messages: Default::default(),
      relay_parent_descendants: Default::default(),
      collator_peer_id: None,
  };
  ```

### Runtime Tests (⚠️ INCOMPLETE)
The test helper files need to be updated to include the new fields. Currently missing in:

- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/tests/common/mod.rs:414-419`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/tests/common/mod.rs:448` (likely similar)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/tests/common/mod.rs:448` (likely similar)

**Current test code** (missing new fields):
```rust
let parachain_inherent_data = ParachainInherentData {
    validation_data: vfp,
    relay_chain_state: relay_chain_state,
    downward_messages: Default::default(),
    horizontal_messages: Default::default(),
};
```

**Should be**:
```rust
let parachain_inherent_data = ParachainInherentData {
    validation_data: vfp,
    relay_chain_state: relay_chain_state,
    downward_messages: Default::default(),
    horizontal_messages: Default::default(),
    relay_parent_descendants: Default::default(),
    collator_peer_id: None,
};
```

## Evidence & References

### Git History
Recent commit shows the node-level changes were already applied:
```
007e9e3aed fix: :bug: add missing relay_parent_descendants and collator_peer_id fields to ParachainInherentData
```

### Search Results
- **RelayParentOffset found in**: 3 runtime files (moonbase, moonriver, moonbeam)
- **ParachainInherentData usage**: Found in node service, lazy loading, and runtime tests
- **New fields (relay_parent_descendants, collator_peer_id)**: Present in node service files, missing in runtime test helpers

## Recommended Actions

1. **Update runtime test helpers** in all three runtimes to include the new ParachainInherentData fields
2. **Run tests** to ensure the changes don't break existing test suites:
   ```bash
   cargo test -p moonbase-runtime
   cargo test -p moonriver-runtime
   cargo test -p moonbeam-runtime
   ```

3. **Optional Enhancement**: Consider whether Moonbeam would benefit from using a non-zero `RelayParentOffset` value to reduce parachain forks (as suggested in the migration guide). This would require:
   - Evaluating the tradeoffs (reduced forks vs. increased PoV size and XCM latency)
   - Consulting the documentation at: https://paritytech.github.io/polkadot-sdk/master/polkadot_sdk_docs/guides/handling_parachain_forks/index.html

## Migration Guide Reference

From the PR documentation:
> Teams that want to keep behaviour as-is can just add `type RelayParentOffset = ConstU32<0>;` to the
> `cumulus_pallet_parachain_system::Config` in their runtime. Teams that wish to leverage the new functionality
> can find more documentation [here](https://paritytech.github.io/polkadot-sdk/master/polkadot_sdk_docs/guides/handling_parachain_forks/index.html)

## Summary

This PR's changes have been **mostly inherited automatically** through the Polkadot SDK upgrade. Moonbeam has already added the required configuration parameter (`RelayParentOffset = ConstU32<0>`) and updated the node service layer to use the new ParachainInherentData structure.

The only remaining work is updating the runtime test helper files to include the two new fields (`relay_parent_descendants` and `collator_peer_id`) in ParachainInherentData construction. This is a minor fix required for test compilation.
