# PR #8299: Collator: Support building on older relay parents

## Overview

**PR:** https://github.com/paritytech/polkadot-sdk/pull/8299
**Labels:** T9-cumulus
**Audience:** Runtime Developers
**Impact:** Breaking Change - Runtime Migration Required

## Summary

This PR introduces mechanisms to build on relay parents that are not at the tip of the relay chain. By choosing a relay parent with an offset, parachains can wait for relay chain forks to settle before building blocks, thereby reducing the likelihood of parachain forks. This is particularly useful in combination with slot-based collators and elastic-scaling.

This is a **BREAKING CHANGE** requiring all parachains to add a new configuration item to their runtime's `cumulus_pallet_parachain_system::Config` implementation.

## Technical Details

### What Changed

**New Runtime Configuration Item:**
```rust
// New trait item required in cumulus_pallet_parachain_system::Config
type RelayParentOffset = ConstU32<N>;  // N = offset value
```

**Key Concepts:**
1. **Relay Parent Offset**: Determines how many blocks behind the relay chain tip to build on
   - Offset = 0: Build on current relay chain tip (existing behavior)
   - Offset = 2: Build on relay parent 2 blocks behind the tip

2. **Fork Reduction**: By waiting for relay chain forks to settle, parachain forks become less likely

3. **Validation Data Changes**: The `set_validation_data` inherent now requires multiple relay parent descendants to enforce the offset

4. **Tradeoffs**:
   - **Pros**: Reduced parachain fork probability
   - **Cons**:
     - XCM message latency increases by `OFFSET * 6s`
     - Additional proof-of-validity space for relay chain authorities
     - Requires increasing unincluded segment capacity

### Affected Crates (All MAJOR bumps)

**Core Cumulus Crates:**
- **cumulus-pallet-parachain-system** (major): Core parachain system pallet - requires new config item
- **cumulus-client-consensus-aura** (major): Aura consensus client
- **cumulus-client-parachain-inherent** (major): Parachain inherent data provider
- **cumulus-primitives-core** (major): Core Cumulus primitives
- **cumulus-primitives-parachain-inherent** (major): Parachain inherent primitives
- **cumulus-pallet-aura-ext** (major): Aura extension pallet
- **cumulus-pallet-xcmp-queue** (major): XCMP queue pallet

**Other Crates:**
- **polkadot-primitives** (major): Polkadot protocol primitives
- **sc-consensus-babe** (major): BABE consensus
- **sp-consensus-babe** (major): BABE consensus primitives
- Plus 15+ system parachain runtimes

## Impact on Moonbeam

### Classification

**Category:** Breaking Change - Runtime Migration Required
**Type:** Infrastructure Change (T9-cumulus)
**Action Required:** Add `RelayParentOffset` configuration to all runtimes

### Current Status

The migration has already been applied in the `moonbeam-polkadot-stable2506` branch:

**Commit:** `8faaf24984faf620eb24b5446f3876b30fea2f64`
**Message:** "fix: add RelayParentOffset trait item"
**Changes:** Added `type RelayParentOffset = ConstU32<0>;` to all three runtimes

### Affected Components

#### 1. Runtime Configuration (BREAKING - Already Fixed)

All three Moonbeam runtimes require the new configuration item:

**Files:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs:750-763`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs:749-762`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs:706-719`

**Current Configuration (master branch - MISSING):**
```rust
// moonbase/src/lib.rs:750-763
impl cumulus_pallet_parachain_system::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type OnSystemEvent = ();
    type SelfParaId = ParachainInfo;
    type ReservedDmpWeight = ReservedDmpWeight;
    type OutboundXcmpMessageSource = XcmpQueue;
    type XcmpMessageHandler = XcmpQueue;
    type ReservedXcmpWeight = ReservedXcmpWeight;
    type CheckAssociatedRelayNumber = EmergencyParaXcm;
    type ConsensusHook = ConsensusHook;
    type DmpQueue = frame_support::traits::EnqueueWithOrigin<MessageQueue, RelayOrigin>;
    type WeightInfo = moonbase_weights::cumulus_pallet_parachain_system::WeightInfo<Runtime>;
    type SelectCore = cumulus_pallet_parachain_system::DefaultCoreSelector<Runtime>;
    // MISSING: type RelayParentOffset = ConstU32<0>;
}
```

**Fixed Configuration (stable2506 branch - commit 8faaf24):**
```rust
impl cumulus_pallet_parachain_system::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type OnSystemEvent = ();
    type SelfParaId = ParachainInfo;
    type ReservedDmpWeight = ReservedDmpWeight;
    type OutboundXcmpMessageSource = XcmpQueue;
    type XcmpMessageHandler = XcmpQueue;
    type ReservedXcmpWeight = ReservedXcmpWeight;
    type CheckAssociatedRelayNumber = EmergencyParaXcm;
    type ConsensusHook = ConsensusHookWrapperForRelayTimestamp<Runtime, ConsensusHook>;
    type DmpQueue = frame_support::traits::EnqueueWithOrigin<MessageQueue, RelayOrigin>;
    type WeightInfo = moonbase_weights::cumulus_pallet_parachain_system::WeightInfo<Runtime>;
    type SelectCore = cumulus_pallet_parachain_system::DefaultCoreSelector<Runtime>;
    type RelayParentOffset = ConstU32<0>;  // <-- ADDED
}
```

**Configuration Choice:** Using `ConstU32<0>` maintains existing behavior (building on relay chain tip).

#### 2. Test Mock Configurations (REQUIRES UPDATE)

Moonbeam's precompile test mocks also implement `cumulus_pallet_parachain_system::Config` and will need updating:

**Files Requiring Updates:**
- `/Users/manuelmauro/Workspace/moonbeam/precompiles/crowdloan-rewards/src/mock.rs:60-69`
- `/Users/manuelmauro/Workspace/moonbeam/precompiles/relay-encoder/src/mock.rs:101-110`

**Current Mock Configuration (INCOMPLETE):**
```rust
// precompiles/crowdloan-rewards/src/mock.rs:60
impl cumulus_pallet_parachain_system::Config for Runtime {
    type SelfParaId = ParachainId;
    type RuntimeEvent = RuntimeEvent;
    type OnSystemEvent = ();
    type OutboundXcmpMessageSource = ();
    type XcmpMessageHandler = ();
    type ReservedXcmpWeight = ();
    type DmpQueue = frame_support::traits::EnqueueWithOrigin<MessageQueue, RelayOrigin>;
    type ReservedDmpWeight = ();
    type CheckAssociatedRelayNumber = cumulus_pallet_parachain_system::RelayNumberStrictlyIncreases;
    // MISSING: type ConsensusHook = ...;
    // MISSING: type WeightInfo = ...;
    // MISSING: type SelectCore = ...;
    // MISSING: type RelayParentOffset = ...;
}
```

**Required Update:**
```rust
impl cumulus_pallet_parachain_system::Config for Runtime {
    type SelfParaId = ParachainId;
    type RuntimeEvent = RuntimeEvent;
    type OnSystemEvent = ();
    type OutboundXcmpMessageSource = ();
    type XcmpMessageHandler = ();
    type ReservedXcmpWeight = ();
    type DmpQueue = frame_support::traits::EnqueueWithOrigin<MessageQueue, RelayOrigin>;
    type ReservedDmpWeight = ();
    type CheckAssociatedRelayNumber = cumulus_pallet_parachain_system::RelayNumberStrictlyIncreases;
    type ConsensusHook = ();  // Or appropriate mock
    type WeightInfo = ();
    type SelectCore = ();
    type RelayParentOffset = ConstU32<0>;  // <-- MUST ADD
}
```

#### 3. Parachain Inherent Changes (Transparent Impact)

The `cumulus-primitives-parachain-inherent` and `cumulus-client-parachain-inherent` crates have breaking changes to the inherent data format:

**Affected Usage Points:**
- `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:31` - Import of `MockValidationDataInherentDataProvider`
- `/Users/manuelmauro/Workspace/moonbeam/node/service/src/rpc.rs:29` - Import of `ParachainInherentData`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/tests/common/mod.rs:19` - Test usage
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/tests/common/mod.rs:19` - Test usage
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/tests/common/mod.rs:19` - Test usage

**Migration:** The changes maintain backward compatibility by attempting to decode both old and new formats. No immediate code changes required beyond version updates.

#### 4. Consensus Mechanism (No Direct Impact)

**Key Finding:** Moonbeam uses **Nimbus consensus**, not Aura:

```rust
// /Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:1059-1060
nimbus_consensus::collators::lookahead::run::<Block, _, _, _, FullBackend, _, _, _, _, _, _>(
    nimbus_consensus::collators::lookahead::Params {
        // Nimbus-specific collation logic
    }
)
```

**Dependencies:**
- `/Users/manuelmauro/Workspace/moonbeam/node/service/Cargo.toml:127` - `nimbus-consensus`
- `/Users/manuelmauro/Workspace/moonbeam/node/service/Cargo.toml:129` - `nimbus-primitives`

**Impact:** While the PR affects `cumulus-client-consensus-aura`, Moonbeam's Nimbus-based consensus is not directly affected. However, Nimbus may need to be updated to work with the new parachain inherent format if it hasn't been already.

#### 5. ConsensusHook Usage (Indirect Impact)

All three runtimes use `FixedVelocityConsensusHook` from `pallet-async-backing`:

```rust
// /Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs:743-748
type ConsensusHook = pallet_async_backing::consensus_hook::FixedVelocityConsensusHook<
    Runtime,
    RELAY_CHAIN_SLOT_DURATION_MILLIS,
    BLOCK_PROCESSING_VELOCITY,
    UNINCLUDED_SEGMENT_CAPACITY,
>;
```

**Current Constants:**
- `RELAY_CHAIN_SLOT_DURATION_MILLIS`: 6000 (6 seconds)
- `BLOCK_PROCESSING_VELOCITY`: 1 (one parachain block per relay parent)
- `UNINCLUDED_SEGMENT_CAPACITY`: 3

**Future Consideration:** If Moonbeam decides to use a non-zero `RelayParentOffset`, the `UNINCLUDED_SEGMENT_CAPACITY` would need to be increased by `VELOCITY * OFFSET` as mentioned in the PR documentation.

### Migration Checklist

- [x] **Runtime Configuration**: Add `type RelayParentOffset = ConstU32<0>;` to all three runtimes
  - Status: Already completed in commit `8faaf24984faf620eb24b5446f3876b30fea2f64`
  - Files: moonbase, moonriver, moonbeam runtime lib.rs files

- [ ] **Test Mocks**: Update mock runtime configurations in precompile tests
  - Status: Pending
  - Files:
    - `/Users/manuelmauro/Workspace/moonbeam/precompiles/crowdloan-rewards/src/mock.rs`
    - `/Users/manuelmauro/Workspace/moonbeam/precompiles/relay-encoder/src/mock.rs`

- [x] **Dependency Updates**: Update Cargo.toml to point to stable2506 branch
  - Status: Handled by Polkadot SDK version bump

- [ ] **Testing**: Verify all tests pass after migration
  - Unit tests with updated mocks
  - Integration tests with dev node
  - Runtime upgrade tests if applicable

### Recommended Actions

1. **Immediate**: Update test mock configurations to include `RelayParentOffset`
   - The mock configs are currently incomplete and will break on upgrade
   - Add: `type RelayParentOffset = ConstU32<0>;`

2. **Short-term**: Run full test suite to verify migration
   - Focus on tests using `MockValidationDataInherentDataProvider`
   - Verify runtime upgrade path on testnet

3. **Long-term**: Evaluate using non-zero offset
   - Consider setting `RelayParentOffset = ConstU32<1>` or higher
   - Would require increasing `UNINCLUDED_SEGMENT_CAPACITY`
   - Tradeoff: Reduced forks vs. XCM latency (6 seconds per offset unit)

### Risk Assessment

**Severity:** Medium
- Runtime compilation will fail without the new configuration item
- The fix is straightforward but affects multiple locations
- Main runtime configurations already fixed in stable2506 branch
- Test mocks still need attention

**Complexity:** Low
- Clear migration path: add one line to runtime configs
- Well-documented in upstream PR and Polkadot SDK docs
- Choosing offset = 0 maintains existing behavior exactly

**Testing Impact:** Medium
- Test mocks need updating
- Integration tests may need adjustments for inherent data format changes
- Should verify on testnet before mainnet deployment

### Documentation References

- **Polkadot SDK Guide**: [Handling Parachain Forks](https://paritytech.github.io/polkadot-sdk/master/polkadot_sdk_docs/guides/handling_parachain_forks/index.html)
- **Migration Guide**: Teams wanting to keep behavior as-is should add `type RelayParentOffset = ConstU32<0>;`
- **Advanced Usage**: Non-zero offsets require careful consideration of unincluded segment capacity and XCM latency

## Code Examples

### Complete Fixed Runtime Configuration

```rust
impl cumulus_pallet_parachain_system::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type OnSystemEvent = ();
    type SelfParaId = ParachainInfo;
    type ReservedDmpWeight = ReservedDmpWeight;
    type OutboundXcmpMessageSource = XcmpQueue;
    type XcmpMessageHandler = XcmpQueue;
    type ReservedXcmpWeight = ReservedXcmpWeight;
    type CheckAssociatedRelayNumber = EmergencyParaXcm;
    type ConsensusHook = ConsensusHook;
    type DmpQueue = frame_support::traits::EnqueueWithOrigin<MessageQueue, RelayOrigin>;
    type WeightInfo = moonbase_weights::cumulus_pallet_parachain_system::WeightInfo<Runtime>;
    type SelectCore = cumulus_pallet_parachain_system::DefaultCoreSelector<Runtime>;
    type RelayParentOffset = ConstU32<0>;  // Maintains existing behavior
}
```

### Test Mock Configuration Fix

```rust
impl cumulus_pallet_parachain_system::Config for Runtime {
    type SelfParaId = ParachainId;
    type RuntimeEvent = RuntimeEvent;
    type OnSystemEvent = ();
    type OutboundXcmpMessageSource = ();
    type XcmpMessageHandler = ();
    type ReservedXcmpWeight = ();
    type DmpQueue = frame_support::traits::EnqueueWithOrigin<MessageQueue, RelayOrigin>;
    type ReservedDmpWeight = ();
    type CheckAssociatedRelayNumber = cumulus_pallet_parachain_system::RelayNumberStrictlyIncreases;
    type ConsensusHook = ();
    type WeightInfo = ();
    type SelectCore = ();
    type RelayParentOffset = ConstU32<0>;  // Required for compilation
}
```

## Conclusion

PR #8299 introduces a breaking change to `cumulus-pallet-parachain-system` that requires all parachains to add a new `RelayParentOffset` configuration item. For Moonbeam:

1. **Main runtimes**: Already fixed in the stable2506 branch
2. **Test mocks**: Need updating to avoid compilation failures
3. **Nimbus consensus**: No direct impact (uses different consensus mechanism than Aura)
4. **Configuration choice**: Using offset = 0 maintains existing behavior without introducing XCM latency

The change is well-contained and low-risk once the configuration item is added. The main work is ensuring all implementations of `cumulus_pallet_parachain_system::Config` are updated, including test mocks.
