# PR #8316: Remove slashing spans from pallet-staking-async

## Summary

This PR removes the slashing spans concept (`SlashingSpans`, `SpanSlash`) and related metadata from `pallet-staking-async`, simplifying the slashing logic. The `num_slashing_spans` parameter in `withdraw_unbonded`, `force_unstake`, and `reap_stash` extrinsics is deprecated but kept for backward compatibility.

## PR Details

- **GitHub**: https://github.com/paritytech/polkadot-sdk/pull/8316
- **Merged**: May 8, 2025
- **Changes**: +848 âˆ’1,520 lines across 13 files
- **Crates**:
  - `pallet-staking-async` (major bump)
  - `pallet-staking` (patch bump)

## Changes Overview

### Removed
- `SlashingSpans` storage map
- `SpanSlash` storage map
- `IncorrectSlashingSpans` error variant

### Deprecated
- `num_slashing_spans` parameter in:
  - `withdraw_unbonded`
  - `force_unstake`
  - `reap_stash`

The parameter is kept for backward compatibility but has no effect.

### Functional Changes
- **Old behavior**: Reward = 50% of `SlashRewardFraction`, halved again for each successive slash in the same era
- **New behavior**: No successive reward halving; only highest offence per validator/nominator per era is considered

## Impact on Moonbeam

### Affected Components

Moonbeam does not use `pallet-staking-async` directly but maintains relay chain encoder functionality for XCM transactions that interact with relay chain staking. The following components are affected:

#### 1. Primitives (`/primitives/xcm/src/transactor_traits.rs`)
```rust
pub enum AvailableStakeCalls {
    // ...
    WithdrawUnbonded(u32),  // u32 is num_slashing_spans
    // ...
}
```
**Line 76** - Defines the interface for withdraw_unbonded with the u32 parameter.

#### 2. Relay Encoders
All three relay encoders maintain the same structure:

- `/runtime/relay-encoder/src/westend.rs` (line 53)
- `/runtime/relay-encoder/src/kusama.rs` (line 52)
- `/runtime/relay-encoder/src/polkadot.rs` (line 53)

```rust
pub enum StakeCall {
    // ...
    WithdrawUnbonded(u32),
    // ...
}
```

#### 3. Precompile (`/precompiles/relay-encoder/src/lib.rs`)
**Lines 125-143** - EVM precompile function:
```rust
#[precompile::public("encodeWithdrawUnbonded(uint32)")]
#[precompile::public("encode_withdraw_unbonded(uint32)")]
#[precompile::view]
fn encode_withdraw_unbonded(
    handle: &mut impl PrecompileHandle,
    slashes: u32,  // num_slashing_spans parameter
) -> EvmResult<UnboundedBytes> {
    // ... encoding logic
}
```

This function is exposed to Ethereum/EVM users via the RelayEncoder precompile.

#### 4. XCM Transactor Pallet (`/pallets/xcm-transactor/src/encode.rs`)
**Lines 150-159** - Encoding implementation:
```rust
AvailableStakeCalls::WithdrawUnbonded(a) => {
    let mut encoded_call: Vec<u8> = Vec::new();
    // pallet index
    encoded_call.push(RelayIndices::<T>::get().staking);
    // call index
    encoded_call.push(RelayIndices::<T>::get().withdraw_unbonded);
    // encoded argument
    encoded_call.append(&mut a.encode());  // encodes num_slashing_spans
    encoded_call
}
```

#### 5. Test Files
- `/runtime/relay-encoder/src/westend.rs` (lines 388-391 in tests)
- Similar test patterns in kusama.rs and polkadot.rs (commented out but present)

### Compatibility Analysis

**BACKWARD COMPATIBLE** - No breaking changes for Moonbeam:

1. **API Stability**: The extrinsic signature remains unchanged (still accepts u32)
2. **Encoding Format**: The SCALE encoding format is identical
3. **Runtime Behavior**: The relay chain will accept and ignore the parameter
4. **Existing Code**: All Moonbeam code will continue to function without modification

### Impact Assessment

**Severity**: LOW

**Impact Type**: Informational

**Rationale**:
- The relay chains (Polkadot, Kusama, Westend) maintain backward compatibility by keeping the parameter
- Moonbeam's relay encoder will continue to encode and send the parameter
- The relay chain will simply ignore the value
- No functional impact on Moonbeam users or operations

## Required Actions

### Mandatory
None - The change is fully backward compatible.

### Recommended

1. **Documentation Update**: Add a note to the RelayEncoder precompile documentation explaining that the `slashes`/`num_slashing_spans` parameter is deprecated and has no effect on current relay chains:

   ```rust
   /// Encode withdraw_unbonded call for relay chain staking
   ///
   /// # Parameters
   /// - slashes: Number of slashing spans (DEPRECATED - ignored by relay chains as of stable2506)
   ///
   /// Note: This parameter is maintained for backward compatibility but has no effect
   /// on Polkadot, Kusama, or Westend relay chains after the stable2506 upgrade.
   ```

2. **TypeScript Types Regeneration**: When updating to stable2506, regenerate TypeScript bindings to match updated relay chain metadata:
   ```bash
   pnpm build
   ```

3. **User Communication**: Consider informing users through release notes that:
   - The `num_slashing_spans` parameter in `withdraw_unbonded` is now ignored by relay chains
   - Existing integrations will continue to work without changes
   - The parameter can be set to any value (e.g., 0) as it has no effect

## Testing Recommendations

1. **Functional Testing**: Verify that relay staking operations via XCM continue to work:
   - Encode withdraw_unbonded calls through the precompile
   - Execute withdraw_unbonded via XCM transactor
   - Confirm successful execution on relay chains

2. **Integration Testing**: Test the complete flow:
   ```typescript
   // Example test case
   const encodedCall = await relayEncoder.encodeWithdrawUnbonded(0); // value doesn't matter
   // Submit via XCM transactor and verify success
   ```

3. **No Migration Testing Required**: Since there are no storage changes in Moonbeam, no migration testing is needed.

## Additional Notes

- The PR affects `pallet-staking-async` which is used by relay chains, not by parachains like Moonbeam
- Moonbeam only encodes calls to be sent to relay chains via XCM; it doesn't execute relay chain staking logic locally
- The slashing span removal simplifies relay chain logic without affecting parachain functionality
- Future cleanup could remove the parameter entirely from Moonbeam's interfaces, but this is not urgent given backward compatibility

## References

- PR Link: https://github.com/paritytech/polkadot-sdk/pull/8316
- PRDoc: `/Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_8316.prdoc`
- Affected Moonbeam Files:
  - `/primitives/xcm/src/transactor_traits.rs` (line 76)
  - `/runtime/relay-encoder/src/westend.rs` (line 53)
  - `/runtime/relay-encoder/src/kusama.rs` (line 52)
  - `/runtime/relay-encoder/src/polkadot.rs` (line 53)
  - `/precompiles/relay-encoder/src/lib.rs` (lines 125-143)
  - `/pallets/xcm-transactor/src/encode.rs` (lines 150-159)
