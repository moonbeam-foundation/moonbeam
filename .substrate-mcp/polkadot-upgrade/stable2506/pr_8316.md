# PR #8316: Remove slashing spans from pallet-staking-async

**Impact**: INHERITED
**Confidence**: High
**Affected Components**:
- relay-encoder (test code only)
- precompiles/relay-encoder (encodes `withdraw_unbonded` calls)
- pallets/xcm-transactor (encodes relay staking calls)
- primitives/xcm (defines `AvailableStakeCalls`)
- typescript-api (type definitions for relay chain types)

## Changes Detected

PR #8316 removes slashing span logic from `pallet-staking-async`:
- Removes storage items: `SlashingSpans`, `SpanSlash`
- Removes error: `IncorrectSlashingSpans`
- **Deprecates** `num_slashing_spans` parameter in `withdraw_unbonded`, `force_unstake`, and `reap_stash` extrinsics (parameter kept for backward compatibility but ignored)
- Changes slashing reward behavior: no longer halves rewards for successive slashes

**Key Detail**: The prdoc lists both:
- `pallet-staking-async`: major bump (breaking changes)
- `pallet-staking`: patch bump (no breaking changes)

Moonbeam uses `pallet-staking` (not `pallet-staking-async`), and the PR only made a patch bump to `pallet-staking`, meaning no API changes for Moonbeam's direct usage.

## Project Impact

**No code changes required** - Impact is INHERITED because:

1. **Moonbeam doesn't use pallet-staking directly in runtimes** - Moonbeam is an Ethereum-compatible parachain that doesn't implement its own staking through pallet-staking. It uses custom parachain-staking pallet.

2. **Relay chain encoding still works** - Moonbeam encodes relay chain staking calls via XCM to interact with Polkadot/Kusama/Westend staking. The `num_slashing_spans` parameter is **deprecated but not removed** for backward compatibility:
   - `/Users/manuelmauro/Workspace/moonbeam/precompiles/relay-encoder/src/lib.rs:128-142` - `encode_withdraw_unbonded(slashes: u32)` still accepts the parameter
   - `/Users/manuelmauro/Workspace/moonbeam/pallets/xcm-transactor/src/encode.rs:150-159` - Encodes `WithdrawUnbonded(u32)` with the parameter
   - `/Users/manuelmauro/Workspace/moonbeam/primitives/xcm/src/transactor_traits.rs:76` - Defines `WithdrawUnbonded(u32)`

3. **Existing code is compatible** - Since the parameter is deprecated but still accepted, existing Moonbeam code that passes `num_slashing_spans` will continue to work. The relay chain runtime will simply ignore the parameter.

4. **Test code references** - Test code in `/Users/manuelmauro/Workspace/moonbeam/runtime/relay-encoder/src/westend.rs:389` uses `num_slashing_spans: 100u32` in tests, but this is only test code that validates encoding format, not production code.

## Evidence & References

### Moonbeam's usage of withdraw_unbonded:

**Precompile interface** (`/Users/manuelmauro/Workspace/moonbeam/precompiles/relay-encoder/src/lib.rs`):
```rust
#[precompile::public("encodeWithdrawUnbonded(uint32)")]
#[precompile::public("encode_withdraw_unbonded(uint32)")]
#[precompile::view]
fn encode_withdraw_unbonded(
    handle: &mut impl PrecompileHandle,
    slashes: u32,  // This parameter is now deprecated on relay chain but still accepted
) -> EvmResult<UnboundedBytes> {
    let encoded = pallet_xcm_transactor::Pallet::<Runtime>::encode_call(
        AvailableStakeCalls::WithdrawUnbonded(slashes),
    )
    .as_slice()
    .into();
    Ok(encoded)
}
```

**XCM transactor encoding** (`/Users/manuelmauro/Workspace/moonbeam/pallets/xcm-transactor/src/encode.rs:150-159`):
```rust
AvailableStakeCalls::WithdrawUnbonded(a) => {
    let mut encoded_call: Vec<u8> = Vec::new();
    encoded_call.push(RelayIndices::<T>::get().staking);
    encoded_call.push(RelayIndices::<T>::get().withdraw_unbonded);
    encoded_call.append(&mut a.encode());  // Parameter still encoded
    encoded_call
}
```

**Type definition** (`/Users/manuelmauro/Workspace/moonbeam/primitives/xcm/src/transactor_traits.rs:69-83`):
```rust
pub enum AvailableStakeCalls {
    Bond(...),
    BondExtra(relay_chain::Balance),
    Unbond(relay_chain::Balance),
    WithdrawUnbonded(u32),  // Still has u32 parameter
    Validate(pallet_staking::ValidatorPrefs),
    Nominate(Vec<relay_chain::AccountId>),
    Chill,
    SetPayee(pallet_staking::RewardDestination<relay_chain::AccountId>),
    SetController,
    Rebond(relay_chain::Balance),
}
```

### Verification that Moonbeam uses pallet-staking, not pallet-staking-async:

**Root Cargo.toml** (`/Users/manuelmauro/Workspace/moonbeam/Cargo.toml:155`):
```toml
pallet-staking = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2506", default-features = false }
```

No references to `pallet-staking-async` found in the Moonbeam codebase.

## Recommendation

**No action required**. The changes are backward compatible for Moonbeam:
- The deprecated parameter is still accepted by relay chain runtimes
- Moonbeam's encoding logic doesn't need to change
- Existing smart contracts calling `encodeWithdrawUnbonded(uint32)` will continue to work
- The relay chain will simply ignore the `num_slashing_spans` parameter

**Optional future cleanup**: In a future update, Moonbeam could update documentation to note that the `slashes`/`num_slashing_spans` parameter is ignored by modern relay chains, but this is not urgent as the API remains compatible.

## Related Files

- `/Users/manuelmauro/Workspace/moonbeam/precompiles/relay-encoder/src/lib.rs` (line 128)
- `/Users/manuelmauro/Workspace/moonbeam/pallets/xcm-transactor/src/encode.rs` (line 150)
- `/Users/manuelmauro/Workspace/moonbeam/primitives/xcm/src/transactor_traits.rs` (line 76)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/relay-encoder/src/westend.rs` (line 389, test only)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/relay-encoder/src/kusama.rs` (line 388, commented test)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/relay-encoder/src/polkadot.rs` (line 389, commented test)
