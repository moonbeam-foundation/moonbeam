# PR #8323 Impact Analysis: Allow Genesis-Presets to be Patched

## PR Overview

**Title:** Allow genesis-presets to be patched and remove native runtime calls from the staging-node-cli

**PR Link:** https://github.com/paritytech/polkadot-sdk/pull/8323

**Audience:** Node Dev

**Crates Modified:**
- `sc-chain-spec` (patch bump)
- `polkadot-parachain-bin` (patch bump)

## Summary

This PR enables runtime genesis presets to be patched with JSON values, addressing issue #7748. The core objective is to allow dynamic modification of hardcoded genesis configurations without requiring direct native runtime calls, ultimately reducing the need to link the runtime in node code.

## Key Changes

### 1. GenesisBuildAction Enum Enhancement

The `GenesisBuildAction` enum in `sc-chain-spec` was restructured to support patching named presets:

- **Previous:** `NamedPreset(String, PhantomData<EHF>)`
- **New:** `NamedPreset(String, json::Value, PhantomData<EHF>)`

All three variants (`Patch`, `Full`, `NamedPreset`) now support a unified `merge_patch()` method for JSON patching capabilities.

### 2. New ChainSpecBuilder API Methods

Two new methods for handling genesis configuration:

1. **`with_genesis_config_patch()`** - Applies JSON patches to the current genesis action via `merge_patch()`
2. **`with_genesis_config_preset_name()`** - Sets a named preset with an empty JSON object as the initial patch value

### 3. Updated Genesis Configuration Processing

The genesis builder API processing flow changed to:
- Retrieve the named preset from the runtime
- Merge the supplied patch into the preset using `json_merge()`
- Pass the combined result as the genesis configuration

## Impact on Moonbeam

### Direct Usage Analysis

Moonbeam uses the affected `sc-chain-spec` crate and its APIs in the following locations:

1. **Chain Spec Module** (`node/service/src/chain_spec/`):
   - `moonbase.rs` - Uses `ChainSpec::builder()` and `with_genesis_config()`
   - `moonbeam.rs` - Uses `ChainSpec::builder()` and `with_genesis_config()`
   - `moonriver.rs` - Uses `ChainSpec::builder()` and `with_genesis_config()`

2. **Lazy Loading Module** (`node/service/src/lazy_loading/mod.rs`):
   - Uses `ChainSpec::builder()` with `with_genesis_config_preset_name()`
   - This is the only location using the preset-based approach

3. **Service Module** (`node/service/src/lib.rs`):
   - Uses `ChainSpec::builder()` for test chain specs

### Breaking Change Assessment

**The NamedPreset variant signature change is a breaking change**, but:

- **Moonbeam is NOT affected** by this breaking change because:
  - No code directly pattern matches on `GenesisBuildAction` enum
  - No code accesses the internal structure of `GenesisBuildAction`
  - All usage is through the public builder API (`ChainSpecBuilder`)

**Code Search Results:**
```bash
# No pattern matching on GenesisBuildAction found
rg "match.*genesis|GenesisBuildAction" /moonbeam/node/service/src --type rust
# Returns: No matches
```

### Current Genesis Configuration Pattern

Moonbeam uses two patterns for genesis configuration:

#### Pattern 1: Direct Genesis Config (Most common)
```rust
ChainSpec::builder(WASM_BINARY, Extensions { ... })
    .with_name("Moonbase Development Testnet")
    .with_id("moonbase_dev")
    .with_chain_type(ChainType::Development)
    .with_genesis_config(testnet_genesis(
        accounts[0],          // sudo
        council_members,      // council
        tech_committee,       // tech committee
        collators,           // collators
        delegations,         // delegations
        endowed_accounts,    // endowed accounts
        para_id,             // para_id
        chain_id,            // chain_id
    ))
    .build()
```

This pattern:
- Builds genesis config using runtime's `testnet_genesis()` function
- Returns `serde_json::Value` which is passed to `with_genesis_config()`
- This approach is **unaffected** by PR #8323

#### Pattern 2: Named Preset (Lazy Loading only)
```rust
ChainSpec::builder(WASM_BINARY, Default::default())
    .with_name("Lazy Loading")
    .with_id("lazy_loading")
    .with_chain_type(ChainType::Development)
    .with_genesis_config_preset_name(sp_genesis_builder::DEV_RUNTIME_PRESET)
```

This pattern:
- Uses `with_genesis_config_preset_name()` which is the API that now supports patching
- Currently does NOT apply any patches (PR #8323 would enable this)
- This approach **benefits** from PR #8323's new capabilities

### Genesis Preset Implementation

Moonbeam properly implements the `sp_genesis_builder::GenesisBuilder` runtime API in all three runtimes:

**Location:** `runtime/{moonbase,moonbeam,moonriver}/src/genesis_config_preset.rs`

**Key Functions:**
- `testnet_genesis()` - Builds complete genesis config returning `serde_json::Value`
- `development()` - Returns development preset as `serde_json::Value`
- `get_preset()` - Runtime API that returns preset by ID
- `preset_names()` - Lists available presets (currently only `DEV_RUNTIME_PRESET`)

**Runtime API Implementation:** `runtime/common/src/apis.rs`
```rust
impl sp_genesis_builder::GenesisBuilder<Block> for Runtime {
    fn build_state(config: Vec<u8>) -> sp_genesis_builder::Result {
        frame_support::genesis_builder_helper::build_state::<RuntimeGenesisConfig>(config)
    }

    fn get_preset(id: &Option<sp_genesis_builder::PresetId>) -> Option<Vec<u8>> {
        frame_support::genesis_builder_helper::get_preset::<RuntimeGenesisConfig>(
            id,
            genesis_config_preset::get_preset
        )
    }

    fn preset_names() -> Vec<sp_genesis_builder::PresetId> {
        genesis_config_preset::preset_names()
    }
}
```

This implementation is **fully compatible** with PR #8323's changes.

## Compatibility Assessment

### Status: COMPATIBLE

**Rating:** âœ… No Breaking Impact

**Reasons:**
1. **No Direct GenesisBuildAction Usage:** Moonbeam doesn't pattern match or directly access the modified enum
2. **Public API Unchanged:** The builder pattern API (`ChainSpec::builder()`) remains backward compatible
3. **Runtime API Compatible:** Moonbeam's `sp_genesis_builder::GenesisBuilder` implementation aligns with the new patching capabilities
4. **Existing Code Works:** All current genesis configuration patterns continue to function

### Potential Benefits

While not required, Moonbeam could benefit from PR #8323's new capabilities:

1. **Dynamic Genesis Patching:** Could patch genesis presets with JSON values without code changes
2. **Flexible Configuration:** Could modify specific genesis parameters for different deployments
3. **Reduced Runtime Linking:** Could reduce node binary size by avoiding native runtime dependencies (though Moonbeam currently uses runtime features)

**Example Use Case:**
```rust
// Current approach (works fine)
.with_genesis_config_preset_name(sp_genesis_builder::DEV_RUNTIME_PRESET)

// New capability (optional, not required)
.with_genesis_config_preset_name(sp_genesis_builder::DEV_RUNTIME_PRESET)
.with_genesis_config_patch(serde_json::json!({
    "parachainInfo": {
        "parachainId": 2000
    }
}))
```

## Recommended Actions

### Required Actions
**None** - Moonbeam's current implementation is fully compatible with PR #8323.

### Optional Enhancements
If Moonbeam wants to leverage the new patching capabilities:

1. **Add Genesis Config Patches** (Optional):
   - Consider using `with_genesis_config_patch()` in lazy loading module
   - Enables dynamic para_id or other parameter configuration
   - Useful for testing different network configurations

2. **Expand Preset Support** (Optional):
   - Add more named presets beyond `DEV_RUNTIME_PRESET`
   - Examples: `STAGING_PRESET`, `PRODUCTION_PRESET`
   - Each preset could have different default configurations

3. **Reduce Native Runtime Dependencies** (Optional):
   - Evaluate if node CLI could avoid linking native runtime
   - Would reduce binary size and compilation dependencies
   - Currently Moonbeam uses feature flags: `moonbase-native`, `moonbeam-native`, `moonriver-native`

## Testing Recommendations

### Verification Tests
Run existing chain spec tests to verify compatibility:

```bash
# Build and test chain spec generation
cargo test -p moonbeam-service --lib chain_spec

# Verify lazy loading chain spec builds correctly
cargo test -p moonbeam-service lazy_loading
```

### Integration Tests
Verify chain initialization with presets:

```bash
# Test development chain with default preset
./target/release/moonbeam --dev --tmp

# Verify chain spec export works
./target/release/moonbeam build-spec --chain moonbase-dev > /tmp/spec.json
```

## Conclusion

**PR #8323 has NO breaking impact on Moonbeam.** The changes are fully backward compatible at the public API level. While the internal `GenesisBuildAction::NamedPreset` variant signature changed, Moonbeam doesn't directly interact with this internal structure.

The PR introduces useful new capabilities (JSON patching of genesis presets) that Moonbeam could optionally leverage in the future, but there's no requirement to adopt these features immediately.

## References

- **PR Link:** https://github.com/paritytech/polkadot-sdk/pull/8323
- **Related Issue:** https://github.com/paritytech/polkadot-sdk/issues/7748
- **Moonbeam Chain Specs:** `node/service/src/chain_spec/`
- **Moonbeam Genesis Presets:** `runtime/{moonbase,moonbeam,moonriver}/src/genesis_config_preset.rs`
- **Runtime APIs:** `runtime/common/src/apis.rs`
