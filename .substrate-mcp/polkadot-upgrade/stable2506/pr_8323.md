# PR #8323: Allow genesis-presets to be patched and remove native runtime calls from the staging-node-cli

**Impact**: INHERITED
**Confidence**: High
**Affected Components**: None

## Changes Detected

This PR introduces two main capabilities to `sc-chain-spec`:

1. **Genesis Preset Patching**: Adds ability to patch hardcoded genesis-presets with JSON values via a new `with_genesis_config_patch()` method
2. **Native Runtime Reduction**: Enables removing calls into native runtime from node code by making genesis configuration more flexible

### Technical Changes

The PR modifies `sc-chain-spec` to support:
- New `GenesisBuildAction` enum variants including `NamedPreset(String, json::Value, PhantomData<EHF>)`
- `with_genesis_config_patch()` method for applying JSON patches to genesis configurations
- More flexible runtime genesis configuration without requiring direct native runtime function calls

Modified crates:
- `sc-chain-spec` (patch bump)
- `polkadot-parachain-bin` (patch bump)

## Project Impact

**No action required for Moonbeam upgrade to stable2506.**

### Why No Impact

1. **Moonbeam's Current Chain Spec Usage**:
   - Moonbeam already uses `ChainSpec::builder()` pattern correctly in `/Users/manuelmauro/Workspace/moonbeam/node/service/src/chain_spec/moonbase.rs`, `/moonbeam.rs`, and `/moonriver.rs`
   - Genesis configuration uses `with_genesis_config()` with runtime-generated JSON from `testnet_genesis()` functions
   - No reliance on the patching mechanism introduced by this PR

2. **Genesis Builder API Already Implemented**:
   - All three runtimes (moonbase, moonbeam, moonriver) already implement the `GenesisBuilder` runtime API in `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/apis.rs` (lines 119-141)
   - Each runtime has its own `genesis_config_preset` module with `get_preset()` and `preset_names()` functions
   - The runtime-side implementation is complete and follows best practices

3. **No Native Runtime Dependency**:
   - Search for "native_runtime", "NativeElseWasmExecutor", and similar patterns found **no matches** in Moonbeam codebase
   - Moonbeam node does not rely on native runtime execution - it uses WASM-only execution
   - Chain specs are loaded from JSON files or built from runtime WASM, not native runtime calls

4. **Additive Feature**:
   - This PR adds optional patching capability to `sc-chain-spec`
   - Moonbeam's existing chain spec construction continues to work without modification
   - The changes are backward compatible with existing `ChainSpec::builder()` API

### Code Evidence

From `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/apis.rs`:
```rust
impl sp_genesis_builder::GenesisBuilder<Block> for Runtime {
    fn build_state(config: Vec<u8>) -> sp_genesis_builder::Result {
        frame_support::genesis_builder_helper::build_state::<RuntimeGenesisConfig>(config)
    }

    #[cfg(not(feature = "disable-genesis-builder"))]
    fn get_preset(id: &Option<sp_genesis_builder::PresetId>) -> Option<Vec<u8>> {
        frame_support::genesis_builder_helper::get_preset::<RuntimeGenesisConfig>(id, genesis_config_preset::get_preset)
    }

    #[cfg(not(feature = "disable-genesis-builder"))]
    fn preset_names() -> Vec<sp_genesis_builder::PresetId> {
        genesis_config_preset::preset_names()
    }
}
```

From `/Users/manuelmauro/Workspace/moonbeam/node/service/src/chain_spec/moonbase.rs` (lines 57-92):
```rust
ChainSpec::builder(
    WASM_BINARY.expect("WASM binary was not build, please build it!"),
    Extensions {
        relay_chain: "dev-service".into(),
        para_id: Default::default(),
    },
)
.with_name("Moonbase Development Testnet")
.with_id("moonbase_dev")
.with_chain_type(ChainType::Development)
.with_properties(/* ... */)
.with_genesis_config(testnet_genesis(/* runtime-generated JSON */))
.build()
```

## Evidence & References

### Grep Results
- **Native runtime patterns**: No matches for "native_runtime", "NativeElseWasmExecutor" in Moonbeam codebase
- **Genesis builder implementation**: Found in `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/apis.rs:125-140`
- **Genesis presets**: Implemented in:
  - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/genesis_config_preset.rs:270-285`
  - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/genesis_config_preset.rs:297-310`
  - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/genesis_config_preset.rs:302-315`

### Chain Spec Loading
From `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs:54-113`:
- Uses `ChainSpec::from_json_bytes()` for embedded production specs
- Uses `ChainSpec::from_json_file()` for custom specs
- Uses `ChainSpec::builder().with_genesis_config()` for development specs
- All approaches are compatible with the new patching capability

## Conclusion

This PR is an **internal enhancement** to `sc-chain-spec` that adds optional patching functionality. Moonbeam's chain specification architecture already follows the recommended patterns and will automatically benefit from the improved flexibility without requiring any code changes. The upgrade impact is **INHERITED** - the benefits come automatically through the dependency update.
