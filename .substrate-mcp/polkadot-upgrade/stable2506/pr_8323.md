# PR #8323 Impact Analysis: Genesis Presets Patching and Runtime Decoupling

**PR Title:** Allow genesis-presets to be patched and remove native runtime calls from the staging-node-cli

**GitHub PR:** https://github.com/paritytech/polkadot-sdk/pull/8323

**Release:** stable2506

**Affected Crates:**
- `sc-chain-spec` (patch bump)
- `polkadot-parachain-bin` (patch bump)

**Audience:** Node Dev

---

## Executive Summary

PR #8323 introduces the ability to patch hardcoded genesis presets with JSON values and removes native runtime dependencies from node code. This change directly affects Moonbeam's chain specification architecture by:

1. **Enabling dynamic genesis configuration** without recompilation
2. **Facilitating the removal of tight runtime coupling** in node code
3. **Providing flexibility for para_id and chain_id customization** via JSON patches

This is a **MEDIUM IMPACT** PR for Moonbeam that offers significant architectural improvements but requires no immediate breaking changes.

---

## Technical Context

### What the PR Does

The PR addresses issue #7748 by:

1. **Making all genesis build actions patchable** through a JSON overlay mechanism using `NamedPreset(String, json::Value, PhantomData)` pattern
2. **Removing native runtime imports** from staging-node-cli to avoid linking runtime code into the node binary
3. **Allowing para-ID values to be patchable** wherever they're configurable in chain specs

### Key Implementation Details

- Genesis presets now accept JSON patches that merge with preset configurations
- Node code can avoid direct runtime imports by duplicating necessary genesis functions locally
- The patching mechanism is backward-compatible - existing code continues to work

---

## Impact on Moonbeam Codebase

### 1. Current Runtime Coupling Issues

Moonbeam currently exhibits the EXACT pattern that PR #8323 addresses:

#### Evidence: Native Runtime Imports in Node Code

**File:** `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs`

```rust
#[cfg(feature = "moonbase-native")]
use moonbeam_service::moonbase_runtime;
#[cfg(feature = "moonbeam-native")]
use moonbeam_service::moonbeam_runtime;
#[cfg(feature = "moonriver-native")]
use moonbeam_service::moonriver_runtime;
```

**Count:** 28 direct native runtime calls found in command.rs, including:
- `moonbeam_service::moonriver_runtime::VERSION`
- `moonbeam_service::moonbeam_runtime::RuntimeApi`
- `moonbeam_service::moonbase_runtime::Block`

#### Evidence: Runtime Genesis Function Calls

**File:** `/Users/manuelmauro/Workspace/moonbeam/node/service/src/chain_spec/moonbase.rs`

```rust
use moonbase_runtime::{
    currency::UNIT, genesis_config_preset::testnet_genesis, AccountId, WASM_BINARY,
};

// Later in the code:
.with_genesis_config(testnet_genesis(
    // Alith is Sudo
    accounts[0],
    // Treasury Council members
    vec![accounts[1], accounts[2], accounts[3]],
    // ...
    Default::default(), // para_id
    1281,               // ChainId
))
```

This pattern is repeated in:
- `/Users/manuelmauro/Workspace/moonbeam/node/service/src/chain_spec/moonbase.rs` (lines 29, 73-91)
- `/Users/manuelmauro/Workspace/moonbeam/node/service/src/chain_spec/moonbeam.rs`
- `/Users/manuelmauro/Workspace/moonbeam/node/service/src/chain_spec/moonriver.rs`

#### Evidence: Optional Runtime Features in Cargo.toml

**File:** `/Users/manuelmauro/Workspace/moonbeam/node/service/Cargo.toml`

```toml
# Moonbeam runtimes
moonbase-runtime = { workspace = true, optional = true }
moonbeam-runtime = { workspace = true, optional = true }
moonriver-runtime = { workspace = true, optional = true }

[features]
default = [
    "moonbase-native",
    "moonbeam-native",
    "moonriver-native",
]

moonbase-native = ["moonbase-runtime"]
moonbeam-native = ["moonbeam-runtime"]
moonriver-native = ["moonriver-runtime"]
```

### 2. Hardcoded Values That Could Be Patched

Moonbeam has several hardcoded genesis values that could benefit from the new patching mechanism:

#### Para ID Values
```rust
// moonbase.rs line 61-62
Extensions {
    relay_chain: "dev-service".into(),
    para_id: Default::default(),  // Could be patched dynamically
}

// moonbase.rs line 155-156
para_id,  // Passed as parameter but could be JSON-patched instead
1280,     // ChainId - hardcoded
```

#### Chain ID Values
Found across all three chain spec files:
- Development: `1281` (moonbase.rs:90, moonbeam.rs:84, moonriver.rs:82)
- Local: `1280` (moonbase.rs:156, moonbeam.rs:148, moonriver.rs:146)

These values are currently hardcoded in function calls to `testnet_genesis()`.

### 3. Genesis Configuration Architecture

**Current Pattern:**
```
Node Code (chain_spec/*.rs)
    ‚Üì (imports & calls)
Runtime Code (genesis_config_preset.rs)
    ‚Üì (returns)
RuntimeGenesisConfig (JSON)
```

**Enabled by PR #8323:**
```
Node Code (chain_spec/*.rs)
    ‚Üì (references preset)
Genesis Preset (in runtime)
    ‚Üì (optionally merged with)
JSON Patch (external file)
    ‚Üì (produces)
Final Genesis Config
```

---

## Benefits for Moonbeam

### 1. Reduced Binary Size and Compilation Time

By removing native runtime dependencies from node code, Moonbeam could:
- Reduce node binary size (no need to link all three runtimes)
- Speed up compilation when only node code changes
- Enable building node binary without runtime features

### 2. Dynamic Network Configuration

The patching mechanism enables:
- **Para ID customization** without code changes or recompilation
- **Chain ID modification** for testing/deployment scenarios
- **Genesis account changes** via JSON overlays
- **Treasury/governance configuration** through patches

Example use case: Testing with different para IDs:
```json
{
  "para_id": 2004,
  "chain_id": 1287
}
```

### 3. Cleaner Architecture

Moonbeam could adopt the recommended pattern:
- Duplicate minimal genesis helper functions in node code (if needed)
- Reference genesis presets by name instead of calling runtime functions
- Apply JSON patches for environment-specific customization
- Eliminate feature flags like `moonbase-native`, `moonbeam-native`, `moonriver-native`

### 4. Improved Testnet Flexibility

Current situation:
```rust
// To change para_id or chain_id, you must:
// 1. Modify Rust code
// 2. Recompile
// 3. Rebuild binaries
```

After adopting PR #8323 patterns:
```bash
# Change configuration via JSON patch:
./moonbeam --chain moonbase-dev --genesis-patch custom-config.json
```

---

## Migration Considerations

### Breaking Changes

**None** - This PR is backward compatible. The changes are additive.

### Optional Adoption Strategy

Moonbeam can choose to:

#### Phase 1: Evaluate (Immediate)
- Test the new patching mechanism with development chains
- Document use cases where JSON patching would be beneficial

#### Phase 2: Selective Adoption (Short-term)
- Apply patching to development and local testnets first
- Keep production chain specs unchanged initially
- Reduce runtime imports in command.rs where possible

#### Phase 3: Full Refactor (Long-term)
- Refactor all chain specs to use preset references + patches
- Remove native runtime feature flags from node crates
- Migrate genesis configuration to preset-based architecture

### Implementation Recommendations

1. **Preserve Existing Patterns**: Current code continues to work - no forced migration

2. **Start with Dev Chains**: Test patching with `development_chain_spec()` first:
   ```rust
   // Instead of:
   .with_genesis_config(testnet_genesis(...))

   // Consider:
   .with_named_preset("development", None) // No patch
   // Or with custom patch:
   .with_named_preset("development", Some(custom_patch_json))
   ```

3. **Document Patch Format**: Create documentation for valid JSON patch structure for each network

4. **Maintain Backward Compatibility**: Keep existing genesis functions for production networks during transition

---

## Code Examples

### Current Moonbeam Pattern

```rust
// node/service/src/chain_spec/moonbase.rs
use moonbase_runtime::{
    genesis_config_preset::testnet_genesis, // Direct runtime import
};

pub fn development_chain_spec(/* ... */) -> ChainSpec {
    ChainSpec::builder(WASM_BINARY, /* ... */)
        .with_genesis_config(testnet_genesis(  // Direct function call
            accounts[0],
            vec![accounts[1], accounts[2], accounts[3]],
            // ... many parameters
            Default::default(), // para_id - hardcoded as Default
            1281,               // ChainId - hardcoded
        ))
        .build()
}
```

### Enabled Pattern (Post PR #8323)

```rust
// node/service/src/chain_spec/moonbase.rs
// No direct runtime import needed!

pub fn development_chain_spec(/* ... */) -> ChainSpec {
    let patch = serde_json::json!({
        "para_id": 1000,     // Customizable via JSON
        "chain_id": 1281,    // Customizable via JSON
        // Additional overrides as needed
    });

    ChainSpec::builder(WASM_BINARY, /* ... */)
        .with_named_preset(
            sp_genesis_builder::DEV_RUNTIME_PRESET,
            Some(patch)
        )
        .build()
}
```

---

## Runtime Configuration (Already Compliant)

Moonbeam's runtime already implements the preset infrastructure correctly:

**File:** `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/genesis_config_preset.rs`

```rust
use sp_genesis_builder::PresetId;

/// Provides the JSON representation of predefined genesis config for given `id`.
pub fn get_preset(id: &PresetId) -> Option<Vec<u8>> {
    let patch = match id.as_str() {
        sp_genesis_builder::DEV_RUNTIME_PRESET => development(),
        _ => return None,
    };
    Some(
        serde_json::to_string(&patch)
            .expect("serialization to json is expected to work. qed.")
            .into_bytes(),
    )
}

/// List of supported presets.
pub fn preset_names() -> Vec<PresetId> {
    vec![PresetId::from(sp_genesis_builder::DEV_RUNTIME_PRESET)]
}
```

This structure is ready for the patching mechanism - no runtime changes needed!

---

## Testing Requirements

### If Adopting the New Pattern

1. **Functional Testing**
   - Verify genesis state matches with and without patches
   - Test para_id and chain_id overrides
   - Validate JSON patch merge behavior

2. **Integration Testing**
   - Ensure moonwall tests work with patched genesis
   - Test chain synchronization with patched configurations
   - Verify precompile addresses remain consistent

3. **Regression Testing**
   - Confirm existing chain specs produce identical genesis
   - Validate backward compatibility with embedded JSON specs
   - Test all three runtimes (moonbase, moonbeam, moonriver)

### Test Commands

```bash
# Build without native runtime features (potential future optimization)
cargo build --release --no-default-features -p moonbeam-cli

# Test development chain with custom genesis
./target/release/moonbeam --dev --alice --genesis-patch test-config.json

# Integration tests should continue to pass
cd test
pnpm moonwall test dev_moonbase
```

---

## Security Considerations

### Low Risk

This PR is primarily an architectural improvement:

- **No consensus changes**: Genesis configuration method doesn't affect chain rules
- **Backward compatible**: Existing patterns remain valid
- **Opt-in adoption**: Moonbeam can adopt gradually

### Validation Points

When adopting patching:

1. **Validate patch structure**: Ensure JSON patches conform to expected schema
2. **Prevent injection**: Don't accept arbitrary patches from untrusted sources
3. **Genesis hash verification**: Confirm genesis hash matches expected value after patching
4. **Test extensively**: Verify patched genesis produces expected initial state

---

## Dependencies and Version Information

### Current Moonbeam Status

- **Current Branch:** `moonbeam-polkadot-stable2503`
- **sc-chain-spec version:** `43.0.0` (from stable2503)
- **Upgrade Target:** stable2506

### When Upgrading to stable2506

- Moonbeam will inherit the patching capabilities automatically
- `sc-chain-spec` will include the new `NamedPreset` variant
- No immediate code changes required - feature is opt-in

---

## Recommendations

### Priority: LOW-MEDIUM

This PR is **not urgent** for Moonbeam but offers **valuable architectural improvements**.

### Action Items

1. **Immediate (v0.48.x - current release)**
   - ‚úÖ Document this PR's impact for awareness
   - ‚è≥ Monitor community adoption patterns
   - ‚è≥ Plan potential use cases for Moonbeam

2. **Short-term (v0.49.x - post stable2506 upgrade)**
   - ‚è≥ Test patching mechanism with development chains
   - ‚è≥ Evaluate removing `moonbase-native` etc. features
   - ‚è≥ Create JSON patch examples for common scenarios

3. **Long-term (v0.50.x+)**
   - ‚è≥ Consider refactoring chain specs to use presets + patches
   - ‚è≥ Reduce runtime coupling in node code
   - ‚è≥ Optimize build times by eliminating unnecessary runtime linking

### Decision Points

1. **Keep current pattern for production**: Production networks (moonbeam, moonriver, moonbase-alpha) should continue using embedded JSON specs - they're proven and stable

2. **Adopt patching for development/testing**: Development and local chains could benefit from the flexibility of JSON patching

3. **Gradual migration**: No rush to refactor - the current approach works fine and is fully supported

---

## Conclusion

PR #8323 provides Moonbeam with valuable new capabilities for genesis configuration flexibility and node/runtime decoupling. While Moonbeam's current architecture exhibits the exact coupling patterns this PR addresses (28 native runtime calls in command.rs, direct runtime genesis function imports), the impact is **entirely optional** and **non-breaking**.

### Key Takeaways

- ‚úÖ **Current code continues to work** - no forced changes
- ‚úÖ **Runtime is already preset-compliant** - ready for patching
- ‚ö†Ô∏è **Node code has tight runtime coupling** - could be improved
- üí° **Patching enables flexibility** - especially useful for dev/test chains
- üéØ **Optional adoption** - can be implemented gradually per use case

### Impact Rating: MEDIUM (Optional Enhancement)

While this PR doesn't require immediate action, Moonbeam should evaluate adopting these patterns to improve architectural flexibility, reduce build times, and enable dynamic genesis configuration for development and testing scenarios.
