# PR #8327 Impact Analysis: Update to frame-metadata v22

## Summary

**Impact Level:** MEDIUM
**Action Required:** YES
**Breaking Changes:** YES

PR #8327 updates frame-metadata from v20 to v22, introducing the latest unstable V16 metadata format. This change removes support for deprecation attributes on outer Event/Error enums and introduces changes to the metadata structure that will require updates to Moonbeam's test suite and potentially TypeScript API generation.

## PR Overview

- **Title:** Update to the latest unstable V16 metadata
- **GitHub:** https://github.com/paritytech/polkadot-sdk/pull/8327
- **Merged:** April 30, 2025

### Key Changes

1. **frame-metadata version bump:** v20 ‚Üí v22 (MAJOR)
2. **Metadata format:** V14 ‚Üí V16
3. **Deprecation policy change:** Deprecation on outer Event/Error enums no longer supported
4. **Affected crates:**
   - `sp-metadata-ir` (major bump)
   - `frame-support` (major bump)
   - `frame-support-procedural` (major bump)
   - `sp-api-proc-macro` (major bump)

## Impact on Moonbeam

### 1. BREAKING: Metadata Version Dependency

**Location:** `/Users/manuelmauro/Workspace/moonbeam/Cargo.toml`

**Current State:**
```toml
frame-metadata = { version = "20.0.0", default-features = false, features = ["current"] }
```

**Impact:**
- Moonbeam currently uses frame-metadata v20.0.0
- PR #8327 bumps it to v22
- This is a 2-version jump with breaking changes
- **Action Required:** Update dependency to v22 when upgrading to stable2506

**Evidence:**
```
/Users/manuelmauro/Workspace/moonbeam/Cargo.toml:357:
frame-metadata = { version = "20.0.0", default-features = false, features = ["current"] }
```

### 2. BREAKING: Integration Tests Will Fail

**Affected Files:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/tests/integration_test.rs` (line 445)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/tests/integration_test.rs` (line 467)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/tests/integration_test.rs` (line 468)

**Current Code Pattern (all 3 runtimes):**
```rust
use frame_metadata::*;
let metadata = Runtime::metadata();
let metadata = match metadata.1 {
    RuntimeMetadata::V14(metadata) => metadata,
    _ => panic!("metadata has been bumped, test needs to be updated"),
};
```

**Impact:**
- All three runtimes have `verify_reserved_indices()` tests that explicitly expect V14 metadata
- When metadata version changes to V16, these tests will panic
- Tests verify that certain pallet indices remain reserved (e.g., BaseFee, Sudo)

**Action Required:**
1. Update pattern matching from `RuntimeMetadata::V14` to `RuntimeMetadata::V16`
2. Verify that V16 metadata structure maintains the same `pallets` field access pattern
3. Test all three runtimes: moonbase, moonriver, moonbeam

**Evidence:**
```rust
// moonbase/tests/integration_test.rs:443-446
let metadata = moonbase_runtime::Runtime::metadata();
let metadata = match metadata.1 {
    RuntimeMetadata::V14(metadata) => metadata,
    _ => panic!("metadata has been bumped, test needs to be updated"),
};
```

### 3. CONSIDERATION: TypeScript API Generation

**Affected Component:** TypeScript API bindings generation

**Location:** `/Users/manuelmauro/Workspace/moonbeam/typescript-api/`

**Current Tooling:**
```json
{
  "@polkadot/api": "16.4.8",
  "@polkadot/typegen": "16.4.8"
}
```

**Impact:**
- Moonbeam generates TypeScript API bindings from runtime metadata
- Scripts in `typescript-api/package.json` fetch metadata and generate types:
  - `load:meta` - Fetches metadata from running nodes
  - `generate:defs` - Generates TypeScript definitions from metadata
  - `generate:meta` - Generates chain-specific types from metadata
- The `@polkadot/typegen` library needs to support V16 metadata format

**Action Required:**
1. Verify `@polkadot/api` version 16.4.8 supports V16 metadata
2. Test TypeScript API generation after metadata upgrade
3. Potentially update `@polkadot/api` and `@polkadot/typegen` to latest versions if V16 support is missing
4. Re-generate all TypeScript bindings after runtime upgrade

**Evidence:**
```json
// typescript-api/package.json
"generate:meta:moonbase": "pnpm tsx node_modules/@polkadot/typegen/scripts/polkadot-types-from-chain.mjs --endpoint ./metadata-moonbase.json ..."
```

### 4. POSITIVE: No Deprecation on Outer Enums Used

**Analysis:** Moonbeam does NOT use deprecation attributes on outer Event/Error enums

**Evidence:**
- Searched all pallets for `#[deprecated]` + `pub enum Event` patterns
- Found deprecation only on:
  - Constants: `/Users/manuelmauro/Workspace/moonbeam/core-primitives/src/lib.rs:56` (relay key constant)
  - Enum variants: `/Users/manuelmauro/Workspace/moonbeam/pallets/parachain-staking/src/types.rs:1115` (DelegatorStatus::Leaving variant)
- All Event/Error enums follow standard FRAME patterns:
  ```rust
  #[pallet::event]
  #[pallet::generate_deposit(pub(crate) fn deposit_event)]
  pub enum Event<T: Config> { ... }
  ```

**Impact:** NONE - The breaking change regarding deprecation on outer enums does not affect Moonbeam

### 5. NEUTRAL: Metadata Hash Extension

**Affected Files:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs:1505`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs:1596`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs:1597`

**Current Usage:**
```rust
frame_metadata_hash_extension::CheckMetadataHash<Runtime>,
```

**Build Configuration:**
```rust
// runtime/*/build.rs
substrate_wasm_builder::WasmBuilder::init_with_defaults()
    .enable_metadata_hash("DEV", 18)  // or "MOVR", "GLMR"
    .build()
```

**Impact:**
- Moonbeam uses the metadata hash extension for all runtimes
- This extension depends on metadata format
- The extension should be compatible with V16 metadata as it's part of the same Polkadot SDK upgrade
- No code changes expected, but should verify metadata hash generation works correctly

**Action Required:**
1. Test that metadata hash generation works with V16 format
2. Verify no changes needed to `enable_metadata_hash()` calls
3. Test the `CheckMetadataHash` extension with V16 metadata

### 6. NEUTRAL: Runtime APIs and Interfaces

**Analysis:** Runtime APIs properly use versioning, not deprecation

**Evidence:**
- `/Users/manuelmauro/Workspace/moonbeam/primitives/rpc/txpool/src/lib.rs` - Uses `#[api_version(2)]` and `#[changed_in(2)]`
- `/Users/manuelmauro/Workspace/moonbeam/primitives/rpc/debug/src/lib.rs` - Uses `#[api_version(7)]` and `#[changed_in(n)]`
- `/Users/manuelmauro/Workspace/moonbeam/primitives/ext/src/lib.rs` - Uses `#[version(2)]` for runtime interface

**Impact:** NONE - Moonbeam follows best practices for API versioning

## Migration Checklist

### Required Changes

- [ ] **Update Cargo.toml:** Change `frame-metadata` version from 20.0.0 to 22.x.x
- [ ] **Fix moonbase integration tests:** Update `RuntimeMetadata::V14` ‚Üí `RuntimeMetadata::V16` in `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/tests/integration_test.rs:445`
- [ ] **Fix moonriver integration tests:** Update `RuntimeMetadata::V14` ‚Üí `RuntimeMetadata::V16` in `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/tests/integration_test.rs:467`
- [ ] **Fix moonbeam integration tests:** Update `RuntimeMetadata::V14` ‚Üí `RuntimeMetadata::V16` in `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/tests/integration_test.rs:468`

### Verification Steps

- [ ] **Run all runtime tests:** `cargo test -p moonbase-runtime -p moonriver-runtime -p moonbeam-runtime`
- [ ] **Verify metadata generation:** Check that `Runtime::metadata()` returns V16 format
- [ ] **Test metadata hash extension:** Verify `CheckMetadataHash` works with V16
- [ ] **Regenerate TypeScript APIs:**
  ```bash
  cd typescript-api
  pnpm load:meta:local  # or from live networks
  pnpm generate
  ```
- [ ] **Verify TypeScript API compilation:** `cd typescript-api && pnpm build`
- [ ] **Check for metadata-related compilation errors:** `cargo clippy --release`
- [ ] **Test integration tests:** `cd test && pnpm moonwall test dev_moonbase`

### Optional Enhancements

- [ ] **Update @polkadot/api dependencies:** Consider upgrading to latest version for V16 support
- [ ] **Document metadata version change:** Add to changelog/release notes
- [ ] **Review metadata-dependent tooling:** Check any custom scripts that parse metadata

## Risk Assessment

### Low Risk Areas
- ‚úÖ No deprecation on outer Event/Error enums (not used)
- ‚úÖ Runtime APIs use proper versioning (no impact)
- ‚úÖ Runtime interfaces use proper versioning (no impact)

### Medium Risk Areas
- ‚ö†Ô∏è Integration tests will fail (known issue, easy fix)
- ‚ö†Ô∏è TypeScript API generation compatibility (needs verification)
- ‚ö†Ô∏è Metadata hash extension compatibility (likely works, needs testing)

### Critical Items
- üî¥ **frame-metadata dependency update:** Required for compilation
- üî¥ **Integration test fixes:** Required for CI/CD to pass

## Compatibility Notes

### Polkadot SDK Integration
- This PR is part of the stable2506 release
- All affected crates (`frame-support`, `sp-api-proc-macro`, etc.) are core dependencies
- The metadata version bump is coordinated across all Polkadot SDK components
- External tools (like Polkadot.js, Subxt) will need V16 metadata support

### Client Compatibility
- RPC clients requesting metadata will receive V16 format
- Legacy clients expecting V14 may not be compatible
- The `metadata_at_version(version: u32)` API can provide backward compatibility
- Polkadot.js version 16.4.8 (used by Moonbeam) should be verified for V16 support

## References

### Files to Review
- `/Users/manuelmauro/Workspace/moonbeam/Cargo.toml` - Dependency update
- `/Users/manuelmauro/Workspace/moonbeam/runtime/*/tests/integration_test.rs` - Test updates
- `/Users/manuelmauro/Workspace/moonbeam/runtime/*/build.rs` - Metadata hash configuration
- `/Users/manuelmauro/Workspace/moonbeam/typescript-api/package.json` - TypeScript tooling

### Related Commits
- `f6b69a87b4` - Add support for metadata hash extension
- `4c307bbff8` - Improvements: fix typegen from metadata
- `a84f80abe9` - Update to polkadot-sdk stable2412

### External Resources
- PR #8327: https://github.com/paritytech/polkadot-sdk/pull/8327
- frame-metadata crate: https://crates.io/crates/frame-metadata
- Metadata V16 spec: Part of Polkadot SDK documentation

## Conclusion

PR #8327 has a **MEDIUM impact** on Moonbeam with **concrete breaking changes** that require attention:

1. **Immediate Action Required:**
   - Update `frame-metadata` dependency
   - Fix three integration test files
   - Verify TypeScript API generation

2. **Testing Critical:**
   - All runtime tests must pass
   - TypeScript API regeneration must succeed
   - Integration tests must verify metadata structure

3. **Low Risk to Runtime Logic:**
   - No changes to pallet behavior
   - No changes to extrinsics or events
   - Only metadata representation changes

The changes are straightforward to implement but must be done carefully to ensure all metadata-dependent tooling continues to work correctly.
