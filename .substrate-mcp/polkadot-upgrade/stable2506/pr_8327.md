# PR #8327 Impact Analysis: Update to frame-metadata 22

## Overview

**PR Title**: Update to the latest unstable V16 metadata
**PR Link**: https://github.com/paritytech/polkadot-sdk/pull/8327
**Audience**: Runtime Dev
**Status**: Merged

## Summary of Changes

This PR updates `frame-metadata` from version 20 to version 22, implementing the latest unstable V16 metadata format. The key change is the removal of support for deprecating entire `Call`, `Error`, and `Event` enums. Only variant-level deprecation is now supported.

### Key Technical Changes:
- Deprecation on entire enums is no longer allowed
- Only enum variants can be marked as deprecated
- Type renamed: `DeprecationStatusIR` → `ItemDeprecationInfoIR`
- New types introduced: `EnumDeprecationInfoIR`, `VariantDeprecationInfoIR`

### Rationale:
1. Full enum deprecation is rarely needed in practice
2. Call enums have no logical place for such warnings
3. Simpler client-side code generation with fewer edge cases
4. Eliminates confusing states where enum-level and variant-level deprecations conflicted

## Impact on Moonbeam

### Dependency Impact: LOW

**Current State:**
- Moonbeam uses `frame-metadata = "20.0.0"` (workspace dependency in `/Users/manuelmauro/Workspace/moonbeam/Cargo.toml`)
- All three runtimes (moonbase, moonbeam, moonriver) use this workspace dependency

**Required Action:**
- Version will be automatically updated to v22 when upgrading to stable2506
- No manual intervention required

### Code Impact: NONE

**Deprecation Usage Analysis:**

1. **No deprecated enums found** in moonbeam's custom pallets
   - Search across all `/pallets` directories found no enum-level deprecation attributes

2. **Existing deprecation usage (SAFE):**
   - `/Users/manuelmauro/Workspace/moonbeam/pallets/parachain-staking/src/types.rs:1115`
     ```rust
     pub enum DelegatorStatus {
         Active,
         #[deprecated(note = "must only be used for backwards compatibility reasons")]
         Leaving(RoundIndex),  // ✓ Variant-level deprecation (ALLOWED)
     }
     ```
   - `/Users/manuelmauro/Workspace/moonbeam/core-primitives/src/lib.rs:56`
     ```rust
     #[deprecated]
     pub const TIMESTAMP_NOW: &[u8] = ...;  // ✓ Constant (NOT AFFECTED)
     ```

### Test Impact: LOW

**Integration Tests Referencing Metadata:**

Three integration tests explicitly match on `RuntimeMetadata::V14`:

1. `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/tests/integration_test.rs:445`
2. `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/tests/integration_test.rs:467`
3. `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/tests/integration_test.rs:468`

**Example from moonbase:**
```rust
#[test]
fn verify_reserved_indices() {
    use frame_metadata::*;
    // ...
    let metadata = moonbase_runtime::Runtime::metadata();
    let metadata = match metadata.1 {
        RuntimeMetadata::V14(metadata) => metadata,  // May need update to V16
        _ => panic!("metadata has been bumped, test needs to be updated"),
    };
    // ...
}
```

**Note:** These tests may require updating if the runtime metadata version changes from V14 to V16 during the stable2506 upgrade. However, this depends on whether the runtime actually exposes V16 metadata or maintains V14 compatibility.

## Affected Crates

Per the PRDoc, the following substrate crates received major version bumps:
- `sp-metadata-ir` (major)
- `pallet-example-view-functions` (major)
- `frame-support` (major)
- `frame-support-procedural` (major)
- `frame-support-test` (major)
- `sp-api-proc-macro` (major)

These are all transitive dependencies for moonbeam through the polkadot-sdk workspace.

## Action Items

### Required Actions: NONE
- No code changes needed
- No deprecated enums to fix
- Existing variant-level deprecation is compliant

### Optional Actions for Testing:
1. **Monitor integration tests** during stable2506 upgrade
   - Watch for failures in `verify_reserved_indices` tests
   - If tests fail, update pattern match from `RuntimeMetadata::V14` to `RuntimeMetadata::V16`
2. **Verify metadata version** after upgrade
   - Check if runtime actually exposes V16 or maintains V14 compatibility

## Risk Assessment

**Overall Risk**: MINIMAL

- ✓ No breaking changes required in moonbeam codebase
- ✓ No deprecated enums to refactor
- ✓ Existing deprecation usage is compliant
- ⚠ Minor test updates may be needed (low effort)
- ✓ Cargo.toml version bumps handled automatically

## Recommendations

1. **No immediate action required** - this PR has no blocking impact on moonbeam
2. **Test monitoring**: During stable2506 upgrade, run integration tests and update metadata version matches if needed
3. **Documentation**: If metadata version changes to V16, update any internal documentation that references V14

## Additional Context

**Related PRs:**
- PR #8441: Follow-up PR that added missing crate references to release documentation

**Frame Metadata Version History:**
- v20: Used in current moonbeam (stable2503)
- v22: Introduced in this PR (stable2506)
- V14 → V16: Runtime metadata format progression

**Testing Verification:**
All moonbeam custom pallets were analyzed for deprecation usage:
- pallet-parachain-staking ✓
- pallet-crowdloan-rewards ✓
- pallet-proxy-genesis-companion ✓
- pallet-erc20-xcm-bridge ✓
- pallet-moonbeam-foreign-assets ✓
- pallet-moonbeam-orbiters ✓
- pallet-moonbeam-lazy-migrations ✓
- pallet-xcm-transactor ✓
- pallet-ethereum-xcm ✓
- pallet-xcm-weight-trader ✓
- pallet-precompile-benchmarks ✓
