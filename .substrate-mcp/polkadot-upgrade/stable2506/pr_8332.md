# PR #8332: Parachain Informant

**Status**: Merged
**PR**: https://github.com/paritytech/polkadot-sdk/pull/8332
**Audience**: Node Operator, Node Dev

## Summary

Adds a "parachain informant" component that provides enhanced logging and metrics for monitoring parachain block production and finalization. The informant automatically tracks the relationship between relay chain blocks and parachain blocks, exposing valuable operational metrics and structured logs.

## Changes

### New Features

1. **Parachain Informant Component**
   - Monitors backed and included block status at relay chain heights
   - Automatically spawned during relay chain task initialization
   - Provides concise status logging: "Parachain status changed at #relay_num (0xrelay_block): backed #x (0xbacked) included #y (0xincluded)"

2. **New Metrics**
   - `parachain_block_authorship_duration`: Tracks time taken for block authoring
   - `parachain_unincluded_segment_size`: Number of backed but not yet included blocks

3. **New Crate: cumulus-relay-chain-streams**
   - Provides reusable relay chain stream transformations
   - Handles stream separations for backed and finalized blocks
   - Extracted common stream handling logic for better code organization

### Crate Changes

- `cumulus-client-service`: **MAJOR** bump
- `cumulus-relay-chain-interface`: **MAJOR** bump
- `cumulus-client-consensus-common`: minor bump
- `cumulus-client-pov-recovery`: minor bump
- `cumulus-relay-chain-inprocess-interface`: minor bump
- `cumulus-relay-chain-rpc-interface`: minor bump
- `cumulus-relay-chain-streams`: new crate

### API Changes

1. **RelayChainInterface Trait** (explains MAJOR bump)
   - Added new method: `async fn candidate_events(&self, _: PHash) -> RelayChainResult<Vec<CandidateEvent>>`
   - Used internally by the informant to track candidate events

2. **Stream Functions Moved** (explains MAJOR bump)
   - `new_best_heads`, `finalized_heads`, `pending_candidates` moved to `cumulus-relay-chain-streams` crate
   - Refactoring for better code organization and reusability

## Impact on Moonbeam

### Code Changes Required

**NONE** - The parachain informant is automatically instantiated by `cumulus-client-service::start_relay_chain_tasks`, which Moonbeam already calls.

**Evidence**:
- Moonbeam uses `cumulus-client-service::start_relay_chain_tasks` at `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:934`
- Moonbeam does NOT implement `RelayChainInterface` directly - uses provided implementations
- Moonbeam does NOT use the moved stream functions (`new_best_heads`, `finalized_heads`, `pending_candidates`)

The MAJOR version bumps are due to:
1. New trait method (not breaking for consumers who don't implement the trait)
2. Function relocations (not breaking for code that doesn't use these internal functions)

Since Moonbeam only consumes the public APIs and doesn't implement these traits or use the moved functions, no code changes are required.

### New Capabilities Available

#### For Node Operators

**New Prometheus Metrics**:
```
# Block authoring duration tracking
parachain_block_authorship_duration

# Unincluded segment size (backed but not included blocks)
parachain_unincluded_segment_size
```

**New Log Messages**:
```
Parachain status changed at #<relay_block_num> (0x<relay_block_hash>):
  backed #<backed_num> (0x<backed_hash>)
  included #<included_num> (0x<included_hash>)
```

These logs appear when:
- Backed block changes at a relay chain height
- Included block changes at a relay chain height
- Both backed and included blocks change

#### For Monitoring & Operations

1. **Block Production Health**
   - Monitor `parachain_block_authorship_duration` to detect slow block production
   - Alert on abnormal authoring times
   - Track authoring performance over time

2. **Inclusion Monitoring**
   - Track `parachain_unincluded_segment_size` to monitor relay chain inclusion lag
   - High values indicate blocks are being authored but not included quickly
   - Useful for detecting relay chain congestion or parachain issues

3. **Status Visibility**
   - Structured logs provide clear visibility into parachain progression
   - Easier to correlate parachain blocks with relay chain blocks
   - Helpful for debugging inclusion delays or fork scenarios

### Testing Recommendations

1. **Verify Metrics Availability**
   ```bash
   # Check that new metrics are exposed
   curl http://localhost:9615/metrics | grep parachain_block_authorship_duration
   curl http://localhost:9615/metrics | grep parachain_unincluded_segment_size
   ```

2. **Verify Log Output**
   - Start a collator node and observe logs for "Parachain status changed" messages
   - Verify logs include relay block number, hash, backed/included block info

3. **Monitor Metric Values**
   - `parachain_block_authorship_duration`: Should be well under relay chain slot duration (6s)
   - `parachain_unincluded_segment_size`: Typically 0-2 under normal conditions

### Documentation Updates Needed

- Add new metrics to node operator monitoring documentation
- Document expected ranges for `parachain_block_authorship_duration` and `parachain_unincluded_segment_size`
- Update alerting/monitoring setup guides to include these metrics

### Migration Notes

- No migration required
- No runtime changes
- No database changes
- Functionality is automatically enabled upon upgrade

## Risk Assessment

**Risk Level**: LOW

**Rationale**:
- Purely additive feature (logging and metrics)
- No changes to consensus logic
- No changes to block production
- No runtime impact
- Automatically integrated through existing `start_relay_chain_tasks` call
- Breaking API changes don't affect Moonbeam's usage patterns

**Potential Issues**:
- Minimal performance overhead from metric collection (negligible)
- Additional log volume (can be filtered if needed)

## Recommendations

### For Development Team

1. **No Action Required** - Code is automatically compatible
2. **Optional**: Add monitoring dashboards for new metrics
3. **Optional**: Configure log filtering if verbose informant logs are unwanted

### For Operations Team

1. **Update Monitoring**:
   - Add `parachain_block_authorship_duration` to Grafana dashboards
   - Add `parachain_unincluded_segment_size` to Grafana dashboards
   - Create alerts for abnormal values

2. **Recommended Alerts**:
   ```yaml
   # Example alert thresholds
   - alert: SlowBlockAuthoring
     expr: parachain_block_authorship_duration > 3000  # 3 seconds

   - alert: HighUnincludedSegment
     expr: parachain_unincluded_segment_size > 5
   ```

3. **Log Management**:
   - Informant logs are INFO level by default
   - Filter with `--log cumulus_relay_chain_streams=warn` if too verbose

### For QA Team

**Test Cases**:
1. Verify collator node starts without errors
2. Verify new metrics appear in Prometheus endpoint
3. Verify log messages appear during block production
4. Verify metric values are reasonable during normal operation
5. Stress test: Verify metrics during high transaction load

## Conclusion

PR #8332 is a low-impact observability enhancement that provides valuable operational insights with zero code changes required. The new metrics and logs will help monitor parachain health, block production performance, and relay chain inclusion status.

**Action Items**:
- [ ] Update monitoring dashboards to include new metrics
- [ ] Configure alerts for abnormal metric values
- [ ] Update node operator documentation
- [ ] Test metric availability in staging environment
- [ ] Verify log output format meets operational needs

**Dependencies**: None
**Blockers**: None
**Follow-up**: Consider creating Grafana dashboard templates that include these metrics
