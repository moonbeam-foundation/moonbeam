# PR #8344: XCMP Weight Metering - Account for MQ Page Position

## Overview
- **PR**: https://github.com/paritytech/polkadot-sdk/pull/8344
- **Title**: XCMP weight metering: account for the MQ page position
- **Labels**: T6-XCM, R0-no-crate-publish-required
- **Status**: Merged (May 21, 2025)
- **Audience**: Runtime Dev
- **Related PRs**: Follow-up to PR #8021 (XCMP Batching), addresses issue #8308

## Summary
This PR refines the XCMP weight metering improvements introduced in PR #8021 by accounting for message queue (MQ) page position during weight calculations. Previously, weight calculations didn't account for the position within a page where messages are inserted, leading to inaccurate weight metering when messages aren't added at the beginning of a page. This PR introduces position-aware weight calculations to improve accuracy.

## Key Changes

### 1. Crate Version Bumps
- `cumulus-pallet-xcmp-queue`: **major** (breaking changes to weight calculation API)
- `pallet-message-queue`: **patch** (internal improvements)
- `frame-support`: **major** (trait changes)
- Various runtime crates: **patch** (weight file regeneration)

### 2. Weight Calculation Improvements

#### Previous Approach
Weight calculated from three parameters:
- `new_pages_count`: Number of new pages created
- `message_count`: Number of messages enqueued
- `size_in_bytes`: Total size of messages

**Problem**: Didn't account for overhead of decoding/re-encoding existing page content when inserting messages at non-zero positions.

#### New Approach
Introduces `BatchFootprint` struct with additional `first_page_pos` parameter:
- Tracks position within the first page where messages will be inserted
- Accounts for position-based overhead when messages aren't added at page beginning
- More accurate weight metering prevents under-estimation of actual costs

### 3. New Benchmark Function

**Added**: `enqueue_empty_xcmp_message_at()`
- Measures cost of page decoding/re-encoding when inserting messages at variable positions
- Parameterized by page position to capture overhead accurately
- Complements existing `enqueue_n_bytes_xcmp_message()` and `enqueue_2_empty_xcmp_messages()` benchmarks

### 4. Weight Accuracy Testing

**Previous**: Feature-gated standard library check (only in `std` mode)

**New**: Runtime integrity test using relative error margin
- Uses `approx::assert_relative_eq!` macro with ~15% tolerance
- Validates weight calculation accuracy at runtime
- Works in both `std` and `no_std` environments

**Dependencies Added**:
- `approx` crate for weight accuracy testing
- `approx/std` feature flag

### 5. Type System Changes

**QueueFootprintQuery Trait**:
- `query_messages()` return type changed from `Vec<BatchFootprint>` to `BatchesFootprints`
- New `BatchesFootprints` collection type includes built-in position tracking
- Provides better ergonomics for position-aware weight calculations

### 6. Updated Weight Files
All parachain runtime weight files regenerated on 2025-05-05 with:
- Adjusted benchmarking parameters
- More accurate position-based overhead calculations
- Reflects actual costs of XCMP message enqueueing

## Impact on Moonbeam

### Direct Usage Analysis

#### 1. XcmpQueue Pallet Configuration
**Location**: All three runtimes (moonbase, moonriver, moonbeam)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/{moonbase,moonriver,moonbeam}/src/xcm_config.rs`

**Current Configuration**:
```rust
impl cumulus_pallet_xcmp_queue::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type ChannelInfo = ParachainSystem;
    type VersionWrapper = PolkadotXcm;
    type XcmpQueue = TransformOrigin<MessageQueue, AggregateMessageOrigin, ParaId, ParaIdToSibling>;
    type MaxInboundSuspended = sp_core::ConstU32<1_000>;
    type ControllerOrigin = EnsureRoot<AccountId>;
    type ControllerOriginConverter = XcmOriginToTransactDispatchOrigin;
    type WeightInfo = moonbase_weights::cumulus_pallet_xcmp_queue::WeightInfo<Runtime>;
    type PriceForSiblingDelivery = polkadot_runtime_common::xcm_sender::NoPriceForMessageDelivery<ParaId>;
    type MaxActiveOutboundChannels = ConstU32<128>;
    type MaxPageSize = MessageQueueHeapSize;
}
```

**Impact**: Standard pallet configuration - NO CHANGES REQUIRED to Config implementation. The pallet handles position tracking internally.

#### 2. MessageQueue Pallet Configuration
**Location**: All three runtimes
- `/Users/manuelmauro/Workspace/moonbeam/runtime/{moonbase,moonriver,moonbeam}/src/xcm_config.rs`

**Impact**: NO CHANGES REQUIRED. Internal improvements to position tracking don't affect the configuration API.

#### 3. Custom Code Review

**Search Results**:
- No usage of `BatchFootprint` type
- No usage of `first_page_pos` parameter
- No direct usage of `QueueFootprintQuery` trait (only referenced in PR #8021 analysis)

**Bridge Implementation** (`/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/bridge.rs`):
- Uses `EnqueueMessage` trait (unchanged)
- Uses `Pallet::<Runtime>::footprint()` method (unchanged)
- NO CHANGES REQUIRED

**Conclusion**: Moonbeam doesn't have custom implementations that interact with the internal weight calculation details. All usage is through high-level pallet APIs which remain backward compatible.

#### 4. Weight Files

**Current Status**:
- **Date**: 2025-09-02 (generated with stable2503)
- **Location**:
  - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/weights/cumulus_pallet_xcmp_queue.rs`
  - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/weights/cumulus_pallet_xcmp_queue.rs`
  - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/weights/cumulus_pallet_xcmp_queue.rs`
  - (Same for `pallet_message_queue.rs`)

**Current Benchmark Functions** (XcmpQueue):
- `set_config_with_u32()`
- `enqueue_n_bytes_xcmp_message(n: u32)`
- `enqueue_2_empty_xcmp_messages()`

**Expected New Benchmark Functions** (from PR #8344):
- `enqueue_empty_xcmp_message_at()` - NEW position-aware benchmark

**Impact**: Weight files are outdated and MUST be regenerated to include:
1. New `enqueue_empty_xcmp_message_at()` benchmark function
2. Updated weight calculations accounting for page position overhead
3. More accurate cost modeling for XCMP message enqueueing

## Comparison with PR #8021

| Aspect | PR #8021 (Batching) | PR #8344 (Position Metering) |
|--------|---------------------|------------------------------|
| **Focus** | Performance optimization through batching | Weight accuracy improvements |
| **Performance Impact** | ~75x speedup (10181us → 134us) | No performance change, better accounting |
| **Weight Changes** | Batch operations reduce per-message overhead | Position-based overhead increases accuracy |
| **New Benchmarks** | `enqueue_n_empty_xcmp_messages()`, `enqueue_n_full_pages()`, `enqueue_1000_small_xcmp_messages()` | `enqueue_empty_xcmp_message_at()` |
| **Breaking Changes** | Trait refactoring (`QueueFootprintQuery`) | Weight calculation API changes |
| **Risk Level** | Medium (performance characteristics changed) | Low (accuracy improvement) |

Both PRs require weight regeneration but for different reasons:
- PR #8021: New batch-oriented benchmarks
- PR #8344: Position-aware cost modeling

## Performance Implications

### Weight Accuracy
- **Before**: Weight calculations underestimated costs when inserting messages mid-page
- **After**: More accurate weight metering accounts for page position overhead
- **Effect**: Slightly higher weight estimates in some scenarios, preventing undercharging

### Block Weight Management
- More accurate weights improve block weight predictions
- Prevents potential block weight overruns from underestimated costs
- Better resource management for XCMP message processing

### Fee Calculation
- More accurate weights may result in slightly higher fees for some XCM operations
- Fees better reflect actual computational costs
- Improved fairness in resource pricing

## Required Actions

### MUST DO

1. **Regenerate Runtime Weights** ⚠️ CRITICAL
   - Weights MUST be regenerated for both `cumulus-pallet-xcmp-queue` and `pallet-message-queue`
   - New benchmark function `enqueue_empty_xcmp_message_at()` added
   - Weight calculations updated with position-aware overhead
   - **Command**:
     ```bash
     ./scripts/run-benches-for-runtime.sh moonbase release
     ./scripts/run-benches-for-runtime.sh moonriver release
     ./scripts/run-benches-for-runtime.sh moonbeam release
     ```
   - **Affected files**:
     - `runtime/moonbase/src/weights/cumulus_pallet_xcmp_queue.rs`
     - `runtime/moonbase/src/weights/pallet_message_queue.rs`
     - `runtime/moonriver/src/weights/cumulus_pallet_xcmp_queue.rs`
     - `runtime/moonriver/src/weights/pallet_message_queue.rs`
     - `runtime/moonbeam/src/weights/cumulus_pallet_xcmp_queue.rs`
     - `runtime/moonbeam/src/weights/pallet_message_queue.rs`

2. **Runtime Version Bump**
   - Bump `spec_version` in all affected runtimes (moonbase, moonriver, moonbeam)
   - Weight changes affect fee calculation and require version increment
   - Combined with PR #8021 changes if both applied simultaneously

### SHOULD DO

1. **Verify Benchmark Compilation**
   - Ensure new `enqueue_empty_xcmp_message_at()` benchmark compiles successfully
   - Verify all weight functions are generated correctly
   - Check for any compiler warnings related to weight calculations

2. **Compare Weight Differences**
   - Compare old vs new weight values to understand magnitude of changes
   - Document significant weight increases (if any)
   - Estimate impact on XCM transaction fees

### OPTIONAL

1. **Integration Testing**
   - Run existing XCM integration tests to ensure functionality unchanged
   - Test location: `/Users/manuelmauro/Workspace/moonbeam/test/suites/dev/moonbase/test-xcm-*`
   - Focus on message enqueueing scenarios

2. **Fee Impact Analysis**
   - Calculate fee differences for common XCM operations
   - Document any user-facing fee changes
   - Prepare communication if fees increase noticeably

3. **Update TypeScript API**
   - Regenerate TypeScript bindings if storage items changed: `pnpm build`
   - Files: `typescript-api/src/{moonbase,moonriver,moonbeam}/interfaces/`
   - Likely not needed as this is internal weight calculation change

## Testing Recommendations

### Existing Tests to Run

1. **XCM Integration Tests**:
   ```bash
   cd test
   pnpm moonwall test dev_moonbase
   ```
   Focus on: `test-xcm-v3/`, message enqueueing scenarios

2. **Rust Tests**:
   ```bash
   cargo test -p moonbase-runtime
   cargo test -p moonriver-runtime
   cargo test -p moonbeam-runtime
   ```

3. **Weight Benchmark Verification**:
   ```bash
   # Verify benchmarks compile and run
   cargo test --features runtime-benchmarks -p cumulus-pallet-xcmp-queue
   ```

### Validation Checks

1. **Weight File Completeness**:
   - Verify all benchmark functions from trait are implemented
   - Check for `enqueue_empty_xcmp_message_at()` in generated files
   - Ensure no missing weight functions

2. **Weight Sanity Checks**:
   - New weights should be >= old weights (more accurate, not less)
   - Position-aware costs should show variation based on page position
   - Verify weight values are reasonable (not astronomical)

## Risk Assessment

### Low Risk
- No configuration changes required
- No custom code affected
- Standard pallet usage pattern
- Internal implementation details changed, not public API
- Backward compatible for standard usage

### Medium Risk
- Weight calculations more accurate but potentially higher
- May result in slightly higher fees for some operations
- Weight regeneration critical for correct operation
- Outdated weights could lead to incorrect fee calculations

### Mitigation
- Regenerate weights immediately after upgrading
- Test on Moonbase Alpha testnet before mainnet deployment
- Monitor XCM transaction fees after deployment
- Compare before/after fee calculations for common operations
- Communicate any fee changes to users in advance

## Dependencies

This PR builds on PR #8021. Ensure both are considered together:
- PR #8021: Introduced batching and initial weight improvements
- PR #8344: Refines weight calculations with position awareness

Both require weight regeneration, so they can be handled together in a single weight update.

## Technical Details

### BatchFootprint Structure
```rust
pub struct BatchFootprint {
    pub new_pages_count: u32,
    pub message_count: u32,
    pub size_in_bytes: u32,
    pub first_page_pos: u32,  // NEW: Position in first page
}
```

### Weight Calculation Formula
```
weight = base_cost
       + (new_pages_count * page_creation_cost)
       + (message_count * per_message_cost)
       + (size_in_bytes * per_byte_cost)
       + (first_page_pos * position_overhead_cost)  // NEW
```

The `position_overhead_cost` accounts for decoding/re-encoding existing page content when inserting messages at non-zero positions.

### Accuracy Improvement
The PR includes runtime integrity tests with ~15% tolerance to validate weight accuracy. This ensures the calculated weights match actual execution costs within acceptable margins.

## Conclusion

**Impact Level**: MUST (Weight regeneration required)

**Summary**: This PR improves XCMP weight metering accuracy by accounting for message queue page position during weight calculations. While it doesn't introduce breaking configuration changes, it requires weight file regeneration to include the new position-aware benchmark and updated weight calculations. This is a follow-up to PR #8021 and should be handled as part of the same upgrade cycle.

**Key Points**:
- NO code changes required to runtime configuration
- NO custom implementations affected
- MUST regenerate weight files (critical)
- MUST bump runtime spec_version
- Weight calculations will be more accurate (potentially slightly higher)
- May result in marginally higher fees for some XCM operations
- Combined with PR #8021 for comprehensive XCMP improvements

**Recommendation**:
1. Regenerate all weight files for `cumulus-pallet-xcmp-queue` and `pallet-message-queue`
2. Bump runtime `spec_version` for all runtimes
3. Verify new weights are reasonable and complete
4. Test on Moonbase Alpha testnet
5. Monitor XCM transaction fees after deployment
6. Handle together with PR #8021 changes

**Migration Path**:
- Straightforward weight regeneration
- No configuration or code changes needed
- Low risk with proper testing
- Can be combined with PR #8021 weight updates

**Combined Effect with PR #8021**:
- Performance: ~75x speedup from batching
- Accuracy: Better weight metering with position awareness
- Result: Faster AND more accurate XCMP message processing
