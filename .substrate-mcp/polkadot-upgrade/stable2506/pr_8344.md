# PR #8344: XCMP Weight Metering - Account for MQ Page Position

## Overview

**PR Link:** https://github.com/paritytech/polkadot-sdk/pull/8344
**Labels:** T6-XCM, I9-optimisation
**Impact Level:** MEDIUM - Internal optimization with weight calculation improvements
**Related PRs:** Follows up on PR #8021 (XCMP batching)

This PR refines the XCMP weight metering introduced in PR #8021 by accounting for message queue page positioning during message enqueueing. This provides more accurate weight calculations when messages don't fit into the current message queue page and require starting a new page.

## What Changed

### Core Technical Changes

**1. BatchesFootprints Structure**

The PR introduces a new `BatchesFootprints` structure that tracks the cumulative footprint of message batches, enabling accurate weight calculation based on page position:

- **Before:** Weight calculations assumed uniform page consumption
- **After:** Tracks `batches_footprints[n]` containing the footprint of batch `xcms[0..n]`

This allows the system to determine the exact/approximate XCMP queue throughput for a parachain based on runtime queue configuration.

**2. New Benchmark: `enqueue_empty_xcmp_message_at`**

Added a benchmark to test message placement within existing pages, improving weight accuracy for:
- Messages that fit into the current page
- Messages that require starting a new page
- Cumulative weight calculations for batch operations

**3. Modified Files**

**Pallet Changes:**
- `cumulus/pallets/xcmp-queue/src/lib.rs` - Batch footprint logic refactored
- `cumulus/pallets/xcmp-queue/src/benchmarking.rs` - New benchmark added
- `cumulus/pallets/xcmp-queue/src/weights_ext.rs` - Updated weight extensions
- `cumulus/pallets/xcmp-queue/src/mock.rs` - Returns `BatchesFootprints` instead of `Vec<BatchFootprint>`

**Weight Updates:**
- Multiple system parachain weight files updated (Asset Hub, Bridge Hub, Collectives, Coretime, People)

## Impact on Moonbeam

### 1. Runtime Configuration (ALL RUNTIMES)

**Impact:** DIRECT - All three runtimes use affected pallets

**Affected Runtimes:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/xcm_config.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/xcm_config.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/xcm_config.rs`

#### XcmpQueue Configuration

All Moonbeam runtimes configure `cumulus_pallet_xcmp_queue` with message queue integration:

```rust
impl cumulus_pallet_xcmp_queue::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type ChannelInfo = ParachainSystem;
    type VersionWrapper = PolkadotXcm;
    type XcmpQueue = TransformOrigin<MessageQueue, AggregateMessageOrigin, ParaId, ParaIdToSibling>;
    type MaxInboundSuspended = sp_core::ConstU32<1_000>;
    type ControllerOrigin = EnsureRoot<AccountId>;
    type ControllerOriginConverter = XcmOriginToTransactDispatchOrigin;
    type WeightInfo = moonbase_weights::cumulus_pallet_xcmp_queue::WeightInfo<Runtime>;
    type PriceForSiblingDelivery = polkadot_runtime_common::xcm_sender::NoPriceForMessageDelivery<
        cumulus_primitives_core::ParaId,
    >;
    type MaxActiveOutboundChannels = ConstU32<128>;
    type MaxPageSize = MessageQueueHeapSize;  // ← 103 * 1024 bytes
}
```

**Key Configuration:**
- `MaxPageSize = MessageQueueHeapSize = 103 * 1024 = 105,472 bytes`
- This is larger than the typical HRMP channel max message size (102,400 bytes)
- The page size configuration directly affects weight calculations in this PR

**Evidence:**
- Moonbase: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/xcm_config.rs` (line 398)
- Moonriver: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/xcm_config.rs` (line 424)
- Moonbeam: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/xcm_config.rs` (line 416)

#### MessageQueue Configuration

```rust
parameter_types! {
    pub MessageQueueServiceWeight: Weight =
        Perbill::from_percent(25) * RuntimeBlockWeights::get().max_block;
    pub const MessageQueueMaxStale: u32 = 8;
    pub const MessageQueueHeapSize: u32 = 103 * 1024;  // 105,472 bytes
}

impl pallet_message_queue::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type MessageProcessor = pallet_ethereum_xcm::MessageProcessorWrapper<
        xcm_builder::ProcessXcmMessage<AggregateMessageOrigin, XcmExecutor, RuntimeCall>,
    >;
    type Size = u32;
    type HeapSize = MessageQueueHeapSize;
    type MaxStale = MessageQueueMaxStale;
    type ServiceWeight = MessageQueueServiceWeight;
    type QueueChangeHandler = NarrowOriginToSibling<XcmpQueue>;
    type QueuePausedQuery = EmergencyParaXcm;
    type WeightInfo = moonbase_weights::pallet_message_queue::WeightInfo<Runtime>;
    type IdleMaxServiceWeight = MessageQueueServiceWeight;
}
```

**Impact of This PR:**
- More accurate weight metering when messages approach the `HeapSize` limit
- Better weight estimation for batched message operations (from PR #8021)
- Improved throughput calculation (estimated ~20,000 small messages per block)

### 2. Dependencies (ALL RUNTIMES)

**Affected Crates:**
```toml
cumulus-pallet-xcmp-queue = { workspace = true }  # MAJOR bump
pallet-message-queue = { workspace = true }       # PATCH bump
frame-support = { workspace = true }              # MAJOR bump
```

**Dependency Files:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/Cargo.toml` (line 157)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/Cargo.toml` (line 175)
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/Cargo.toml` (line 174)

### 3. Congestion Management (Runtime Common)

**Impact:** DIRECT - Uses `footprint()` method for congestion detection

**Affected File:** `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/bridge.rs`

```rust
pub struct CongestionManager<Runtime>(PhantomData<Runtime>);
impl<Runtime: pallet_message_queue::Config> pallet_xcm_bridge::LocalXcmChannelManager
    for CongestionManager<Runtime>
where
    <Runtime as pallet_message_queue::Config>::MessageProcessor:
        ProcessMessage<Origin = AggregateMessageOrigin>,
{
    type Error = SendError;

    fn is_congested(_with: &Location) -> bool {
        let book_state =
            pallet_message_queue::Pallet::<Runtime>::footprint(AggregateMessageOrigin::Here);

        book_state.ready_pages >= MESSAGE_QUEUE_CONGESTION_THRESHOLD  // 32 pages
    }
    // ...
}
```

**Evidence:** Line 128 in `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/bridge.rs`

**Important:** The `footprint()` method is called directly on the pallet, not through a trait. According to PR #8021 analysis, the trait refactoring (moving `footprint()` to `QueueFootprintQuery` trait) **does not affect this usage pattern** since it's a pallet method call.

**Congestion Threshold:**
- `MESSAGE_QUEUE_CONGESTION_THRESHOLD = 32 ready pages`
- With improved weight metering, this threshold becomes more accurate
- Better page position awareness means more predictable congestion detection

### 4. Runtime Weights (Benchmarking)

**Impact:** MEDIUM - Weights need re-benchmarking for accurate values

**Affected Weight Files:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/weights/cumulus_pallet_xcmp_queue.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/weights/cumulus_pallet_xcmp_queue.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/weights/cumulus_pallet_xcmp_queue.rs`

**Current Benchmark Information (Moonbase):**
```rust
//! DATE: 2025-09-02, STEPS: `50`, REPEAT: `20`
//! HOSTNAME: `ip-10-0-0-198`, CPU: `Intel(R) Xeon(R) Platinum 8375C CPU @ 2.90GHz`

/// The range of component `n` is `[1, 105467]`.
fn enqueue_n_bytes_xcmp_message(n: u32, ) -> Weight {
    // Proof Size summary in bytes:
    //  Measured:  `148`
    //  Estimated: `5487`
    // Minimum execution time: 12_823_000 picoseconds.
    Weight::from_parts(9_221_745, 5487)
        // Standard Error: 5
        .saturating_add(Weight::from_parts(920, 0).saturating_mul(n.into()))
        .saturating_add(T::DbWeight::get().reads(4_u64))
        .saturating_add(T::DbWeight::get().writes(3_u64))
}
```

**Expected Changes:**
- New benchmark: `enqueue_empty_xcmp_message_at` will appear
- Existing benchmarks may have slightly different values due to improved page position accounting
- Weight calculations will be more granular based on message position within pages

**Action Required:** Re-run benchmarks after upgrade to capture improved weight characteristics.

### 5. XCM Mock Test Runtimes

**Impact:** LOW - Test infrastructure uses same configuration

**Affected Files:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/tests/xcm_mock/relay_chain.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/tests/xcm_mock/relay_chain.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/tests/xcm_mock/relay_chain.rs`

**Configuration in Mock:**
```rust
parameter_types! {
    pub const MessageQueueHeapSize: u32 = 65_536;  // Smaller for testing
    pub const MessageQueueMaxStale: u32 = 16;
}
```

**Impact:** Mock runtimes use a smaller heap size (64KB vs 103KB) but will benefit from the same improved weight accuracy.

## Breaking Changes

### API Changes

**Frame Support (MAJOR bump):**
- While frame-support has a MAJOR bump from PR #8021, this PR (#8344) is a PATCH-level change
- No new trait methods added
- Internal implementation improvements only

**Cumulus XcmpQueue (MAJOR bump):**
- MAJOR bump is from PR #8021 (batching)
- This PR adds refinements to weight calculation
- No configuration changes required
- `BatchesFootprints` structure is internal to the pallet

**Pallet Message Queue (PATCH bump):**
- PATCH bump indicates no breaking changes
- `footprint()` method remains unchanged on the pallet
- Internal optimizations only

### Migration Requirements

**For Moonbeam:**

✅ **No code changes required**
- All usage patterns are compatible
- `footprint()` method call in bridge.rs is unaffected
- Configuration parameters remain the same

⚠️ **Weight updates required**
- Re-run benchmarks to capture improved weight calculations
- Update weight files for all three runtimes

✅ **Testing recommended**
- Verify XCM message processing under various load scenarios
- Test congestion detection with improved page position awareness

## Benefits for Moonbeam

### 1. More Accurate Weight Metering

**Direct Benefits:**
- **Precise weight calculations** based on actual message queue page position
- **Better throughput estimation** (~20,000 small messages per block)
- **Improved weight budgeting** for complex XCM operations

**Technical Improvement:**
The system can now distinguish between:
- Messages fitting into the current page (lower weight)
- Messages requiring a new page (higher weight)
- Cumulative weight for batched operations

### 2. Enhanced Congestion Management

**File:** `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/bridge.rs` (line 128)

**Improvements:**
- More accurate `footprint()` calculations
- Better congestion threshold detection (32 ready pages)
- Improved bridge pause/resume decisions
- More reliable cross-chain messaging during high load

**Current Configuration:**
```rust
const MESSAGE_QUEUE_CONGESTION_THRESHOLD: u32 = 32;
```

With page position awareness, this threshold becomes more predictable and accurate.

### 3. Optimized Resource Utilization

**Block Space Efficiency:**
- More accurate weights mean better block space utilization
- Reduced over-estimation of weight consumption
- More transactions can fit in a block with precise weight accounting

**Use Cases:**
- High-volume XCM asset transfers
- Batch operations via XCMP
- Cross-chain DeFi protocols
- Bridge message processing

### 4. Compatibility with PR #8021 Batching

This PR enhances the 75x batching performance improvement from PR #8021 by:
- Adding accurate weight calculations for batched messages
- Accounting for page boundaries in batch operations
- Enabling throughput prediction for runtime configuration

### 5. Improved Developer Experience

**Throughput Calculation:**
Developers can now determine the exact/approximate XCMP queue throughput based on:
- Runtime's `MessageQueueHeapSize` (103 * 1024 bytes for Moonbeam)
- Message sizes and patterns
- Page position effects

**Example for Moonbeam:**
- Page size: 103KB
- With improved metering, can estimate: ~20,000 small messages per block
- Better capacity planning for XCM-heavy applications

## Risk Assessment

### Low Risk Areas

1. **No Configuration Changes:** All existing runtime configurations remain valid
2. **No Code Changes Required:** Moonbeam's usage patterns are fully compatible
3. **Internal Optimization:** Changes are internal to cumulus-pallet-xcmp-queue
4. **Patch-level Change:** pallet-message-queue only has patch-level updates

### Medium Risk Areas

1. **Weight Accuracy:**
   - **Risk:** Outdated weights may not reflect improved calculations
   - **Mitigation:** Re-run benchmarks for all three runtimes
   - **Validation:** Compare old vs new weight values for reasonableness

2. **Congestion Detection:**
   - **Risk:** More accurate footprint calculations might change congestion behavior
   - **Mitigation:** Monitor congestion events after upgrade
   - **Validation:** Test bridge functionality under various load conditions

### Testing Recommendations

**Pre-Upgrade Testing:**

```bash
# 1. Run Rust unit tests
cargo test -p moonbeam-runtime
cargo test -p moonriver-runtime
cargo test -p moonbase-runtime

# 2. Run XCM integration tests
cd test
pnpm moonwall test dev_moonbase
pnpm moonwall test smoke_moonbase

# 3. Re-run benchmarks
./scripts/run-benches-for-runtime.sh moonbase release
./scripts/run-benches-for-runtime.sh moonriver release
./scripts/run-benches-for-runtime.sh moonbeam release
```

**Post-Upgrade Validation:**

1. Deploy to Moonbase Alpha (testnet) first
2. Monitor metrics:
   - XCMP message processing times
   - MessageQueue page statistics
   - Congestion event frequency
3. Test scenarios:
   - High-volume XCM transfers
   - Large message enqueueing
   - Bridge operations under load
   - Multiple concurrent XCMP channels

**Focus Areas:**
- Message queue page transitions
- Congestion threshold behavior
- Weight consumption patterns
- Bridge pause/resume logic

## Recommended Actions

### Immediate (During Upgrade)

1. ✅ **Update dependencies** - Handled via workspace dependencies
   - `cumulus-pallet-xcmp-queue` (MAJOR bump)
   - `pallet-message-queue` (PATCH bump)
   - `frame-support` (MAJOR bump from PR #8021)

2. ⚠️ **Re-run benchmarks** - REQUIRED for accurate weight values
   ```bash
   ./scripts/run-benches-for-runtime.sh moonbase release
   ./scripts/run-benches-for-runtime.sh moonriver release
   ./scripts/run-benches-for-runtime.sh moonbeam release
   ```

3. ✅ **Run test suite** - Verify all tests pass
   ```bash
   cargo test -p moonbeam-runtime
   cargo test -p moonriver-runtime
   cargo test -p moonbase-runtime
   cd test && pnpm moonwall test dev_moonbase
   ```

### Post-Upgrade (After Deployment)

1. 📊 **Monitor Performance Metrics:**
   - XCMP message throughput
   - MessageQueue page utilization
   - Congestion detection frequency
   - Block weight consumption patterns

2. 📈 **Validate Improvements:**
   - Compare weight consumption before/after
   - Verify throughput calculations are accurate
   - Monitor bridge congestion management
   - Track XCM operation latency

3. 🔍 **Functional Validation:**
   - Cross-chain asset transfers
   - Foreign asset operations
   - XCM transactor precompile
   - Bridge message processing
   - Emergency XCM pause/resume

### Documentation Updates

1. Update runtime release notes with weight metering improvements
2. Document new throughput estimation capabilities
3. Update benchmark results in documentation
4. Communicate improvements to ecosystem developers

## Related PR Context

This PR is a refinement of **PR #8021: XCMP Batching**, which delivered:
- 75x performance improvement for message enqueueing
- Batch processing for XCMP messages
- `EnqueueMessage` trait refactoring

**Combined Benefits:**
- PR #8021: 75x faster batching
- PR #8344: Accurate weight metering for batched operations
- Result: High-performance XCMP with precise weight accounting

## Conclusion

**Overall Impact: POSITIVE - MEDIUM VALUE**

PR #8344 provides more accurate XCMP weight metering by accounting for message queue page position. This refinement enhances the 75x performance improvement from PR #8021 with precise weight calculations.

**Key Takeaways:**

✅ **No code changes required** - All Moonbeam usage patterns are compatible
⚠️ **Benchmarks must be re-run** - Required to capture improved weight values
✅ **More accurate weights** - Better page position awareness
✅ **Improved congestion detection** - More reliable footprint calculations
✅ **Better throughput estimation** - Can calculate ~20,000 messages per block capacity
✅ **Enhances PR #8021 benefits** - Complements batching with accurate metering
✅ **Low risk** - Internal optimization with no breaking changes

**Affected Components:**

| Component | Impact | Action Required |
|-----------|--------|-----------------|
| XcmpQueue Config | DIRECT | None - automatic |
| MessageQueue Config | DIRECT | None - automatic |
| CongestionManager | DIRECT | None - compatible |
| Runtime Weights | MEDIUM | Re-run benchmarks |
| Dependencies | LOW | Cargo update |
| Tests | LOW | Verify pass |

**Priority Level: MEDIUM** - The improvements are valuable for accurate weight accounting, and the risks are minimal with proper benchmarking and testing. The change is internal and doesn't require code modifications, making it a safe optimization to adopt.

**Deployment Strategy:**
1. Update dependencies
2. Re-run benchmarks
3. Test on Moonbase Alpha
4. Monitor performance metrics
5. Deploy to Moonriver and Moonbeam
