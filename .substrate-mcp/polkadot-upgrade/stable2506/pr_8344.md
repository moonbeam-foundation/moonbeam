# PR #8344: XCMP weight metering: account for the MQ page position

**Impact**: INHERITED
**Confidence**: High
**Affected Components**:
- `cumulus-pallet-xcmp-queue`
- Weight benchmarks for XCMP queue operations
- All three runtimes (moonbase, moonbeam, moonriver)

## Changes Detected

This PR introduces improvements to XCMP weight metering by accounting for message queue (MQ) page position during message processing. The changes affect how weights are calculated when messages span multiple pages in the message queue.

### Key Technical Changes:

1. **New benchmark functions added** to `cumulus_pallet_xcmp_queue::WeightInfo`:
   - `enqueue_n_empty_xcmp_messages(n: u32)` - replaces `enqueue_2_empty_xcmp_messages()`
   - `enqueue_empty_xcmp_message_at(n: u32)` - new function for accounting page position
   - `enqueue_n_full_pages(n: u32)` - new function for multiple page scenarios
   - `enqueue_1000_small_xcmp_messages()` - new benchmark for small messages

2. **Weight calculation improvements**:
   - More accurate weight accounting based on message position within pages
   - Variable weight calculations based on the number of messages/pages
   - Better handling of edge cases when messages span page boundaries

3. **Crate versions**:
   - `cumulus-pallet-xcmp-queue`: **major** bump
   - `pallet-message-queue`: **patch** bump
   - `frame-support`: **major** bump

## Project Impact

**INHERITED** - The changes are automatically inherited through the Polkadot SDK upgrade. The weight calculation improvements in `cumulus-pallet-xcmp-queue` are internal to the pallet implementation and do not require code changes in Moonbeam.

### Action Required:

**Weight benchmarks have already been regenerated** (as evidenced by the modified files in git status):
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/weights/cumulus_pallet_xcmp_queue.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/weights/cumulus_pallet_xcmp_queue.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/weights/cumulus_pallet_xcmp_queue.rs`

The new benchmark functions are properly implemented with the following signatures:
```rust
fn enqueue_n_empty_xcmp_messages(n: u32) -> Weight
fn enqueue_empty_xcmp_message_at(n: u32) -> Weight
fn enqueue_n_full_pages(n: u32) -> Weight
fn enqueue_1000_small_xcmp_messages() -> Weight
```

### Configuration Already in Place:

All three runtimes already have the correct XCMP queue configuration:

**Moonbase** (`/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/xcm_config.rs:382-398`):
```rust
impl cumulus_pallet_xcmp_queue::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type ChannelInfo = ParachainSystem;
    type VersionWrapper = PolkadotXcm;
    type XcmpQueue = TransformOrigin<MessageQueue, AggregateMessageOrigin, ParaId, ParaIdToSibling>;
    type MaxInboundSuspended = sp_core::ConstU32<1_000>;
    type ControllerOrigin = EnsureRoot<AccountId>;
    type ControllerOriginConverter = XcmOriginToTransactDispatchOrigin;
    type WeightInfo = moonbase_weights::cumulus_pallet_xcmp_queue::WeightInfo<Runtime>;
    type PriceForSiblingDelivery = polkadot_runtime_common::xcm_sender::NoPriceForMessageDelivery<
        cumulus_primitives_core::ParaId,
    >;
    type MaxActiveOutboundChannels = ConstU32<128>;
    type MaxPageSize = MessageQueueHeapSize;  // 103 * 1024 = 105,472 bytes
}
```

**Moonbeam** (`/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/xcm_config.rs:385-401`) - identical configuration

**Moonriver** (`/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/xcm_config.rs:392-408`) - identical configuration

## Evidence & References

### PR Documentation:
- **Title**: "XCMP weight metering: account for the MQ page position"
- **Audience**: Runtime Dev
- **Related Issues**: #8308, #8021
- **Merged**: May 21, 2025

### Modified Weight Files in Moonbeam:

All three runtime weight files show additions of 65 lines each, implementing the new benchmark functions:

```bash
runtime/moonbase/src/weights/cumulus_pallet_xcmp_queue.rs  | 65 +++++++++++++++++++++-
runtime/moonbeam/src/weights/cumulus_pallet_xcmp_queue.rs  | 65 +++++++++++++++++++++-
runtime/moonriver/src/weights/cumulus_pallet_xcmp_queue.rs | 65 +++++++++++++++++++++-
```

### Key Changes in Weight Implementation:

The diff shows the replacement of fixed benchmarks with parameterized ones:

**Before**:
```rust
fn enqueue_2_empty_xcmp_messages() -> Weight
```

**After**:
```rust
fn enqueue_n_empty_xcmp_messages(n: u32) -> Weight {
    Weight::from_parts(21_706_000, 5487)
        // Standard Error: 313
        .saturating_add(Weight::from_parts(94_980, 0).saturating_mul(n.into()))
        .saturating_add(T::DbWeight::get().reads(4_u64))
        .saturating_add(T::DbWeight::get().writes(3_u64))
}
```

This allows for more accurate weight calculation based on the actual number of messages being processed.

### Configuration Validation:

All runtimes use the same `MessageQueueHeapSize` configuration:
```rust
pub const MessageQueueHeapSize: u32 = 103 * 1024;  // 105,472 bytes
```

This is properly set as `MaxPageSize` in the XCMP queue configuration, ensuring messages larger than 102,400 bytes (the typical HRMP channel max message size) can be accommodated.

## Summary

PR #8344 improves XCMP weight metering accuracy by introducing new parameterized benchmark functions that account for message queue page position. The changes are **automatically inherited** through the Polkadot SDK upgrade, and Moonbeam has already regenerated the required weight benchmarks for all three runtimes. No additional code changes or configuration updates are required.

The impact is **INHERITED** because:
1. The pallet's internal weight calculation logic was improved
2. The `WeightInfo` trait interface was extended with new benchmark functions
3. Moonbeam has already regenerated benchmarks implementing these new functions
4. No runtime configuration changes are needed
5. The improvements are transparent to runtime developers
