# PR #8345 Analysis: Transaction Watch Metrics for RPC v2

## Overview

**PR Title:** tx/metrics: Add metrics for the RPC v2 `transactionWatch_v1_submitAndWatch`

**GitHub:** https://github.com/paritytech/polkadot-sdk/pull/8345

**Audience:** Node Operator

**Related Issue:** https://github.com/paritytech/polkadot-sdk/issues/8336

## Summary

This PR introduces comprehensive metrics collection for the `transactionWatch_v1_submitAndWatch` RPC subscription endpoint, which is part of the new JSON-RPC v2 specification. The metrics help node operators monitor transaction lifecycle performance and debug latency issues in the transaction pool.

## Changes Made

### Metrics Implementation

The PR adds two types of metrics for transaction lifecycle monitoring:

1. **Global Event Counters**
   - Simple counters tracking the frequency of each transaction state event
   - Provides visibility into overall transaction pool activity

2. **Execution Time Histograms**
   - Labeled histogram vectors measuring time between state transitions
   - Tracks paths like: `submitted → inblock → finalized`
   - Captures start-to-final timing even with state oscillations (e.g., `inblock ↔ retracted` cycles)
   - Uses linear bucket distribution: 0.0 to 60.0 seconds in 3-second increments

### Technical Implementation

- **Metric buckets:** Configured with linear distribution for granular timing analysis
- **Optional registration:** Metrics are only registered once to avoid duplication
- **Clean API separation:** Metric control is separated from core transaction logic
- **Error tracking:** Properly tracks and reports error conditions
- **Prometheus compatible:** Integrates seamlessly with existing monitoring infrastructure

## Affected Crates

| Crate | Bump | Impact |
|-------|------|---------|
| `sc-service` | Major | Service configuration changes for metrics propagation |
| `sc-rpc-spec-v2` | Major | Core RPC v2 transaction watch implementation |

## Impact on Moonbeam

### Direct Impact: LOW

**Moonbeam's RPC Configuration:**
- Moonbeam uses `sc-service` (confirmed in `/Users/manuelmauro/Workspace/moonbeam/node/service/Cargo.toml`)
- `sc-rpc-spec-v2` is present as an indirect dependency (via Cargo.lock)
- The node uses `substrate_prometheus_endpoint::Registry` for metrics collection

**Transaction Monitoring:**
- Moonbeam primarily uses Frontier-based Ethereum RPC endpoints
- The codebase shows no direct usage of `transactionWatch_v1_submitAndWatch` or RPC v2 transaction APIs
- Current RPC implementation in `/Users/manuelmauro/Workspace/moonbeam/node/service/src/rpc.rs` focuses on:
  - Ethereum JSON-RPC compatibility (eth_*, web3_*, net_*)
  - Custom Moonbeam RPC (finality, debug, trace)
  - Substrate standard RPC (system, transactionPayment)

### Potential Benefits

While Moonbeam doesn't currently expose the RPC v2 transaction watch endpoints, this PR provides:

1. **Infrastructure readiness:** If Moonbeam decides to expose RPC v2 endpoints in the future, the metrics will be available automatically
2. **Upstream compatibility:** Keeps Moonbeam aligned with Polkadot SDK's monitoring capabilities
3. **No breaking changes to existing functionality:** The metrics are purely additive

### Migration Requirements

**NONE** - No action required for Moonbeam

- The changes are additive and don't break existing APIs
- The major version bump in `sc-service` and `sc-rpc-spec-v2` is for new capability addition
- Existing RPC endpoints and metrics continue to function unchanged

## Recommendations

### For Current Release

✅ **SAFE TO MERGE** - No migration needed

- This is a pure monitoring enhancement with no functional impact
- No code changes required in Moonbeam codebase
- Existing prometheus metrics collection will continue to work

### For Future Consideration

If Moonbeam wants to leverage these metrics in the future:

1. **Enable RPC v2 endpoints:** Consider exposing `transactionWatch_v1_submitAndWatch` for users who prefer the new JSON-RPC v2 specification
2. **Dashboard updates:** Create Grafana dashboards to visualize transaction lifecycle metrics
3. **Performance monitoring:** Use histogram data to identify transaction pool bottlenecks

## Testing Recommendations

### Minimal Testing Required

Since this PR doesn't affect Moonbeam's current functionality:

1. **Build verification:** Confirm the project builds successfully with updated dependencies
   ```bash
   cargo build --release
   ```

2. **Metrics endpoint check:** Verify prometheus metrics endpoint still functions
   - Start a dev node and check metrics at the prometheus endpoint
   - Confirm existing metrics are still present

3. **RPC smoke tests:** Run existing RPC integration tests
   ```bash
   cd test
   pnpm moonwall test smoke_moonbase
   ```

## Technical Details

### Service Integration

The metrics are integrated through the service builder pattern:
- Metrics registry is passed through the RPC layer during service construction
- Prometheus endpoint remains unchanged
- Metrics are automatically registered when RPC v2 transaction watch is enabled

### Performance Considerations

- **Minimal overhead:** Metrics collection uses efficient Prometheus client libraries
- **Optional activation:** Only active when RPC v2 endpoints are used
- **No impact on transaction processing:** Metrics are collected asynchronously

## Additional Context

### Related PRs in stable2506

This PR is part of broader RPC v2 improvements. Check if there are related PRs that:
- Introduce RPC v2 endpoints
- Modify transaction pool behavior
- Add additional metrics

### Node Operator Benefits

For node operators who enable RPC v2:
- Better visibility into transaction lifecycle
- Ability to identify slow state transitions
- Debug support for transaction stuck in pending state
- Historical performance analysis through prometheus data

## Conclusion

**Status:** ✅ Low Risk, No Action Required

PR #8345 is a pure observability enhancement that adds metrics for RPC v2 transaction watch functionality. Since Moonbeam doesn't currently use these RPC v2 endpoints, the PR has no functional impact on the codebase. The changes are forward-compatible and will automatically provide monitoring capabilities if Moonbeam decides to enable RPC v2 endpoints in the future.

The major version bumps in `sc-service` and `sc-rpc-spec-v2` are for new capability addition, not breaking changes to existing functionality.
