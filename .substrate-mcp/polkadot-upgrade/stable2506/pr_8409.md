# PR #8409: Check XCM Size in VMP Routing

## Summary

This PR adds XCM message size validation to UMP (Upward Message Passing - parachain to relay chain) routing. The validation now happens during the `validate` phase rather than only at delivery time, enabling earlier detection of oversized messages.

**PR Link:** https://github.com/paritytech/polkadot-sdk/pull/8409
**Status:** Merged (May 14, 2025)
**Audience:** Runtime Dev
**Version Bump:** Minor (non-breaking)

## Changes Overview

### Modified Crates
- `cumulus-primitives-core` (minor bump)
- `cumulus-pallet-parachain-system` (minor bump)
- `cumulus-primitives-utility` (minor bump)

### Technical Changes

1. **cumulus-primitives-core**: Added `can_send_upward_message` method to `UpwardMessageSender` trait
   ```rust
   fn can_send_upward_message(message: &UpwardMessage) -> Result<(), MessageSendError>;
   ```

2. **cumulus-pallet-parachain-system**: Implemented validation against `max_upward_message_size` from host configuration
   ```rust
   fn can_send_upward_message(message: &UpwardMessage) -> Result<(), MessageSendError> {
       let max_upward_message_size = HostConfiguration::<T>::get()
           .map(|cfg| cfg.max_upward_message_size)
           .ok_or(MessageSendError::Other)?;

       if message.len() > max_upward_message_size as usize {
           Err(MessageSendError::TooBig)
       } else {
           Ok(())
       }
   }
   ```

3. **cumulus-primitives-utility**: Modified `ParentAsUmp` router to call validation in its `validate` method
   - Maps `MessageSendError::TooBig` to `SendError::ExceedsMaxMessageSize`
   - Added benchmark support with `ensure_successful_delivery`

## Moonbeam Impact Analysis

### Impact Level: **INHERITED**

This change is automatically inherited through dependency upgrade with **no code changes required**.

### Current Moonbeam Usage

All three Moonbeam runtimes use `ParentAsUmp` for UMP routing:

**File:** `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/xcm_config.rs` (line 307-312)
**File:** `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/xcm_config.rs` (line ~307-312)
**File:** `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/xcm_config.rs` (line ~307-312)

```rust
/// For routing XCM messages which do not cross local consensus boundary.
pub type LocalXcmRouter = (
    // Two routers - use UMP to communicate with the relay chain:
    cumulus_primitives_utility::ParentAsUmp<ParachainSystem, PolkadotXcm, ()>,
    // ..and XCMP to communicate with the sibling chains.
    XcmpQueue,
);

/// The means for routing XCM messages which are not for local execution
pub type XcmRouter = WithUniqueTopic<LocalXcmRouter>;
```

### Configuration

Moonbeam's UMP configuration aligns with standard Polkadot parameters:

**Files:**
- `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs`
- `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lazy_loading/mod.rs`
- `/Users/manuelmauro/Workspace/moonbeam/zombienet/specs/polkadot-local.json`
- `/Users/manuelmauro/Workspace/moonbeam/zombienet/specs/kusama-local.json`

```rust
max_upward_message_size: 65_531,  // Standard size limit (64 KB - overhead)
max_upward_queue_size: 1_048_576,
max_upward_queue_count: 174_762,
```

### Behavior Changes

**Before:** Message size validation occurred only during delivery
**After:** Message size validation occurs during both `validate` and delivery phases

This means:
1. Oversized messages are caught earlier in the pipeline
2. Better error handling with `SendError::ExceedsMaxMessageSize`
3. Prevents wasted computation on messages that will fail delivery
4. Enables recursive message splitting strategies (as mentioned in PR motivation for AHM project)

### Risk Assessment

**Risk Level: Very Low**

**Reasons:**
1. **Additive Change:** Only adds validation that should already be enforced at delivery time
2. **Standard Limits:** Moonbeam uses the standard 65,531 byte limit for UMP messages
3. **No Evidence of Large Messages:** No code patterns indicating Moonbeam sends oversized UMP messages
4. **Minor Version Bump:** Non-breaking change per semantic versioning
5. **Improved Error Handling:** Better user experience with clearer error messages

**Potential Issues:**
- None identified. The change makes the system more robust by catching errors earlier.

### Benefits to Moonbeam

1. **Earlier Error Detection:** Oversized messages fail during validation instead of delivery
2. **Better Debugging:** Clear error messages (`ExceedsMaxMessageSize`) help identify issues faster
3. **Performance:** Avoids processing messages that will ultimately fail
4. **Future-Proof:** Supports advanced features like recursive message splitting if needed

## Action Items

### Required Actions
- **NONE** - Changes are automatically inherited

### Recommended Actions
- **NONE** - No additional work needed

### Optional Actions
- Monitor UMP message sizes in tests to ensure all messages are well under the 65,531 byte limit
- If implementing custom XCM message construction, be aware of the new early validation

## Testing Considerations

The PR adds unit tests for oversized message scenarios in cumulus. Moonbeam's existing XCM tests should continue to pass without modification since:
1. Standard XCM messages are well under the size limit
2. The validation adds safety without changing successful message handling
3. Moonbeam's test configurations properly set `max_upward_message_size`

**Test files to verify (optional):**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/tests/xcm_tests.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/tests/xcm_mock/`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/tests/xcm_mock/`

## Conclusion

This PR enhances UMP routing with proactive message size validation. Moonbeam inherits this improvement automatically through the dependency upgrade with zero code changes required. The change is low-risk and provides better error handling for XCM message routing.

The only behavioral difference users might notice is that oversized UMP messages now fail earlier (during validation) with a clearer error message (`ExceedsMaxMessageSize`) rather than failing later during delivery.

**Recommendation:** Accept this change as part of the stable2506 upgrade. No additional work required.
