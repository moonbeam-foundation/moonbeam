# PR #8422: [AHM] Staking async fixes for XCM and election planning

## Overview

**PR Link**: https://github.com/paritytech/polkadot-sdk/pull/8422
**Status**: Merged on May 30, 2025
**Audience**: Runtime Dev

## Summary

This PR introduces fixes and improvements to the staking-async pallets related to XCM message handling and election planning mechanisms. The changes are part of the Async Hooks Migration (AHM) initiative for relay chain staking.

## Key Changes

### 1. XCM Message Size Validation
- Enhanced `xcm::validate` to check message sizes
- Implemented validation in staking-async runtime configurations
- Note: Contains code duplication with plans for future refactoring

### 2. Election Planning
- Introduced default `EraElectionPlannerOf` implementation
- Uses educated guesses based on `ElectionProvider::duration` rather than arbitrary values
- Ensures elections always happen in time

### 3. Solution Type Improvements
- Resolved duplicate voter issues in solution types
- Changed `PagedRawSolution` storage from `BoundedVec` to `Vec` (unbounded) for decoding without Proof of Validity

### 4. Configuration Updates
- Renamed `SessionDuration` to `RelaySessionDuration` for better clarity
- Reverted `ErasClaimedRewards` back to `ClaimedRewards`

### 5. Logging Improvements
- Reduced unnecessary INFO-level logs to DEBUG
- Improved CLI-friendly type printing

### 6. Test Coverage
- Added comprehensive unit tests for XCM validation
- Enhanced tests for election planning mechanisms

## Affected Crates

| Crate | Bump Type | Description |
|-------|-----------|-------------|
| `pallet-staking-async` | **major** | Core pallet with API changes |
| `pallet-election-provider-multi-block` | **major** | Solution type storage changes |
| `pallet-staking-async-rc-runtime` | **major** | Runtime configuration updates |
| `pallet-staking-async-rc-client` | **minor** | XCM validation additions |
| `pallet-staking-async-parachain-runtime` | **minor** | Runtime config enhancements |
| `pallet-staking-async-ah-client` | **patch** | Logging level changes |

## Breaking Changes

### API Changes
1. **Type Rename**: `SessionDuration` → `RelaySessionDuration`
   - **Impact**: Any runtime using this associated type must update configuration

2. **Storage Format**: `PagedRawSolution` changed from bounded to unbounded
   - **Impact**: Storage decoding logic may need updates

3. **Storage Name**: `ErasClaimedRewards` → `ClaimedRewards`
   - **Impact**: Reversion to original name, may affect storage migrations

### New Requirements
- Runtimes using staking-async should consider implementing XCM message size validation
- Election planning configuration should use the new `EraElectionPlannerOf` default

## Impact on Moonbeam

### Direct Impact: NONE

**Rationale:**
1. Moonbeam does not use any of the affected staking-async pallets
2. Moonbeam uses its own parachain staking mechanism via `pallet-parachain-staking`
3. The staking-async pallets are specific to relay chain staking (Polkadot/Kusama)
4. No dependencies found in any Moonbeam runtime Cargo.toml files

### Verification
```bash
# Searched moonbeam codebase for staking-async dependencies
grep -r "staking-async\|election-provider-multi-block" runtime/*/Cargo.toml
# Result: No matches found
```

## Action Items

### For Moonbeam: NONE REQUIRED

- No code changes needed
- No testing required
- No migration necessary

### Monitoring
While this PR does not affect Moonbeam directly, it's part of the broader Async Hooks Migration for relay chains. Future relay chain upgrades may include these changes, but they will not impact Moonbeam's parachain staking functionality.

## Technical Details

### File Changes Summary
- **Core Logic**: Updates to pallet implementation, session rotation, and weight calculations
- **XCM Integration**: Enhanced XCM message validation in RC client
- **Testing**: Expanded test coverage for election provider and payout mechanisms
- **Configuration**: Genesis config updates for RC runtime

### Related PRs
- Backport PR: https://github.com/paritytech/polkadot-sdk/pull/8409

## Conclusion

This PR is part of the relay chain staking improvements and has **no impact** on Moonbeam. The changes are isolated to the staking-async ecosystem which is not used by parachain runtimes like Moonbeam. No action is required.
