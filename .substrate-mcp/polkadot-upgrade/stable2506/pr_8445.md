# PR #8445: Fix the clearing of gap sync on known imported blocks

## Overview

**PR Link**: https://github.com/paritytech/polkadot-sdk/pull/8445
**Type**: Bug Fix
**Severity**: Medium
**Affected Crate**: `sc-network` (patch bump)
**Audience**: Node Dev, Node Operator

## Summary

This PR fixes a critical synchronization bug where warp sync gaps were not properly cleared when known blocks were imported. This issue caused asset-hub and bridge-hub collators to become stuck in the "Block history" state without progressing.

## Problem Description

### Root Cause
The synchronization logic had a flaw where gaps were only cleared in response to `ImportedUnknown` events. This limitation created a problematic scenario:

1. During node startup or restart, `client.info()` reports a gap when block verification fails
2. A peer may respond with the missing blocks after they've already been imported locally
3. The gap remains open because the import is treated as "known" rather than "unknown"
4. The node gets stuck in the "Block history" synchronization state

### Affected Components
- **Primary Impact**: Collator nodes (specifically mentioned: asset-hub and bridge-hub)
- **Sync Mechanism**: Warp sync gap clearing logic
- **Network Layer**: `sc-network` crate

## Changes Made

### Core Fix
- Modified gap sync logic to clear gaps upon importing known blocks, not just `ImportedUnknown` events
- Implemented `complete_gap_if_target` helper function for consistent gap completion across different import scenarios

### Additional Improvements
- Added debug logging for sync operations and gap state tracking
- Implemented `Debug` trait for sync actions to improve observability

### Testing
Two new tests were added to verify gap clearing under different block import scenarios:
1. Test following actual node operations flow
2. Test emulating block imports

## Impact on Moonbeam

### Relevance
**HIGH** - Moonbeam is a parachain collator similar to asset-hub and bridge-hub

### Potential Issues Addressed
1. **Collator Synchronization**: If Moonbeam collators experience similar sync stalls during startup or restart, this fix will resolve them
2. **Network Stability**: Improves reliability of gap sync mechanism during normal operations
3. **Restart Resilience**: Better handling of block verification failures during node restarts

### Risk Assessment
**LOW RISK** - This is a bug fix in sync logic with no breaking changes

### Migration Requirements
**NONE** - No runtime changes, no storage migrations, no configuration changes required

## Recommendations

### Action Items
1. **Accept this PR**: The fix addresses a real synchronization issue that could affect Moonbeam collators
2. **Monitor**: After upgrade, monitor collator sync behavior during restarts to confirm the fix works as expected
3. **Test**: Consider testing node restart scenarios in development environment to verify improved sync behavior

### Testing Checklist
- [ ] Verify collator can sync from scratch
- [ ] Test collator restart scenarios (graceful and ungraceful)
- [ ] Monitor sync state transitions during block history sync
- [ ] Check logs for proper gap clearing messages

## Technical Details

### Files Changed
- `substrate/client/network/sync/src/block_relay_protocol.rs` (gap clearing logic)
- `substrate/client/network/sync/src/gap_sync.rs` (helper functions and debug implementations)

### Code Changes
The main change involves extending the gap clearing logic from:
```rust
// Before: Only cleared on ImportedUnknown
if event == ImportedUnknown { clear_gap() }
```

To:
```rust
// After: Also clears on known block imports
if event == ImportedUnknown || event == ImportedKnown {
    complete_gap_if_target()
}
```

## Related Issues
- Closes: #8416 (Collators stuck in "Block history" state)

## Conclusion

This is a valuable bug fix that improves the robustness of parachain collator synchronization. Given that Moonbeam operates collator nodes similar to asset-hub and bridge-hub, this fix is highly relevant and should be included in the stable2506 upgrade.

**Recommendation**: APPROVE and INCLUDE in upgrade
