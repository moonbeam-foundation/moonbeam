# PR 8461: Use litep2p as the Default Network Backend

## Overview

**PR**: https://github.com/paritytech/polkadot-sdk/pull/8461
**Labels**: T0-node
**Impact Level**: **INHERITED**
**Merged**: June 3, 2025
**Backported to**: stable2412, stable2503

## Summary

This PR makes litep2p the default network backend for all substrate-based chains, replacing libp2p. Litep2p is a lightweight alternative to libp2p designed for better performance and efficiency. The change provides significant performance improvements while maintaining backward compatibility through CLI flags.

## Technical Changes

### Performance Improvements

1. **CPU Efficiency**: Litep2p consumes approximately 2x less CPU than libp2p
   - Reduced from ~2.9-3x CPUs to ~1.3x CPUs on live validators

2. **Peer Discovery**: DHT records discovered approximately 4x faster
   - 2.5 minutes vs. 10 minutes with libp2p
   - Improves validator authority discovery
   - Addresses issues causing missed era rewards

3. **Connection Stability**:
   - More stable peer counts
   - Faster chain synchronization (526s vs. 803s in testing)

### Network Backend Changes

1. **Default Backend Switch**:
   - Changed from libp2p to litep2p across all chains
   - Reverted selective Kusama enablement (PR #7866)

2. **Dependency Updates**:
   - Updated litep2p to version 0.9.5
   - Fixed WebSocket transport connection stability
   - Improved compatibility with Smoldot light clients

3. **Configuration Updates**:
   - Fixed reserved-only peer filtering in notification peersets
   - Updated test transports from in-memory to TCP for litep2p compatibility
   - Added configuration comments for deprecated libp2p components

### Crate Version Impacts

**MINOR Bumps**:
- `sc-network`: Minor bump - default backend changed
- `sc-network-types`: Minor bump
- `polkadot-service`: Minor bump
- `cumulus-relay-chain-minimal-node`: Patch bump
- `cumulus-relay-chain-inprocess-interface`: Patch bump
- `polkadot-omni-node-lib`: Patch bump

**PATCH Bumps**:
- `sc-cli`: Patch bump
- `sc-offchain`: Patch bump

## Moonbeam-Specific Analysis

### Current Moonbeam Architecture

**Network Backend Usage**:

1. **Service Layer** (`/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs`):
   ```rust
   // Line 66: Import NetworkBackend trait
   use sc_network::{config::FullNetworkConfiguration, NetworkBackend, NetworkBlock};

   // Line 684, 1143: Generic NetworkBackend trait bound
   Net: NetworkBackend<Block, Hash>,
   ```

2. **CLI Integration** (`/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs`):
   ```rust
   // Lines 801, 816, 831, 871: Concrete NetworkWorker type usage
   sc_network::NetworkWorker<_, _>,
   ```

   Used in:
   - `moonbeam_service::new_dev::<...>()` (dev service)
   - `moonbeam_service::lazy_loading::new_lazy_loading_service::<...>()` (lazy loading)
   - All runtime variants (Moonbase, Moonriver, Moonbeam)

3. **Network Configuration** (`/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs`):
   ```rust
   // Lines 723-726: Network configuration creation
   let net_config = FullNetworkConfiguration::<_, _, Net>::new(
       &parachain_config.network,
       prometheus_registry.clone(),
   );
   ```

### Current Dependency Status

**From Cargo.lock**:
```toml
# Already at the target version
name = "litep2p"
version = "0.9.5"

name = "sc-network"
version = "0.50.1"
source = "git+https://github.com/moonbeam-foundation/polkadot-sdk?branch=moonbeam-polkadot-stable2503"
```

**Good News**: Moonbeam is already using litep2p 0.9.5, which is the exact version PR #8461 upgrades to.

### Network Backend Abstraction

Moonbeam uses a **generic approach** to network backends:

1. **Generic Type Parameter**: Service functions use `Net: NetworkBackend<Block, Hash>`
2. **Concrete Implementation**: CLI passes `sc_network::NetworkWorker<_, _>`
3. **No Direct Backend Selection**: Moonbeam doesn't explicitly choose libp2p or litep2p
4. **Inherits Default**: Will automatically use whatever `sc_network::NetworkWorker` defaults to

**This means the change is fully transparent to Moonbeam's code.**

## Impact Assessment

### Why INHERITED?

1. **Automatic Backend Selection**:
   - Moonbeam uses `sc_network::NetworkWorker<_, _>` without specifying the backend
   - PR #8461 changes the default backend inside `sc_network`
   - Moonbeam will automatically get litep2p as the default upon upgrade

2. **No Breaking API Changes**:
   - The `NetworkBackend` trait remains unchanged
   - No changes to `FullNetworkConfiguration` API
   - No new fields or parameters required
   - Changes are internal to `sc_network`

3. **Dependency Update Required**:
   - `sc-network` is a core dependency that must be updated
   - `sc-cli` includes CLI flag for backend selection
   - Part of mandatory stable2506 upgrade

4. **No Code Changes Needed**:
   - Moonbeam's generic approach insulates it from backend-specific code
   - No type changes required
   - No function signature updates needed

### Required Actions

#### Code Changes

**NONE REQUIRED** - Moonbeam's generic network backend approach means no code changes are necessary.

#### Testing Requirements

**Recommended**:

1. **Basic Network Functionality**:
   - Test node startup with default litep2p backend
   - Verify peer discovery works correctly
   - Test collator and full node modes
   - Verify network synchronization

2. **Network Operations**:
   - Test bootnode connection (especially with PR #8072 DHT bootnodes)
   - Verify DHT discovery performance improvements
   - Test peer connection stability
   - Monitor CPU usage improvements

3. **Parachain-Specific**:
   - Test relay chain connection with litep2p
   - Verify collator block production
   - Test XCM message propagation
   - Verify network sync after relay chain epoch changes

4. **Fallback Testing** (Optional):
   - Test with libp2p using `--network-backend libp2p` CLI flag
   - Verify backward compatibility if needed

5. **Environment Testing**:
   - Dev mode (`--dev`)
   - Alphanet (testnet)
   - Moonriver (Kusama parachain)
   - Moonbeam (Polkadot parachain)

#### Configuration Changes

**Optional CLI Flag**:
```bash
# Use libp2p instead of litep2p (if needed for compatibility)
./moonbeam --network-backend libp2p

# Default behavior (litep2p)
./moonbeam
# or explicitly
./moonbeam --network-backend litep2p
```

**Documentation Updates**:
- Update operator documentation to mention litep2p as default
- Document the `--network-backend` flag for troubleshooting
- Note performance improvements in release notes

### Benefits for Moonbeam

1. **Performance Improvements**:
   - **2x less CPU usage** - Significant cost savings for validators and infrastructure
   - **4x faster DHT discovery** - Faster network bootstrap and peer discovery
   - **Better sync performance** - 35% faster chain synchronization (803s ‚Üí 526s)

2. **Operational Benefits**:
   - More stable peer counts
   - Improved connection stability
   - Better compatibility with light clients (Smoldot)
   - Reduced resource requirements

3. **Network Health**:
   - Faster validator authority discovery
   - Reduced risk of missed era rewards
   - More efficient network protocol handling
   - Better WebSocket transport handling

4. **Complementary to PR #8072**:
   - Works well with DHT bootnode discovery
   - Improved DHT performance enhances bootnode discovery
   - Better peer discovery across the network

### Risks and Considerations

1. **New Backend Behavior**:
   - Different network behavior than libp2p
   - May require monitoring to verify expected performance
   - Initial testing needed to ensure compatibility

2. **Ecosystem Compatibility**:
   - Other nodes on the network must also support litep2p
   - Mixed libp2p/litep2p networks should work but may have suboptimal performance
   - Coordinated upgrade timing with Polkadot/Kusama relay chains

3. **Fallback Option**:
   - Can revert to libp2p via CLI flag if issues arise
   - libp2p still maintained for compatibility reasons
   - Provides safety net during transition

4. **Test Coverage**:
   - Litep2p is newer than libp2p
   - Less battle-tested in production
   - Requires thorough testing before mainnet deployment

### Migration Strategy

**Recommended Phased Rollout**:

1. **Phase 1: Development** (Low Risk)
   - Test with `--dev` mode
   - Verify basic functionality
   - Monitor for any immediate issues

2. **Phase 2: Alphanet** (Medium Risk)
   - Deploy to Alphanet testnet
   - Monitor peer discovery metrics
   - Collect performance data
   - Run for several days to ensure stability

3. **Phase 3: Moonriver** (Higher Risk)
   - Deploy to Moonriver (Kusama parachain)
   - Monitor closely for any issues
   - Collect performance metrics vs. libp2p
   - Verify collator performance

4. **Phase 4: Moonbeam** (Production)
   - Deploy to Moonbeam (Polkadot parachain)
   - Continue monitoring
   - Document any performance improvements

**Rollback Plan**:
If issues arise, operators can quickly revert to libp2p:
```bash
# Restart with libp2p backend
./moonbeam --network-backend libp2p
```

## Recommendation

**Action Required**: Test litep2p backend in development and testnet environments.

**Priority**: Medium
- No code changes required (transparent upgrade)
- Performance improvements are beneficial
- Testing recommended before production deployment
- Part of stable2506 upgrade (will be included automatically)

**Next Steps**:

1. ‚úÖ **Update dependencies** to stable2506 versions (includes litep2p 0.9.5)
2. ‚úÖ **Verify compilation** - Should compile without changes
3. üîç **Test in development mode** - Verify basic network functionality
4. üîç **Test on Alphanet** - Verify testnet performance and stability
5. üìä **Monitor metrics**:
   - Peer count stability
   - DHT discovery time
   - CPU usage
   - Network sync time
6. üöÄ **Deploy to Moonriver** - Monitor for any issues
7. üöÄ **Deploy to Moonbeam** - Final production deployment
8. üìù **Document findings** - Update operator guides with litep2p information

## Additional Resources

- **PR Discussion**: https://github.com/paritytech/polkadot-sdk/pull/8461
- **Related PR #8072**: DHT bootnode discovery (benefits from litep2p performance)
- **Litep2p Crate**: https://crates.io/crates/litep2p
- **Performance Metrics**: See PR description for detailed benchmarks

## Files Referenced

- `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs` (Lines 66, 684, 723-726, 1143)
- `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs` (Lines 801, 816, 831, 871)
- `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lazy_loading/mod.rs` (Lines 40, 362)
- `/Users/manuelmauro/Workspace/moonbeam/Cargo.lock` (litep2p version)

## Notes

- **No Code Changes Required**: Moonbeam's generic network backend approach means this upgrade is transparent
- **Already Has litep2p 0.9.5**: Moonbeam's Cargo.lock already includes the target version
- **Automatic Upgrade**: Simply updating to stable2506 will switch the default to litep2p
- **Fallback Available**: Can use `--network-backend libp2p` if any issues arise
- **Performance Win**: Significant CPU and DHT performance improvements expected
