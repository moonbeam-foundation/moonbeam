# PR #8473: Snowbridge: Remove asset location check

## Overview

**Title:** Snowbridge: Remove asset location check for compatibility
**Author:** yrong
**Status:** Merged (May 27, 2025)
**PR URL:** https://github.com/paritytech/polkadot-sdk/pull/8473
**Audience:** Runtime Dev
**Backport:** stable2503 (patch level)

## Summary

This PR removes unnecessary asset location verification checks from Snowbridge pallets to improve XCM version compatibility. The core change simplifies asset validation by relying solely on `TokenIdOf` conversion, which is XCM version-agnostic, eliminating redundant location-based verification.

## Technical Details

### Rationale

The `TokenIdOf` conversion is XCM version-agnostic, meaning it generates the same token ID for both XCM V5 and legacy V4 assets. Since the TokenId is stored as the storage key, checking whether the key exists is sufficient to verify if a token is registered. The additional asset location verification was redundant.

### Key Changes

**Before:**
- Asset verification included both TokenId conversion AND location verification
- Additional storage lookups and comparisons were performed

**After:**
- Verification simplified to: `ConvertAssetId::convert(&token_id).ok_or(InvalidAsset)?;`
- This alone verifies whether the token is registered

### Affected Crates (All Patch Bumps)

- `snowbridge-outbound-queue-primitives`
- `snowbridge-inbound-queue-primitives`
- `snowbridge-test-utils`
- `snowbridge-pallet-inbound-queue`
- `snowbridge-pallet-inbound-queue-v2`
- `snowbridge-pallet-system`
- `snowbridge-pallet-system-v2`
- `bridge-hub-westend-runtime`
- `bridge-hub-westend-integration-tests`

## Discussion & Concerns

### XCM Version Compatibility Debate

**Reviewer vgeddes raised concerns:**
- Questioned whether TokenId generation is truly deterministic across XCM versions
- Cited potential incompatibility risks from future protocol changes
- Worried about forward compatibility with unknown future XCM versions

**Author's response:**
- Referenced existing compatibility tests validating V4/V5 equivalence
- Argued that careful governance of codec indices prevents breaking changes
- Emphasized that the conversion is designed to be stable across versions

### Storage Design Discussion

**Initial proposal:** Use `VersionedLocation` in storage to preserve version information

**Final decision:** Reverted to storing base/unversioned types for consistency across pallets

### Later Feedback (September 2025)

**Contributor girazoki expressed reservations:**
- Concerned about reduced system flexibility
- Proposed restoring `NativeToForeignId` storage mapping
- Suggested this would enable future adaptability without sacrificing safety

## Impact on Moonbeam

### Direct Impact: **NONE**

Moonbeam does **not** use any of the affected Snowbridge crates. Analysis of the Moonbeam codebase shows:

1. **No Snowbridge pallet dependencies:**
   - Moonbeam doesn't depend on `snowbridge-pallet-inbound-queue`
   - Moonbeam doesn't depend on `snowbridge-pallet-system`
   - Moonbeam doesn't use Bridge Hub Westend runtime

2. **Only transitive dependency:**
   - `snowbridge-core` appears in `Cargo.lock` as a transitive dependency
   - `snowbridge-core` is **NOT** listed in the affected crates
   - No direct usage in any Moonbeam Cargo.toml files

3. **Different bridge architecture:**
   - Moonbeam's bridge configuration (`/runtime/moonbeam/src/bridge_config.rs`) is for the **Moonbeam-Moonriver** bridge via Kusama
   - This is separate from Snowbridge, which is the **Polkadot-Ethereum** bridge
   - No overlap in functionality or codebase

### Indirect Considerations

While there's no direct impact, teams should be aware of:

1. **XCM Version Handling Philosophy:** The PR establishes a pattern of relying on version-agnostic token IDs rather than explicit location verification. This pattern might influence future XCM-related design decisions.

2. **Future Snowbridge Integration:** If Moonbeam ever integrates with Snowbridge in the future, the simplified asset verification model will be the standard approach.

## Recommendations

### For Moonbeam Team

1. **No Action Required:** This PR doesn't affect Moonbeam's current functionality
2. **Monitor Discussion:** The concerns raised by girazoki about flexibility are worth tracking if the issue resurfaces
3. **Test Coverage:** Standard XCM testing should continue to validate cross-chain asset handling

### For Future Reference

If Moonbeam ever considers:
- Integrating with Snowbridge (Ethereum bridge)
- Implementing similar asset registration mechanisms
- Designing XCM version-agnostic storage patterns

Then the design decisions and trade-offs discussed in this PR would be relevant reference material.

## Labels

- Bridges infrastructure
- Runtime development
- Patch-level change

## Conclusion

This PR simplifies Snowbridge's asset verification logic by removing redundant location checks. While the change sparked interesting technical discussions about XCM version compatibility and future flexibility, it has **no impact on Moonbeam** as the project doesn't use the affected Snowbridge components. The PR represents a refinement to bridge infrastructure that Moonbeam doesn't currently depend on.
