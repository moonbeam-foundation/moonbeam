# PR #8477: FeeTracker Deduplications

## Overview

**PR**: [paritytech/polkadot-sdk#8477](https://github.com/paritytech/polkadot-sdk/pull/8477)
**Status**: Merged (May 12, 2025)
**Author**: serban300
**Audience**: Runtime Developers

## Summary

This PR refactors the `FeeTracker` trait to eliminate code duplication across multiple pallets that handle XCM message delivery fees. The refactoring consolidates fee factor management logic that was duplicated in cumulus parachain system, XCMP queue, and bridge router pallets.

## Changes

### Affected Crates

| Crate | Version Bump | Impact |
|-------|--------------|--------|
| `pallet-xcm-bridge-hub-router` | Minor | New trait implementation added |
| `cumulus-pallet-parachain-system` | Major | API changes to FeeTracker usage |
| `cumulus-pallet-xcmp-queue` | Major | API changes to FeeTracker usage |
| `polkadot-runtime-parachains` | Major | Core trait refactoring |
| `polkadot-runtime-common` | Patch | Minor adjustments |

### Core FeeTracker Trait Changes

The refactoring modified the `FeeTracker` trait to use a more unified approach:

**Previous API**:
```rust
fn increase_fee_factor(id: Self::Id, message_size_factor: FixedU128) -> FixedU128
fn decrease_fee_factor(id: Self::Id) -> FixedU128
```

**New API**:
```rust
fn get_min_fee_factor() -> FixedU128
fn get_fee_factor(id: Self::Id) -> FixedU128
fn set_fee_factor(id: Self::Id, val: FixedU128)
fn increase_fee_factor(id: Self::Id, message_size: u128)
fn decrease_fee_factor(id: Self::Id) -> bool
```

**Key Changes**:
- Methods now use raw message sizes (`u128`) instead of pre-calculated factors (`FixedU128`)
- Added getter/setter pattern for fee factors
- Changed return types to support better composition
- Removed duplicated fee calculation constants from individual pallets

### Files Modified

1. **polkadot/runtime/parachains/src/lib.rs** - Core trait definition
2. **cumulus/pallets/parachain-system/src/lib.rs** - Removed local fee constants
3. **cumulus/pallets/xcmp-queue/src/lib.rs** - Eliminated duplicated delivery fee logic
4. **polkadot/runtime/parachains/src/dmp.rs** - Removed hardcoded threshold constants
5. **bridges/modules/xcm-bridge-hub-router/src/lib.rs** - Added trait implementation

### Test Changes

Modified test expectations in `cumulus/pallets/xcmp-queue/src/tests.rs` where a delivery fee factor assertion changed from 1.72 to 1.80 due to the refactored fee calculation logic. An unrelated "remaining size computation" change was initially included but reverted to maintain focus.

## Impact on Moonbeam

### Direct Impact: **LOW** ✅

Moonbeam is **minimally affected** by this refactoring for the following reasons:

1. **No Custom FeeTracker Implementation**: All three Moonbeam runtimes (moonbeam, moonriver, moonbase) use `NoPriceForMessageDelivery` for the `PriceForSiblingDelivery` configuration parameter in `cumulus_pallet_xcmp_queue::Config`:

   ```rust
   // From runtime/moonbase/src/xcm_config.rs:392
   type PriceForSiblingDelivery = polkadot_runtime_common::xcm_sender::NoPriceForMessageDelivery<
       cumulus_primitives_core::ParaId,
   >;
   ```

2. **No Custom Fee Logic**: Moonbeam doesn't implement custom XCM delivery fee tracking or dynamic fee adjustment mechanisms that would use the FeeTracker trait.

3. **Standard Pallet Usage**: While Moonbeam uses both affected pallets (`cumulus-pallet-parachain-system` and `cumulus-pallet-xcmp-queue`), the changes are internal to their implementations and don't require configuration changes.

### Affected Moonbeam Components

**Runtime Files** (All using standard configurations):
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs`

**XCM Configuration Files**:
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/xcm_config.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/xcm_config.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/xcm_config.rs`

### Dependencies in Moonbeam

```toml
# All three runtimes have these dependencies
cumulus-pallet-parachain-system = { workspace = true }
cumulus-pallet-xcmp-queue = { workspace = true }
polkadot-runtime-common = { workspace = true }
```

## Required Actions

### For Moonbeam Upgrade

- [ ] **No code changes required** - Moonbeam uses the no-op implementation
- [ ] **No migration needed** - No storage or state changes
- [ ] **Verify compilation** - Ensure clean build with updated dependencies
- [ ] **Update Cargo.lock** - Will be updated automatically during upgrade
- [ ] **Consider testing** - Run XCM integration tests to verify message delivery works as expected

### Testing Recommendations

1. **Build Verification**:
   ```bash
   cargo build --release -p moonbase-runtime
   cargo build --release -p moonbeam-runtime
   cargo build --release -p moonriver-runtime
   ```

2. **XCM Message Tests**:
   ```bash
   # Run XCM-related integration tests
   cd test
   pnpm moonwall test dev_moonbase -g "XCM"
   ```

3. **Smoke Tests**:
   ```bash
   pnpm moonwall test smoke_moonbase
   ```

## Related PRs

- **Follow-up**: [PR #8528 - FeeTracker: remove get_min_fee_factor()](https://github.com/paritytech/polkadot-sdk/pull/8528)
- **Context**: [Issue #8462 - Refactor pallet-xcm-bridge-router to use FeeTracker/PriceForDelivery mechanism](https://github.com/paritytech/polkadot-sdk/issues/8462)

## Technical Details

### Why Major Version Bumps?

The cumulus pallets received major version bumps because:
1. The `FeeTracker` trait changed its method signatures (breaking change)
2. Internal fee calculation logic was consolidated and refactored
3. Any custom implementations would need to update their trait implementations

### Storage Impact

**No storage changes** - This is purely a code refactoring. The storage layout of affected pallets remains unchanged:
- `ParachainSystem::UpwardDeliveryFeeFactor` - Still exists
- `XcmpQueue` storage - Unchanged

### Performance Impact

**Neutral to Positive** - Code deduplication reduces WASM binary size slightly and may improve compilation times. Runtime performance should be identical as the fee calculation logic is functionally equivalent.

## Conclusion

This PR represents a **low-risk internal refactoring** for Moonbeam. Since Moonbeam uses the standard `NoPriceForMessageDelivery` implementation without custom fee tracking logic, the changes are transparent to Moonbeam's runtime. The upgrade should proceed smoothly without requiring any code changes or migrations.

### Risk Assessment

| Category | Risk Level | Notes |
|----------|------------|-------|
| Compilation | Low | Standard dependency update |
| Runtime | Low | No custom implementations affected |
| Storage | None | No storage changes |
| XCM Functionality | Low | Using no-op fee tracking implementation |
| Migration | None | No migration required |

### Review Status

✅ **Analysis Complete**
✅ **No Action Required**
✅ **Ready for Upgrade**

---

*Analysis Date: 2025-10-22*
*Polkadot SDK Release: stable2506*
*Moonbeam Version: master (d67d222bb3)*
