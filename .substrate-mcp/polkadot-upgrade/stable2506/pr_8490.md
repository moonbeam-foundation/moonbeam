# PR #8490: fatxpool: fix: remove invalid txs from the dropped stream controller

**Impact**: INHERITED
**Confidence**: High
**Affected Components**: Transaction Pool (sc-transaction-pool)

## Changes Detected

This PR fixes a bug in Substrate's transaction pool (`sc-transaction-pool`) where invalid transactions remained in internal stream controllers after being dropped, causing continuous log traces. The issue was identified when sending a transaction from an account with insufficient funds would generate repeated "dropped_watcher: Command::RemoveView ready views: {}" log messages until the collator was restarted.

**Root Cause**: Internal structures in the transaction pool were not cleaned correctly after removal of invalid transactions.

**Fix**: The PR properly cleans up transaction-related data structures in the transaction pool when transactions are dropped or marked as invalid.

## Project Impact

**INHERITED** - This is a bug fix in the upstream Substrate transaction pool implementation that Moonbeam inherits automatically. Moonbeam does not implement custom transaction pool logic or interact directly with the internal stream controllers that were fixed.

### Analysis of Moonbeam's Transaction Pool Usage

Moonbeam uses the standard Substrate transaction pool (`sc_transaction_pool`) without custom modifications:

1. **Transaction Pool Construction** (`/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:544-551`):
   ```rust
   let transaction_pool = sc_transaction_pool::Builder::new(
       task_manager.spawn_essential_handle(),
       client.clone(),
       config.role.is_authority().into(),
   )
   .with_options(config.transaction_pool.clone())
   .with_prometheus(config.prometheus_registry())
   .build();
   ```

2. **RPC Integration** (`/Users/manuelmauro/Workspace/moonbeam/node/service/src/rpc.rs:47`):
   - Uses `sc_transaction_pool_api::TransactionPool` trait
   - Exposes standard Ethereum-compatible transaction pool RPC via `TxPool` API (line 312)
   - No custom transaction validation or pool management logic

3. **Custom TxPool Runtime API** (`/Users/manuelmauro/Workspace/moonbeam/primitives/rpc/txpool/src/lib.rs`):
   - Provides `extrinsic_filter` runtime API for filtering transactions
   - Used by Ethereum RPC to filter ready/future transactions
   - Does not interact with internal pool stream controllers

### No Custom Implementation Detected

Search results confirm Moonbeam does not:
- Implement custom transaction pool watchers
- Access internal `dropped_watcher` stream controllers
- Implement custom `Command::RemoveView` logic
- Override transaction pool cleanup behavior

## Evidence & References

### Transaction Pool Dependencies
```toml
# From Cargo.lock and Cargo.toml
sc-transaction-pool = { workspace = true }
sc-transaction-pool-api = { workspace = true }
```

### Code Search Results

1. **Transaction Pool Usage** (46 files found):
   - `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs` - Standard pool construction
   - `/Users/manuelmauro/Workspace/moonbeam/node/service/src/rpc.rs` - RPC integration
   - `/Users/manuelmauro/Workspace/moonbeam/primitives/rpc/txpool/src/lib.rs` - Custom runtime API

2. **No Internal Pool Logic**:
   - Search for "dropped.*stream", "watcher", "Command::RemoveView" found no matches
   - Moonbeam uses transaction pool as a black box dependency

3. **Test Coverage**:
   - Moonbeam has extensive txpool tests in `/Users/manuelmauro/Workspace/moonbeam/test/suites/dev/moonbase/test-txpool/`
   - Tests cover limits, pending transactions, future transactions, and resets
   - Tests may benefit from the fix by reducing spurious log messages during invalid transaction scenarios

## Conclusion

This PR fixes an internal bug in Substrate's transaction pool that would manifest as:
- Repeated log traces after invalid transactions
- Memory/resource inefficiency from uncleaned internal structures
- No functional impact on transaction processing (transactions were still correctly rejected)

**Moonbeam automatically inherits this fix** with no code changes required. The fix improves:
- Log cleanliness (no more repeated "dropped_watcher" messages)
- Internal resource management in the transaction pool
- Developer experience when debugging transaction issues

**No action required** for the Moonbeam upgrade - this is a transparent improvement.
