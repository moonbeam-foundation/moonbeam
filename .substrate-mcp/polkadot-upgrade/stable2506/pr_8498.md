# PR #8498: txpool: fix tx removal from unlocks set

**Impact**: INHERITED
**Confidence**: High
**Affected Components**: Transaction Pool (Substrate Core)

## Changes Detected

This PR fixes a bug in the transaction pool's internal logic for removing transactions from the "unlocks" set in `/substrate/client/transaction-pool/src/graph/ready.rs`. The bug was related to incomplete removal of transaction subtrees when processing transaction dependencies.

The fix ensures that when transactions are removed from the pool, all dependent transactions in the subtree are properly cleared from the unlocks tracking structure. This prevents potential memory leaks or incorrect transaction ordering in the transaction pool under high load conditions.

## Project Impact

**INHERITED** - This is an internal bug fix in Substrate's transaction pool implementation that Moonbeam uses without modification. The fix is automatically inherited through the Polkadot SDK upgrade to stable2506.

### Why INHERITED:

1. **No Custom Transaction Pool Logic**: Moonbeam uses the standard `sc_transaction_pool::Builder` and `sc_transaction_pool::TransactionPoolHandle` from Substrate without any custom implementations or wrappers that would interact with the internal "unlocks" data structure.

2. **No Direct API Changes**: The PR modifies internal transaction pool logic (`graph/ready.rs`) but does not change any public APIs, type signatures, or configuration interfaces that downstream projects would depend on.

3. **Transparent Bug Fix**: This is a correctness fix for edge cases in transaction dependency management. The improved behavior (proper cleanup of transaction subtrees) is automatically beneficial without requiring any code changes in Moonbeam.

4. **RPC Layer Unaffected**: Moonbeam's transaction pool RPC interface (`primitives/rpc/txpool/src/lib.rs`) only deals with filtering and presenting transactions, not with internal pool management structures like "unlocks".

## Evidence & References

### Moonbeam's Transaction Pool Usage

**Transaction Pool Initialization** (`/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:544-551`):
```rust
let transaction_pool = sc_transaction_pool::Builder::new(
    task_manager.spawn_essential_handle(),
    client.clone(),
    config.role.is_authority().into(),
)
.with_options(config.transaction_pool.clone())
.with_prometheus(config.prometheus_registry())
.build();
```

Moonbeam uses the standard Substrate transaction pool builder with default configuration. There are no custom pool implementations or modifications to the internal transaction graph structures.

**Transaction Pool Type** (`/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:105`):
```rust
sc_transaction_pool::TransactionPoolHandle<Block, Client>
```

Moonbeam uses the standard `TransactionPoolHandle` type, which encapsulates the pool implementation details.

**RPC Integration** (`/Users/manuelmauro/Workspace/moonbeam/node/service/src/rpc.rs:103,312`):
```rust
pub graph: Arc<P>,
// ...
if ethapi_cmd.contains(&EthApiCmd::Txpool) {
    io.merge(TxPool::new(Arc::clone(&client), graph).into_rpc())?;
}
```

The RPC layer only exposes the pool through standard interfaces for querying ready/future transactions.

**Custom TxPool RPC API** (`/Users/manuelmauro/Workspace/moonbeam/primitives/rpc/txpool/src/lib.rs`):
This module only defines a runtime API for filtering extrinsics to return Ethereum transactions. It does not interact with or modify the internal transaction pool graph structures.

### No Custom Transaction Pool Logic Found

Searches for:
- Custom implementations of transaction pool graph structures: **Not found**
- Direct manipulation of "unlocks" or "ready" sets: **Not found**
- Custom transaction removal logic: **Not found**
- Custom dependency tracking: **Not found**

## Conclusion

PR #8498 is an internal bug fix in Substrate's transaction pool that Moonbeam inherits automatically. No code changes are required in the Moonbeam codebase. The fix improves transaction pool correctness under high load conditions, which will benefit Moonbeam's stability without any action needed.

The change is particularly relevant for Moonbeam since it processes high volumes of Ethereum-style transactions, and proper transaction pool management is critical for performance. However, the fix is transparent and requires no modifications to Moonbeam's code.
