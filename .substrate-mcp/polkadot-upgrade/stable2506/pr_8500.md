# PR #8500: txpool: fix tx removal from unlocks set

## Summary

This PR fixes a bug in the transaction pool's internal bookkeeping when removing transaction subtrees. The issue affected how transactions are removed from the unlocks sets of their parent transactions.

**PR Link**: https://github.com/paritytech/polkadot-sdk/pull/8500
**Audience**: Node Dev
**Crate**: `sc-transaction-pool` (major bump)
**Status**: Merged (May 21, 2025)

## Technical Details

### The Bug

When removing a transaction subtree, the transaction pool maintains an "unlocks" set that tracks which transactions would be unlocked when other transactions complete. The bug was in the removal logic where the wrong hash variable was used.

**Location**: `substrate/client/transaction-pool/src/graph/ready.rs` (lines ~301-303)

**Before**:
```rust
if let Some(tx) = ready.get_mut(hash) {
    remove_item(&mut tx.unlocks, hash);
```

**After**:
```rust
if let Some(tx_unlocking) = ready.get_mut(hash) {
    remove_item(&mut tx_unlocking.unlocks, &tx_hash);
```

The original code incorrectly used `hash` (the tag provider) instead of `tx_hash` (the removed transaction) when removing items from unlock lists. This meant that when a transaction was removed, its dependents weren't properly cleaned up from parent transactions' unlock sets.

### Impact Scope

According to the PR reviewer (michalkucharczyk), this bug existed in the code but didn't appear to cause "user-facing problems" or validity issues with the ready set iterator in practice. However:
- The fix was validated with load testing (5 million transactions)
- A new unit test was added: `should_remove_tx_from_unlocks_set_of_its_parent`
- The test validates that when tx2 is removed, it's correctly removed from tx1's unlock list while other dependencies remain intact

## Impact on Moonbeam

### Current Usage

Moonbeam uses `sc-transaction-pool` directly without any custom modifications to the unlocking logic:

1. **Direct Dependency**: Listed in `/Users/manuelmauro/Workspace/moonbeam/node/service/Cargo.toml` (line 72)

2. **Standard Implementation**: Built using the standard builder pattern in `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs` (lines 558-565):
```rust
let transaction_pool = sc_transaction_pool::Builder::new(
    task_manager.spawn_essential_handle(),
    client.clone(),
    config.role.is_authority().into(),
)
.with_options(config.transaction_pool.clone())
.with_prometheus(config.prometheus_registry())
.build();
```

3. **RPC Integration**: Exposed via Frontier's `fc-rpc` TxPool API for Ethereum compatibility

4. **Custom Runtime API**: Moonbeam has a `TxPoolRuntimeApi` in `/Users/manuelmauro/Workspace/moonbeam/primitives/rpc/txpool/src/lib.rs` for filtering transactions, but this doesn't interact with the internal unlocking mechanism

### Impact Assessment

**Risk Level**: LOW
**Action Required**: NONE
**Breaking Changes**: NO

#### Analysis

1. **Automatic Fix**: Since Moonbeam uses the standard `sc-transaction-pool` implementation, the bug fix will automatically apply when upgrading to stable2506.

2. **No Custom Logic**: Moonbeam doesn't override or customize the transaction pool's unlocking logic, so there's no code to update.

3. **Internal Fix**: This is an internal bookkeeping improvement that doesn't change the public API or observable behavior.

4. **Improved Reliability**: The fix will improve transaction pool management correctness, especially beneficial under high transaction loads (important for Moonbeam's EVM-based workloads).

5. **Testing Considerations**: No specific testing required as:
   - The bug didn't manifest as user-facing issues
   - Existing transaction pool tests continue to pass
   - The fix has been validated upstream with extensive load testing

## Recommendations

1. **No Action Required**: Simply upgrade `sc-transaction-pool` as part of the normal stable2506 upgrade process.

2. **Monitor Transaction Pool**: While the bug was minor, it's worth monitoring transaction pool behavior after the upgrade to ensure smooth operation, particularly during high-load periods.

3. **No Migration Needed**: This fix doesn't require any runtime or client migrations.

## Related Files

- `/Users/manuelmauro/Workspace/moonbeam/node/service/Cargo.toml` - Transaction pool dependency
- `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs` - Transaction pool initialization
- `/Users/manuelmauro/Workspace/moonbeam/node/service/src/rpc.rs` - TxPool RPC integration
- `/Users/manuelmauro/Workspace/moonbeam/primitives/rpc/txpool/src/lib.rs` - Custom TxPool runtime API

## Conclusion

This PR provides a minor but important correctness fix to the transaction pool's internal bookkeeping. Moonbeam will benefit from this improvement automatically when upgrading to stable2506, with no code changes or special considerations required.
