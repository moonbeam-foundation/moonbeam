# PR #8500: txpool - Fix Transaction Removal from Unlocks Set

## Overview

**PR Link**: https://github.com/paritytech/polkadot-sdk/pull/8500
**Audience**: Node Dev
**Crate**: `sc-transaction-pool` (major bump)

This PR fixes a bug in the Substrate transaction pool where removing a transaction subtree did not correctly update the "unlocks set" - the internal tracking mechanism that manages which transactions depend on (are unlocked by) other transactions.

## Technical Details

### The Problem

When a transaction subtree is removed from the transaction pool, the pool must update its internal bookkeeping to reflect that certain transactions are no longer waiting for these removed transactions. The flawed logic failed to properly remove these transactions from the unlocks tracking mechanism.

### The Fix

**Modified File**: `substrate/client/transaction-pool/src/graph/ready.rs`

The fix corrects the logic that manages the unlocks set when removing transaction subtrees. While the bug didn't cause observable user-facing issues (as noted by reviewers), it represented flawed internal state management that needed correction for system integrity.

### Testing

- Added comprehensive unit tests to validate the corrected behavior
- Tested with high-volume scenarios (5 million transactions)
- All existing txpool unit tests continue to pass

## Impact on Moonbeam

### Direct Usage

Moonbeam directly uses `sc-transaction-pool` without custom modifications:

**File**: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs`
```rust
let transaction_pool = sc_transaction_pool::Builder::new(
    task_manager.spawn_essential_handle(),
    client.clone(),
    config.role.is_authority().into(),
)
.with_options(config.transaction_pool.clone())
.with_prometheus(config.prometheus_registry())
.build();
```

The same pattern is used in both:
- Normal service initialization (`node/service/src/lib.rs`)
- Lazy loading mode (`node/service/src/lazy_loading/mod.rs`)

### Breaking Changes

**API Level**: The crate receives a major version bump, indicating potential API-level breaking changes. However, the PR description confirms there are no behavioral breaking changes.

**For Moonbeam**: Since Moonbeam uses the standard `sc_transaction_pool::Builder` API without customization, the upgrade should be transparent. The fix will automatically apply when dependencies are updated.

## Severity Assessment

**Severity**: LOW

**Rationale**:
1. The bug did not cause observable issues in production
2. This is a correctness fix for internal state management
3. No changes to transaction pool behavior or semantics
4. No impact on transaction validity or ordering
5. Moonbeam uses standard APIs without customization

## Action Items

- [ ] **Review**: Acknowledge this change during the stable2506 upgrade review
- [ ] **Testing**: Standard integration tests should be sufficient; no specific transaction pool tests needed
- [ ] **Monitoring**: No special monitoring required post-upgrade
- [ ] **Documentation**: No documentation updates needed

## Recommendation

**ACCEPT** - This is a beneficial correctness fix with no negative impact. The change improves the internal consistency of the transaction pool implementation without altering its external behavior or API (beyond version numbering).

## Related Context

### Transaction Pool Usage in Moonbeam

Moonbeam's transaction pool integration includes:
- Standard Substrate transaction pool via `sc-transaction-pool`
- Ethereum-style transaction pool RPC via `fc-rpc` with `txpool` feature enabled
- Custom RPC primitives in `moonbeam-rpc-primitives-txpool`
- Manual sealing support for development chains

None of these components require changes due to this fix.

### Dependencies

**Direct dependencies affected**:
- `sc-transaction-pool` (v0.10.0 or similar, will be bumped)
- `sc-transaction-pool-api` (interface crate, may also be bumped)

**Files to watch during upgrade**:
- `node/service/Cargo.toml` - dependency version updates
- `node/service/src/lib.rs` - transaction pool initialization
- `node/service/src/lazy_loading/mod.rs` - lazy loading pool initialization
