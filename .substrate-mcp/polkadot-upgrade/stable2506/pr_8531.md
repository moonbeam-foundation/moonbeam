# PR #8531 Analysis: Added `OnNewHead` to `pallet-bridge-parachains`

## Summary

This PR introduces a new `OnNewHead` runtime hook for `pallet-bridge-parachains`, which is triggered when a new parachain head is relayed. This is a **BREAKING CHANGE** that requires configuration updates in both Moonbeam and Moonriver runtimes.

**PR Link**: https://github.com/paritytech/polkadot-sdk/pull/8531
**Status**: Merged May 14, 2025
**Impact Level**: **MEDIUM - ACTION REQUIRED**

## Changes Overview

### New Hook API

A new `OnNewHead` trait was added to `bp-parachains`:

```rust
pub trait OnNewHead {
    fn on_new_head(id: ParaId, head: &ParaHead) -> Weight;
}
```

This hook is called whenever a parachain head is updated through the bridge, allowing runtime developers to execute custom logic (e.g., syncing state roots for message verification).

### Config Trait Changes

The `pallet_bridge_parachains::Config` trait now requires:

```rust
type OnNewHead: OnNewHead;
```

## Impact on Moonbeam

### Affected Runtimes

Both **Moonbeam** and **Moonriver** runtimes use `pallet-bridge-parachains` and will be affected:

1. **Moonbeam Runtime** (`/runtime/moonbeam/src/bridge_config.rs`, lines 85-93):
   - Bridges to Moonriver via Kusama relay chain
   - Instance: `BridgeMoonriverInstance`

2. **Moonriver Runtime** (`/runtime/moonriver/src/bridge_config.rs`, lines 85-93):
   - Bridges to Moonbeam via Polkadot relay chain
   - Instance: `BridgeMoonbeamInstance`

### Current Configuration

Both configurations are currently missing the new required `OnNewHead` type:

**Moonbeam**:
```rust
impl pallet_bridge_parachains::Config<BridgeMoonriverInstance> for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type BridgesGrandpaPalletInstance = BridgeGrandpaKusamaInstance;
    type ParasPalletName = KusamaBridgeParachainPalletName;
    type ParaStoredHeaderDataBuilder = SingleParaStoredHeaderDataBuilder<bp_moonriver::Moonriver>;
    type HeadsToKeep = ParachainHeadsToKeep;
    type MaxParaHeadDataSize = MaxKusamaParaHeadDataSize;
    type WeightInfo = moonbeam_weights::pallet_bridge_parachains::WeightInfo<Runtime>;
    // MISSING: type OnNewHead = ...;
}
```

**Moonriver**:
```rust
impl pallet_bridge_parachains::Config<BridgeMoonbeamInstance> for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type BridgesGrandpaPalletInstance = BridgeGrandpaPolkadotInstance;
    type ParasPalletName = PolkadotBridgeParachainPalletName;
    type ParaStoredHeaderDataBuilder = SingleParaStoredHeaderDataBuilder<bp_moonbeam::Moonbeam>;
    type HeadsToKeep = ParachainHeadsToKeep;
    type MaxParaHeadDataSize = MaxPolkadotParaHeadDataSize;
    type WeightInfo = moonriver_weights::pallet_bridge_parachains::WeightInfo<Runtime>;
    // MISSING: type OnNewHead = ...;
}
```

## Required Actions

### 1. Update Moonbeam Runtime Configuration

**File**: `/runtime/moonbeam/src/bridge_config.rs`

Add the following line to the `pallet_bridge_parachains::Config<BridgeMoonriverInstance>` implementation (after line 92):

```rust
type OnNewHead = ();
```

### 2. Update Moonriver Runtime Configuration

**File**: `/runtime/moonriver/src/bridge_config.rs`

Add the following line to the `pallet_bridge_parachains::Config<BridgeMoonbeamInstance>` implementation (after line 92):

```rust
type OnNewHead = ();
```

### 3. Verify and Test

- Ensure the runtime compiles with `cargo build --release`
- Run bridge-related tests to verify functionality
- Consider if Moonbeam needs custom `OnNewHead` logic in the future

## Implementation Notes

### Default Implementation

The standard approach (used in Bridge Hub runtimes) is to use the unit type `()`, which provides a no-op implementation:

```rust
type OnNewHead = ();
```

This is appropriate when no custom logic is needed on parachain head updates.

### Custom Implementation

If future requirements need custom logic when parachain heads are received, you can implement the `OnNewHead` trait:

```rust
pub struct CustomOnNewHead;
impl bp_parachains::OnNewHead for CustomOnNewHead {
    fn on_new_head(id: ParaId, head: &ParaHead) -> Weight {
        // Custom logic here
        // Return the weight consumed
        Weight::zero()
    }
}

// Then in config:
type OnNewHead = CustomOnNewHead;
```

### Composable Implementations

The trait supports tuple implementations, allowing multiple handlers:

```rust
type OnNewHead = (Handler1, Handler2, Handler3);
```

## Related PRs

- **PR #8326**: Syncing mechanism that uses this hook to send relayed headers with state_root for message proof verification
- **PR #8325**: Setup permissionless lanes for AssetHubs (parent feature)

## Affected Crates

- `pallet-bridge-parachains`: **major** bump
- `bp-parachains`: minor bump
- `bp-polkadot-core`: minor bump
- `bridge-runtime-common`: minor bump
- `pallet-bridge-relayers`: minor bump
- `bridge-hub-rococo-runtime`: minor bump
- `bridge-hub-westend-runtime`: minor bump

## Severity Assessment

**MEDIUM - Action Required**

- **Compilation Impact**: HIGH - Code will not compile without this change
- **Runtime Impact**: LOW - Default implementation has no behavioral changes
- **Implementation Complexity**: LOW - Simple one-line addition per runtime
- **Testing Complexity**: LOW - No behavioral changes with default implementation

## Recommendations

1. **Immediate Action**: Add `type OnNewHead = ();` to both runtime configurations
2. **Documentation**: No additional documentation needed for default implementation
3. **Future Consideration**: Evaluate if Moonbeam/Moonriver can benefit from custom `OnNewHead` logic for advanced bridge features
4. **Testing**: Include in standard runtime upgrade testing procedures
