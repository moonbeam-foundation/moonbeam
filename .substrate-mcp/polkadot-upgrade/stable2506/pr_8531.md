# PR #8531 Impact Analysis: Added OnNewHead to pallet-bridge-parachains

## Overview
- **PR Title**: Added `OnNewHead` to `pallet-bridge-parachains`
- **GitHub**: https://github.com/paritytech/polkadot-sdk/pull/8531
- **Status**: Merged (May 14, 2025)
- **Audience**: Runtime Dev
- **Crates Modified**:
  - pallet-bridge-parachains (major)
  - bp-parachains (minor)
  - bp-polkadot-core (minor)
  - bridge-hub-rococo-runtime (minor)
  - bridge-hub-westend-runtime (minor)
  - bridge-runtime-common (minor)
  - pallet-bridge-relayers (minor)

## Description

This PR introduces a new `OnNewHead` hook for `pallet-bridge-parachains`, which is triggered when a new parachain head is relayed.

The feature enables custom logic to execute when parachain headers are relayed across bridges. It was extracted from PR #8325 and works in conjunction with the [syncing mechanism](https://github.com/paritytech/polkadot-sdk/pull/8326), which sends relayed AssetHubRococo headers with `state_root`s to AssetHubWestend for message proof verification.

### Technical Details

**New Config Type:**
```rust
/// Runtime hook for when a parachain head is updated.
type OnNewHead: OnNewHead;
```

**OnNewHead Trait Definition (in bp-parachains):**
```rust
pub trait OnNewHead {
    /// Called when a parachain head is updated.
    /// Returns the weight consumed by this function.
    fn on_new_head(id: ParaId, head: &ParaHead) -> Weight;
}
```

The trait supports tuple implementations for up to 8 implementations, allowing multiple handlers to execute when parachain heads are updated.

## Impact Assessment

### Impact Category: **REQUIRED - CONFIGURATION UPDATE**

### Evidence

#### 1. Dependency Analysis

Moonbeam uses `pallet-bridge-parachains` in production:

**Moonriver Runtime** (`/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/Cargo.toml`):
```toml
# Bridge
pallet-bridge-parachains = { workspace = true }
```

**Moonbeam Runtime** (`/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/Cargo.toml`):
```toml
# Bridge
pallet-bridge-parachains = { workspace = true }
```

#### 2. Current Configuration Analysis

**Moonriver Configuration** (`/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/bridge_config.rs`, lines 85-93):
```rust
/// Add parachain bridge pallet to track Moonbeam parachain.
pub type BridgeMoonbeamInstance = pallet_bridge_parachains::Instance1;
impl pallet_bridge_parachains::Config<BridgeMoonbeamInstance> for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type BridgesGrandpaPalletInstance = BridgeGrandpaPolkadotInstance;
    type ParasPalletName = PolkadotBridgeParachainPalletName;
    type ParaStoredHeaderDataBuilder = SingleParaStoredHeaderDataBuilder<bp_moonbeam::Moonbeam>;
    type HeadsToKeep = ParachainHeadsToKeep;
    type MaxParaHeadDataSize = MaxPolkadotParaHeadDataSize;
    type WeightInfo = moonriver_weights::pallet_bridge_parachains::WeightInfo<Runtime>;
}
```

**Moonbeam Configuration** (`/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/bridge_config.rs`, lines 85-93):
```rust
/// Add parachain bridge pallet to track Moonriver parachain.
pub type BridgeMoonriverInstance = pallet_bridge_parachains::Instance1;
impl pallet_bridge_parachains::Config<BridgeMoonriverInstance> for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type BridgesGrandpaPalletInstance = BridgeGrandpaKusamaInstance;
    type ParasPalletName = KusamaBridgeParachainPalletName;
    type ParaStoredHeaderDataBuilder = SingleParaStoredHeaderDataBuilder<bp_moonriver::Moonriver>;
    type HeadsToKeep = ParachainHeadsToKeep;
    type MaxParaHeadDataSize = MaxKusamaParaHeadDataSize;
    type WeightInfo = moonbeam_weights::pallet_bridge_parachains::WeightInfo<Runtime>;
}
```

**Key Finding**: Both configurations are MISSING the new `type OnNewHead` configuration.

#### 3. Reference Implementation

Both BridgeHubRococo and BridgeHubWestend use the unit type as a no-op implementation:

```rust
type OnNewHead = ();
```

This is the simplest implementation that satisfies the trait bound without adding any custom logic.

#### 4. Test Configuration

The XCM mock tests already use similar patterns for other pallets:

**File**: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/tests/xcm_mock/relay_chain.rs` (line 285)
```rust
type OnNewHead = ();
```

This shows Moonbeam is already familiar with this pattern from the `paras` pallet configuration.

## Breaking Changes

### Major Version Bump

The `pallet-bridge-parachains` crate received a **major version bump**, indicating breaking changes to the Config trait. This is because a new associated type was added to the Config trait, which requires all implementations to provide this type.

### Compilation Impact

Without adding the `OnNewHead` type, the Moonbeam runtime will **fail to compile** during the upgrade to stable2506:

```
error[E0046]: not all trait items implemented, missing: `OnNewHead`
  --> runtime/moonriver/src/bridge_config.rs:85:1
   |
85 | impl pallet_bridge_parachains::Config<BridgeMoonbeamInstance> for Runtime {
   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ missing `OnNewHead` in implementation
```

## Action Items

### Required Actions

#### 1. Update Moonriver Runtime Configuration

**File**: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/bridge_config.rs`

Add the `OnNewHead` type to the configuration:

```rust
impl pallet_bridge_parachains::Config<BridgeMoonbeamInstance> for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type BridgesGrandpaPalletInstance = BridgeGrandpaPolkadotInstance;
    type ParasPalletName = PolkadotBridgeParachainPalletName;
    type ParaStoredHeaderDataBuilder = SingleParaStoredHeaderDataBuilder<bp_moonbeam::Moonbeam>;
    type HeadsToKeep = ParachainHeadsToKeep;
    type MaxParaHeadDataSize = MaxPolkadotParaHeadDataSize;
    type WeightInfo = moonriver_weights::pallet_bridge_parachains::WeightInfo<Runtime>;
    type OnNewHead = ();  // ADD THIS LINE
}
```

#### 2. Update Moonbeam Runtime Configuration

**File**: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/bridge_config.rs`

Add the `OnNewHead` type to the configuration:

```rust
impl pallet_bridge_parachains::Config<BridgeMoonriverInstance> for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type BridgesGrandpaPalletInstance = BridgeGrandpaKusamaInstance;
    type ParasPalletName = KusamaBridgeParachainPalletName;
    type ParaStoredHeaderDataBuilder = SingleParaStoredHeaderDataBuilder<bp_moonriver::Moonriver>;
    type HeadsToKeep = ParachainHeadsToKeep;
    type MaxParaHeadDataSize = MaxKusamaParaHeadDataSize;
    type WeightInfo = moonbeam_weights::pallet_bridge_parachains::WeightInfo<Runtime>;
    type OnNewHead = ();  // ADD THIS LINE
}
```

#### 3. Verify Compilation

After making the changes, verify that the runtime compiles:

```bash
cargo build --release -p moonriver-runtime
cargo build --release -p moonbeam-runtime
```

#### 4. Test Impact

Since the `()` implementation is a no-op (does nothing and returns zero weight), there are no functional changes:
- No behavior changes to bridge operations
- No weight changes to transactions
- No storage changes

The existing tests should pass without modifications.

### Optional Actions

#### Future Enhancement Opportunity

If Moonbeam ever needs to execute custom logic when parachain heads are relayed (for example, to sync state roots or trigger specific actions), the `OnNewHead` hook can be replaced with a custom implementation:

```rust
// Example custom implementation (future enhancement)
pub struct CustomOnNewHead;

impl bp_parachains::OnNewHead for CustomOnNewHead {
    fn on_new_head(id: ParaId, head: &ParaHead) -> Weight {
        // Custom logic here
        // e.g., sync state roots, trigger callbacks, etc.
        Weight::from_parts(10_000, 0)
    }
}

// Then configure it:
type OnNewHead = CustomOnNewHead;
```

However, this is not needed for the initial upgrade.

## Risk Assessment

**Risk Level**: **LOW**

### Why Low Risk?

1. **No-op Implementation**: Using `()` as the `OnNewHead` implementation means no actual logic executes, resulting in zero functional changes
2. **Zero Weight Impact**: The unit type returns `Weight::zero()`, so there's no impact on transaction weights or block production
3. **Reference Implementation**: Both BridgeHub runtimes use the same `()` implementation, showing this is the recommended approach
4. **No Storage Changes**: This configuration change doesn't affect storage or state
5. **Backwards Compatible Behavior**: The bridge functionality remains exactly the same, just with a hook available for future use

### Potential Issues

**Compilation Failure if Not Added**: The only risk is compilation failure if the type is not added. This is easily detected and fixed during the upgrade process.

## Migration Path

### No Runtime Migration Needed

This change does not require a runtime migration because:
- No storage items are added or modified
- No existing functionality is changed
- It's purely a configuration addition
- The `()` implementation is stateless

### No Version Bump Required

Since there are no functional changes to the runtime behavior, this does not necessitate a spec version bump. However, it will be included as part of the overall stable2506 upgrade version bump.

## Related Changes

### Connection to PR #8326

This PR was designed to work with PR #8326 (syncing mechanism) which sends relayed AssetHubRococo headers with `state_root`s to AssetHubWestend for message proof verification. While Moonbeam uses the bridge parachains pallet, it doesn't currently use this specific syncing mechanism, hence the `()` no-op implementation is appropriate.

## Benchmarking Considerations

The benchmark configuration also needs the `OnNewHead` type, which is already present in the test configurations:

**File**: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs` (line 1769)
```rust
impl pallet_bridge_parachains::benchmarking::Config<bridge_config::BridgeMoonbeamInstance> for Runtime {
    // Benchmark config
}
```

The benchmark implementation can also use `type OnNewHead = ()` unless specific benchmarking logic is needed.

## Conclusion

This PR introduces a required configuration change to `pallet-bridge-parachains`. While it's a **major version bump** from the perspective of the pallet's API, the actual impact on Moonbeam is **minimal** because:

1. **Simple Fix**: Adding one line (`type OnNewHead = ();`) to each runtime's bridge configuration
2. **No Functional Changes**: The `()` implementation is a no-op, preserving existing behavior
3. **No Migration Needed**: No storage or state changes required
4. **Low Risk**: Zero impact on transaction weights, storage, or runtime behavior
5. **Future-Ready**: The hook is available if Moonbeam ever needs to add custom logic for parachain head updates

## Recommendation

**Status**: âœ… **REQUIRED - SIMPLE CONFIGURATION UPDATE**

### Implementation Steps:
1. Add `type OnNewHead = ();` to both bridge configurations (moonbeam and moonriver)
2. Verify compilation with `cargo build --release`
3. Run existing tests to confirm no regressions
4. Include in the stable2506 upgrade

**Complexity**: Trivial
**Risk**: Low
**Effort**: < 5 minutes

This change is straightforward and should be included as part of the stable2506 upgrade preparation.
