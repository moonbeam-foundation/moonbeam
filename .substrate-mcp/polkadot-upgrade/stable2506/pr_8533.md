# PR #8533: Transaction Pool Fallback for Ready at Light

## Overview

**PR Title:** `fatxpool`: add fallback for ready at light

**Labels:** R0-silent

**Crate:** `sc-transaction-pool` (major bump)

**Audience:** Node Dev

## Summary

This PR adds a fallback mechanism for the `ready_at_light` method in the fork-aware transaction pool (fatxpool). The change addresses scenarios where block proposers request ready transactions from the pool but receive empty results because the parent block hash is part of a fork without a best block notification. The solution introduces a fallback that returns ready transactions from the most recent view processed by the transaction pool, even if those transactions might be invalid for the specific fork context. Additionally, the PR includes optimizations for how the best view is searched.

## Changes

### Core Implementation

The PR addresses two related issues (#8213 and #6056) with the following changes:

1. **Fallback Mechanism for ready_at_light**:
   - When a block proposer requests ready transactions using a parent block hash that is part of a fork without a best block notification
   - Instead of returning an empty set, the pool now falls back to returning ready transactions from the most recent view
   - This prevents block proposers from producing empty blocks when transactions are available

2. **Best View Search Optimization**:
   - Improved the algorithm for finding the best view in the view store
   - More efficient traversal of available views
   - Better performance when selecting fallback views

3. **Updated Tests**:
   - Modified existing tests to exercise the new fallback behavior
   - Added new test cases specifically for the fallback scenario
   - Ensures correctness of fallback logic

### Technical Details

The changes are concentrated in:
- `fork_aware_txpool.rs`: Main fallback logic implementation
- `view_store.rs`: Best view search optimization
- Test suite updates to verify new behavior

The fallback mechanism is designed to be conservative:
- Only activates when the specific fork view is not available
- Returns transactions that may not be valid for the specific fork
- Relies on transaction validation to filter out invalid transactions
- Prevents the critical issue of empty blocks when transactions exist

## Impact on Moonbeam

### MEDIUM-HIGH IMPACT

This change has **significant positive impact** on Moonbeam's block production and transaction pool reliability:

### 1. Parachain Block Production

**Evidence:**
- File: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs` (lines 1011-1017)
  ```rust
  ProposerFactory::new(
      task_manager.spawn_handle(),
      client.clone(),
      transaction_pool.clone(),
      prometheus_registry.as_ref(),
      telemetry.as_ref().map(|x| x.handle()),
  );
  ```
- Transaction pool used for collation (line 966)
- Implements delayed best block selection strategy (lines 592-595)

**Impact:**
Moonbeam collators rely on the transaction pool to provide ready transactions for block production. The fallback mechanism ensures:
- Collators don't produce empty blocks when transactions are available
- Fork scenarios don't cause transaction availability issues
- Block production remains consistent even during chain reorganizations
- Better utilization of available block space

### 2. Fork-Aware Transaction Pool Usage

**Evidence:**
- File: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs` (lines 558-565)
  ```rust
  let transaction_pool = sc_transaction_pool::Builder::new(
      task_manager.spawn_essential_handle(),
      client.clone(),
      config.role.is_authority().into(),
  )
  .with_options(config.transaction_pool.clone())
  .with_prometheus(config.prometheus_registry())
  .build();
  ```
- Standard fork-aware transaction pool implementation

**Impact:**
Moonbeam uses the fork-aware transaction pool (fatxpool) directly, making it a primary beneficiary of this fix. The fallback mechanism prevents scenarios where:
- Transactions become unavailable during fork resolution
- Block proposers receive empty ready sets despite pending transactions
- Users experience delayed transaction inclusion

### 3. Parachain Fork Scenarios

**Evidence:**
- Supports `legacy_block_import_strategy` flag (node/cli/src/cli.rs:167)
- Implements `ParachainBlockImport::new_with_delayed_best_block`
- Git history shows async backing support (commits #2623, #2593)

**Impact:**
As a parachain, Moonbeam experiences various fork scenarios:
- **Relay Chain Coordination**: Forks occur during relay chain block processing
- **Async Backing**: Multiple candidate blocks can exist simultaneously
- **Delayed Best Block Selection**: Temporary forks while determining the best chain
- **Chain Reorganizations**: Fork resolution after relay chain finality

The fallback mechanism ensures transaction availability remains consistent across all these scenarios.

### 4. EVM Transaction Handling

**Evidence:**
- File: `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/apis.rs` (lines 388-410)
  - Implements `TxPoolRuntimeApi` for filtering Ethereum transactions
- File: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/rpc.rs` (line 345)
  ```rust
  io.merge(TxPool::new(Arc::clone(&client), graph).into_rpc())?;
  ```

**Impact:**
EVM transactions in Moonbeam have specific characteristics:
- Strict nonce ordering requirements
- Users expect consistent transaction pool visibility
- RPC methods like `eth_getBlockByNumber` with pending tag rely on ready transactions
- EVM dApp users are sensitive to transaction availability issues

The fallback mechanism ensures EVM users see consistent transaction availability even during fork scenarios.

### 5. Transaction Pool RPC

**Evidence:**
- File: `/Users/manuelmauro/Workspace/moonbeam/node/service/Cargo.toml` (lines 101-104)
  ```toml
  fc-rpc = { workspace = true, features = [
      "rpc-binary-search-estimate",
      "txpool",
  ] }
  ```
- Frontier TxPool RPC implementation enabled
- Custom `moonbeam-rpc-primitives-txpool` integration

**Impact:**
The fallback mechanism improves RPC reliability:
- `txpool_content` RPC calls return consistent results
- `eth_sendRawTransaction` submissions are more reliable
- Transaction status queries are more accurate
- Better user experience for wallets and dApps

## Benefits for Moonbeam

### 1. Improved Block Production

**Before (without fallback):**
- Fork scenarios could result in empty blocks despite available transactions
- Block proposers receive empty ready sets when parent hash is on a side fork
- Wasted block space and reduced transaction throughput

**After (with fallback):**
- Block proposers always receive available transactions
- Fallback to most recent view ensures transaction availability
- Better block space utilization
- Improved transaction throughput

### 2. Enhanced Fork Handling

The optimization complements other fork-aware improvements:
- Works alongside PR #7980 (transaction pruning optimization)
- Supports PR #8001 (structured logging) for better debugging
- Improves reliability during async backing scenarios
- Reduces impact of fork scenarios on user experience

### 3. Better User Experience

Users benefit from:
- Consistent transaction inclusion across fork scenarios
- Reduced risk of transaction delays during chain reorganizations
- More predictable transaction confirmation times
- Better RPC response reliability

### 4. Operational Improvements

Node operators benefit from:
- Fewer empty blocks during fork scenarios
- Better block space utilization
- More consistent block production metrics
- Improved parachain efficiency

## Technical Details

### Affected Components

1. **Transaction Pool** (`sc-transaction-pool`):
   - Type: `sc_transaction_pool::TransactionPoolHandle<Block, Client>`
   - Used in: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs` (line 105)
   - Also in lazy loading: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lazy_loading/mod.rs` (line 300)

2. **Block Authorship**:
   - ProposerFactory: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs` (lines 1011-1017)
   - Used during collation and block building

3. **Fork Handling**:
   - Parachain block import with delayed best block strategy
   - Integration with relay chain fork resolution

### Fallback Logic

The fallback mechanism operates as follows:

1. **Primary Path**: Try to get ready transactions for the specific fork view
2. **Fallback Trigger**: If the specific view is not available (fork without best block notification)
3. **Fallback Action**: Return ready transactions from the most recent processed view
4. **Validation Filter**: Transactions that are invalid for the specific fork are filtered during validation

This approach balances:
- **Availability**: Ensures transactions are provided to block proposers
- **Safety**: Invalid transactions are still filtered by validation
- **Performance**: Optimized view search reduces overhead

### Compatibility

The change is backward compatible:
- No API changes to transaction pool interface
- Existing transaction pool consumers work unchanged
- Fallback is transparent to callers
- Major version bump due to internal behavior change

## Potential Concerns

### 1. Invalid Transaction Inclusion Risk

**Concern**: The fallback may provide transactions that are invalid for the specific fork

**Mitigation**:
- Transaction validation still occurs during block building
- Invalid transactions are filtered out before inclusion
- The fallback prevents empty blocks, validation ensures correctness
- Conservative approach that prioritizes availability

**Assessment**: âœ… Low risk - validation provides safety

### 2. Performance Impact

**Concern**: Fallback logic and best view search could add overhead

**Mitigation**:
- Best view search has been optimized (addresses issue #6056)
- Fallback only activates when specific view is unavailable
- Performance improvements offset any overhead
- Multiple reviews confirmed performance characteristics

**Assessment**: âœ… Low risk - net performance improvement

### 3. Fork Resolution Complexity

**Concern**: Fallback behavior could complicate fork resolution logic

**Mitigation**:
- Fallback is a last resort when specific view is unavailable
- Clear separation between primary and fallback paths
- Extensive test coverage validates correctness
- Multiple maintainer reviews (michalkucharczyk, bkchr)

**Assessment**: âœ… Low risk - well-tested and reviewed

## Migration Required

**No migration required** - This is an internal improvement in `sc-transaction-pool` behavior.

Changes are transparent to transaction pool consumers and do not require any configuration updates or code changes in Moonbeam.

## Recommendations

### 1. Monitor Block Production

After upgrade to stable2506, monitor:
- Empty block frequency (should decrease)
- Block space utilization (should improve)
- Transaction inclusion rates during fork scenarios
- Collator performance metrics

### 2. Fork Scenario Testing

Test transaction pool behavior under:
- Simulated parachain fork scenarios
- Async backing with multiple candidate blocks
- Chain reorganizations
- High transaction load during forks

Specific test scenarios:
```bash
# Test fork scenarios with transaction pool
pnpm moonwall test dev_moonbase test-txpool

# Monitor transaction availability during forks
# Check that blocks are not empty when transactions exist
```

### 3. RPC Reliability Verification

Verify improved RPC behavior:
- `txpool_content` consistency during forks
- `eth_sendRawTransaction` reliability
- Transaction status query accuracy
- Wallet and dApp integration testing

### 4. Logging and Observability

Leverage structured logging from PR #8001:
- Monitor fallback activation frequency
- Track transaction availability patterns
- Identify fork scenarios that trigger fallback
- Correlate with block production metrics

### 5. Integration with Other Improvements

This PR complements other transaction pool improvements:
- **PR #7980**: Transaction pruning optimization
- **PR #8001**: Structured logging
- Together, these provide: better performance + better observability + better reliability

## Concrete Evidence Summary

### Direct Usage
- âœ… Moonbeam depends on `sc-transaction-pool` (node/service/Cargo.toml:72)
- âœ… Uses standard transaction pool builder (node/service/src/lib.rs:558-565)
- âœ… Uses transaction pool for block authorship (node/service/src/lib.rs:1011-1017)
- âœ… Uses transaction pool for collation (node/service/src/lib.rs:966)

### Fork Handling Context
- âœ… Implements delayed best block strategy (node/service/src/lib.rs:592-595)
- âœ… Supports legacy block import strategy flag (node/cli/src/cli.rs:167)
- âœ… Async backing enabled (git history: commits #2623, #2593)
- âœ… Parachain fork scenarios common in production

### Transaction Pool Features
- âœ… TxPool RPC enabled via Frontier (node/service/src/rpc.rs:345)
- âœ… Custom TxPoolRuntimeApi implementation (runtime/common/src/apis.rs:388-410)
- âœ… EVM transaction filtering and management
- âœ… Integration with Frontier's fc-rpc txpool feature

### Testing
- âœ… Comprehensive txpool integration tests in `/Users/manuelmauro/Workspace/moonbeam/test/suites/dev/moonbase/test-txpool/`
- Multiple test files covering various txpool scenarios

## Conclusion

PR #8533 is a **critical reliability improvement** for Moonbeam's transaction pool operations, particularly during fork scenarios that are inherent to parachain operations. The fallback mechanism ensures:

1. **Block Production Reliability**: Collators don't produce empty blocks when transactions are available
2. **Fork Resilience**: Transaction availability remains consistent across fork scenarios
3. **User Experience**: Consistent transaction inclusion and RPC behavior
4. **Performance**: Optimized best view search improves overall efficiency

The change addresses a real operational issue that could impact:
- Block space utilization
- Transaction throughput
- User experience during chain reorganizations
- Collator efficiency

Given Moonbeam's:
- Role as a parachain with frequent fork scenarios
- EVM transaction processing with strict ordering requirements
- Async backing support increasing fork likelihood
- Production transaction volume and throughput needs

This is a **high-value, low-risk** improvement that enhances the reliability of transaction pool operations without requiring any migration or configuration changes.

### Key Takeaways
- âœ… No action required for upgrade
- âœ… Improved block production reliability
- âœ… Better fork scenario handling
- âœ… Enhanced transaction availability
- âœ… Recommend monitoring block production metrics after upgrade
- âœ… Test fork scenarios to verify improvements
- âœ… Complements other transaction pool enhancements in stable2506

### Risk Assessment
- **Functional Risk**: âœ… Low - well-tested fallback mechanism with validation safety
- **Performance Risk**: âœ… Low - includes optimizations that improve performance
- **Migration Risk**: âœ… None - transparent internal change
- **Testing Risk**: âœ… Low - extensive test coverage and maintainer review

### Priority
**RECOMMENDED** - This improvement addresses a real operational issue that could affect block production and user experience in parachain fork scenarios. The benefits significantly outweigh any risks.
