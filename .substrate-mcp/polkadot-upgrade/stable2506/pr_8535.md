# PR #8535: Make `WeightBounds` Return `XcmError` to Surface Failures

## Summary

This PR improves XCM weight calculation error handling by changing the `WeightBounds` trait to return detailed `XcmError` types instead of opaque `Result<Weight, ()>`. This is a **breaking change** that requires updates to custom implementations of the trait.

## Change Details

### Trait Signature Changes

**Before:**
```rust
fn weight(message: &mut Xcm<RuntimeCall>) -> Result<Weight, ()>;
fn instr_weight(instruction: &mut Instruction<RuntimeCall>) -> Result<Weight, ()>;
```

**After:**
```rust
fn weight(message: &mut Xcm<RuntimeCall>) -> Result<Weight, XcmError>;
fn instr_weight(instruction: &mut Instruction<RuntimeCall>) -> Result<Weight, XcmError>;
```

### New Error Variants

- `XcmError::ExceedsStackLimit` - instruction count exceeds limits
- `XcmError::Overflow` - weight calculations overflow
- `XcmError::FailedToDecode` - call decoding fails
- `XcmError::WeightNotComputable` - general weight calculation failures

### Affected Crates

- `staging-xcm-builder` (major bump)
- `staging-xcm-executor` (major bump)
- `pallet-xcm` (patch bump)

## Impact on Moonbeam

### Required Changes

#### 1. Custom WeightBounds Implementation
**File:** `/Users/manuelmauro/Workspace/moonbeam/pallets/xcm-transactor/src/mock.rs`

**Current Code (lines 206-213):**
```rust
impl<C: Decode> WeightBounds<C> for DummyWeigher<C> {
    fn weight(_message: &mut Xcm<C>) -> Result<Weight, ()> {
        Ok(Weight::zero())
    }
    fn instr_weight(_instruction: &mut Instruction<C>) -> Result<Weight, ()> {
        Ok(Weight::zero())
    }
}
```

**Required Update:**
```rust
impl<C: Decode> WeightBounds<C> for DummyWeigher<C> {
    fn weight(_message: &mut Xcm<C>) -> Result<Weight, XcmError> {
        Ok(Weight::zero())
    }
    fn instr_weight(_instruction: &mut Instruction<C>) -> Result<Weight, XcmError> {
        Ok(Weight::zero())
    }
}
```

**Action:** Update return types from `Result<Weight, ()>` to `Result<Weight, XcmError>`. Since the dummy implementation always returns `Ok`, no error handling changes needed.

### Code Review Recommended

#### 2. Weight Calculation in xcm-transactor Pallet
**File:** `/Users/manuelmauro/Workspace/moonbeam/pallets/xcm-transactor/src/lib.rs:1257`

**Current Code:**
```rust
T::Weigher::weight(&mut xcm.into()).map_or(Weight::max_value(), |w| {
    T::BaseXcmWeight::get().saturating_add(w)
})
```

**Analysis:** Uses `map_or()` which works with both error types. Currently returns `Weight::max_value()` on any error. With the new error types, you can now:
- Log specific error types for debugging
- Handle different error cases differently (e.g., overflow vs decode failure)
- Surface errors to callers instead of silently returning max weight

**Recommendation:** Consider improving error handling to leverage the new error information, especially for debugging weight calculation issues.

#### 3. Weight Calculation in xcm-utils Precompile
**File:** `/Users/manuelmauro/Workspace/moonbeam/precompiles/xcm-utils/src/lib.rs:197`

**Current Code:**
```rust
XcmConfig::Weigher::weight(&mut x).map_err(|_| revert("failed weighting"))
```

**Analysis:** Uses `map_err(|_| ...)` which discards error details. Code will compile and work as-is.

**Recommendation:** Consider using the error information for better error messages:
```rust
XcmConfig::Weigher::weight(&mut x).map_err(|e| revert(format!("Weight calculation failed: {:?}", e)))
```

### No Changes Required

#### Production Runtimes
All three runtimes (moonbeam, moonriver, moonbase) use `WeightInfoBounds` from `staging-xcm-builder`:

- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/xcm_config.rs:174`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/xcm_config.rs:182`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/xcm_config.rs:185`

These will automatically receive the updated implementation from the upstream crate.

#### Test Mocks
All XCM test mocks use `FixedWeightBounds` from `staging-xcm-builder`, which will also be updated automatically:
- Runtime XCM mock tests (relay_chain.rs, parachain.rs, statemine_like.rs)
- Precompile mocks (xcm-utils, xcm-transactor, gmp, relay-encoder, xtokens)

## Benefits

1. **Better Debugging:** Detailed error types provide context for weight calculation failures
2. **Improved Observability:** Structured logging helps diagnose issues during message preparation
3. **Proper Error Propagation:** Downstream consumers can now access specific error information
4. **Enhanced Developer Experience:** Clear error messages instead of opaque failures

## Migration Checklist

- [ ] Update `DummyWeigher` implementation in `/Users/manuelmauro/Workspace/moonbeam/pallets/xcm-transactor/src/mock.rs`
- [ ] Review error handling in `/Users/manuelmauro/Workspace/moonbeam/pallets/xcm-transactor/src/lib.rs:1257`
- [ ] Consider improving error messages in `/Users/manuelmauro/Workspace/moonbeam/precompiles/xcm-utils/src/lib.rs:197`
- [ ] Add import for `XcmError` if not already present
- [ ] Run tests to verify no regressions
- [ ] Consider adding logging for weight calculation errors in production code

## Risk Assessment

**Risk Level:** LOW-MEDIUM

- **Compilation:** Will fail until `DummyWeigher` is updated
- **Runtime Impact:** None for production runtimes (use upstream implementations)
- **Test Impact:** Minimal (test mocks use upstream implementations)
- **Functionality:** No functional changes, only error type improvements

## Testing Recommendations

1. Run unit tests for `pallet-xcm-transactor` after updating `DummyWeigher`
2. Run XCM integration tests to ensure weight calculations still work correctly
3. Test error scenarios to verify proper error propagation (if error handling is improved)
4. Verify precompile tests pass with the updated error types

## References

- **PR:** https://github.com/paritytech/polkadot-sdk/pull/8535
- **Issue:** #8419
- **PRDoc:** `/Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_8535.prdoc`
