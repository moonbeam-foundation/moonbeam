# PR #8535: Make `WeightBounds` Return `XcmError` to Surface Failures

## Overview

**PR**: [paritytech/polkadot-sdk#8535](https://github.com/paritytech/polkadot-sdk/pull/8535)
**Status**: Merged
**Audience**: Runtime Developers
**Impact Level**: Low Risk (Breaking Change - Test Code Only)

## Summary

This PR improves XCM weight calculation error handling by changing the `WeightBounds` trait to return structured `XcmError` types instead of opaque `()` errors. This enables better diagnostics and debugging of XCM weight estimation failures.

## Changes

### Trait Signature Update

**Before:**
```rust
trait WeightBounds<Call> {
    fn weight(message: &mut Xcm<Call>) -> Result<Weight, ()>;
    fn instr_weight(instruction: &mut Instruction<Call>) -> Result<Weight, ()>;
}
```

**After:**
```rust
trait WeightBounds<Call> {
    fn weight(message: &mut Xcm<Call>) -> Result<Weight, XcmError>;
    fn instr_weight(instruction: &mut Instruction<Call>) -> Result<Weight, XcmError>;
}
```

### Error Types

The implementation now captures specific failure scenarios:
- `XcmError::FailedToDecode` - Instruction decoding failures
- `XcmError::Overflow` - Weight calculation overflows
- `XcmError::ExceedsStackLimit` - Excessive instruction counts

### Debug Logging

Added structured debug logging with contextual information including:
- Error type and context
- Instructions remaining (for `weight()` operations)
- Specific instruction details (for `instr_weight()` operations)

## Affected Crates

| Crate | Bump Type | Reason |
|-------|-----------|--------|
| `pallet-xcm` | patch | Minor error handling updates |
| `staging-xcm-builder` | major | Breaking trait signature change |
| `staging-xcm-executor` | major | Breaking trait signature change |

## Impact on Moonbeam

### Risk Assessment: **LOW**

Only one custom implementation exists in the Moonbeam codebase, and it's in test mock code.

### Affected Code

#### 1. Custom Implementation (Test Mock Only)

**File**: `/Users/manuelmauro/Workspace/moonbeam/pallets/xcm-transactor/src/mock.rs`

**Current Implementation:**
```rust
pub struct DummyWeigher<C>(PhantomData<C>);

impl<C: Decode> WeightBounds<C> for DummyWeigher<C> {
    fn weight(_message: &mut Xcm<C>) -> Result<Weight, ()> {
        Ok(Weight::zero())
    }
    fn instr_weight(_instruction: &mut Instruction<C>) -> Result<Weight, ()> {
        Ok(Weight::zero())
    }
}
```

**Required Changes:**
- Update return type from `Result<Weight, ()>` to `Result<Weight, XcmError>`
- Add import: `use xcm::latest::Error as XcmError;`

#### 2. Standard Implementations (No Changes Required)

The following implementations are provided by upstream crates and will be automatically updated:

**Production Runtime** (`runtime/*/src/xcm_config.rs`):
- Uses `WeightInfoBounds` from `xcm-builder`
- No migration needed

**Test Mocks** (various test files):
- Use `FixedWeightBounds` from `xcm-builder`
- No migration needed

**Usage Sites**:
- Runtime configurations: moonbase, moonbeam, moonriver
- Precompile test mocks: xcm-utils, xcm-transactor, gmp, xtokens, relay-encoder
- XCM test mocks: parachain, relay chain, statemint-like chains

## Migration Guide

### Required Changes

Update the `DummyWeigher` implementation in `pallets/xcm-transactor/src/mock.rs`:

```rust
// Add import at the top of the file
use xcm::latest::Error as XcmError;

// Update implementation
impl<C: Decode> WeightBounds<C> for DummyWeigher<C> {
    fn weight(_message: &mut Xcm<C>) -> Result<Weight, XcmError> {
        Ok(Weight::zero())
    }
    fn instr_weight(_instruction: &mut Instruction<C>) -> Result<Weight, XcmError> {
        Ok(Weight::zero())
    }
}
```

### Testing

After making changes:
1. Run xcm-transactor pallet tests: `cargo test -p pallet-xcm-transactor`
2. Run affected precompile tests:
   - `cargo test -p pallet-xcm-transactor-precompile`
3. Verify mock XCM integration tests still pass

## Benefits

### Improved Error Diagnostics

Previously, vague errors like "Failed to prepare message" made debugging extremely difficult. With this change:
- Developers can identify specific failure points (decoding, overflow, limits)
- Error context is preserved through the execution stack
- Debug logs provide detailed information for troubleshooting

### Better Developer Experience

The change enables:
- More precise error messages in XCM failure scenarios
- Easier identification of weight calculation issues
- Better tooling support for XCM development and debugging

## Breaking Change Analysis

### Why Breaking

The trait signature fundamentally changed, affecting all implementations.

### Mitigation

The impact is minimal because:
1. Only one custom implementation exists in Moonbeam
2. That implementation is in test mock code (not production)
3. All production code uses standard implementations from upstream
4. The fix is straightforward (change error type)

## Related PRs

- **PR #7730**: Referenced for future refinement of overflow error handling with more specific enum variants
- Currently, `XcmError::Overflow` serves as a placeholder for various overflow scenarios

## Recommendation

**Action**: ACCEPT and migrate

**Priority**: Low (only affects test code)

**Effort**: Minimal (single file update)

**Blockers**: None

This is a valuable improvement to XCM error handling with minimal impact on Moonbeam. The only required change is a simple update to a test mock implementation.
