# PR #8549: Make `WeightBounds` return `Result<Weight, XcmError>` to surface XCM weight failures

**Impact**: MUST (partially complete)
**Confidence**: High
**Affected Components**:
- `/Users/manuelmauro/Workspace/moonbeam/pallets/xcm-transactor/src/lib.rs` (lines 110, 1257)
- `/Users/manuelmauro/Workspace/moonbeam/pallets/xcm-transactor/src/mock.rs` (lines 206-212)
- `/Users/manuelmauro/Workspace/moonbeam/precompiles/xcm-transactor/src/mock.rs`
- `/Users/manuelmauro/Workspace/moonbeam/precompiles/xcm-utils/src/lib.rs` (lines 40, 196)
- `/Users/manuelmauro/Workspace/moonbeam/precompiles/xcm-utils/src/mock.rs`
- All runtime test mocks (moonbase, moonbeam, moonriver) - ALREADY UPDATED
- All precompile test mocks - some still need updates

## Changes Detected

PR #8549 changes the `WeightBounds` trait return type from `Result<Weight, ()>` to `Result<Weight, XcmError>`:

**Before:**
```rust
pub trait WeightBounds<Call> {
    fn weight(message: &mut Xcm<Call>) -> Result<Weight, ()>;
    fn instr_weight(instruction: &mut Instruction<Call>) -> Result<Weight, ()>;
}
```

**After:**
```rust
pub trait WeightBounds<Call> {
    fn weight(message: &mut Xcm<Call>) -> Result<Weight, XcmError>;
    fn instr_weight(instruction: &mut Instruction<Call>) -> Result<Weight, XcmError>;
}
```

This change improves error handling by surfacing detailed XCM error context instead of losing error information with the unit type `()`.

## Project Impact

### Status: Partially Complete

Moonbeam has **already updated** most of its XCM test infrastructure to use `Result<Weight, XcmError>`, but there are still a few mock implementations that need updating:

### Files Already Updated ✓
These runtime test mocks already return `Result<Weight, XcmError>`:
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/tests/xcm_mock/statemine_like.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/tests/xcm_mock/parachain.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/tests/xcm_mock/parachain.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/tests/xcm_mock/statemint_like.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/tests/xcm_mock/statemint_like.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/tests/xcm_mock/parachain.rs`

### Files Still Needing Update ✗

**1. `/Users/manuelmauro/Workspace/moonbeam/pallets/xcm-transactor/src/mock.rs` (lines 206-212)**

Current implementation still returns `Result<Weight, ()>`:
```rust
pub struct DummyWeigher<C>(PhantomData<C>);

impl<C: Decode> WeightBounds<C> for DummyWeigher<C> {
    fn weight(_message: &mut Xcm<C>) -> Result<Weight, ()> {
        Ok(Weight::zero())
    }
    fn instr_weight(_instruction: &mut Instruction<C>) -> Result<Weight, ()> {
        Ok(Weight::zero())
    }
}
```

**Required Change:**
```rust
impl<C: Decode> WeightBounds<C> for DummyWeigher<C> {
    fn weight(_message: &mut Xcm<C>) -> Result<Weight, XcmError> {
        Ok(Weight::zero())
    }
    fn instr_weight(_instruction: &mut Instruction<C>) -> Result<Weight, XcmError> {
        Ok(Weight::zero())
    }
}
```

**2. Precompile mock files (need verification)**
- `/Users/manuelmauro/Workspace/moonbeam/precompiles/xcm-transactor/src/mock.rs`
- `/Users/manuelmauro/Workspace/moonbeam/precompiles/xcm-utils/src/mock.rs`
- `/Users/manuelmauro/Workspace/moonbeam/precompiles/xtokens/src/mock.rs`
- `/Users/manuelmauro/Workspace/moonbeam/precompiles/relay-encoder/src/mock.rs`
- `/Users/manuelmauro/Workspace/moonbeam/precompiles/gmp/src/mock.rs`

### Production Code - No Changes Needed ✓

The production code already handles `Result` types correctly and will work with either `()` or `XcmError` as the error type:

**In `/Users/manuelmauro/Workspace/moonbeam/pallets/xcm-transactor/src/lib.rs:1257`:**
```rust
T::Weigher::weight(&mut xcm.into(), Weight::MAX)
    .map_or(Weight::MAX, |w| T::BaseXcmWeight::get().saturating_add(w))
```

**In `/Users/manuelmauro/Workspace/moonbeam/precompiles/xcm-utils/src/lib.rs:196`:**
```rust
Ok(Ok(mut x)) => XcmConfig::Weigher::weight(&mut x, Weight::MAX)
    .map_err(|_| revert("failed weighting")),
```

Both use `.map_or()` or `.map_err(|_| ...)` which work regardless of the error type since they discard the error value. The code is already future-proof.

## Evidence & References

### Search Results

1. **WeightBounds trait usage in Moonbeam:**
   - Import in pallet: `/Users/manuelmauro/Workspace/moonbeam/pallets/xcm-transactor/src/lib.rs:110`
   - Import in precompile: `/Users/manuelmauro/Workspace/moonbeam/precompiles/xcm-utils/src/lib.rs:40`
   - Used extensively in mock configurations for XCM testing

2. **Weigher::weight calls:**
   - pallet-xcm-transactor: Line 1257 - used in `weight_of_initiate_reserve_withdraw()`
   - precompile-xcm-utils: Line 196 - used in `weight_message()` precompile function

3. **Type usage:**
   ```rust
   type Weigher: WeightBounds<Self::RuntimeCall>;
   ```
   Defined in pallet Config trait (line 159) and used throughout the XCM infrastructure.

### GitHub PR Details

- **PR**: https://github.com/paritytech/polkadot-sdk/pull/8549
- **Title**: Make `WeightBounds` return `Result<Weight, XcmError>` to surface XCM weight failures
- **Related**: Continues work from PR #8535, addresses issue #8419
- **Motivation**: Previous implementation lost valuable error information; new approach allows downstream callers to access detailed error context

## Recommended Actions

1. **Update mock implementation in pallet-xcm-transactor:**
   - Change `DummyWeigher` in `/Users/manuelmauro/Workspace/moonbeam/pallets/xcm-transactor/src/mock.rs` to return `Result<Weight, XcmError>`
   - Ensure `XcmError` is imported from `xcm::latest::Error`

2. **Verify and update precompile mocks:**
   - Check all precompile mock files for `WeightBounds` implementations
   - Update any that still use `Result<Weight, ()>`

3. **Build and test:**
   - Run `cargo build` to ensure all mock updates compile correctly
   - Run unit tests: `cargo test -p pallet-xcm-transactor`
   - Run precompile tests to verify no regressions

4. **No production code changes needed:**
   - The actual runtime implementations use `FixedWeightBounds` from `xcm-builder` which will be updated by the Polkadot SDK upgrade
   - The error handling in production code is already compatible

## Notes

- This is a **breaking change** at the trait level but has minimal impact on Moonbeam since most code already uses error-generic handlers (`.map_err(|_|)`, `.map_or()`)
- The change improves debugging capabilities by preserving XCM error information during weight calculation failures
- Moonbeam's runtime test infrastructure is already 90% updated, only mock implementations in pallets and precompiles need final updates
- The unit error type `()` was a temporary design that lost important error context; this PR rectifies that by using `XcmError` throughout
