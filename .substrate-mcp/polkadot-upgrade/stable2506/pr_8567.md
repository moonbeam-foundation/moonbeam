# PR #8567: [FRAME] Omni bencher fixes

**Impact**: OPTIONAL
**Confidence**: High
**Affected Components**:
- Benchmarking infrastructure (frame-omni-bencher)
- CI/CD workflow: `.github/workflows/check-benchmarks.yml`
- Benchmarking script: `scripts/run-benches-for-runtime.sh`

## Changes Detected

PR #8567 introduces improvements to the `frame-omni-bencher` tool used for runtime benchmarking:

1. **New `--pallets` option**: Allows running benchmarks for multiple pallets in a single command (previously only single pallet was supported)
2. **New `--exclude-extrinsics` option**: Enables exclusion of specific (Pallet, Extrinsic) combinations during benchmarking
3. **Fixed storage overlay reversion**: Ensures storage overlay is properly reverted before benchmark runs, preventing state pollution between benchmarks
4. **Root hash determinism for V2 benchmarks**: Improves consistency and reliability of V2 benchmarks

These changes significantly improve benchmarking reliability, reducing benchmark failures from 5 to 1 in Kusama testing according to the PR description.

## Project Impact

This PR has **OPTIONAL** impact on Moonbeam - it provides improvements to the benchmarking tooling but does not require immediate code changes:

### Current Moonbeam Usage

Moonbeam uses `frame-omni-bencher` extensively for weight generation:

1. **CI/CD Integration** (`/Users/manuelmauro/Workspace/moonbeam/.github/workflows/check-benchmarks.yml`):
   - Line 10: Currently pinned to `FRAME_OMNI_BENCHER_RELEASE_VERSION: polkadot-stable2503-5`
   - Lines 65-70: Downloads and installs frame-omni-bencher from Polkadot SDK releases
   - Line 74: Runs benchmarks for all three runtimes (moonbeam, moonbase, moonriver)

2. **Benchmarking Script** (`/Users/manuelmauro/Workspace/moonbeam/scripts/run-benches-for-runtime.sh`):
   - Line 52: Uses `./frame-omni-bencher v1 benchmark pallet` command
   - Lines 35-69: Iterates through all pallets, benchmarking each individually
   - Currently uses single-pallet approach that this PR enhances

3. **Generated Weight Files**: All runtime weight files in:
   - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/weights/*.rs`
   - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/weights/*.rs`
   - `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/weights/*.rs`

   These files contain comments indicating they were generated with `./frame-omni-bencher` (line 27 in each file).

### Benefits of Adopting This PR

1. **Improved Reliability**: The storage overlay fix will reduce benchmark failures, which Moonbeam may have experienced
2. **Flexibility**: The new `--pallets` option could allow batch benchmarking of multiple pallets (though current script architecture runs pallets individually)
3. **Selective Benchmarking**: The `--exclude-extrinsics` option enables skipping problematic extrinsics if needed

### Recommended Actions

**When upgrading to stable2506:**

1. Update the frame-omni-bencher version in CI workflow:
   ```yaml
   # File: .github/workflows/check-benchmarks.yml:10
   # Change from: FRAME_OMNI_BENCHER_RELEASE_VERSION: polkadot-stable2503-5
   # Change to:   FRAME_OMNI_BENCHER_RELEASE_VERSION: polkadot-stable2506
   ```

2. **Optional**: Consider using the new `--pallets` option for batch benchmarking in `scripts/run-benches-for-runtime.sh` if the team wants to optimize benchmark execution time

3. **Optional**: If any pallets consistently fail benchmarking, the new `--exclude-extrinsics` option can be used to skip specific problematic combinations

### No Breaking Changes

- No API changes affecting runtime code
- No changes to benchmark output format
- Existing benchmark scripts will continue to work
- The improvements are backward-compatible enhancements

## Evidence & References

### GitHub PR Details
- PR: https://github.com/paritytech/polkadot-sdk/pull/8567
- Title: "[FRAME] Omni bencher fixes"
- Originated from PR #8265
- Backported to stable2503 branch
- Result: Benchmark failures reduced from 5 to 1 in testing

### Moonbeam Codebase References

**Current frame-omni-bencher usage locations:**

1. CI Workflow configuration:
   ```bash
   /Users/manuelmauro/Workspace/moonbeam/.github/workflows/check-benchmarks.yml
   ```

2. Benchmark execution scripts:
   ```bash
   /Users/manuelmauro/Workspace/moonbeam/scripts/run-benches-for-runtime.sh
   /Users/manuelmauro/Workspace/moonbeam/scripts/benchmarking.sh
   ```

3. All generated weight files (120+ files) contain frame-omni-bencher attribution

**Key Script Usage Pattern:**
```bash
# From scripts/run-benches-for-runtime.sh:52-63
./frame-omni-bencher v1 benchmark pallet \
  --runtime="./target/${profile}/wbuild/${runtime}-runtime/${runtime}_runtime.wasm" \
  --genesis-builder=runtime \
  --genesis-builder-preset=development \
  --steps=50 \
  --repeat=20 \
  --pallet="$PALLET" \
  --extrinsic="*" \
  --wasm-execution=compiled \
  --header=./file_header.txt \
  --template=./benchmarking/frame-weight-template.hbs \
  --output="./runtime/${output}/src/weights" 2>&1
```

This usage pattern is compatible with the PR changes and will benefit from the improved storage overlay handling and deterministic root hash computation.

### Testing Impact

No additional testing required in Moonbeam codebase. The improvements are internal to frame-omni-bencher and will be inherited when updating the tool version. However, teams should monitor for:

1. Reduced benchmark failures in CI
2. More consistent weight values across benchmark runs
3. Improved benchmark execution reliability

## Conclusion

PR #8567 provides quality-of-life improvements to the benchmarking infrastructure. Moonbeam should update to the stable2506 version of frame-omni-bencher to benefit from increased reliability and the new features, but no code changes are required. The improvements are fully backward-compatible and will be inherited automatically.
