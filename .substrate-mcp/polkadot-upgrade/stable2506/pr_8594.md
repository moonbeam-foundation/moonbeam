# PR #8594 Analysis: omni-node: fix `benchmark pallet` to work with `--runtime`

## Overview

**PR Title:** omni-node: fix `benchmark pallet` to work with `--runtime`
**Status:** Merged (June 4, 2025, commit d9e16fd)
**Audience:** Node Dev
**Impact Level:** Medium - Breaking changes to benchmarking CLI

## Summary

This PR improves the flexibility of the `polkadot-omni-node benchmark pallet` command by allowing it to work with the `--runtime` flag alone, without requiring the `--chain` flag and full node configuration instantiation. This brings it in line with `frame-omni-bencher` behavior.

## Changes

### Main Modifications

1. **Made `--chain` flag optional** for `polkadot-omni-node benchmark pallet`
2. **Removed deprecated `run` method** for benchmark pallet from `frame-benchmarking-cli`
3. **Removed restrictions** on using the chain flag in `frame-omni-bencher`
4. **Removed `runtime-benchmarks` feature guards** from benchmark commands

### Crate Version Bumps

| Crate | Bump Type | Significance |
|-------|-----------|--------------|
| `frame-benchmarking-cli` | **MAJOR** | Breaking API changes |
| `polkadot-omni-node-lib` | patch | Minor fixes |
| `frame-omni-bencher` | patch | Minor improvements |
| `polkadot-sdk` | patch | Overall patch |
| `polkadot-omni-node` | patch | Minor fixes |
| `polkadot-parachain-bin` | patch | Minor fixes |

## Impact on Moonbeam

### Direct Dependencies

Moonbeam **directly depends** on `frame-benchmarking-cli`:

**Workspace dependency:**
```toml
# /Users/manuelmauro/Workspace/moonbeam/Cargo.toml:195
frame-benchmarking-cli = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2503" }
```

**Node CLI dependency:**
```toml
# /Users/manuelmauro/Workspace/moonbeam/node/cli/Cargo.toml:20
frame-benchmarking-cli = { workspace = true }
```

### Current Usage in Moonbeam

#### 1. CLI Integration (`/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs`)

Moonbeam uses `frame-benchmarking-cli` for pallet benchmarking:

```rust
// Line 22: Import
use frame_benchmarking_cli::{BenchmarkCmd, SUBSTRATE_REFERENCE_HARDWARE};

// Lines 511-546: Pallet Benchmarking
BenchmarkCmd::Pallet(cmd) => {
    if cfg!(feature = "runtime-benchmarks") {
        let chain_spec = &runner.config().chain_spec;
        match chain_spec {
            #[cfg(feature = "moonriver-native")]
            spec if spec.is_moonriver() => {
                return runner.sync_run(|config| {
                    cmd.run_with_spec::<HashingFor<moonriver_runtime::Block>, HostFunctions>(
                        Some(config.chain_spec),
                    )
                })
            }
            // Similar for moonbeam and moonbase runtimes
        }
    }
}
```

**Key Method Used:** `cmd.run_with_spec()`

#### 2. Benchmarking Script (`/Users/manuelmauro/Workspace/moonbeam/scripts/run-benches-for-runtime.sh`)

Moonbeam's benchmarking workflow uses:

1. **Moonbeam binary** (lines 16-25) - to list pallets:
   ```bash
   ./target/${profile}/moonbeam benchmark pallet \
     --list \
     --runtime="./target/${profile}/wbuild/${runtime}-runtime/${runtime}_runtime.wasm"
   ```

2. **frame-omni-bencher** (line 52) - to run actual benchmarks:
   ```bash
   ./frame-omni-bencher v1 benchmark pallet \
     --runtime="./target/${profile}/wbuild/${runtime}-runtime/${runtime}_runtime.wasm" \
     --genesis-builder=runtime \
     --genesis-builder-preset=development \
     --steps=50 \
     --repeat=20 \
     --pallet="$PALLET" \
     --extrinsic="*" \
     --wasm-execution=compiled
   ```

### Breaking Change Assessment

#### Critical Question

The PR removes a **deprecated `run` method** from `frame-benchmarking-cli`, causing a **MAJOR version bump**.

**Concern:** Does Moonbeam's usage of `run_with_spec()` depend on the removed `run()` method?

**Analysis:**
- Moonbeam uses `BenchmarkCmd::Pallet(cmd).run_with_spec()`
- The PR specifically targets the `run` method, not `run_with_spec`
- However, the major version bump indicates API-level changes
- Need to verify if `run_with_spec` signature or behavior changed

#### Compatibility Verification Needed

Since this is a **MAJOR** bump, Moonbeam will need to:

1. **Review API changes** - Check if `run_with_spec()` method signature changed
2. **Test compilation** - Ensure the code compiles with updated `frame-benchmarking-cli`
3. **Test benchmarking workflow** - Verify that both:
   - `./moonbeam benchmark pallet --list` still works
   - Integration with `frame-omni-bencher` remains functional

## Benefits

### For Polkadot SDK

1. **Improved developer experience** - Can use `--runtime` flag directly without full node config
2. **Consistency** - `polkadot-omni-node` now matches `frame-omni-bencher` behavior
3. **Cleaner API** - Removed deprecated methods

### For Moonbeam

1. **Potential workflow simplification** - If Moonbeam adopts the `--runtime` pattern
2. **Better alignment** - Moonbeam's use of `frame-omni-bencher` benefits from removed restrictions
3. **Future-proof** - Updated to latest benchmarking patterns

## Migration Considerations

### Immediate Actions

1. **Code Review:**
   - Check if `run_with_spec()` API changed in `frame-benchmarking-cli`
   - Review any deprecation warnings from the current Polkadot SDK version

2. **Testing:**
   - Run full benchmarking suite after upgrade
   - Test with all three runtimes: moonbeam, moonriver, moonbase
   - Verify both listing and execution work correctly

3. **Documentation:**
   - Update any internal docs if benchmarking commands change
   - Update CI/CD pipelines if necessary

### Potential Migration Steps

If API changes are needed:

```rust
// Current usage (may need updates)
cmd.run_with_spec::<HashingFor<Runtime::Block>, HostFunctions>(
    Some(config.chain_spec),
)

// Potential new usage (if API changed)
// Check actual SDK documentation for exact changes
```

### Script Updates

The benchmarking script (`run-benches-for-runtime.sh`) should be reviewed:

```bash
# Current: Uses both moonbeam binary and frame-omni-bencher
# May benefit from using --runtime consistently
```

## Risk Assessment

| Risk | Severity | Mitigation |
|------|----------|------------|
| Breaking API changes | **HIGH** | Test compilation and runtime before upgrade |
| Benchmarking workflow breaks | **HIGH** | Comprehensive testing of benchmark script |
| CI/CD pipeline failures | Medium | Update CI configuration as needed |
| Documentation gaps | Low | Review and update documentation |

## Recommendations

### High Priority

1. **Before Upgrade:**
   - [ ] Review the exact API changes in `frame-benchmarking-cli` from Polkadot SDK stable2506
   - [ ] Test compilation with updated dependency
   - [ ] Run benchmarking script on test environment

2. **During Upgrade:**
   - [ ] Update `run_with_spec()` calls if API changed
   - [ ] Address any new compiler warnings or errors
   - [ ] Update imports if module structure changed

3. **After Upgrade:**
   - [ ] Run full benchmarking suite
   - [ ] Verify benchmark weight outputs are correct
   - [ ] Update CI/CD if needed

### Medium Priority

4. **Consider Workflow Improvements:**
   - [ ] Evaluate using `--runtime` flag more consistently
   - [ ] Consider simplifying benchmarking script if new API allows
   - [ ] Review if polkadot-omni-node could replace custom moonbeam binary for some tasks

### Low Priority

5. **Documentation Updates:**
   - [ ] Update CLAUDE.md if benchmarking commands change
   - [ ] Document any new patterns or best practices

## Additional Resources

- **GitHub PR:** https://github.com/paritytech/polkadot-sdk/pull/8594
- **PRDoc Path:** /Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_8594.prdoc
- **Affected Moonbeam Files:**
  - `/Users/manuelmauro/Workspace/moonbeam/Cargo.toml` (workspace dependency)
  - `/Users/manuelmauro/Workspace/moonbeam/node/cli/Cargo.toml` (direct dependency)
  - `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs` (usage)
  - `/Users/manuelmauro/Workspace/moonbeam/scripts/run-benches-for-runtime.sh` (workflow)

## Conclusion

PR #8594 introduces a **MAJOR** breaking change to `frame-benchmarking-cli` that Moonbeam directly depends on. While the changes primarily target the deprecated `run()` method and Moonbeam uses `run_with_spec()`, the major version bump requires careful verification during upgrade.

**Action Required:** Before upgrading to stable2506, Moonbeam must test the benchmarking workflow thoroughly and be prepared to update the CLI integration code if the `run_with_spec()` API has changed.

**Overall Impact:** Medium - Requires attention but likely manageable with proper testing and potential minor code adjustments.
