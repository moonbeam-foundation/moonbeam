# PR #8596: fatxpool: limits handling optimizations and fixes

**Impact**: INHERITED
**Confidence**: High
**Affected Components**: Transaction pool (sc_transaction_pool)

## Changes Detected

PR #8596 introduces optimizations and bug fixes to the fork-aware transaction pool (fatxpool) implementation in Polkadot SDK. The key changes include:

1. **Debug Logging Adjustments**: Changed log levels from `debug -> trace` for transactions and `trace -> debug` for general flow
2. **Transaction Pool Storage Improvements**: Internal TxMemPool storage is now sorted, with new helper methods to reduce transaction clone operations and eliminate inefficient on-the-fly sorting
3. **Concurrency Enhancements**: Migrated mutexes to `tokio::sync::Mutex`, implemented sync-to-async message-based bridge
4. **Architectural Refinements**: `ViewStore::most_recent_view` is now a reference to `View`, removed `TXMEMPOOL_TRANSACTION_LIMIT_MULTIPLIER` constant, fixed bug in pre-insert actions removal
5. **Validation Process Optimization**: Added `ValidateTransactionPriority` to balance processing between maintain and submit+revalidate contexts
6. **Instant Seal Fix**: Creates a view for the known best block during fatxpool instantiation, fixing instant-seal nodes where block building is triggered via transaction import

## Project Impact

**No action required.** This PR contains internal optimizations and bug fixes to the fork-aware transaction pool that Moonbeam already uses. The changes are:

- **Internal Implementation Details**: All modifications are within the transaction pool's internal logic and do not affect public APIs or configuration interfaces
- **Performance Improvements**: The optimizations (sorted storage, reduced clones, better mutex usage) will automatically benefit Moonbeam without requiring code changes
- **Bug Fixes**: The instant-seal fix and pre-insert action bug fixes will be automatically inherited

### Moonbeam's Transaction Pool Configuration

Moonbeam uses the fork-aware transaction pool explicitly in test/zombienet configurations:

- `/Users/manuelmauro/Workspace/moonbeam/zombienet/configs/moonbeam-polkadot.toml:40`: `--pool-type=fork-aware`
- `/Users/manuelmauro/Workspace/moonbeam/test/configs/localZombie.json:57`: `--pool-type=fork-aware`
- `/Users/manuelmauro/Workspace/moonbeam/test/configs/zombieMoonbeam.json:58,71`: `--pool-type=fork-aware`
- `/Users/manuelmauro/Workspace/moonbeam/test/configs/zombieMoonriver.json:58,71`: `--pool-type=fork-aware`
- `/Users/manuelmauro/Workspace/moonbeam/test/configs/zombieAlphanet.json:58,71`: `--pool-type=fork-aware`

### Transaction Pool Implementation in Moonbeam

Moonbeam uses the standard Substrate transaction pool without customization:

```rust
// /Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:544-551
let transaction_pool = sc_transaction_pool::Builder::new(
    task_manager.spawn_essential_handle(),
    client.clone(),
    config.role.is_authority().into(),
)
.with_options(config.transaction_pool.clone())
.with_prometheus(config.prometheus_registry())
.build();
```

The transaction pool is created using the standard builder pattern with no custom wrappers or internal pool modifications. The pool type (fork-aware vs single-state) is determined by command-line arguments, and Moonbeam explicitly uses `--pool-type=fork-aware` in its configurations.

## Evidence & References

### Search Results

1. **Transaction Pool Usage**:
   - `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:105`: Type alias `sc_transaction_pool::TransactionPoolHandle<Block, Client>`
   - `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:544-551`: Standard builder instantiation
   - `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:987`: Usage in consensus

2. **Fork-Aware Pool Configuration**:
   - Multiple zombienet test configurations explicitly set `--pool-type=fork-aware`
   - No custom transaction pool implementation found in codebase
   - No direct interaction with fatxpool internal structures

3. **Related PRs**:
   - PR #8479 mentioned issues with both SingleState and ForkAware pools, where transactions could be marked invalid prematurely
   - PR #8498 modified internal transaction pool logic (graph/ready.rs) without changing public APIs

### GitHub PR Details

From the PR description, the changes are focused on:
- Internal optimizations to reduce memory allocations and improve sorting efficiency
- Concurrency improvements for better async/sync interop
- Bug fixes for instant-seal mode and view management
- No breaking changes to public APIs

## Recommendation

**INHERITED** - No action required. These optimizations and bug fixes will automatically apply to Moonbeam's fork-aware transaction pool usage. The changes improve performance and fix bugs without requiring any code modifications in the Moonbeam codebase.

The instant-seal fix is particularly relevant since Moonbeam uses instant-seal mode for development (see `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:1235` and README.md documentation about instant-seal mode).
