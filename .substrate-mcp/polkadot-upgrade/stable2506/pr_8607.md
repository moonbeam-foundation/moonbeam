# PR #8607: Bump memory-db

**Impact**: INHERITED
**Confidence**: High
**Affected Components**: None directly (indirect performance improvement)

## Changes Detected

This PR bumps the `memory-db` dependency to incorporate upstream changes from:
- PR #8606: Use hashbrown HashMap/HashSet in validation context
- paritytech/trie#221: Internal trie library improvements
- Also bumps `polkavm` dependency to resolve GitHub Actions workflow issues

The key technical change is replacing BTreeMap/BTreeSet with hashbrown HashMap/HashSet in:
- TrieCache
- TrieRecorder
- memory-db internals

This change provides significant performance improvements:
- ~40% improvement in read costs
- ~20% improvement in write costs

The affected crate in Polkadot SDK is `cumulus-pallet-parachain-system` (minor bump).

## Project Impact

**No code changes required for Moonbeam.**

This is a dependency bump with no breaking API changes. The performance improvements are automatically inherited when Moonbeam updates to stable2506.

### Verification

1. **No Direct Dependencies**: Moonbeam does not directly depend on `memory-db` or `polkavm` in its Cargo.toml files. These are transitive dependencies through Polkadot SDK.

2. **No Custom Trie Code**: Moonbeam does not implement custom TrieCache or TrieRecorder logic that would be affected by the internal data structure change.

3. **ParachainSystem Usage**: Moonbeam uses `cumulus-pallet-parachain-system` in all three runtimes (moonbase, moonriver, moonbeam), but the pallet's public API remains unchanged. The internal performance improvements are transparent to consumers.

4. **Existing Hashbrown Optimization**: Moonbeam already has `hashbrown = { opt-level = 3 }` in its root Cargo.toml, showing awareness and optimization of hashbrown usage.

5. **Lazy Loading Backend**: The custom lazy loading backend in `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lazy_loading/substrate_backend.rs` uses:
   - Standard library HashMap and HashSet (lines 30-33, 111, 936, 943, 1404)
   - TrieCacheContext from sc_client_api (already adapted in previous PR)
   - PrefixedMemoryDB from sp_trie (line 53, 955, 1175)

   None of these are affected by the internal memory-db changes.

## Evidence & References

### Codebase Search Results

**memory-db references** (only in Cargo.lock):
```
/Users/manuelmauro/Workspace/moonbeam/Cargo.lock
name = "memory-db"
version = "0.34.0"
```

**polkavm references** (only in Cargo.lock):
```
/Users/manuelmauro/Workspace/moonbeam/Cargo.lock
name = "polkavm"
version = "0.21.0"
name = "polkavm"
version = "0.24.0"
```

**cumulus-pallet-parachain-system usage** (in all runtimes):
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs`

Example from moonbase runtime:
```rust
impl cumulus_pallet_parachain_system::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type OnSystemEvent = ();
    type SelfParaId = ParachainInfo;
    type ReservedDmpWeight = ReservedDmpWeight;
    type OutboundXcmpMessageSource = XcmpQueue;
    // ... standard configuration
}
```

**No custom trie implementations**: The only TrieCache/TrieRecorder-related code is the import of TrieCacheContext in the lazy loading backend, which is a separate concern.

## Related PRs

- PR #8606: The actual implementation of hashbrown HashMap/HashSet in validation context
- PR #9127: Follow-up to add block hash randomness to the hasher for additional security

## Recommendation

**Action**: None required. Update to stable2506 will automatically include these dependency bumps and inherit the ~40% read and ~20% write performance improvements in validation contexts.

**Testing**: Standard runtime upgrade testing should be sufficient. The performance improvements are beneficial and transparent to Moonbeam's code.
