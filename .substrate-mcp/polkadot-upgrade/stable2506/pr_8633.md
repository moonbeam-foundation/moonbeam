# PR #8633: Staking (EPMB) - Update elect() and Phase::Export(N) Semantics

## Overview

**PR Title:** Staking (EPMB): update the semantics of elect() and Phase::Extract(N)

**Source:** https://github.com/paritytech/polkadot-sdk/pull/8633

**Author:** sigurpol

**Status:** Merged (May 30, 2025)

**Audience:** Runtime Dev

**Crate:** `pallet-election-provider-multi-block`

**Breaking Change:** Yes (major bump)

## Summary

This PR refactors the election-provider-multi-block (EPMB) pallet to consolidate all `Phase::Export` transition logic within the `elect()` function. Previously, this responsibility was split between EPMB's `on_initialize()/next()` and the `elect()` calls triggered by the staking-async pallet, leading to potential race conditions when pallet initialization order varied.

## Technical Changes

### New elect(N) Semantics

The PR updates the semantics of `elect(N)` and the `Phase::Export(N)` state:

- Calling `elect(N)` now means the system expects to serve results for page N
- After serving page N, the system transitions to `Phase::Export(N-1)` if N > 0, or to `Phase::Off` if N == 0

### Election Flow Example

For a 4-page election, the new flow is:

1. `elect(3)`: If in Done, serve result for page 3, transition to Export(2)
2. `elect(2)`: If in Export(2), serve result for page 2, transition to Export(1)
3. `elect(1)`: If in Export(1), serve result for page 1, transition to Export(0)
4. `elect(0)`: If in Export(0), serve result for page 0, transition to Off

### Problem Addressed

The change fixes an issue where multiple phase transitions could occur within a single block when the staking-async pallet was initialized before EPMB:

**Old Behavior (Block X):**
1. staking-async's `on_initialize()` calls `elect(N)` → forces transition `Done` → `Export(N)`
2. EPMB's `on_initialize()` calls `next()` → forces transition `Export(N)` → `Export(N-1)` within the same block

This caused inconsistent state transitions depending on pallet initialization order.

**New Behavior:**
All phase transitions now happen exclusively within `elect()`, eliminating the race condition.

## Key Discussion Points

### Error Handling

Reviewers questioned whether the phase should advance if `elect()` returns an error. The resolution maintained the original behavior of advancing unconditionally to maintain compatibility with staking-async's pagination logic.

### Missing Pages

The PR acknowledges that unsigned submissions may not provide all pages. Specific test coverage was added to ensure robustness in these scenarios.

## Impact on Moonbeam

### Assessment: NO IMPACT

**Reasoning:**

1. **Moonbeam Does Not Use EPMB**: Analysis of Moonbeam's runtime configuration confirms that the `pallet-election-provider-multi-block` is not included in any of the three runtime variants (moonbeam, moonriver, moonbase).

2. **Different Staking Model**: Moonbeam uses its own parachain-specific staking system (`pallet-parachain-staking`), which is fundamentally different from the relay chain's staking system that uses EPMB.

3. **Relay Chain Staking**: While Moonbeam's `relay-encoder` module includes references to `pallet_staking`, these are solely for encoding relay chain staking calls for XCM transactions. The relay-encoder does not interact with or depend on the EPMB pallet.

4. **No Dependencies**: None of Moonbeam's pallets, precompiles, or runtime components depend on the EPMB pallet or the staking-async pallet.

### Verification

```bash
# Search for EPMB usage in Moonbeam runtime
grep -r "election-provider-multi-block\|ElectionProviderMultiBlock" runtime/
# Result: No matches in runtime configuration

# Verify pallet usage in runtime
grep -r "construct_runtime" runtime/{moonbase,moonbeam,moonriver}/src/lib.rs
# Result: No EPMB pallet included in any runtime
```

## Required Actions

**None** - This PR requires no action from the Moonbeam team.

## Recommendations

1. **No Changes Needed**: This PR can be safely ignored as it does not affect Moonbeam's functionality.

2. **Monitoring**: If Moonbeam ever plans to integrate with relay chain staking mechanisms directly (beyond XCM encoding), this semantic change should be reviewed at that time.

3. **Documentation**: No documentation updates required as Moonbeam does not use this pallet.

## Additional Context

### Related Pallets

- `pallet-election-provider-multi-block`: The pallet modified by this PR
- `pallet-staking-async`: The pallet that calls `elect()` to trigger phase transitions
- `pallet-staking`: The relay chain staking pallet that uses EPMB as its election provider

### Election Provider Context

The EPMB pallet is part of Polkadot SDK's validator election mechanism for relay chains. It provides a multi-block election process that:
- Distributes computational work across multiple blocks
- Supports paginated result delivery
- Integrates with the relay chain's NPoS (Nominated Proof of Stake) system

Parachains like Moonbeam typically do not use this system as they have their own consensus and validator selection mechanisms appropriate for their specific use cases.

## Conclusion

PR #8633 is a relay chain-specific improvement that consolidates phase transition logic in the EPMB pallet. Since Moonbeam operates as a parachain with its own staking system and does not use the EPMB pallet, this change has no impact on Moonbeam's runtime, client, or functionality.

**Impact Level:** None

**Action Required:** None

**Review Priority:** Low (informational only)
