# PR #8650: litep2p/peerset: Reject non-reserved peers in the reserved-only mode

**Impact**: INHERITED
**Confidence**: High
**Affected Components**: Node networking layer (sc-network)

## Changes Detected

This PR fixes a bug in the litep2p notification peerset where non-reserved peers were not properly rejected in reserved-only mode. Previously, litep2p ignored the reserved-only state when accepting inbound connections, though it handled it properly during slot allocation.

**Key changes:**
- Modified `report_inbound_substream` function to propagate a `Rejected` response in reserved-only mode
- Ensures litep2p will not open inbound substreams after receiving a rejected response
- Peer states are not advanced while in `Disconnected` or `Backoff` states
- Opening state is moved to `Cancelled`
- Replaced a panic with `debug_assert` in `report_substream_opened` for robustness

**Component affected:** `sc-network` crate (patch bump)

## Project Impact

**No code changes required** - This is a bugfix that will be automatically inherited through the Polkadot SDK dependency update.

### Usage in Moonbeam

Moonbeam uses the `--reserved-only` flag in several contexts:

1. **Test configurations** (`/Users/manuelmauro/Workspace/moonbeam/test/moonwall.config.json`):
   - Lines 387, 445, 489, 533, 573, 611: Multiple test environments use `--reserved-only` flag

2. **CI/CD workflows** (`/Users/manuelmauro/Workspace/moonbeam/.github/workflows/subxt-diff.yml`):
   - Lines 71, 89: GitHub workflows use `--reserved-only` for testing

3. **Network layer integration** (`/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs`):
   - Line 66: Imports `sc_network::{config::FullNetworkConfiguration, NetworkBackend, NetworkBlock}`
   - Lines 713-716, 1173: Creates `FullNetworkConfiguration` for network setup
   - Standard Substrate networking integration without custom peerset logic

### What This Fixes

When Moonbeam nodes are run with `--reserved-only` mode:
- **Before**: Non-reserved peers could establish inbound connections improperly
- **After**: Non-reserved peers are correctly rejected at connection time

This improves security and consistency for reserved-only mode operations, particularly important for:
- Test environments that use reserved-only networking
- Production collators that may use reserved peer configurations
- Any scenario where network topology needs strict control

### No Breaking Changes

This is a bugfix in internal litep2p/peerset logic with no API changes. The fix:
- Does not modify public interfaces
- Does not change configuration options
- Does not affect normal (non-reserved-only) operations
- Only corrects behavior that was already intended but improperly implemented

## Evidence & References

**Moonbeam dependency:**
```toml
# /Users/manuelmauro/Workspace/moonbeam/Cargo.toml:206
sc-network = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2506" }
```

**Reserved-only usage in tests:**
```json
// /Users/manuelmauro/Workspace/moonbeam/test/moonwall.config.json
"--reserved-only"  // Used in 6+ test configurations
```

**Network configuration:**
```rust
// /Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:713-716
let net_config = FullNetworkConfiguration::<_, _, Net>::new(
    &parachain_config.network,
    prometheus_registry.clone(),
);
```

## Recommendation

**Action:** Accept this change as part of the stable2506 upgrade.

**Rationale:**
1. Bugfix improves correctness of reserved-only mode used in Moonbeam tests
2. No API changes or breaking modifications
3. Enhances security and reliability of network peerset management
4. Automatically inherited through sc-network dependency update
5. Benefits Moonbeam's test infrastructure that actively uses `--reserved-only` flag

**Testing:** Existing tests using `--reserved-only` flag should continue to work and will benefit from the improved peer rejection behavior.
