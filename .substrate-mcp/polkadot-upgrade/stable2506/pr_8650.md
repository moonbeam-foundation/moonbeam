# PR #8650: litep2p/peerset - Reject Non-Reserved Peers in Reserved-Only Mode

## Overview

**PR Link**: https://github.com/paritytech/polkadot-sdk/pull/8650
**Type**: Bug Fix / Security Improvement
**Severity**: Medium
**Affected Crate**: `sc-network` (patch bump)
**Audience**: Node Operator

## Summary

This PR fixes a security/correctness bug in litep2p's notification peerset where non-reserved peers were not being properly rejected when the node operates in reserved-only mode. Previously, litep2p completely ignored the reserved-only state during inbound connection acceptance, though it correctly enforced the restriction during slot allocation.

## Problem Description

### Root Cause
The litep2p peerset had inconsistent handling of the reserved-only mode:
- **During inbound connection acceptance**: The reserved-only state was completely ignored, allowing non-reserved peers to establish connections
- **During slot allocation**: The reserved-only mode was properly enforced

This inconsistency created a security/operational issue where nodes configured to only accept connections from a predefined set of trusted peers (reserved-only mode) would inadvertently accept connections from non-reserved peers.

### Affected Components
- **litep2p Networking Stack**: The notification peerset component
- **Reserved-Only Mode**: Nodes configured to only communicate with specific trusted peers
- **sc-network**: The Substrate networking layer

### Impact Scope
Nodes operating in reserved-only mode that use litep2p as their network backend were vulnerable to accepting connections from non-reserved peers, potentially:
- Consuming network resources unnecessarily
- Exposing the node to unwanted peer connections
- Violating operational security policies

## Changes Made

### Core Fixes

**1. Enhanced `report_inbound_substream` Function**
- Now propagates a `Rejected` response to litep2p when in reserved-only state
- Prevents peer state advancement while in `Disconnected` or `Backoff` states
- Moves opening state to `Cancelled` when rejecting connections
- litep2p should never open an inbound substream after receiving the rejected response

**2. Improved `report_substream_opened` Robustness**
- More robust handling of the `Disconnected` state
- Replaced a panic with `debug_assert` and immediate rejection for better error handling
- Ensures consistent behavior for fuzzing purposes

### Testing
- Manual testing with 2 nodes on Kusama and Polkadot using litep2p
- Added `reserved_only_rejects_non_reserved_peers` test to verify proper peer handling across different states
- Extracted from larger PR #8461 to facilitate focused review

## Impact on Moonbeam

### Current Status
**IMMEDIATE IMPACT: NONE**

Moonbeam is currently **not affected** by this issue because:

1. **Moonbeam uses libp2p, not litep2p**: As documented in PR #8461 analysis, Moonbeam explicitly specifies the libp2p network backend:
   - Production nodes: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:L1115`
     ```rust
     start_node_impl::<RuntimeApi, Customizations, sc_network::NetworkWorker<_, _>>(
     ```
   - Development nodes: `/Users/manuelmauro/Workspace/moonbeam/node/cli/src/command.rs` (multiple locations)

2. **This is a litep2p-specific bug**: The fix only applies to the litep2p network backend

### Future Relevance
**BECOMES RELEVANT IF MIGRATING TO LITEP2P**

If Moonbeam decides to migrate to litep2p (as suggested in PR #8461 analysis for performance benefits), this fix becomes important **only if** Moonbeam operates nodes in reserved-only mode:

**Reserved-Only Mode Use Cases**:
- **Validator/Collator Security**: Restricting connections to known, trusted peers only
- **Private Networks**: Operating test or staging environments with controlled peer sets
- **Partner Nodes**: Establishing dedicated connections between consortium members

**Moonbeam's Typical Configuration**:
- Moonbeam is a **public parachain** on Polkadot/Kusama
- Collators typically accept connections from any peer (not reserved-only mode)
- Reserved-only mode is more common for validators or private enterprise deployments

### Risk Assessment
**CURRENT RISK: NONE** (Moonbeam uses libp2p)
**FUTURE RISK: LOW** (Only affects reserved-only mode, which Moonbeam likely doesn't use for public collators)

### Migration Considerations

If Moonbeam plans to migrate to litep2p AND use reserved-only mode:

**Benefits of This Fix**:
1. **Security**: Properly enforces connection restrictions
2. **Resource Management**: Prevents unwanted peer connections from consuming network resources
3. **Compliance**: Ensures operational policies for peer restrictions are properly enforced

**Testing Requirements**:
- Verify reserved-only mode configuration works correctly (if used)
- Test peer rejection behavior during connection attempts
- Monitor connection logs to ensure only reserved peers are accepted

## Technical Details

### Files Changed
- `substrate/client/network/src/litep2p/peerset.rs` (primary changes in `report_inbound_substream` and `report_substream_opened`)

### Code Flow

**Before the Fix**:
```
Inbound connection → Accept (ignores reserved-only state)
                   → Slot allocation → Reject if reserved-only
                   → Connection already established (wasted resources)
```

**After the Fix**:
```
Inbound connection → Check reserved-only state
                   → Reject immediately if non-reserved peer
                   → Propagate Rejected response to litep2p
                   → Connection never established
```

### State Transitions
The fix ensures proper state handling:
- `Disconnected` state: No state advancement
- `Backoff` state: No state advancement
- `Opening` state: Moved to `Cancelled` upon rejection
- Litep2p receives `Rejected` response and avoids opening substreams

## Related PRs
- **Extracted from**: PR #8461 (Use litep2p as the default network backend)
- **Backported to**: stable2412, stable2503 branches
- **Part of**: litep2p networking improvements

## Recommendations

### For Current Stable2506 Upgrade
**Action**: ACCEPT

**Rationale**:
1. This is a bug fix with no breaking changes (patch bump)
2. No immediate impact on Moonbeam (uses libp2p)
3. Includes this fix now ensures future-proofing if litep2p migration happens
4. No downsides to including a security/correctness improvement

### For Future litep2p Migration (If Pursued)

**If NOT using reserved-only mode** (typical for public parachains):
- No action required
- This fix provides robustness but doesn't affect normal operation

**If USING reserved-only mode** (private deployments, validator security):
- This fix is **critical** for proper operation
- Test thoroughly to ensure peer restrictions work as expected
- Monitor connection logs to verify only reserved peers connect

### Testing Checklist (If Using Reserved-Only Mode)

- [ ] Configure node with reserved-only mode and reserved peers list
- [ ] Attempt connection from non-reserved peer (should be rejected)
- [ ] Verify reserved peers can connect successfully
- [ ] Check logs for proper rejection messages
- [ ] Monitor resource usage (should not increase from rejected peers)
- [ ] Test peer addition/removal from reserved list dynamically

## Relevant Context

### What is Reserved-Only Mode?
A network configuration where a node only accepts connections from a predefined list of trusted peer nodes. This is useful for:
- **Private Networks**: Test environments, staging networks
- **Validator Security**: Limiting attack surface by only connecting to known peers
- **Enterprise Deployments**: Controlled peer-to-peer networks
- **Consortium Chains**: Restricting communication to consortium members

### libp2p vs litep2p
- **libp2p**: Original Substrate network backend, battle-tested, currently used by Moonbeam
- **litep2p**: New high-performance network backend, now default in Polkadot SDK
- **Performance**: litep2p offers ~2x lower CPU usage and ~4x faster peer discovery
- **Migration**: Moonbeam may migrate to litep2p in future releases for performance benefits

## Conclusion

This PR fixes a legitimate bug in litep2p's reserved-only mode enforcement. While it has **no immediate impact** on Moonbeam (which uses libp2p), it should be included in the stable2506 upgrade as:

1. It's a patch-level bug fix with no breaking changes
2. It future-proofs Moonbeam if a litep2p migration is pursued
3. It improves overall networking stack quality
4. There are no downsides to including this fix

**Verdict**: APPROVE and INCLUDE in upgrade (no action required for current Moonbeam deployment)

## Additional Resources

- **PR #8461 Analysis**: Details about litep2p becoming the default backend and Moonbeam's current use of libp2p
- **Original PR**: https://github.com/paritytech/polkadot-sdk/pull/8650
- **Related Issue**: Extracted from #8461 for easier review
- **Test Coverage**: `reserved_only_rejects_non_reserved_peers` test added
