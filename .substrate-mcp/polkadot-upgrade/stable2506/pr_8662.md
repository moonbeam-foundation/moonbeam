# PR #8662 Analysis: Update Dry-Run Logic in pallet-revive

## Overview

**PR Title:** `[pallet-revive] update dry-run logic`
**Status:** Merged (June 2, 2025)
**Audience:** Runtime Dev
**GitHub:** https://github.com/paritytech/polkadot-sdk/pull/8662
**Related:** Reverts PR #8504 and supersedes it with a new approach

## Summary

This PR reverts PR #8504 and introduces a cleaner architectural solution to the contract address derivation problem in pallet-revive. Instead of maintaining separate execution logic for dry-runs versus actual transactions, it introduces a `prepare_dry_run` function that standardizes state preparation before dry-run execution.

## Problem Context

### Original Issue (From PR #8504)
When dry-running a contract deployment through the runtime API, the returned contract address did not match the actual address created during real transaction execution. The mismatch occurred because:

1. During real transactions, nonces are incremented pre-dispatch
2. During dry-runs, nonces remain unchanged
3. Address derivation logic needed to account for this difference

### Why PR #8504 Was Reverted

PR #8504 solved the problem by adding execution context awareness (`ExecContext::Transaction` vs dry-run) throughout the call chain. However, this approach:

- Created separate code paths for execution vs. dry-running
- Made the codebase harder to maintain
- Contradicted the principle that dry-runs should simulate actual execution as closely as possible
- Would complicate future features like prestate tracing, which also needs to track nonce changes

## New Solution: `prepare_dry_run`

### Architecture

The new approach introduces a `prepare_dry_run` function that runs **before** `bare_call` and `bare_instantiate` during dry-run operations.

**Key Concept:** Instead of handling execution context differences inside the execution logic, prepare the state beforehand to match what would happen during real execution.

### What `prepare_dry_run` Does

```rust
// Pseudocode representation
fn prepare_dry_run() {
    // Simulate transaction extension pre-dispatch logic
    // Specifically: bump the nonce as would happen in a real transaction
    account_nonce += 1;
}
```

This ensures that by the time the dry-run execution occurs, the account state (particularly the nonce) matches what it would be during a real transaction's execution phase.

### Benefits

1. **Unified Code Path:** The same execution logic handles both real and dry-run transactions
2. **Simplified Maintenance:** No need to pass execution context through multiple layers
3. **Future-Proof:** Enables features like prestate tracing that need to collect state changes
4. **Cleaner Architecture:** State preparation is separated from execution logic
5. **Better Simulation:** Dry-runs more accurately reflect real execution conditions

## Technical Details

### Modified Components
- `substrate/frame/revive/src/exec.rs` - Reverted context-aware address derivation
- `substrate/frame/revive/src/call_builder.rs` - Removed execution context passing
- Added `prepare_dry_run` function to handle pre-execution state setup
- Runtime API implementations updated to call `prepare_dry_run` before dry-runs

### Execution Flow Comparison

**Before (PR #8504):**
```
RPC Dry-Run Request
  → bare_call(exec_context=DryRun)
    → create_account(exec_context=DryRun)
      → address_derivation(nonce - if exec_context==Transaction else nonce)
```

**After (PR #8662):**
```
RPC Dry-Run Request
  → prepare_dry_run()  // Bumps nonce
    → bare_call()      // No context needed
      → create_account()
        → address_derivation(nonce - 1)  // Always subtracts, nonce already bumped
```

## Affected Crates

| Crate | Bump Type | Impact |
|-------|-----------|--------|
| `pallet-revive` | major | Core architectural change |

Note: Major bump indicates breaking API changes to the pallet's dry-run interface.

## Commit History

- **26 commits** merged into master
- **256 total checks**, 246 passed
- **Label:** T7-smart_contracts
- **Final Commit:** fb41dde

## Code Review

**Approved by:**
- athei
- castillax
- xermicus

All three reviewers agreed this approach was superior to the execution-context-based solution.

## Impact on Moonbeam

### Relevance Assessment
**NONE** - This PR has zero impact on Moonbeam.

### Why No Impact

**Moonbeam does not use `pallet-revive`.**

Moonbeam's smart contract architecture:
- **EVM Contracts:** Uses `pallet-evm` from the Frontier project
- **Ethereum Compatibility:** Uses `pallet-ethereum` for transaction handling
- **Substrate Integration:** Custom precompiles bridge Substrate and EVM

`pallet-revive` is Polkadot SDK's RISC-V/PolkaVM-based smart contract pallet, which is architecturally different from EVM-based systems.

### Verification

```bash
# Search confirms no usage of pallet-revive in Moonbeam
$ rg "pallet-revive" Cargo.toml runtime/
# No matches found
```

## Migration Requirements

**None** - No action required for Moonbeam:
- No code changes needed
- No runtime updates necessary
- No storage migrations required
- No API compatibility concerns

## Architectural Insights for Moonbeam

While this PR doesn't directly affect Moonbeam, the architectural pattern is noteworthy:

### Pattern: State Preparation vs. Context Passing

**Problem:** Dry-runs need different initial state than real execution
**Solution Options:**
1. ❌ Pass execution context everywhere (PR #8504 approach)
2. ✅ Prepare state before execution (PR #8662 approach)

**Lesson:** When simulating execution, prepare the simulation environment rather than modifying execution logic.

### Relevance to Moonbeam

Moonbeam's EVM tracing and simulation features (`debug_traceTransaction`, `eth_call`) face similar challenges. The `prepare_dry_run` pattern could inform improvements to:
- EVM state simulation in `pallet-evm`
- Transaction dry-run accuracy
- Debugging and tracing features

## Related PRs

- **PR #8504:** "Fix generated address returned by Substrate RPC runtime call" (Reverted)
  - Analysis: `/Users/manuelmauro/Workspace/moonbeam/.substrate-mcp/polkadot-upgrade/stable2506/pr_8504.md`
- **PR #8587:** "[pallet-revive] make subscription task panic on error"
  - Related to pallet-revive RPC improvements

## References

- **Issue:** https://github.com/paritytech/contract-issues/issues/37
- **Superseded PR:** #8504
- **Merge Commit:** fb41dde

## Conclusion

PR #8662 represents a significant architectural improvement to pallet-revive's dry-run logic. By reverting PR #8504's context-passing approach in favor of state preparation via `prepare_dry_run`, it achieves:

1. Cleaner, more maintainable code
2. Better simulation accuracy
3. Support for advanced features like prestate tracing

**For Moonbeam:** This PR requires no action as Moonbeam uses EVM-based contracts (`pallet-evm`) rather than RISC-V contracts (`pallet-revive`). However, the architectural pattern of preparing simulation state rather than passing execution context is a valuable insight for any blockchain system implementing transaction simulation or tracing features.

## Action Items

- [ ] **None** - No changes required for Moonbeam's stable2506 upgrade
- [ ] **Optional:** Consider reviewing Moonbeam's EVM simulation/tracing logic to see if similar state-preparation patterns would be beneficial
