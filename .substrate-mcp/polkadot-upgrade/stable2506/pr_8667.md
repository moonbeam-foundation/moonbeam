# PR #8667: revive: Simplify the storage meter

## Metadata
- **PR Number**: 8667
- **Title**: revive: Simplify the storage meter
- **Author**: @athei
- **Status**: Merged (May 27, 2025)
- **Labels**: T7-smart_contracts
- **Audience**: Runtime Dev
- **Crate**: pallet-revive (patch bump)
- **GitHub**: https://github.com/paritytech/polkadot-sdk/pull/8667

## Summary

This PR simplifies the storage deposit metering logic in `pallet-revive` by decoupling storage deposit limits from the origin's account balance. Previously, the code had legacy complexity from when storage deposits were collected in an infallible context, requiring the deposit limit to be capped at the origin's maximum balance.

## Technical Changes

### 1. **Decoupled Limits from Balance**
- The root storage meter and all nested meters' limits are now completely independent of the origin's balance
- Makes it easier to reason about limits for nested meters at any point in execution
- Removes conflation between deposit limit (a safety parameter) and available balance (a state variable)

### 2. **Consistent Error Handling**
- Standardized error codes:
  - `StorageDepositNotEnoughFunds`: Used when limit has not been reached but funds are insufficient
  - `StorageDepositLimitExhausted`: Used when the specified limit has been reached
- Origin unable to pay the existential deposit (ED) for a new account now returns `StorageDepositNotEnoughFunds` and traps the caller
- Changed from `TransferFailed` return code to trap since ED is hidden from contracts

### 3. **Fallible Collection Context**
- Leverages the fact that deposit collection is now fallible (changed in earlier work)
- Removes unnecessary complexity that was kept from the infallible era

## Impact on Moonbeam

### Direct Impact: **NONE**

Moonbeam does not use `pallet-revive`. This pallet is part of the new Polkadot SDK contracts framework (successor to `pallet-contracts`).

**Moonbeam's architecture**:
- Uses `pallet-evm` for Ethereum-compatible smart contracts
- Does not integrate `pallet-revive` or `pallet-contracts`
- Has its own gas metering and storage cost model through the EVM implementation

### Indirect Considerations

While this PR doesn't affect Moonbeam directly, it demonstrates:

1. **Pattern Evolution**: Shows how Polkadot SDK is evolving storage deposit patterns
2. **Error Handling**: Improvements in distinguishing between limit exhaustion vs. insufficient funds
3. **Nested Contexts**: Better handling of nested execution contexts (relevant for any nested call patterns)

These patterns could inform future improvements in Moonbeam's own storage metering or nested execution contexts (e.g., in precompiles that make subcalls).

## Risk Assessment

**Risk Level**: NONE

- No changes required in Moonbeam codebase
- No migration needed
- No API changes affecting Moonbeam

## Related Work

This PR is in preparation for: https://github.com/paritytech/contract-issues/issues/38

## Review Notes

**Key Discussion Point**: Can refunds ever fail?

**Answer** (@athei): Yes, refunds can fail in scenarios where:
- The limit exceeds the origin's balance
- Balance is transferred away via precompile calls during execution

Tests have been added to exercise these failure scenarios.

## Action Items

- [ ] No action required for Moonbeam
- [ ] Monitor future PRs related to contract-issues#38 for potential patterns

## Conclusion

This PR improves the internal consistency and maintainability of `pallet-revive`'s storage metering but has no impact on Moonbeam's runtime or functionality. It's a good example of technical debt cleanup in the contracts pallet that doesn't affect EVM-based chains.
