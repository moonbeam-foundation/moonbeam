# PR #8669: cumulus-aura: Improve equivocation checks

**Impact**: INHERITED
**Confidence**: High
**Affected Components**: None (Moonbeam uses Nimbus consensus, not Aura)

## Changes Detected

This PR improves equivocation checks in cumulus-client-consensus-aura by:
- Checking not just the slot, but also the block number and relay parent when detecting equivocations
- Allowing multiple blocks to be built per slot
- Ensuring blocks can still be imported from availability recovery
- Preventing network stagnation during equivocation events

The PR modifies three crates:
- cumulus-client-consensus-aura (patch bump)
- cumulus-client-pov-recovery (no bump)
- cumulus-pallet-parachain-system (no bump)

Future work mentioned includes implementing on-chain slashing for equivocations and disabling offending authors.

## Project Impact

**No direct impact on Moonbeam.**

Moonbeam uses **Nimbus consensus**, not Aura consensus. This is a critical architectural difference:

1. **Consensus Layer**: Moonbeam uses nimbus-consensus from the Moonkit repository, not cumulus-client-consensus-aura
   - Evidence: `/Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:1056` uses `nimbus_consensus::collators::lookahead::run`
   - Evidence: `/Users/manuelmauro/Workspace/moonbeam/Cargo.toml:73` includes `nimbus-consensus = { git = "https://github.com/Moonsong-Labs/moonkit", branch = "moonbeam-polkadot-stable2506" }`

2. **No Aura Dependencies**: The codebase does not use cumulus-client-consensus-aura at all
   - Searched for `cumulus-client-consensus-aura` and `cumulus_client_consensus_aura` - no matches found
   - Searched for `aura` in Cargo.toml files - no matches found

3. **Parachain System Pallet**: While Moonbeam does use cumulus-pallet-parachain-system (which is mentioned in the PR), the PR shows no version bump for this pallet, indicating no interface changes

4. **POV Recovery**: Moonbeam's Cargo.lock includes cumulus-client-pov-recovery as a transitive dependency, but the PR shows no version bump, indicating no breaking changes

## Evidence & References

### Nimbus Consensus Usage
```rust
// /Users/manuelmauro/Workspace/moonbeam/node/service/src/lib.rs:1044-1084
log::info!("Collator started with asynchronous backing.");
let client_clone = client.clone();
let code_hash_provider = move |block_hash| {
    client_clone
        .code_at(block_hash)
        .ok()
        .map(polkadot_primitives::ValidationCode)
        .map(|c| c.hash())
};
task_manager.spawn_essential_handle().spawn(
    "nimbus",
    None,
    nimbus_consensus::collators::lookahead::run::<Block, _, _, _, FullBackend, _, _, _, _, _, _>(
        nimbus_consensus::collators::lookahead::Params {
            additional_digests_provider: maybe_provide_vrf_digest,
            additional_relay_keys: vec![
                moonbeam_core_primitives::well_known_relay_keys::TIMESTAMP_NOW.to_vec(),
                relay_chain::well_known_keys::EPOCH_INDEX.to_vec(),
            ],
            authoring_duration: block_authoring_duration,
            block_import,
            code_hash_provider,
            collator_key,
            collator_service,
            create_inherent_data_providers,
            force_authoring,
            keystore,
            overseer_handle,
            para_backend: backend,
            para_client: client,
            para_id,
            proposer,
            relay_chain_slot_duration,
            relay_client: relay_chain_interface,
            slot_duration: None,
            sync_oracle,
            reinitialize: false,
            max_pov_percentage,
        },
    ),
);
```

### Cumulus Client Dependencies
```toml
# /Users/manuelmauro/Workspace/moonbeam/Cargo.toml:291-296
cumulus-client-cli = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2506" }
cumulus-client-collator = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2506" }
cumulus-client-consensus-common = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2506" }
cumulus-client-consensus-proposer = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2506" }
cumulus-client-service = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2506" }
cumulus-client-parachain-inherent = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2506" }
```

Note: No cumulus-client-consensus-aura dependency present.

### Parachain System Pallet Usage
```toml
# /Users/manuelmauro/Workspace/moonbeam/Cargo.toml:277
cumulus-pallet-parachain-system = { git = "https://github.com/moonbeam-foundation/polkadot-sdk", branch = "moonbeam-polkadot-stable2506", default-features = false }

# Used in all three runtimes:
# /Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/Cargo.toml:155
# /Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/Cargo.toml:172
# /Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/Cargo.toml:171
```

## Conclusion

This PR's changes are **automatically inherited** through the dependency update to stable2506, but have no functional impact on Moonbeam's operation since:

1. Moonbeam does not use Aura consensus (uses Nimbus instead)
2. The PR does not introduce breaking changes to cumulus-pallet-parachain-system (no version bump)
3. No code changes are required in Moonbeam

The improved equivocation checks in Aura are simply not applicable to Moonbeam's consensus mechanism.
