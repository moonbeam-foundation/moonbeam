# PR #8669: cumulus-aura: Improve equivocation checks

## Metadata
- **PR**: https://github.com/paritytech/polkadot-sdk/pull/8669
- **Author**: Bastian KÃ¶cher (@bkchr)
- **Merged**: 2025-05-27
- **Audience**: Node Dev
- **Labels**: T9-cumulus, A4-backport-stable2412, A4-backport-stable2503

## Summary

This PR enhances equivocation detection in cumulus-aura consensus by improving how duplicate block production is tracked and handled. The changes prevent networks from getting stuck during "equivocation storms" while ensuring legitimate blocks from recovery processes can still be imported.

## Technical Changes

### 1. Enhanced Equivocation Tracking

**Before**: The equivocation defender only tracked the slot number to detect duplicate blocks.

**After**: Tracks a composite key of `(Slot, BlockNumber, RelayParent)` to uniquely identify blocks.

```rust
// Old
struct NaiveEquivocationDefender {
    cache: LruMap<u64, usize>,
}

// New
struct NaiveEquivocationDefender<N> {
    cache: LruMap<(u64, N, RHash), usize>,
}
```

**Rationale**: In parachain consensus, multiple blocks can be built per slot (this is a valid scenario). The old implementation would incorrectly flag these as equivocations. The new approach considers:
- **Slot**: The consensus time slot
- **BlockNumber**: The height of the block
- **RelayParent**: The relay chain parent hash

This combination uniquely identifies legitimate multiple blocks per slot vs. actual equivocations.

### 2. Recovery Block Exemption

The PR adds special handling for blocks originating from `BlockOrigin::ConsensusBroadcast`, which is used by the pov-recovery system:

```rust
if self.defender.lock().insert_and_check(
    slot,
    *block_params.header.number(),
    relay_parent,
) && !matches!(block_params.origin, BlockOrigin::ConsensusBroadcast) {
    return Err(format!(
        "Rejecting block {:?} due to excessive equivocations at slot",
        post_hash,
    ).into());
}
```

**Rationale**: When a network experiences an equivocation storm, nodes need to recover blocks through the availability recovery process. These recovered blocks should bypass the equivocation limit to prevent the network from becoming permanently stuck.

### 3. Increased LRU Cache Window

- **Before**: 256 entries
- **After**: 512 entries

This provides a larger window for tracking recent equivocations, accommodating the more complex tracking key.

## Files Modified

1. **cumulus/client/consensus/aura/src/equivocation_import_queue.rs** (128 additions, 16 deletions)
   - Core logic changes to equivocation detection
   - New test suite for equivocation recovery

2. **cumulus/client/pov-recovery/src/lib.rs** (2 additions)
   - Added comment explaining ConsensusBroadcast origin usage

3. **cumulus/test/client/src/lib.rs** (28 additions, 27 deletions)
   - Refactored `seal_block` function to be more reusable
   - Split into `seal_block` (single block) and `seal_parachain_block_data` (multiple blocks)

4. **cumulus/pallets/parachain-system/src/validate_block/tests.rs** (7 additions, 7 deletions)
   - Updated test calls to use new `seal_parachain_block_data` function

## Crate Impact

- `cumulus-client-consensus-aura`: **patch** bump
- `cumulus-client-pov-recovery`: no bump (comment-only change)
- `cumulus-pallet-parachain-system`: no bump (test-only changes)

## Impact on Moonbeam

### Direct Impact: **NONE**

Moonbeam uses **Nimbus consensus** (from the Moonkit repository), not cumulus-aura. Therefore, this PR's changes do not directly affect Moonbeam's consensus mechanism.

Evidence:
- `/Users/manuelmauro/Workspace/moonbeam/node/service/Cargo.toml` uses `nimbus-consensus` from `Moonsong-Labs/moonkit`
- No references to `cumulus-client-consensus-aura` in Moonbeam's codebase
- Nimbus is a custom consensus implementation tailored for Moonbeam's needs

### Indirect Considerations

While this PR doesn't directly impact Moonbeam, it provides valuable insights:

1. **Equivocation Handling Pattern**: The approach of using `(slot, block_number, relay_parent)` as a composite key is a robust pattern for tracking block production in parachain consensus.

2. **Recovery System Integration**: The exemption for `ConsensusBroadcast` blocks demonstrates how to balance security (preventing equivocations) with liveness (allowing recovery).

3. **Future Reference**: If Moonbeam's Nimbus consensus encounters similar equivocation challenges, this PR's implementation could serve as a reference for handling multiple valid blocks per slot.

## Testing

The PR includes comprehensive test coverage:

```rust
#[test]
fn import_equivocated_blocks_from_recovery()
```

This test verifies:
- Normal blocks up to the equivocation limit (16) are accepted
- Additional blocks with `NetworkBroadcast` origin are rejected
- The same blocks with `ConsensusBroadcast` origin (recovery) are accepted
- Both previously-verified and new blocks can be recovered

## Security Implications

### Positive
- Prevents false-positive equivocation detection for legitimate multi-block-per-slot scenarios
- Maintains network liveness during equivocation storms
- More precise tracking reduces the attack surface

### Considerations
- The exemption for `ConsensusBroadcast` blocks could theoretically be exploited if the recovery system is compromised
- Future work mentioned: on-chain slashing for equivocations and disabling offending authors

## Upgrade Path

For projects using cumulus-aura:
- **No action required**: This is a client-side improvement
- **Automatic benefit**: Nodes will automatically get better equivocation handling after upgrading
- **No breaking changes**: The improvement is backward compatible

## Future Work (Per PR Description)

The author mentions next steps:
1. Implement on-chain slashing for equivocations
2. Implement disabling/banning of offending authors

## Recommendation for Moonbeam

**Action**: **No action required**

**Rationale**: Moonbeam uses Nimbus consensus and is not affected by changes to cumulus-aura. However, this PR is worth noting as a reference for best practices in parachain consensus equivocation handling.

**Optional**: Review if Nimbus consensus has similar equivocation detection logic and whether it could benefit from similar improvements (tracking relay parent in addition to slot).

## Related Documentation

- Cumulus-aura equivocation handling: `cumulus/client/consensus/aura/src/equivocation_import_queue.rs`
- POV recovery system: `cumulus/client/pov-recovery/src/lib.rs`
- Moonbeam's Nimbus consensus: https://github.com/Moonsong-Labs/moonkit (branch: moonbeam-polkadot-stable2503)
