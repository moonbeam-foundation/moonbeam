# PR #8724: Implement Detailed Logging for XCM Failures

## Overview
- **Title**: Implement detailed logging for XCM failures
- **PR Link**: https://github.com/paritytech/polkadot-sdk/pull/8724
- **Audience**: Runtime Dev
- **Status**: Merged

## Summary
This PR enhances diagnostics across XCM (Cross-Consensus Messaging) components by implementing detailed error logging, especially within `map_err` paths. It provides clearer messages, standardized log targets, and richer context to aid runtime developers and node operators in debugging and monitoring XCM operations.

## Changes

### Affected Crates
- `cumulus-pallet-xcmp-queue` (patch)
- `parachains-common` (minor)
- `polkadot-runtime-common` (patch)
- `polkadot-runtime-parachains` (minor)
- `staging-xcm-executor` (patch)
- `staging-xcm-builder` (minor)
- `pallet-xcm` (patch)

### Key Improvements
1. **Detailed Error Logging**: Added logging to error handling blocks (`.map_err`) throughout XCM code
2. **Standardized Log Targets**: Predictable naming convention (e.g., `xcm::module::function_name`)
3. **Rich Context**: Logs include message hashes, origin, destination, and relevant parameters
4. **Appropriate Log Levels**:
   - Debug level for runtime errors
   - Trace level for expected routing failures
   - Removed redundant logs

### Modified Files
- `cumulus/pallets/xcmp-queue/src/lib.rs`
- `cumulus/parachains/common/src/xcm_config.rs`
- `polkadot/xcm/pallet-xcm/src/lib.rs`
- `polkadot/xcm/xcm-builder/src/currency_adapter.rs`
- `polkadot/xcm/xcm-builder/src/fungible_adapter.rs`
- And several others

## Impact on Moonbeam

### Severity: LOW-MEDIUM (Informational)

### Affected Areas

#### 1. Runtime XCM Dependencies
**Location**: All three runtimes (moonbase, moonbeam, moonriver)

**Used Crates from this PR**:
```toml
# From runtime/moonbase/Cargo.toml (lines 143-163)
pallet-xcm
xcm-builder (aliased as staging-xcm-builder)
xcm-executor (aliased as staging-xcm-executor)
cumulus-pallet-xcmp-queue
parachains-common
polkadot-runtime-common
```

**Evidence**: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/Cargo.toml`

#### 2. Custom XCM Configuration
**Locations**:
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/xcm_config.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/xcm_config.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/xcm_config.rs`

**Usage**: Moonbeam uses standard xcm-builder components that now have enhanced logging:
- `XcmCurrencyAdapter` (FungibleAdapter)
- Various converters and filters
- XCM executor configuration
- Message queue configuration

#### 3. Node Operators & Monitoring

**Impact**: Enhanced diagnostics for XCM operations:
- Better visibility into XCM failures
- Standardized log formats for parsing
- Improved debugging capability for cross-chain operations

**Log Examples** (new output):
```
[DEBUG xcm::pallet_xcm::do_send] Failed to send XCM message: BadVersion
[DEBUG xcm::xcm_builder::fungible_adapter] Failed to withdraw asset: InsufficientBalance
[TRACE xcm::xcmp_queue::handle_message] Message routing failed (expected)
```

#### 4. Precompiles with XCM Functionality

**Affected Precompiles**:
- `/Users/manuelmauro/Workspace/moonbeam/precompiles/xcm-transactor/` - Transact via XCM
- `/Users/manuelmauro/Workspace/moonbeam/precompiles/xcm-utils/` - XCM utilities
- `/Users/manuelmauro/Workspace/moonbeam/precompiles/xtokens/` - Cross-chain token transfers

**Impact**: When these precompiles execute XCM operations that fail, the logs will now provide much better diagnostic information.

## Migration Path

### Step 1: No Code Changes Required
This PR only adds logging - no behavioral changes to XCM functionality. Moonbeam code does not need to be modified.

### Step 2: Update Monitoring & Log Parsing

If you have log parsing or monitoring systems:

**Action Items**:
1. Update log parsers to handle new log formats
2. Create alerts for critical XCM failures now visible in logs
3. Update documentation for node operators

**New Log Targets to Monitor**:
```
xcm::pallet_xcm::*
xcm::xcm_builder::*
xcm::xcm_executor::*
xcm::xcmp_queue::*
```

### Step 3: Testing

Test XCM functionality to verify logging:

```bash
# Run XCM-related tests
cd test
pnpm moonwall test dev_moonbase -d "xcm"
pnpm moonwall test dev_moonbase -d "xtokens"

# Test XCM precompiles
pnpm moonwall test dev_moonbase -d "xcm-transactor"
pnpm moonwall test dev_moonbase -d "xcm-utils"

# Run runtime integration tests
cargo test -p moonbase-runtime xcm
```

### Step 4: Node Configuration

Consider adjusting log levels for XCM components:

```bash
# Example: Enable debug logging for XCM
./target/release/moonbeam --dev --alice \
  -lxcm=debug \
  -lxcm::pallet_xcm=debug \
  -lxcm::xcm_executor=trace
```

## Compatibility Notes

- **Backward Compatible**: Only adds logging, no behavior changes
- **Breaking Changes**: None
- **Runtime Impact**: Minimal - logging has negligible performance impact
- **Log Volume**: May increase log output during XCM operations (especially failures)

## Benefits for Moonbeam

### 1. Improved Debugging
Better visibility into XCM failures helps diagnose issues with:
- Cross-chain asset transfers
- Remote transacts
- XCM version incompatibilities
- Asset reserve issues

### 2. Better Monitoring
Node operators can:
- Set up alerts for specific XCM error patterns
- Track XCM success/failure rates
- Identify integration issues with other parachains

### 3. Enhanced Support
Support teams can:
- Diagnose user-reported XCM issues faster
- Provide better guidance based on error logs
- Identify common failure patterns

### 4. Development Efficiency
Developers can:
- Debug XCM precompile issues more easily
- Understand why XCM messages fail
- Validate XCM configurations

## Recommendations

1. **Update Monitoring**: Add alerts for new XCM error log patterns
2. **Document for Ops**: Update node operator documentation with new log targets
3. **Test Extensively**: Run full XCM test suite to verify functionality and observe new logging
4. **Log Level Tuning**: Adjust XCM log levels based on production needs (debug vs trace vs info)
5. **Create Runbooks**: Document common XCM error patterns and their solutions based on new logging

## Risk Assessment

### Low Risk
1. No behavioral changes - only adds logging
2. Logging code has minimal performance impact
3. Well-tested in Polkadot SDK before merge
4. No API changes required in Moonbeam code

### Medium Risk (Operational)
1. Increased log volume may require log storage adjustments
2. Log parsing scripts may need updates
3. Monitoring alerts may need reconfiguration

## Example Log Output Changes

### Before (PR #8724)
```
Error: XCM execution failed
```

### After (PR #8724)
```
[DEBUG xcm::pallet_xcm::send_xcm] Failed to send XCM to Location { parents: 1, interior: Parachain(2004) }: BadVersion. Message hash: 0x1234...
[DEBUG xcm::xcm_executor::execute] XCM execution failed at instruction 3: AssetNotFound. Origin: Location { parents: 1, interior: Parachain(1000) }
```

## Additional Notes

This PR is part of ongoing efforts to improve XCM observability across the Polkadot ecosystem. Moonbeam, as a parachain with extensive XCM usage (asset transfers, remote transacts, governance), will significantly benefit from these improvements without requiring any code changes.

The enhanced logging is particularly valuable for Moonbeam's unique use case of bridging Ethereum and Polkadot ecosystems via XCM.
