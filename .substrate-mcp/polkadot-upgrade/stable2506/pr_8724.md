# PR #8724: Implement Detailed Logging for XCM Failures

## Overview

**PR Title:** Implement detailed logging for XCM failures
**PR Link:** https://github.com/paritytech/polkadot-sdk/pull/8724
**Status:** Merged (June 4, 2025)
**Audience:** Runtime Developers

This PR enhances diagnostics in XCM-related code by implementing comprehensive error logging, particularly within `map_err` paths. The goal is to improve visibility into XCM failures to enable faster debugging and monitoring for runtime developers and node operators.

## Technical Details

### Key Changes

1. **Enhanced Error Logging**: Added detailed logging for error conditions including:
   - `BadVersion` errors
   - `BadLocation` errors
   - XCM execution failures
   - Message processing errors

2. **Richer Context**: Error logs now include essential context such as:
   - Message hashes
   - Origin and destination information
   - Relevant parameters (sender, recipient, amounts for transfers)
   - Execution details

3. **Standardized Log Targets**: Implemented consistent log target format `xcm::module::function_name` for easier filtering and analysis

4. **Migration to Tracing**: Later commits migrated from `log` crate to `tracing` instrumentation for structured logging

5. **Log Level Adjustment**: After review feedback, runtime execution failures use `debug` level rather than `error` level (error logs are reserved for node operator-relevant issues)

### Affected Crates

The following crates received logging improvements with their respective version bumps:

| Crate | Bump Type | Used in Moonbeam |
|-------|-----------|------------------|
| `cumulus-pallet-xcmp-queue` | patch | Yes - All runtimes |
| `parachains-common` | minor | Yes - All runtimes |
| `polkadot-runtime-common` | patch | Yes - All runtimes + node/service |
| `polkadot-runtime-parachains` | minor | Yes - All runtimes + relay-encoder |
| `staging-xcm-executor` | patch | Yes - All runtimes (as `xcm-executor`) |
| `staging-xcm-builder` | minor | Yes - All runtimes (as `xcm-builder`) |
| `pallet-xcm` | patch | Yes - All runtimes + precompiles |

## Impact on Moonbeam

### Direct Impact

Moonbeam uses ALL affected crates across its architecture:

**Runtimes:**
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/Cargo.toml`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/Cargo.toml`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/Cargo.toml`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/common/Cargo.toml`

**Precompiles:**
- `precompiles/xcm-utils` - Uses `pallet-xcm`
- `precompiles/xtokens` - Uses `pallet-xcm` and `pallet-xcm-transactor`
- `precompiles/xcm-transactor` - Uses `pallet-xcm-transactor`
- `precompiles/gmp` - Uses `pallet-xcm` and `pallet-xcm-transactor`
- `precompiles/relay-encoder` - Uses `pallet-xcm-transactor`

**Node:**
- `/Users/manuelmauro/Workspace/moonbeam/node/service/Cargo.toml` - Uses `polkadot-runtime-common`

**Custom Pallets:**
- `pallets/xcm-transactor`
- `pallets/xcm-weight-trader`

### Compatibility with Existing Logging

Moonbeam already uses structured logging in XCM-related code. Example from `/Users/manuelmauro/Workspace/moonbeam/precompiles/gmp/src/lib.rs`:

```rust
log::debug!(target: "gmp-precompile", "wormhole_vaa: {:?}", wormhole_vaa.clone());
log::debug!(target: "gmp-precompile", "sending XCM via xtokens::transfer...");
log::debug!(target: "gmp-precompile", "error sending XCM: {:?}", e);
```

This is consistent with PR #8724's approach of using `log::debug!` for runtime execution logging with structured targets.

## Benefits

1. **Improved Debugging**: More detailed error messages will make it easier to diagnose XCM failures in production
2. **Better Monitoring**: Standardized log targets enable better filtering and alerting
3. **Enhanced Observability**: Rich context in error logs reduces time to resolution
4. **Consistency**: Aligned with community best practices for XCM logging
5. **Tracing Support**: Migration to `tracing` crate enables structured logging and span context

## Risks and Considerations

### Low Risk

This is primarily an additive change (adding logging statements) with minimal risk:

1. **No Functional Changes**: Core XCM logic remains unchanged
2. **Debug Level Logging**: Performance impact is minimal (debug logs can be disabled in production)
3. **Backward Compatible**: No breaking API changes
4. **Tested**: PR had 244 passing checks before merge

### Potential Considerations

1. **Log Volume**: More verbose logging may increase log volume in debug mode
   - **Mitigation**: Debug logs can be filtered at runtime; only relevant modules need to be enabled

2. **Dependency Version Bumps**: Minor version bumps in some crates
   - **Note**: Following semantic versioning correctly; minor bumps indicate backward-compatible additions

3. **Review Existing Log Levels**: Moonbeam team may want to review if any custom XCM error logging should follow the same pattern (debug vs error)

## Action Items

### Required

1. **Test XCM Functionality**: After upgrade, verify XCM operations work correctly:
   - Cross-chain asset transfers
   - Remote transact operations
   - XCM message routing
   - Precompile XCM calls (xcm-utils, xtokens, gmp)

2. **Review Runtime Tests**: Ensure XCM-related tests pass, especially:
   - `pallet-xcm-transactor` tests
   - `pallet-xcm-weight-trader` tests
   - Precompile tests (gmp, xtokens, xcm-transactor, xcm-utils)

### Recommended

1. **Enable Debug Logging in Test Environments**: Configure debug logging for XCM modules to benefit from enhanced diagnostics:
   ```bash
   RUST_LOG=xcm=debug,cumulus_pallet_xcmp_queue=debug
   ```

2. **Update Monitoring**: Consider adding alerts for specific XCM error patterns now that logs are standardized

3. **Documentation**: Update any internal debugging guides to reference the new structured log targets

## Related PRs

- Continues work from PR #7003
- Partially addresses issue #6119

## Conclusion

PR #8724 is a low-risk, high-value improvement that enhances XCM debugging capabilities across the Polkadot SDK. For Moonbeam, which heavily relies on XCM for cross-chain operations, this will improve the ability to diagnose and resolve XCM-related issues in production. The changes align well with Moonbeam's existing logging patterns and should integrate seamlessly during the stable2506 upgrade.

**Recommendation:** APPROVE - No action required beyond standard upgrade testing.
