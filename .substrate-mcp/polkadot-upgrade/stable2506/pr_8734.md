# PR #8734: pallet-revive - Contract's Nonce Starts at 1

## Overview
- **Title**: [pallet-revive] contract's nonce starts at 1
- **PR Link**: https://github.com/paritytech/polkadot-sdk/pull/8734
- **Audience**: Runtime Dev
- **Status**: Merged

## Summary
This PR modifies pallet-revive to initialize contract nonces at 1 instead of 0, aligning with Ethereum's EIP-161 standard. This ensures that smart contract behavior matches Ethereum's nonce conventions.

## Changes
- **Affected Crate**: `pallet-revive` (minor bump)
- **Change**: Contract nonces now start at 1 instead of 0
- **Rationale**: EIP-161 compliance (https://github.com/ethereum/EIPs/blob/master/EIPS/eip-161.md)

### What is EIP-161?
EIP-161 (State Trie Clearing) is an Ethereum improvement proposal that defines:
1. Accounts are considered "empty" when they have nonce = 0, balance = 0, and no code
2. Contract accounts should start with nonce = 1 upon creation
3. This prevents certain edge cases and improves state trie efficiency

## Impact on Moonbeam

### Severity: NONE

### Analysis

**Moonbeam Does Not Use pallet-revive**

As with PR #8718, Moonbeam uses `pallet-evm` (from Frontier) for Ethereum smart contract execution, not `pallet-revive`.

**Evidence**:
```bash
# Search for pallet-revive usage in Moonbeam
grep -r "pallet-revive\|pallet_revive" /Users/manuelmauro/Workspace/moonbeam/
# Result: No matches in actual codebase (only in analysis documents)
```

### Moonbeam's EIP-161 Compliance

**Important Note**: While this PR doesn't affect Moonbeam, EIP-161 compliance is relevant to Moonbeam's architecture.

**Evidence of Correct Behavior**:
Moonbeam's tests expect nonce = 1 after transactions:
```rust
// From pallets/ethereum-xcm/src/tests/v1/legacy.rs:197
assert!(t.nonce == U256::from(1u8));
```

**Verification Needed**: It would be prudent to verify that:
1. `pallet-evm` correctly initializes contract nonces at 1 (EIP-161 compliant)
2. Moonbeam's EVM implementation handles empty account clearing correctly
3. Tests cover EIP-161 edge cases

### Moonbeam's Smart Contract Architecture

| Component | Moonbeam | pallet-revive |
|-----------|----------|---------------|
| Execution | EVM bytecode (pallet-evm) | EVM-compatible WASM |
| Nonce Management | Handled by Frontier | Handled by pallet-revive |
| EIP Compliance | Full Ethereum compatibility | Partial EVM compatibility |
| Account Model | Ethereum account model | Substrate account model |

## Migration Path

### No Action Required for This PR

Since Moonbeam doesn't use pallet-revive, this specific PR has no impact.

### Recommended Verification (General Best Practice)

While not related to this PR, it's good practice to verify Moonbeam's EIP-161 compliance:

```bash
# Run EVM-related tests
cargo test -p pallet-ethereum-xcm
cargo test -p moonbase-runtime evm

# Run contract deployment tests
cd test
pnpm moonwall test dev_moonbase -d "contract"
pnpm moonwall test dev_moonbase -d "evm"
```

## EIP-161 Context for Moonbeam

### Why EIP-161 Matters

EIP-161 defines critical account state rules:
1. **Contract Creation**: New contracts start with nonce = 1
2. **Empty Accounts**: Accounts with nonce = 0, balance = 0, and no code are "empty"
3. **State Clearing**: Empty accounts can be removed from state
4. **Reentrancy Protection**: Nonce = 1 prevents certain reentrancy attacks

### Moonbeam's Implementation

Moonbeam uses `pallet-evm` from the Frontier framework, which should already be EIP-161 compliant:
- Frontier is maintained to match Ethereum's behavior
- pallet-evm follows Ethereum's account model
- Contract deployments follow Ethereum rules

### Verification Areas

If you want to verify EIP-161 compliance in Moonbeam (recommended for completeness):

1. **Contract Deployment Nonce**:
   - Deploy a contract and check its initial nonce is 1
   - Verify the deployer's nonce increments correctly

2. **Empty Account Handling**:
   - Create an account, use it, and drain it completely
   - Verify it's treated as empty (nonce = 0, balance = 0)

3. **Self-destruct Behavior**:
   - Test SELFDESTRUCT opcode with nonce checks
   - Verify recreating contracts at same address works correctly

## Compatibility Notes

- **pallet-revive**: Not used by Moonbeam - no impact
- **pallet-evm**: Moonbeam's actual EVM implementation - assumed EIP-161 compliant
- **Frontier**: Maintains Ethereum compatibility including EIPs
- **Testing**: Moonbeam tests show correct nonce behavior

## Recommendations

1. **This PR**: No action needed - pallet-revive not used
2. **General Practice**: Document and verify Moonbeam's EIP compliance levels
3. **Testing**: Ensure test coverage for EIP-161 edge cases
4. **Documentation**: Reference which EIPs are supported in Moonbeam docs
5. **Future**: Monitor Frontier updates for EIP compliance changes

## Related Information

### EIP-161 Specification
- **Title**: State trie clearing (invariant-preserving alternative)
- **Status**: Final
- **Link**: https://github.com/ethereum/EIPs/blob/master/EIPS/eip-161.md

### Key Rules from EIP-161
1. Account states: nonce, balance, code, storage
2. Empty accounts: nonce = 0 AND balance = 0 AND code empty
3. Contract creation: nonce starts at 1
4. Account deletion: happens when empty after transaction

### Frontier/pallet-evm Compliance
Frontier is designed to be Ethereum-compatible and should implement EIP-161 correctly. However, explicit verification is always good practice.

## Conclusion

This PR is not applicable to Moonbeam as it only affects pallet-revive, which Moonbeam doesn't use. However, the underlying issue (EIP-161 compliance for contract nonces) is relevant to Moonbeam's pallet-evm implementation.

**Action Items**: None for this PR specifically, but consider adding explicit EIP-161 compliance tests to Moonbeam's test suite for completeness and documentation purposes.
