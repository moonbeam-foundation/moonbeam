# PR #8860: XCMP and DMP Improvements

## Overview

**PR Link**: https://github.com/paritytech/polkadot-sdk/pull/8860
**Status**: Merged (July 1, 2025)
**Audience**: Runtime Dev, Node Dev, Node Operator
**Breaking Changes**: Yes (Major)

## Summary

This PR fundamentally changes how parachains receive and process cross-chain messages through XCMP (Cross-Chain Message Passing) and DMP (Downward Message Passing). It introduces an offchain processing layer that handles messages before they are forwarded to the parachain's `set_validation_data` inherent, enabling relaxation of message advancement rules.

## Key Changes

### Architecture Modifications

1. **Offchain Message Processing**
   - Adds preprocessing layer for XCMP and DMP messages
   - Messages are now processed offchain before reaching the `set_validation_data` inherent
   - Enables more flexible message advancement rules

2. **Inherent Data Structure Changes**
   - Modified `set_validation_data` inherent arguments
   - Breaking change to parachain-system pallet interface

3. **Multi-Component Update**
   - Relay chain runtime changes
   - Relay chain node client changes
   - Parachain runtime changes (dependent on relay chain deployment)

### Affected Crates

| Crate | Bump | Impact |
|-------|------|--------|
| `cumulus-pallet-parachain-system` | **major** | Breaking changes to inherent interface |
| `cumulus-primitives-parachain-inherent` | minor | Updated primitives structure |
| `cumulus-client-parachain-inherent` | minor | Client-side inherent handling |
| `polkadot-core-primitives` | minor | Core primitive updates |
| `polkadot-runtime-parachains` | patch | HRMP logic adjustments |
| `polkadot-node-subsystem-util` | patch | Subsystem utility updates |
| `parachains-runtimes-test-utils` | patch | Test utility updates |
| `xcm-emulator` | minor | Emulator compatibility updates |

## Impact on Moonbeam

### Critical Components Affected

1. **Parachain System Pallet** (Major Breaking Change)
   - Moonbeam uses `cumulus-pallet-parachain-system` as a core component
   - The inherent data structure changes require runtime updates
   - Message processing logic has been fundamentally modified

2. **Cross-Chain Communication**
   - Affects all XCMP message handling (communication with other parachains)
   - Affects all DMP message handling (messages from relay chain)
   - Impacts XCM operations and cross-chain asset transfers

3. **Collator Operations**
   - Changes to inherent processing may affect block production
   - No collator client code modifications required (confirmed by PR author)

### Migration Requirements

**Mandatory Changes:**
- Update to latest `cumulus-pallet-parachain-system` version
- Verify compatibility with new inherent data structure
- Test XCMP/DMP message handling thoroughly

**Testing Focus:**
- Cross-chain asset transfers
- XCM message execution
- DMP message processing from relay chain
- HRMP channel operations

## Deployment Strategy

### Two-Phase Rollout (Critical)

**Phase 1: Relay Chain Deployment**
- Deploy relay chain runtime changes
- Deploy relay chain node client changes
- Order of relay chain updates doesn't matter

**Phase 2: Parachain Deployment**
- Deploy Moonbeam runtime updates (AFTER relay chain is updated)
- This phase must follow Phase 1 completion

### Sequencing Risk

**Warning**: Deploying parachain changes before relay chain updates could cause:
- Message processing failures
- Broken cross-chain communication
- Potential parachain stalling

**Recommendation**: Wait for confirmed relay chain deployment (Polkadot/Kusama/Westend) before deploying Moonbeam runtime updates.

## Technical Details

### Modified Components

1. **cumulus/pallets/parachain-system/src/lib.rs**
   - Core pallet logic updates
   - New message processing flow

2. **cumulus/primitives/parachain-inherent/src/lib.rs**
   - Updated inherent data structures
   - New primitive definitions

3. **polkadot/runtime/parachains/src/hrmp.rs**
   - Relay chain HRMP logic adjustments
   - Message routing updates

4. **polkadot/core-primitives/src/lib.rs**
   - Core primitive modifications

### Key Discussion Points from PR

1. **Documentation Concerns**
   - Reviewers noted missing documentation for public methods
   - Recommendation: Review updated API documentation when available

2. **External Tooling Compatibility**
   - Chopsticks and other parachain testing tools may need updates
   - Verify testing infrastructure compatibility

3. **No Collator Client Changes**
   - PR author confirmed no collator client modifications needed
   - Only runtime changes required for parachains

## Risk Assessment

### High Risk Areas

1. **Message Processing**
   - Risk: Changed processing logic could affect message delivery
   - Mitigation: Extensive testing on testnet (Moonbase Alpha)

2. **Deployment Timing**
   - Risk: Incorrect deployment order could break parachain
   - Mitigation: Follow strict two-phase deployment, monitor relay chain upgrades

3. **Cross-Chain Operations**
   - Risk: XCM operations may behave differently
   - Mitigation: Test all XCM scenarios on testnet

### Medium Risk Areas

1. **Performance Impact**
   - Risk: Offchain processing may affect block production times
   - Mitigation: Monitor block times and parachain performance

2. **Testing Tool Compatibility**
   - Risk: Development tools (Chopsticks, etc.) may be incompatible
   - Mitigation: Update development environment before mainnet deployment

## Action Items for Moonbeam

### Pre-Deployment

- [ ] Wait for relay chain (Polkadot/Kusama/Westend) to deploy Phase 1
- [ ] Update Moonbase Alpha testnet with new runtime
- [ ] Test XCMP message handling on testnet
- [ ] Test DMP message handling on testnet
- [ ] Verify XCM asset transfers work correctly
- [ ] Test HRMP channel operations
- [ ] Update development tooling (if needed)
- [ ] Verify Chopsticks compatibility

### Deployment

- [ ] Deploy to Moonbase Alpha first
- [ ] Monitor for 48-72 hours on testnet
- [ ] Deploy to Moonriver (after Kusama relay chain upgrade)
- [ ] Deploy to Moonbeam (after Polkadot relay chain upgrade)

### Post-Deployment

- [ ] Monitor cross-chain message processing
- [ ] Track block production times
- [ ] Monitor XCM operation success rates
- [ ] Update documentation for any behavioral changes

## Recommended Testing

### Unit Tests
```bash
# Test parachain-system pallet updates
cargo test -p cumulus-pallet-parachain-system

# Test XCM-related functionality
cargo test -p pallet-xcm
```

### Integration Tests
```bash
# Test cross-chain operations on Moonbase
cd test
pnpm moonwall test dev_moonbase

# Focus on XCM-related tests
pnpm moonwall test -g "XCM" dev_moonbase
```

### Smoke Tests
```bash
# Quick validation after deployment
pnpm moonwall test smoke_moonbase
```

## References

- **PR**: https://github.com/paritytech/polkadot-sdk/pull/8860
- **PRDoc**: `/Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_8860.prdoc`
- **Affected Pallet**: `cumulus-pallet-parachain-system`
- **Cumulus Repo**: https://github.com/paritytech/polkadot-sdk/tree/master/cumulus

## Conclusion

PR #8860 is a **high-impact, breaking change** that requires careful deployment coordination with relay chain upgrades. The offchain processing improvements may offer performance benefits, but the breaking changes to inherent data structures require thorough testing and careful deployment sequencing.

**Priority**: High
**Breaking**: Yes
**Requires Migration**: Yes
**Deployment Coordination**: Critical
