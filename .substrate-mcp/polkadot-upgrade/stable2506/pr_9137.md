# PR #9137: Pallet XCM - transfer_assets Pre-AHM Patch

## Overview

**PR**: [paritytech/polkadot-sdk#9137](https://github.com/paritytech/polkadot-sdk/pull/9137)
**Author**: franciscoaguirre
**Status**: Merged (July 14, 2025)
**Crate**: `pallet-xcm` (patch bump)
**Audience**: Runtime User, Runtime Dev

## Summary

This PR introduces a temporary safeguard in `pallet-xcm`'s `transfer_assets` extrinsic that prevents reserve transfers of relay chain native tokens (DOT, KSM, WND, PAS) in preparation for the Asset Hub Migration (AHM). After AHM, the reserve location for these tokens will move from the Relay Chain to Asset Hub, and this patch prevents incorrect transfers during the transition period.

## Changes

### Core Functionality

The `transfer_assets` extrinsic now returns an error when it detects that a reserve transfer of relay chain native tokens must be performed. This is implemented by:

1. Using the runtime's `UniversalLocation` configuration to identify the token being transferred
2. Checking if the asset is a relay chain native token (DOT/KSM/WND/PAS)
3. Blocking the transfer and returning an error

### Post-Migration Plan

After the Asset Hub Migration is complete, a follow-up patch will:
- Remove this error condition
- Update the logic to use the correct reserve (Asset Hub instead of Relay Chain)

### Alternative Extrinsics

Users who need to perform reserve transfers of relay chain native tokens should use these alternatives that allow explicit reserve specification:
- `limited_reserve_transfer_assets`
- `transfer_assets_using_type_and_then`
- `execute` (XCM program)

## Impact on Moonbeam

### Configuration Requirements

**Critical**: The `UniversalLocation` configuration must be correct for this safeguard to work properly. Moonbeam's current configuration is:

**File**: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/xcm_config.rs` (lines 88-89)
```rust
pub UniversalLocation: InteriorLocation =
    [GlobalConsensus(RelayNetwork::get()), Parachain(ParachainInfo::parachain_id().into())].into();
```

This configuration is correct and properly identifies Moonbeam's position in the network hierarchy.

### Code Usage Analysis

Analysis of Moonbeam's codebase shows:

**Minimal Direct Impact**:
- Moonbeam does NOT use `transfer_assets` for relay chain native token transfers in production code
- All relay chain token transfers use `limited_reserve_transfer_assets` which is unaffected
- `transfer_assets` is only used in tests for self-reserve tokens (GLMR/MOVR/DEV)

**Test Usage**:
- File: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/tests/xcm_tests.rs`
- Tests use `transfer_assets` for parachain self-reserve assets
- Tests use `limited_reserve_transfer_assets` for relay chain assets
- No code changes required for existing tests

### User Impact

**Low Risk for Moonbeam Users**:
- Users transferring GLMR (Moonbeam) or MOVR (Moonriver) are unaffected
- Users transferring DOT or KSM through Moonbeam should already be using alternative extrinsics
- The blocked functionality (`transfer_assets` for DOT/KSM) was not exposed through Moonbeam's precompiles

### XCM Configuration Review

The PR emphasizes the importance of correct `UniversalLocation` configuration. All three Moonbeam runtimes have been verified to have correct configurations:

**Moonbeam Runtime**: Polkadot parachain
- File: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/xcm_config.rs` (line 85)
- Configuration: `NetworkId::Polkadot`
```rust
pub const RelayNetwork: NetworkId = NetworkId::Polkadot;
pub UniversalLocation: InteriorLocation =
    [GlobalConsensus(RelayNetwork::get()), Parachain(ParachainInfo::parachain_id().into())].into();
```

**Moonriver Runtime**: Kusama parachain
- File: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/xcm_config.rs` (line 85, 89-90)
- Configuration: `NetworkId::Kusama`
```rust
pub const RelayNetwork: NetworkId = NetworkId::Kusama;
pub UniversalLocation: InteriorLocation =
    [GlobalConsensus(RelayNetwork::get()), Parachain(ParachainInfo::parachain_id().into())].into();
```

**Moonbase Runtime**: TestNet on Westend
- File: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/xcm_config.rs` (line 86, 93-94)
- Configuration: `NetworkId::ByGenesis(xcm::v5::WESTEND_GENESIS_HASH)`
```rust
pub RelayNetwork: NetworkId = NetworkId::ByGenesis(xcm::v5::WESTEND_GENESIS_HASH);
pub UniversalLocation: InteriorLocation =
    [GlobalConsensus(RelayNetwork::get()), Parachain(ParachainInfo::parachain_id().into())].into();
```

All configurations correctly identify their respective network and parachain position.

## Technical Details

### Affected Asset Detection

The patch identifies relay chain native assets by checking if an asset's reserve location matches:
- Interior: `[]` (root)
- Parent count: 1 (one level up, i.e., relay chain)

This matches the canonical location for DOT/KSM/WND/PAS from a parachain's perspective.

### Error Handling

The extrinsic returns an error without attempting the transfer, preventing incorrect reserve determinations that would occur during the AHM transition period.

## Action Items

### Required Actions
None - Moonbeam's configuration is correct and code patterns are already using the appropriate extrinsics.

### Recommended Actions

1. **Documentation Update** (if applicable)
   - Update any user-facing documentation that mentions `transfer_assets` for relay chain tokens
   - Document the temporary restriction if it affects any user guides

2. **Monitor for Follow-up PR**
   - Watch for the post-AHM patch that removes this restriction
   - This follow-up will be part of a future Polkadot SDK release

## Integration Checklist

- [x] Review PRDoc documentation
- [x] Verify `UniversalLocation` configuration in Moonbeam runtime
- [x] Verify Moonriver `UniversalLocation` configuration (correct: `NetworkId::Kusama`)
- [x] Verify Moonbase `UniversalLocation` configuration (correct: `NetworkId::ByGenesis(WESTEND_GENESIS_HASH)`)
- [x] Check codebase usage of `transfer_assets`
- [x] Assess impact on existing tests
- [x] Confirm minimal user impact (no relay chain token transfers via `transfer_assets` in production)
- [ ] Monitor for post-AHM follow-up PR

## Related Information

- **Issue**: [#9054](https://github.com/paritytech/polkadot-sdk/issues/9054)
- **Asset Hub Migration**: This is part of the broader AHM initiative to move relay chain native tokens to Asset Hub
- **Backports**: Successfully backported to stable2409, stable2412, stable2503, stable2506, unstable2507
- **Integration**: Incorporated into polkadot-fellows/runtimes

## References

- PRDoc: `/Users/manuelmauro/.substrate-mcp/moonbeam/releases/stable2506/pr-docs/pr_9137.prdoc`
- GitHub PR: https://github.com/paritytech/polkadot-sdk/pull/9137
- Related PRs: Part of the Asset Hub Migration preparation series
