# PR #9202 Impact Analysis: apply_authorized_force_set_current_code does not need to consume the whole block

## Overview
- **PR Title**: `apply_authorized_force_set_current_code` does not need to consume the whole block
- **GitHub**: https://github.com/paritytech/polkadot-sdk/pull/9202
- **Author**: bkchr
- **Merge Status**: Merged (July 15, 2025)
- **Backported to**: stable2503, stable2506, unstable2507
- **Crates Modified**: polkadot-runtime-parachains (patch)

## Description

This PR is a performance optimization for the `apply_authorized_force_set_current_code` dispatchable function in the `polkadot-runtime-parachains` crate.

### Background

The `apply_authorized_force_set_current_code` function was introduced in PR #7592 as part of the new parachain code authorization mechanism. This function allows applying a previously authorized code hash to update parachain code on the relay chain without transmitting the entire WASM blob across chains.

### The Problem

Previously, this dispatchable was configured to consume an entire block's computational resources (full block weight). This was overly conservative since the function simply writes a value to storage - it doesn't trigger runtime changes on the relay chain itself.

### The Solution

The PR reduces the weight consumption of this dispatchable to reflect its actual computational cost: a storage write operation. This optimization is safe because:

1. **On a standard runtime upgrade**: Full block consumption makes sense because the runtime changes and many internal state transitions occur
2. **On a relay chain parachain code update**: The relay chain runtime itself doesn't change - only the parachain's code is updated, which is a simple storage write operation

### Technical Changes

- Reduced the weight of `apply_authorized_force_set_current_code` from full block consumption to a more accurate storage write weight
- Removed an unused import identified during code review
- Updated weight benchmarks accordingly

## Impact Assessment

### Impact Category: **NO IMPACT**

### Evidence

#### 1. Dependency Analysis

**Current Moonbeam Dependencies**:
```toml
# From runtime/moonbase/Cargo.toml (line 190)
[dev-dependencies]
polkadot-runtime-parachains = { workspace = true }

# From runtime/relay-encoder/Cargo.toml (line 36)
[dev-dependencies]
polkadot-runtime-parachains = { workspace = true }
```

**Key Finding**: The `polkadot-runtime-parachains` crate is used **ONLY as a dev-dependency** in Moonbeam, meaning it's exclusively used for testing purposes, not in production runtime.

**Current Version**:
```
polkadot-runtime-parachains v19.2.1
source: git+https://github.com/moonbeam-foundation/polkadot-sdk?branch=moonbeam-polkadot-stable2503
```

#### 2. Production Runtime Analysis

**File**: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/lib.rs`
**File**: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/lib.rs`
**File**: `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/lib.rs`

**Search Result**: No production imports or usage of `polkadot-runtime-parachains::paras` module

**Evidence**: The production Moonbeam runtimes do not import or use any functionality from the `paras` pallet of the `polkadot-runtime-parachains` crate. This is expected because:
- Moonbeam is a **parachain**, not a relay chain
- The `paras` pallet is relay chain functionality for managing parachains
- Parachains interact with relay chain functionality through XCM, not direct pallet calls

#### 3. Test Usage Analysis

**Test Mock Relay Chain Configuration** (`runtime/*/tests/xcm_mock/relay_chain.rs`):
```rust
use polkadot_runtime_parachains::{
    configuration, dmp, hrmp,
    inclusion::{AggregateMessageOrigin, UmpQueueId},
    origin, paras, shared,
};

impl paras::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type WeightInfo = paras::TestWeightInfo;  // ‚Üê Uses test weight implementation
    type UnsignedPriority = ParasUnsignedPriority;
    type NextSessionRotation = TestNextSessionRotation;
    type QueueFootprinter = ();
    type OnNewHead = ();
    type AssignCoretime = ();
}
```

**Key Observations**:
1. Mock relay chains use `paras::TestWeightInfo`, which is a test-only weight implementation
2. The actual weight changes in the PR affect production relay chain weights, not test weights
3. Test weights are intentionally simplified and don't reflect real resource consumption

#### 4. Function Usage Analysis

**Search for the modified function**:
```bash
grep -r "apply_authorized_force_set_current_code" /Users/manuelmauro/Workspace/moonbeam/
```

**Result**: No matches in Moonbeam codebase (except in related analysis documents)

**Interpretation**: Moonbeam does not use, call, or interact with the `apply_authorized_force_set_current_code` function anywhere in its codebase, including:
- Production runtime
- Test code
- XCM configurations
- Relay encoder utilities

#### 5. Relay Chain Interaction Analysis

**File**: `/Users/manuelmauro/Workspace/moonbeam/runtime/relay-encoder/src/kusama.rs`
```rust
pub enum RelayCall {
    #[codec(index = 6u8)]
    Stake(StakeCall),
    #[codec(index = 24u8)]
    Utility(UtilityCall),
    #[codec(index = 60u8)]
    Hrmp(HrmpCall),
}
```

**File**: `/Users/manuelmauro/Workspace/moonbeam/runtime/relay-encoder/src/polkadot.rs` (similar structure)
**File**: `/Users/manuelmauro/Workspace/moonbeam/runtime/relay-encoder/src/westend.rs` (similar structure)

**Evidence**: Moonbeam's relay encoder, which enables encoding relay chain calls that can be executed via XCM, only supports:
- **Staking calls**: For relay chain staking operations
- **Utility calls**: For batching and proxying
- **HRMP calls**: For horizontal relay message passing (parachain-to-parachain communication setup)

There is **NO support for Paras pallet calls**, confirming that Moonbeam cannot and does not interact with any `paras` pallet functionality, including the optimized `apply_authorized_force_set_current_code` function.

#### 6. Weight Impact Analysis

**Weight Benchmark Files Checked**:
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbase/src/weights/frame_system.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonbeam/src/weights/frame_system.rs`
- `/Users/manuelmauro/Workspace/moonbeam/runtime/moonriver/src/weights/frame_system.rs`

**Finding**: These files contain weight benchmarks for Moonbeam's own pallets, not relay chain pallets. The weight changes in PR #9202 affect relay chain benchmarks, which are:
1. Not included in Moonbeam's runtime
2. Not used by Moonbeam's operations
3. Only relevant to relay chain block production

## Detailed Findings

### What This PR Does NOT Affect

1. **Moonbeam's Runtime**: No production code uses the modified function
2. **Moonbeam's Tests**: Tests use `TestWeightInfo`, not production weights
3. **XCM Functionality**: XCM operations don't invoke this function
4. **Block Production**: Moonbeam's block production uses parachain consensus, not relay chain functionality
5. **Upgrade Mechanisms**: Moonbeam uses its own upgrade mechanisms via `frame_system::authorize_upgrade` and `frame_system::apply_authorized_upgrade`, not the relay chain `paras` pallet functions

### What This PR Does Affect (Relay Chain Only)

1. **Relay Chain Performance**: When the relay chain executes `apply_authorized_force_set_current_code`, it will consume less block weight
2. **Relay Chain Block Space**: More transactions can fit in the same relay chain block alongside this operation
3. **Relay Chain Governance**: Governance operations that use this function will be more efficient

### Relationship to PR #7592

**PR #7592** introduced the `apply_authorized_force_set_current_code` function as part of a new parachain code authorization mechanism. That analysis (see `/Users/manuelmauro/Workspace/moonbeam/.substrate-mcp/polkadot-upgrade/stable2506/pr_7592.md`) concluded:

- **Impact**: NO IMPACT / TEST-ONLY
- **Reason**: Function added to relay chain, not used by Moonbeam

**PR #9202** is a follow-up optimization to PR #7592. Since Moonbeam doesn't use the function introduced in #7592, it similarly doesn't benefit from or need to adapt to the optimization in #9202.

## Related Moonbeam Functionality

For context, Moonbeam has its own runtime upgrade mechanism that is **separate and independent** from the relay chain's parachain code management:

**File**: `/Users/manuelmauro/Workspace/moonbeam/runtime/common/src/apis.rs`
```rust
// Moonbeam uses standard frame_system authorization
impl_runtime_apis! {
    impl frame_system_rpc_runtime_api::AccountNonceApi<Block, AccountId, Index> for Runtime {
        fn account_nonce(account: AccountId) -> Index {
            System::account_nonce(account)
        }
    }
}
```

**Moonbeam's Upgrade Flow**:
1. Governance proposes a runtime upgrade
2. `frame_system::authorize_upgrade` is called to authorize a code hash
3. `frame_system::apply_authorized_upgrade` is called with the actual WASM code
4. The runtime upgrade is applied to the Moonbeam parachain

This is entirely independent of the relay chain's `paras::apply_authorized_force_set_current_code` function.

## Action Items

### Required Actions: **NONE**

This PR has zero impact on Moonbeam's production runtime, test suite, or functionality.

### Optional Actions: **NONE**

No code changes, test updates, or documentation updates are needed.

## Risk Assessment

**Risk Level**: **NONE**

### Why No Risk?

1. **Dev-only Dependency**: The affected crate is only used for testing
2. **No Production Usage**: Moonbeam's runtime doesn't use the modified function
3. **Test Weight Isolation**: Test weights (`TestWeightInfo`) are separate from production weights
4. **Relay Chain Only**: The optimization affects relay chain operations, not parachain operations
5. **Backwards Compatible**: The PR is a performance optimization with no API changes

### Verification

**Compilation Test**: The upgrade will succeed because:
- No API changes require code modifications
- Test weights are unchanged
- No new dependencies are introduced

**Runtime Test**: All existing tests will pass because:
- Mock relay chains use test weights
- No test logic depends on the specific weight value
- The function isn't called in any test scenarios

**Integration Test**: XCM and relay chain interactions will work identically because:
- Moonbeam doesn't call this function
- The function's behavior is unchanged, only its weight
- Relay chain compatibility is maintained

## Benefits of This PR (For Relay Chains)

While this PR doesn't directly affect Moonbeam, it does provide benefits to the broader Polkadot ecosystem:

1. **Improved Relay Chain Efficiency**: More efficient block space utilization on relay chains
2. **Faster Governance Operations**: Parachain code upgrade governance operations complete faster
3. **Better Resource Allocation**: More accurate weight accounting improves overall system performance
4. **Enables AHM Use Case**: The AssetHub Migration scenario (where governance moves to AssetHub) becomes more efficient

As a parachain in the Polkadot ecosystem, Moonbeam indirectly benefits from improved relay chain efficiency, but requires no changes to take advantage of these improvements.

## Moonbeam Upgrade Path

### Upgrade to stable2506

**Step 1: Dependency Update**
```toml
# This happens automatically via workspace dependency update
polkadot-runtime-parachains = { workspace = true }
```

**Step 2: Compilation**
```bash
cargo build --release
cargo test
```

**Expected Result**: ‚úÖ Builds and tests pass without modification

**Why It Works**:
- The patch bump is API-compatible
- Test code doesn't depend on specific weight values
- No breaking changes to used APIs

## Conclusion

PR #9202 is a relay chain performance optimization that:

‚úÖ **Has zero impact on Moonbeam's production runtime**
‚úÖ **Requires no code changes**
‚úÖ **Requires no test modifications**
‚úÖ **Introduces no risks**
‚úÖ **Improves relay chain efficiency (indirect benefit to ecosystem)**

The PR modifies functionality that Moonbeam does not use, in a crate that Moonbeam only depends on for testing. The test usage is not affected because tests use simplified weight implementations.

## Recommendation

**Status**: ‚úÖ **APPROVED - NO ACTION REQUIRED**

This PR can be included in the stable2506 upgrade without any concerns, code modifications, or testing requirements for Moonbeam.

### Related Analysis Documents

- **PR #7592 Analysis**: `/Users/manuelmauro/Workspace/moonbeam/.substrate-mcp/polkadot-upgrade/stable2506/pr_7592.md`
  - Introduced the `apply_authorized_force_set_current_code` function
  - Concluded: NO IMPACT on Moonbeam

- **PR #9202 Analysis**: This document
  - Optimizes the weight of `apply_authorized_force_set_current_code`
  - Concludes: NO IMPACT on Moonbeam

## Additional Notes

### For Future Reference

If Moonbeam ever needs to implement relay chain governance operations that manage parachain code from the relay chain side (unlikely for a production parachain), this optimization means such operations would be more efficient. However, given Moonbeam's architecture and governance model, this scenario is not anticipated.

### Ecosystem Context

This PR is part of the broader AssetHub Migration (AHM) initiative where relay chain governance is being moved to AssetHub. The optimization makes it more practical for governance operations to manage parachain code from alternative chains. While this doesn't affect Moonbeam directly, it represents the evolution of the Polkadot governance model.

---

**Analysis completed**: 2025-10-22
**Analyzer**: Claude Code (Substrate MCP)
**Confidence**: High (based on comprehensive codebase analysis and dependency verification)
